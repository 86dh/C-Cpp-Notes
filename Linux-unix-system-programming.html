<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-10-18 Sun 14:47 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux and Unix system programming</title>
<meta name="generator" content="Org mode" />
<meta name="description" content="Linux, unix and posix system programming"
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
<link href="theme/org-nav-theme.css" rel="stylesheet">
<script src="theme/org-nav-theme.js"></script>
<link rel="icon" href="favicon.ico" type="image/vnd.microsoft.icon" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Linux and Unix system programming</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8077dde">1. Unix System Programming focused on Linux</a>
<ul>
<li><a href="#org385e828">1.1. Overview</a>
<ul>
<li><a href="#orge63d5b7">1.1.1. Unix-like Operating Systems</a></li>
<li><a href="#orgdc49172">1.1.2. Components of Linux-based operating systems</a></li>
</ul>
</li>
<li><a href="#orgf45b797">1.2. Command Line Essentials</a>
<ul>
<li><a href="#orge74a6ab">1.2.1. Overview</a></li>
<li><a href="#org2720c02">1.2.2. Fundamentals</a></li>
<li><a href="#orgf9385b9">1.2.3. Creating files and directories from command line</a></li>
<li><a href="#orgf8e9fb8">1.2.4. Files and executables</a></li>
<li><a href="#org7511352">1.2.5. System information</a></li>
</ul>
</li>
<li><a href="#org504f18c">1.3. Widely used functions for strings and buffers in low level codes</a></li>
<li><a href="#orgc9a194a">1.4. Creating Portable Binaries for Linux / GLIBC Dependency Hell</a>
<ul>
<li><a href="#org21508d6">1.4.1. Overview</a></li>
<li><a href="#org5f8c31b">1.4.2. The GLIBC Problem</a></li>
<li><a href="#org52e26db">1.4.3. Solution 1 - via linking against older GLIBC</a></li>
<li><a href="#orgc63ca24">1.4.4. Solution 2 - via linking against MUSL libC</a></li>
<li><a href="#org775c0f4">1.4.5. Portable binary using Golang</a></li>
<li><a href="#org02e9b01">1.4.6. The GLIBC Problem</a></li>
<li><a href="#orgd3a48c4">1.4.7. Solution 1 - via linking against older GLIBC</a></li>
<li><a href="#org78584d9">1.4.8. Solution 2 - via linking against MUSL libC</a></li>
<li><a href="#org4e15465">1.4.9. Portable binary using Golang</a></li>
</ul>
</li>
<li><a href="#org75faa69">1.5. Fully Statically linked executables for embedded Linux systems</a>
<ul>
<li><a href="#orgcd81790">1.5.1. Overview</a></li>
<li><a href="#org6fc0f82">1.5.2. Project Files</a></li>
<li><a href="#orgc0f6071">1.5.3. Building and running</a></li>
</ul>
</li>
<li><a href="#orga03560c">1.6. Creating command line applications with CLI11 C++ Library</a>
<ul>
<li><a href="#org8a2ee1a">1.6.1. Overview</a></li>
<li><a href="#org5b9b7ea">1.6.2. Sample application with multiple sub-comamnds</a></li>
</ul>
</li>
<li><a href="#orgaca1bb4">1.7. System information via virtual file systems</a>
<ul>
<li><a href="#org3724c11">1.7.1. Overview</a></li>
<li><a href="#orgbae45dd">1.7.2. Sample Code</a></li>
<li><a href="#orgca04156">1.7.3. Running</a></li>
</ul>
</li>
<li><a href="#org95f6c94">1.8. Disk Space Usage on Linux and BSD-variants</a></li>
<li><a href="#orgbe9074b">1.9. Low level IO functions overview</a></li>
<li><a href="#orgea07ca1">1.10. Low level IO - open(), read(), write() syscall functions</a></li>
<li><a href="#orgd47c91a">1.11. Low level IO - creat()</a></li>
<li><a href="#orgb1afc89">1.12. Process Inputs, Outputs and States and PROCFS on Linux</a></li>
<li><a href="#org790b042">1.13. Information about file permissions, owner and group - fstat and stat syscalls</a>
<ul>
<li><a href="#org80ee7c7">1.13.1. Overview</a></li>
<li><a href="#org5bc547a">1.13.2. Sample code</a></li>
</ul>
</li>
<li><a href="#org72c0b14">1.14. Information about current process</a></li>
<li><a href="#org3eb2be7">1.15. Dynamic Loading Shared Libraries / dlopen() API</a>
<ul>
<li><a href="#org50d7658">1.15.1. Overview</a></li>
<li><a href="#org19d2959">1.15.2. GTK3/GTK2 GUI using dynamic loading - low level</a></li>
<li><a href="#org4836c66">1.15.3. GTK3/GTK2 GUI using dynamic loading - high level C++ wrapper</a></li>
</ul>
</li>
<li><a href="#org17fa151">1.16. Library calls hooking/interception with LD_PRELOAD</a>
<ul>
<li><a href="#orgdf1ce8e">1.16.1. Overview</a></li>
<li><a href="#org88f82a1">1.16.2. Sample code and experiment</a></li>
</ul>
</li>
<li><a href="#orgabc9aa4">1.17. Launching processes with exec and fork system-call wrappers</a></li>
<li><a href="#org8d8a81e">1.18. Reading subprocess output via Popen()</a></li>
<li><a href="#orgd1bacc9">1.19. Unix Pipes - Inter Process Communication</a></li>
<li><a href="#org35b5c12">1.20. Reading/Listings directory contents</a></li>
<li><a href="#org51b012c">1.21. Memory Mapped Files - mmap</a>
<ul>
<li><a href="#orgc8c57b1">1.21.1. Overview</a></li>
<li><a href="#orgbf80345">1.21.2. Example (C) - mmap for reading Windows PE32 files</a></li>
<li><a href="#orge23abe8">1.21.3. Example (C++) - mmap for reading Windows PE32 files</a></li>
<li><a href="#orgeb4eda4">1.21.4. Example (C++) - mmap for reading Windows PE32 with class</a></li>
</ul>
</li>
<li><a href="#orgfc480f9">1.22. Sockets - TCP/IP and Unix Domain Sockets</a>
<ul>
<li><a href="#orgb3ba086">1.22.1. Overview</a></li>
<li><a href="#orgf08383d">1.22.2. BSD Socket APIs</a></li>
<li><a href="#org5d950dc">1.22.3. Simple TCP/IP socket echo server</a></li>
<li><a href="#org3b4bf6e">1.22.4. Simple Unix-domain socket echo server</a></li>
</ul>
</li>
<li><a href="#org94d7d42">1.23. Sockets with IO Multiplexing [DRAFT]</a>
<ul>
<li><a href="#org43694b1">1.23.1. Overview</a></li>
<li><a href="#org0f196f9">1.23.2. Epoll() multiplexed IO API</a></li>
<li><a href="#org78a897f">1.23.3. Epoll() example - sample code</a></li>
</ul>
</li>
<li><a href="#org1372cc1">1.24. X11 - X Windows System</a>
<ul>
<li><a href="#orgd087564">1.24.1. Overview</a></li>
<li><a href="#org05c07d7">1.24.2. Further reading and references</a></li>
<li><a href="#org7f95cfe">1.24.3. X11 Uitilities</a></li>
<li><a href="#org629d1a1">1.24.4. X11 programming via Xlib</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-org8077dde" class="outline-2">
<h2 id="org8077dde"><span class="section-number-2">1</span> Unix System Programming focused on Linux</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org385e828" class="outline-3">
<h3 id="org385e828"><span class="section-number-3">1.1</span> Overview</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orge63d5b7" class="outline-4">
<h4 id="orge63d5b7"><span class="section-number-4">1.1.1</span> Unix-like Operating Systems</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
Unix-like operating system are a family of operating system based on
the AT&amp;T Unix operating system, developed in the 1970's by <a href="https://en.m.wikipedia.org/wiki/Ken_Thompson">Ken Thompson</a>, 
<a href="https://en.m.wikipedia.org/wiki/Dennis_Ritchie">Dennis Ritchie</a> and others. Later AT&amp;T licensed Unix to third-party
vendors, what lead to many proprietary Unix variants. 
</p>

<p>
<b>Some Unix-like operating systems are</b>
</p>

<p>
Desktop or Server:
</p>

<ul class="org-ul">
<li><span class="underline">Mac OSX</span> / Apple [Most Used]</li>

<li><span class="underline">Linux-based or GNU-Linux based</span> operating systems (Note: Linux is
not an operating system, it is just the kernel) 
<ul class="org-ul">
<li>Debian Linux</li>
<li>Ubuntu Linux</li>
<li>Fedora Linux</li>
<li>Centos Linux</li>
<li>Gentoo Linux</li>
<li>Arch   Linux</li>
<li>&#x2026; &#x2026; &#x2026;</li>
</ul></li>

<li><a href="https://en.m.wikipedia.org/wiki/FreeBSD">FreeBSD</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/NetBSD">NetBSD</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/OpenBSD">OpenBSD</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/DragonFly_BSD">DragonFly BSD</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Minix">Minix</a> - Open source small operating system created for teaching
about operating system concepts.</li>

<li><a href="https://en.m.wikipedia.org/wiki/Solaris_(operating_system)">Solaris</a> (from Sun Microsystems)</li>

<li><a href="https://en.m.wikipedia.org/wiki/Z/OS">z/OS</a> / IBM - Unix-variant for mainframes.</li>

<li>AIX / IBM</li>

<li><a href="https://en.m.wikipedia.org/wiki/HP-UX">HP-UX</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/IRIX">IRIX</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Xenix">Xenix</a></li>
</ul>

<p>
Mobile (touch devices): 
</p>

<ul class="org-ul">
<li><b>Android</b> (Linux-based OS, but without GPL on the userland).
<ul class="org-ul">
<li>Unlike Desktop Linux distributions, Android uses the C runtime
library <a href="https://en.wikipedia.org/wiki/Bionic_(software)">bionic</a>, derived from BSD, instead of GLIBC. Other
significant differences is that Android does not uses <a href="https://en.wikipedia.org/wiki/X_Window_System">X11</a> (X
Windows System) as graphical user interface, instead the
operating system uses the framebuffer directly. Shell command
line tools, such as mv, ls, cp, and others, come from <a href="http://landley.net/toybox/about.html">toybox</a>
(BSD license), instead of <a href="https://busybox.net/about.html">busybox</a> or other GNU tools.</li>
</ul></li>

<li>iOS / Apple</li>
</ul>

<p>
Embedded Systems: 
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/QNX">QNX</a></li>

<li>Linux (called Embedded-Linux)</li>

<li><a href="https://en.m.wikipedia.org/wiki/Minix">Minix</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/NetBSD">NetBSD</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/LynxOS">LynxOS</a></li>
</ul>


<p>
<b>Common Features of Unix-like Operating Systems</b>
</p>


<p>
Nowadays, there may be many difference between Unix-like operating
systems, but they still have the following features in common: 
</p>

<ul class="org-ul">
<li><span class="underline">Command line shell</span>
<ul class="org-ul">
<li>In the early days of computing, the shell or command line
interpreter was the primary means of interaction between users
and computers. A unix shell is used both as a scripting language
and as an interactive command line interpreter for
user interaction, launching processes, launching daemons (aka
services), manipulating files and controlling the operating system.</li>

<li>Common Unix shells:
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Almquist_shell">ash</a>  (Almiquistt Shell)</li>
<li><a href="https://en.wikipedia.org/wiki/C_shell">c-shell</a></li>
<li><a href="https://en.wikipedia.org/wiki/Debian_Almquist_shell">dash</a> (Debian Almiquist Shell)</li>
<li>tcsh</li>
<li>ksh  (Korn Shell)</li>
<li>Tcl</li>
<li><a href="https://en.wikipedia.org/wiki/Bash_(Unix_shell)">bash</a> (Bourn Shell) [Most used, most popular]</li>
<li>zsh                [Most popular]</li>
<li>fish               [Most popular]</li>
</ul></li>
</ul></li>

<li><span class="underline">Command Line Applications</span> (Command-Line Centric)
<ul class="org-ul">
<li>mv; cp; rm; mkdir; ls; telnet; ssh; &#x2026; and so on.</li>
</ul></li>

<li><span class="underline">Terminal Emulation</span>
<ul class="org-ul">
<li>Early Unix-like operating systems only ran in big and expensive
<span class="underline">mainframe</span> computers that were simultaneously shared by many
users via physical dumb terminals attached through serial cables
(RS232 - UART). The first terminals were <span class="underline">teletype printers</span> (tty)
where users could type commands and the teletype printer would
print the the command output in a paper type. Later, dumb CRT
(Cathode-Ray Tube) terminals were adopted. Those machines were
comprised of a keyboard attached to a CRT video display as
single unit attached to a mainframe via a serial cable. Physical
Terminals, such as the once popular <a href="https://en.wikipedia.org/wiki/VT100">DEC VT100</a>, are long gone,
but the are still <span class="underline">emulated</span> by unix-based operating systems. For
instance, most of those systems provide the following types of
terminal emulation:</li>

<li>=&gt; <i>Virtual console</i> =&gt; Kernel built-in terminal emulator, which can
be accessed without any graphical user interface by typing
Ctrl + Alt + F1, Ctrl + Alt + F[N] on Linux. BSD has different
keybinds for the <i>virtual console</i>. Note: Mac-OSX does not have
virtual console.</li>

<li>=&gt; <i>Graphical Terminal Emulator</i> =&gt; Example: Xterm (X11); Gnome
Terminal; Terminator; iTerm (MacOSX).</li>

<li>=&gt; <i>Serial console</i> =&gt; Allows accessing a command line shell
(bash, for instance) through a serial cable (RS232 /
UART). Serial console is still used for accessing servers or
embedded systems.</li>
</ul></li>
</ul>


<ul class="org-ul">
<li><span class="underline">Text-centric</span>

<ul class="org-ul">
<li>Unix-like operating system has the tradition of storing
configuration in human-readable text files, instead of binary files as
Windows does. The benefits of using text files are the better
reusability, searchability and reproducibility of
configurations. All that one needs to reproduce the configuration
in another machine is to copy the configuration file.</li>

<li>Many applications also use text for configuration instead of
graphical user interfaces.</li>

<li>Examples:
<ul class="org-ul">
<li>Linux-based operating system store many of their configuration
as text files in the '/etc' directory. For instance, the file
'/etc/fstab' controls the disk partitions mounted during boot
time. As opposite to Unix-tradition, Windows and most of its
applications store configuration in the registry file which
is a binary file.</li>

<li>Applications such as bash, vi, emacs store configuration in
text files placed in default locations which are read during
the initialization.</li>
</ul></li>
</ul></li>

<li><span class="underline">POSIX Features</span> / <a href="https://en.m.wikipedia.org/wiki/POSIX">POSIX</a> - (Portable Operating System Interface) standard

<ul class="org-ul">
<li>POSIX System Calls
<ul class="org-ul">
<li>open(), read(), close() &#x2026;</li>
</ul></li>

<li>POSIX Functions encapsulating system calls 
<ul class="org-ul">
<li>open(), read(), close(), mmap(), dlopen(), dlclose() &#x2026;</li>
</ul></li>

<li>POSIX Threads (_PThreads_) - Thread C API</li>

<li>POSIX Shells</li>
</ul></li>

<li><span class="underline">BSD TCP/IP Sockets</span>  =&gt; TCP/IP networks were first implemented on Unix.</li>

<li><span class="underline">Hierarchical file system</span>
<ul class="org-ul">
<li>File system with paths like: '/' (root directory); '.' (dot) as
the current directory; '/home/user/data' (Linux);
'/home/Users/somthing' (MacOSX) and so on.</li>
</ul></li>

<li><span class="underline">Dynamic Link</span> (Symlink)
<ul class="org-ul">
<li>Allows file and directories to be accessed from other
directories as they were in that location.</li>
</ul></li>

<li><span class="underline">Virtual File Systems</span>
<ul class="org-ul">
<li>Many unix-like operating system provide virtual file-system
(in-memory file systems) which exposes kernel and system
information to user-space applications as human-readable text
files. For instance, Linux has the <span class="underline">PROCFS</span> (/proc directory) file
system which exposes information about all the running
processes. PROCFS also has the file <span class="underline">/proc/cpuinfo</span> which contains
information about the current machine microprocessor, such as:
CPU cores; number of hyper threads; CPU features and
capabilities.</li>
</ul></li>

<li><span class="underline">Everything is a file</span> (or better everything is a file descriptor)
<ul class="org-ul">
<li>Many operating such as reading/writing sockets, pipes and so on,
use the same read/write system-calls for file descriptors.</li>
<li>Hardware represented as device-files</li>
<li>Kernel exposes information as text files (Linux)</li>
<li>Disk partitions are represented as files /dev/sda, /dev/sdb1,
/dev/sdb2 &#x2026;</li>
<li>see: <a href="https://en.wikipedia.org/wiki/File_descriptor">file descriptor</a></li>
</ul></li>

<li><span class="underline">Device Files</span> (a.k.a device nodes)
<ul class="org-ul">
<li>Device files are pseudo-files created in virtual file systems
which allows user-space applications to interact with the
<span class="underline">hardware peripherals</span> by using reading and writing system-calls
or just by reading and writing files. This feature is
particularly important for industrial and embedded system
applications as it allows reading sensor data, such as ADC  -
Analog-To-Digital Converters or digital input, just by reading
files and controlling actuators, such as motors, solenoids or
valves just by writing to files.</li>

<li>Note A: On Linux-based, operating systems, most device files are
in the virtual file systems <span class="underline">devfs</span> (/dev) and and <span class="underline">sysfs</span> (/sys)
directory.</li>

<li>Note B: Not all device files are associated to real hardware
devices. The device-files /dev/null, /dev/zero, /dev/random,
/dev/urandom, /dev/kmsg, /dev/tty0 are not associated to any
real hardware.</li>

<li>Example 1: It allows user-space application to read and write
from/to serial port devices by just reading or writing to the
device file /dev/ttyS1, /dev/ttyUSB0, &#x2026;</li>

<li>Example 2: In single-board computers SBCs (embedded systems)
such as Beagle Bone Black or Raspberry PI, both which contains
SOC (System-On-Chip) embedded processors, it is possible to
control GPIOs (General Purpose IO) which are digital IOs, and
consequently any device attached to them, such as lights, LEDs,
motors or valves, just by writing to the corresponding GPIO
device file (/sys/class/gpio/gpio10/value). By writing 1 to the
this file, the LED is turned on, by writing 0, the LED is turned
off. The device-file feature allows controlling the hardware
with any programming language, including, shell scripts, python,
ruby, standard C++ (without volatile and embedded bare-metal
restrictions) and so on.</li>

<li>Common Linux Device Files associated to hardware 
<ul class="org-ul">
<li><span class="underline">/dev/mem</span>
<ul class="org-ul">
<li>=&gt; Device file that represents the physical RAM
memory. It can be used for reading MMIO (Memory-Mapped IO)
devices.</li>
</ul></li>
<li>/dev/lp0, /dev/lp1 =&gt; Parallel ports</li>
<li>/dev/ttyS0, /dev/ttyS1, &#x2026; =&gt; Serial Ports</li>
<li>/dev/ttyUSB0, /dev/ttyUSB1, &#x2026; =&gt; USB-to-serial converters such as FTDI</li>
<li>/dev/sys/class/gpio/gpio10/export =&gt; GPIO / General Purpose Digital IO</li>
<li>/dev/sys/class/gpio/gpio10/value</li>
<li>&#x2026; &#x2026; &#x2026;</li>
<li>/dev/input/mice =&gt; Binary file contains mouse position, mouse
buttons and and so on. The mouse position can be obtained by
reading this file, without any special API.</li>
<li>/dev/fb0, /dev/fb1 &#x2026; =&gt; <a href="https://www.kernel.org/doc/Documentation/fb/framebuffer.txt">Framebuffer</a> - allows user-space
applications to control the graphics card and draw on the
screen by just writing to a file. The framebuffer is the
lowest level GUI in Linux kernel. Most embedded linux
applications draw directly on framebuffer without X11
(X-Windows System).</li>
</ul></li>

<li>Linux Device Files not associated to hardware:
<ul class="org-ul">
<li><span class="underline">/dev/kmsg</span> 
<ul class="org-ul">
<li>=&gt; charavter device file containing kernel messages. The
file is read by the command line tool '$ dmesg'.</li>
</ul></li>
<li>/dev/stdout =&gt; Console stdout</li>
<li>/dev/stdin  =&gt; Console stdin</li>
<li>/dev/stderr =&gt; Console stderr</li>
<li>/dev/random =&gt; File which generates random numbers</li>
<li>/dev/urandom =&gt; File which generates random numbers</li>
<li>/dev/null =&gt; File used for discarding stdout or stderr of
command line applications.</li>
<li>/dev/zero =&gt; Generate zero-values</li>
<li>/dev/null</li>
</ul></li>
</ul></li>
</ul>

<p>
<b>Quotes</b> 
</p>


<ul class="org-ul">
<li>Ken Thompson</li>
</ul>

<blockquote>
<p>
I think the major good idea in Unix was its clean and simple
interface: open, close, read, and write.
</p>
</blockquote>

<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/Doug_McIlroy">Doug Mcllroy</a> - Creator of Unix Pipes</li>
</ul>

<blockquote>
<p>
This is the Unix philosophy: Write programs that do one thing and
do it well. Write programs to work together. Write programs to
handle text streams, because that is a universal interface.
</p>
</blockquote>


<ul class="org-ul">
<li>Brian Kernighan</li>
</ul>

<blockquote>
<p>
Unix has, I think for many years, had a reputation as being
difficult to learn and incomplete. Difficult to learn means that
the set of shared conventions, and things that are assumed about
the way it works, and the basic mechanisms, are just different from
what they are in other systems.
</p>
</blockquote>

<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/Rob_Pike">Rob Pike</a> - Member of the Unix design team; creator of GO (Golang)
and Plan-9 operating system.</li>
</ul>

<blockquote>
<p>
Even though the UNIX system introduces a number of innovative
programs and techniques, no single program or idea makes it work
well. Instead, what makes it effective is the approach to
programming, a philosophy of using the computer. Although that
philosophy can't be written down in a single sentence, at its
heart is the idea that the power of a system comes more from the
relationships among programs than from the programs
themselves. Many UNIX programs do quite trivial things in
isolation, but, combined with other programs, become general and
useful tools.
</p>
</blockquote>


<p>
<b>See also</b> 
</p>

<p>
General Unix Concepts: 
</p>

<ul class="org-ul">
<li><a href="https://en.m.wikipedia.org/wiki/Unix">Unix concept</a></li>

<li><a href="http://www.catb.org/~esr/writings/taoup/">Book: The Art of Unix Programming</a> - Eric Raymond 
<ul class="org-ul">
<li>'The Art of Unix Programming attempts to capture the engineering
wisdom and philosophy of the Unix community as it's applied
today — not merely as it has been written down in the past, but
as a living "special transmission, outside the scriptures"
passed from guru to guru. Accordingly, the book doesn't focus so
much on "what" as on "why", showing the connection between Unix
philosophy and practice through case studies in widely available
open-source software.'</li>
</ul></li>

<li><a href="https://en.m.wikipedia.org/wiki/Unix-like">Unix-like operating systems</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/POSIX">POSIX - Portable Operating System Interface</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Unix_philosophy">Unix philosophy</a></li>

<li><a href="https://en.wikipedia.org/wiki/Unix_shell">Unix Shell Scripting</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Symbolic_link">Symbolic Link / symlink</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Pipeline_(Unix)">Pipeline, Pipes - IPC (Inter Process Communication)</a></li>

<li><a href="https://www.bottomupcs.com/file_descriptors.xhtml">Unix File Descriptors</a></li>

<li><a href="https://en.wikipedia.org/wiki/File_descriptor">File Descriptors</a></li>

<li><a href="https://www.cs.uic.edu/~jbell/CourseNotes/OperatingSystems/12_FileSystemImplementation.html">Operating Systems - File System Implementation</a></li>
</ul>

<p>
Papers and mail lists: 
</p>

<ul class="org-ul">
<li><a href="https://people.eecs.berkeley.edu/~brewer/cs262/unix.pdf">The UNIX Time Sharing System {PDF}</a> - Dennis M. Ritchie and Ken Thompson - Bell Laboratories</li>

<li><a href="https://www.usenix.org/legacy/publications/library/proceedings/usenix03/tech/freenix03/full_papers/appavoo/appavoo_html/node18.html">Files, file descriptors, and name space</a></li>

<li><a href="https://yarchive.net/comp/linux/everything_is_file.html">Linux kernel mail list discussion - Everything is a file</a></li>
</ul>

<p>
Usage of <span class="underline">Linux Device Files</span> for controlling hardware (reading Sensors
and manipulating actuators):
</p>

<ul class="org-ul">
<li>/dev/mem -  <a href="https://stackoverflow.com/questions/12040303/how-to-access-physical-addresses-from-user-space-in-linux">memory - How to access physical addresses from user space in Linux? - Stack Overflow</a></li>

<li>/dev/mem - <a href="https://elinux.org/EBC_GPIO_via_mmap">EBC GPIO via mmap - eLinux.org</a></li>

<li>/dev/mem - <a href="https://github.com/tchebb/memdump">GitHub - tchebb/memdump: A simple /dev/mem dumper for Linux</a></li>

<li>/dev/mem - <a href="https://man7.org/linux/man-pages/man4/kmem.4.html">kmem(4) - Linux manual page</a></li>

<li><a href="https://lwn.net/Articles/147901/">Who needs /dev/kmem? - LWN.net</a></li>

<li><a href="https://unix.stackexchange.com/questions/101759/difference-between-device-file-and-device-drivers">Difference between Device file and device drivers</a></li>

<li><a href="http://ibgwww.colorado.edu/~lessem/psyc5112/usail/peripherals/devices/devintro.html">Introduction to device drivers and device nodes</a></li>

<li><a href="https://thehackerdiary.wordpress.com/2017/04/21/exploring-devinput-1/">The hacker diary - exploring /dev/input</a> =&gt; Shows how to read the
device file /dev/input/mice which contains mouse information such
as position and buttons state.</li>

<li><a href="https://www.ics.com/blog/how-control-gpio-hardware-c-or-c">How to Control GPIO Hardware from C or C++</a>
<ul class="org-ul">
<li>Note: It only works in PCs with <span class="underline">industrial IO cards</span> or systems
with SOC processors (System-On-Chip) with GPIO devices; SBC -
Single Board Computers, which are PCBs - printed circuit boards
containin SOC microprocessors or MCU - Microcontrollers and all
necessary supporting ICs (Integrated Circuits) such as RAM
memory chips; flash memory chips; voltage regulators; USB
connectors; &#x2026;</li>
</ul></li>

<li><a href="https://blog.mbedded.ninja/programming/operating-systems/linux/linux-serial-ports-using-c-cpp/">Linux Serial Ports Using C/C++</a></li>

<li><a href="https://stackoverflow.com/questions/6947413/how-to-open-read-and-write-from-serial-port-in-c">How to open, read, and write from serial port in C?</a></li>

<li><a href="https://www.iot-programmer.com/index.php/books/22-raspberry-pi-and-the-iot-in-c/chapters-raspberry-pi-and-the-iot-in-c/57-raspberry-pi-and-the-iot-in-c-sysfs-the-linux-way-to-gpio?start=1">Raspberry Pi And The IoT In C - SYSFS The Linux Way To GPIO</a></li>
</ul>


<p>
Terminal Emulation and Serial Console
</p>

<ul class="org-ul">
<li><a href="https://www.ttwin.com/blog/270-history-terminal-emulation">A Brief History of Terminal Emulation</a></li>

<li><a href="https://en.wikipedia.org/wiki/VT100">DEC VT100 CRT Terminal</a></li>

<li><a href="https://en.wikipedia.org/wiki/Computer_terminal">Computer Terminal</a></li>

<li><a href="https://www.kernel.org/doc/html/v4.15/admin-guide/serial-console.html">Linux Kernel Docs / Linux Serial Console</a></li>

<li><a href="https://www.tldp.org/HOWTO/Remote-Serial-Console-HOWTO/intro-why.html">Remote Serial Console HOWTO Prev / Chapter 1. Introduction</a></li>

<li><a href="https://wiki.archlinux.org/index.php/Working_with_the_serial_console">Arch Linux / Working with the serial console</a></li>

<li><a href="https://elinux.org/Serial_console">Elinux - Serial Console</a></li>

<li><a href="https://bootlin.com/doc/legacy/serial-drivers/linux-serial-drivers.pdf">Bootlin - Linux Serial Driver</a></li>

<li><a href="https://developer.toradex.com/knowledge-base/how-to-disable-enable-debug-messages-in-linux">Configuring Serial Port Debug Console (Linux/U-Boot)</a></li>

<li><a href="https://wiki.alpinelinux.org/wiki/Enable_Serial_Console_on_Boot">Alpine Linux - Enable Serial Console</a></li>

<li><a href="https://www.linuxjournal.com/article/7206">Linux Serial Consoles for Servers and Clusters</a></li>

<li><a href="https://roll.urown.net/server/serial-console.html">Roll Your Own Network / Serial Console</a> (for servers, data-centers)</li>
</ul>

<p>
Plan 9 Operating System 
</p>

<ul class="org-ul">
<li><a href="https://css.csail.mit.edu/6.824/2014/papers/plan9.pdf">Plan 89 from Bell Labs</a> [PAPER] - Ken Thompson, Rob Pike, Dave Presotto, and others.</li>

<li><a href="https://www.cs.kent.ac.uk/people/staff/srk21/research/papers/kell19unix-personal.pdf">Unix, Plan 9 and the Lurking Smalltak</a> [PAPER]</li>

<li><a href="https://woozle.org/papers/plan9.html">Making Unix a little more Plan9-like</a></li>

<li><a href="https://wiki.installgentoo.com/wiki/Plan_9">Plan 9 - Gentoo Wiki</a></li>

<li><a href="http://www.catb.org/esr/writings/taoup/html/plan9.html">Plan 9: The Way the Future Was - Chapter 20. Futures</a></li>

<li><a href="https://www.slideshare.net/anantn/unix-plan9-from-bell-labs?qid=024d0f21-1e4b-4414-91a8-2d7d8a88ebba&amp;v=&amp;b=&amp;from_search=2">Plan 9 - from Bell Labs - Unix++ Anyone?</a></li>

<li><a href="http://groups.di.unipi.it/~nids/docs/the_plan-9_effect.html">The Plan-9 Effect or why you should not fix it if it ain't broken</a></li>

<li><a href="https://www.slideshare.net/anantn/glendix-the-why-and-the-how?qid=024d0f21-1e4b-4414-91a8-2d7d8a88ebba&amp;v=&amp;b=&amp;from_search=30">Glendix - A Plan 9/Linux Distribution</a></li>

<li><a href="https://www.cs.cmu.edu/~davide/p9.html">Dr. David A. Eckhardt &#x2013; Plan 9</a></li>

<li><a href="https://www.slideshare.net/jserv/plan-9-not-only-a-better-unix?qid=cab7305a-e78c-44bb-8b7f-88925f3717b4&amp;v=&amp;b=&amp;from_search=17">Plan 9: Not (Only) A better UNIX</a> - Jim Huang</li>

<li><a href="https://www.slideshare.net/twopoint718/rc-the-plan-9-shell?qid=cab7305a-e78c-44bb-8b7f-88925f3717b4&amp;v=&amp;b=&amp;from_search=18">Rc - The Plan 9 Shell</a></li>

<li><a href="https://www.slideshare.net/oraccha/plan-9">Plan-9 from the outer space</a> (Presentation, In Japanese)</li>

<li><a href="https://9p.io/wiki/plan9/Unix_to_Plan_9_command_translation/index.html">UNIX to Plan 9 command translation</a></li>

<li><a href="https://docs.huihoo.com/plan9/Plan9.pdf">The Unix Spirit set Free: Plan 9 from Bell Labs</a></li>

<li><a href="http://fqa.9front.org/fqa0.html">Introduction to Plan 9</a></li>

<li><a href="https://sigkill.dk/writings/guides/plan_9_tools.html#running-plan-9-userland-tools-on-unix">Running Plan 9 Userland Tools On Unix</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgdc49172" class="outline-4">
<h4 id="orgdc49172"><span class="section-number-4">1.1.2</span> Components of Linux-based operating systems</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
<b>Components of a Linux-based Operating System</b> 
</p>

<ul class="org-ul">
<li>Boot Loader =&gt; Loads the operating system
<ul class="org-ul">
<li>Examples:
<ul class="org-ul">
<li>Grub (Mostly used on Desktop)</li>
<li><a href="https://en.wikipedia.org/wiki/SYSLINUX">Syslinux</a> (Mostly used for booting CDROM ISO images, Linux
Live CDs)</li>
</ul></li>
</ul></li>

<li><b>Linux Kernel</b>
<ul class="org-ul">
<li>Maintainer: Linux Foundation</li>
</ul></li>

<li>CRT - C-Runtime Library
<ul class="org-ul">
<li>Encapsulates kernel system-calls and basic services as C APIs
for user-space applications.</li>
<li>Example:
<ul class="org-ul">
<li>GLIBC (GNU C-library, most used C library by Linux Desktop
and server distributions). Maintained by: FSF - Free Software
Foundation.</li>
<li>Bionic - CRT library used by Android.</li>
<li>MUSL - CRT library used for embedded systems and static linking.</li>
</ul></li>
</ul></li>

<li>User-space utilities

<ul class="org-ul">
<li>Shell - command line interpreter.
<ul class="org-ul">
<li>ASH</li>
<li>Bash</li>
<li>ZSH</li>
<li>Fish</li>
</ul></li>

<li>Basic Command Line Tools (ls, mv, pwd, ln, rm, file, &#x2026;)
<ul class="org-ul">
<li>Standalone tools (GNU)</li>
<li>Busybox =&gt; Is a single binary containing all command line
tools as sub-commands. Busybox is widely used on
Embedded-Linux systems.</li>
</ul></li>

<li>GUI - Graphical User Interface Stack (Not part of Kernel) - all
GUI applications are built on top of kernel <span class="underline">framebuffer</span>.
<ul class="org-ul">
<li>X11 - X Windows System</li>
<li>GTK - Gimp Toolkit</li>
<li>QT</li>
</ul></li>

<li>Package Managers
<ul class="org-ul">
<li>Examples:
<ul class="org-ul">
<li>DPKG (Debian)</li>
<li>RPM (Read-Hat Package Manager) =&gt; Used by Fedora.</li>
<li>Pacman =&gt; Arch Linux Distribution</li>
<li>Portage =&gt; Gentoo Distribution</li>
</ul></li>
</ul></li>
</ul></li>
</ul>


<p>
<b>Components of a Embedded Linux System</b> 
</p>

<ul class="org-ul">
<li><span class="underline">Cross Compiler Toolchain</span>: Mostly GCC - GNU C Compiler
<ul class="org-ul">
<li>Note: The Linux Kernel uses many C proprietary extensions of
GCC compiler, therefore it is almost impossible to compile the
kernel using any other compiler.</li>
</ul></li>

<li><span class="underline">Boot Loader</span> =&gt; Loads the operating system 
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Das_U-Boot">U-Boot</a> (Most popular)</li>
<li><a href="https://en.wikipedia.org/wiki/Barebox">Barebox</a></li>
<li><a href="https://en.wikipedia.org/wiki/RedBoot">RedBoot</a></li>
<li><a href="https://en.wikipedia.org/wiki/Yaboot">Yaboot</a></li>
</ul></li>

<li><span class="underline">Linux Kernel</span> (GPL v2 License)
<ul class="org-ul">
<li>Among other-things, the kernel provides: virtual memory
management; processes; kernel-space (native) threads; kernel
modules (device drivers) API and many other essential
features.</li>
</ul></li>

<li><span class="underline">CRT - C Runtime Library</span>
<ul class="org-ul">
<li>uLibC</li>
<li>MUSL</li>
<li>Bionic (Android C library)</li>
<li>GLIBC</li>
</ul></li>

<li><span class="underline">User-Space Utilities</span>

<ul class="org-ul">
<li><a href="https://busybox.net/about.html">busybox</a> (GPL v2 License) - Single binary executable containing
many common unix command line utitlities in a single
executable, such as: unix shell, ls, mv, cp, rm, zip, unzip, &#x2026; and so
on. 
<ul class="org-ul">
<li>"BusyBox combines tiny versions of many common UNIX utilities
into a single small executable. It provides replacements for
most of the utilities you usually find in GNU fileutils,
shellutils, etc. The utilities in BusyBox generally have
fewer options than their full-featured GNU cousins; however,
the options that are included provide the expected
functionality and behave very much like their GNU
counterparts. BusyBox provides a fairly complete environment
for any small or embedded system."</li>
</ul></li>

<li><a href="http://landley.net/toybox/about.html">toybox</a> (BSD License) =&gt; Used on Android. 
<ul class="org-ul">
<li>"Toybox combines many common Linux command line utilities
together into a single BSD-licensed executable. It's simple,
small, fast, and reasonably standards-compliant (POSIX-2008
and LSB 4.1). Toybox's main goal is to make Android
self-hosting by improving Android's command line utilities so
it can build an installable Android Open Source Project image
entirely from source under a stock Android system. After a
talk at the 2013 Embedded Linux Conference explaining this
plan (outline, video), Google merged toybox into AOSP and
began shipping toybox in Android Mashmallow."</li>
</ul></li>
</ul></li>

<li><span class="underline">BSP - Board Support Package</span>

<ul class="org-ul">
<li>Device drivers or kernel modules provided by SOC
(System-On-Chip) manafucaturer. Most device drivers maps
on-board peripherals, such as UART (serial communication
device); GPIO - General Purporse IO; CAN - Controller Area
Network or ADC - Analog-To-Digital Converter, to device files
which allows user-space applications to control the hardware by
just reading and writing files.</li>

<li>The device-files feature allows using <span class="underline">standard C or C++</span> for
interacting the aforementioned peripherals and any physical
devices attached to them such as pumps, electric motors,
, valves, sensors, accelerometers or gyroscopes. The
device-file feature also allows controling the hardware with
any scripting language such as: ruby, python, unix shell script
(bash, ash, sh, &#x2026;) &#x2026;</li>
</ul></li>

<li><span class="underline">GUI - Graphical User Interface</span>
<ul class="org-ul">
<li>Framebuffer - Linux Kernel Device file which allows user-space
applications to control graphical display.</li>
<li>In-house GUI on top framebuffer (Lowest level)</li>
<li>SDL (LGPL) - <a href="http://www.libsdl.org/">http://www.libsdl.org/</a> - Library that came from Game Development.</li>
<li>QT on top of framebuffer</li>
<li>X11 - X Windows System (Rarely used, too heavy.)</li>
</ul></li>
</ul>

<p>
<b>See</b> 
</p>

<ul class="org-ul">
<li><a href="https://elinux.org/DirectFB">Direct FB</a> - Elinux</li>

<li><a href="https://doc.qt.io/qt-5/embedded-linux.html">QT For Embedded Linux</a> (QT Company)</li>

<li><a href="https://doc.qt.io/archives/qt-4.8/qt-embedded-displaymanagement.html">Qt for Embedded Linux Display Management</a></li>

<li><a href="https://bootlin.com/blog/building-a-linux-system-for-the-stm32mp1-enabling-qt5-for-graphical-applications/">Building a Linux system for the STM32MP1: enabling Qt5 for graphical applications - Bootlin's blog</a></li>

<li><a href="https://elinux.org/images/6/64/Choosing-embedded-graphical-libraries.pdf">Choosing Embedded Graphical Libraries</a></li>

<li><a href="https://itnext.io/top-five-libraries-for-creating-gui-on-embedded-linux-5ce03903be32">Top Five Libraries for creating GUI on Embedded Linux | by Kevin Muhuri | ITNEXT</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgf45b797" class="outline-3">
<h3 id="orgf45b797"><span class="section-number-3">1.2</span> Command Line Essentials</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-orge74a6ab" class="outline-4">
<h4 id="orge74a6ab"><span class="section-number-4">1.2.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
Useful reminder of common built-in command line applications for many
unix-like operating systems, including Linux-distros; BSD-variants and
MacOSX.
</p>
</div>
</div>
<div id="outline-container-org2720c02" class="outline-4">
<h4 id="org2720c02"><span class="section-number-4">1.2.2</span> Fundamentals</h4>
<div class="outline-text-4" id="text-1-2-2">
<ul class="org-ul">
<li>=&gt; Change current prompt (works for Bash and ZSH shells)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ export <span class="org-variable-name">PS1</span>=<span class="org-string">" $ &gt;&gt; "</span>

$ &gt;&gt; command typed by user  
output line 0 
output line 1 
... ... ... 
output line N-1
</pre>
</div>

<ul class="org-ul">
<li><b>pwd</b> =&gt; Get current working directory</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ pwd
/home/mxpkf8/Downloads
</pre>
</div>

<ul class="org-ul">
<li><b>cd</b> - Change the current directory</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ cd /Applications <span class="org-comment-delimiter"># </span><span class="org-comment">OSX </span>
$ cd ~/Downloads 
$ cd /home/user/Downloads 
$ cd /Users/user/Downloads

<span class="org-comment-delimiter"># </span><span class="org-comment">Enter in Home directory: </span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">/Users/&lt;USER&gt; in Mac OSX </span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">/home/&lt;USER/ in Linux                 </span>
$ cd $<span class="org-variable-name">HOME</span> 
</pre>
</div>

<ul class="org-ul">
<li><b>ls</b> - List directory</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ls /

bin@   dev/  home/  lib64@       media/  opt/   root/  sbin@  sys/  usr/
boot/  etc/  lib@   lost+found/  mnt/    proc/  run/   srv/   tmp/  var/
</pre>
</div>

<p>
Mac OSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ls -l /System/Applications/Utilities/Terminal.app/Contents

total 32
-rw-r--r--   1 root  wheel  7998 Apr 17 22:57 Info.plist
drwxr-xr-x   3 root  wheel    96 May 27 20:40 MacOS
-rw-r--r--   1 root  wheel     8 Apr 17 22:57 PkgInfo
drwxr-xr-x  74 root  wheel  2368 May 27 20:30 Resources
drwxr-xr-x   3 root  wheel    96 Apr 17 22:57 _CodeSignature
-rw-r--r--   1 root  wheel   510 Apr 17 22:58 version.plist
</pre>
</div>

<ul class="org-ul">
<li><b>rm</b> - Delete files or directory</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Delete file </span>
$ rm file.txt 

<span class="org-comment-delimiter"># </span><span class="org-comment">Delete directory dir2 and all sub-directories of dir2 </span>
$ rm -rf ./dir1/dir2

<span class="org-comment-delimiter"># </span><span class="org-comment">Delete directory dir2 and all sub-directories of dir2 in verbose mode </span>
$ rm -rf -v ./dir1/dir2
</pre>
</div>

<ul class="org-ul">
<li><b>cat</b> - Display text file content</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cat /proc/uptime 
11960.35 36214.14

$ cat /proc/filesystems 
nodev   sysfs
nodev   tmpfs
nodev   bdev
nodev   proc
nodev   cgroup
nodev   cgroup2
.. ... ... ... 
... ... ... .. 
</pre>
</div>

<p>
Mac OSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ cat /System/Applications/Utilities/Terminal.app/Contents/Info.plist  

&lt;?xml <span class="org-variable-name">version</span>=<span class="org-string">"1.0"</span> <span class="org-variable-name">encoding</span>=<span class="org-string">"UTF-8"</span>?&gt;
&lt;!DOCTYPE plist PUBLIC <span class="org-string">"-//Apple//DTD PLIST 1.0//EN"</span> <span class="org-string">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span>&gt;
&lt;plist <span class="org-variable-name">version</span>=<span class="org-string">"1.0"</span>&gt;
&lt;dict&gt;
        &lt;key&gt;ATSApplicationFontsPath&lt;/key&gt;
        &lt;string&gt;Fonts&lt;/string&gt;
        &lt;key&gt;BuildMachineOSBuild&lt;/key&gt;
        &lt;string&gt;18A391024&lt;/string&gt;
  ... ...   ... ...   ... ...   ... ...   ... ...   ... ...   ... ... 
  ... ...   ... ...   ... ...   ... ...   ... ...   ... ...   ... ... 
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf9385b9" class="outline-4">
<h4 id="orgf9385b9"><span class="section-number-4">1.2.3</span> Creating files and directories from command line</h4>
<div class="outline-text-4" id="text-1-2-3">
<ul class="org-ul">
<li><b>mkdir</b> - Create directory (aka folder)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Create single directory/folder 'somedir' at current directory</span>
$ mkdir somedir

<span class="org-comment-delimiter"># </span><span class="org-comment">Create single directory/folder 'somedir' at /tmp path</span>
$ mkdir -p /tmp/somedir

<span class="org-comment-delimiter"># </span><span class="org-comment">Create directory-tree root-folder, root-folder/sub1 and root-folder/sub1/sub2 </span>
$ mkdir -p /Users/unix/root-folder/sub1/sub2

<span class="org-comment-delimiter"># </span><span class="org-comment">Create directory tree </span>
$ mkdir -p mydir/{subA,subB}/d1/d2

$ tree mydir
mydir
&#9500;&#9472;&#9472; subA
&#9474;&#160;&#160; &#9492;&#9472;&#9472; d1
&#9474;&#160;&#160;     &#9492;&#9472;&#9472; d2
&#9492;&#9472;&#9472; subB
    &#9492;&#9472;&#9472; d1
        &#9492;&#9472;&#9472; d2
</pre>
</div>

<ul class="org-ul">
<li><b>touch</b> - Create empty files:</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ touch file1.txt somefile.cpp CMakeLists.txt 
</pre>
</div>

<ul class="org-ul">
<li>Create multi-line file with echo</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ echo line1 &gt; file.txt
$ echo line1 &gt; file.txt
$ echo line3 &gt;&gt; file.txt

$ cat file.txt 
line1
line2
line3
</pre>
</div>

<ul class="org-ul">
<li>Create multi-line files with cat-EOF trick.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Create a file with some content </span>
$ cat &gt; script.sh &lt;&lt;EOF
<span class="org-sh-heredoc">#!/usr/bin/env sh </span>

<span class="org-sh-heredoc">echo " =&gt; Showing root directory"</span>
<span class="org-sh-heredoc">ls /</span>

<span class="org-sh-heredoc">EOF</span>

$ cat script.sh 
<span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/env sh </span>

<span class="org-builtin">echo</span> <span class="org-string">" =&gt; Showing root directory"</span>
ls /

$ sh script.sh 
 =&gt; Showing root directory
bin   dev  home  lib64       media  opt   root  sbin  sys  usr
boot  etc  lib   lost+found  mnt    proc  run   srv   tmp  var
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf8e9fb8" class="outline-4">
<h4 id="orgf8e9fb8"><span class="section-number-4">1.2.4</span> Files and executables</h4>
<div class="outline-text-4" id="text-1-2-4">
<ul class="org-ul">
<li><b>which</b> - Get path to executable in $PATH environment variable.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ which xdg-open
/usr/bin/xdg-open

$ which zsh
/usr/bin/zsh

$ which brave
/home/mxpkf8/Applications/brave/brave
</pre>
</div>

<ul class="org-ul">
<li><b>file</b> - Identify text or binary files by they "magic-number"
(uniquely identifying byte sequence)</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ file /usr/bin/bash
 /usr/bin/bash: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV)
 , dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2
 .. ... ... ... ... ... 

$ file vs_buildtools__80950065.1591646379.exe 
<span class="org-function-name">vs_buildtools__80950065.1591646379.exe</span>: PE32 executable (GUI) Intel 80386, for MS Windows
</pre>
</div>

<p>
Mac OSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ file /bin/zsh 
<span class="org-function-name">/bin/zsh</span>: Mach-O 64-bit executable x86_64

$ file $<span class="org-variable-name">HOME</span>/Desktop/Console 
<span class="org-function-name">/Users/unix/Desktop/Console</span>: MacOS Alias file

$ file /System/Applications/Utilities/Terminal.app/Contents/MacOS/Terminal
<span class="org-function-name">/System/Applications/Utilities/Terminal.app/Contents/MacOS/Terminal</span>: Mach-O 64-bit executable x86_64
</pre>
</div>


<ul class="org-ul">
<li>Open file with default system Application / <b>xdg-open</b> (Linux with
X11, BSD with X11); <b>open</b> (MacOSX)</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Open Desktop directory with default system file manager </span>
$ xdg-open $<span class="org-variable-name">HOME</span>/Desktop 

<span class="org-comment-delimiter"># </span><span class="org-comment">Open file image.png with default system image viewer </span>
$ xdg-open image.png 
</pre>
</div>

<p>
Mac OSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Open /Volumes directory with default system file manager (finder)</span>
$ open /Volumes 

<span class="org-comment-delimiter"># </span><span class="org-comment">Open file CmakeLists.txt with default system text editor </span>
$ open CMakeLists.txt 

$ open disk-image.dmg 
</pre>
</div>
</div>
</div>

<div id="outline-container-org7511352" class="outline-4">
<h4 id="org7511352"><span class="section-number-4">1.2.5</span> System information</h4>
<div class="outline-text-4" id="text-1-2-5">
<ul class="org-ul">
<li><b>uname</b> =&gt; Get Kernel Version</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ uname -a
Linux localhost.localdomain 5.6.6-300.fc32.x86_64 <span class="org-comment-delimiter">#</span><span class="org-comment">1 SMP Tue Apr 21 13:44:19 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span>
</pre>
</div>

<p>
Mac OSX Catalina: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ uname -a 
Darwin ghosts-iMac-Pro.local 19.5.0 Darwin Kernel Version 19.5.0: Tue May 26 20:41:44 PDT 2020; root:xnu-6153.121.2~2/RELEASE_X86_64 x86_64
</pre>
</div>

<ul class="org-ul">
<li><b>uptime</b> - Shows how long the machine is running.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Linux </span>
$ &gt;&gt; uptime
<span class="org-function-name">13</span>:43:36 up  2:22,  1 user,  load average: 1.31, 1.00, 0.99

<span class="org-comment-delimiter"># </span><span class="org-comment">Mac OSX</span>
<span class="org-function-name">13</span>:44  up  1:48, 2 users, load averages: 1.17 1.30 1.35
</pre>
</div>

<ul class="org-ul">
<li><b>whoami</b> - Show current user (Note: it also works on Windows)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ whoami
user_ml7abfg
</pre>
</div>

<ul class="org-ul">
<li><b>w</b> - Show logged users</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ w
 13:37:31 up  2:16,  1 user,  load average: 0.63, 0.87, 0.98
USER     TTY        LOGIN@   IDLE   JCPU   PCPU WHAT
<span class="org-function-name">user_ml7abfg</span>   :0        11:22   ?xdm?  43:26   0.00s /usr/libexec/gdm-x-session --register-session --
</pre>
</div>

<p>
Mac OSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ w 
<span class="org-function-name">13</span>:38  up  1:42, 2 users, load averages: 1.86 1.53 1.44
USER     TTY      FROM              LOGIN@  IDLE WHAT
unix     console  -                11:58    1:39 -
unix     s000     -                13:32       - w
</pre>
</div>

<ul class="org-ul">
<li><b>ps</b> - Show running processes</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ps -ef 
UID          PID    PPID  C STIME TTY          TIME CMD
root           1       0  0 11:21 ?        00:00:18 /usr/lib/systemd/systemd --switched-root --system --deserialize 29
root           2       0  0 11:21 ?        00:00:00 [kthreadd]
root           3       2  0 11:21 ?        00:00:00 [rcu_gp]
root           4       2  0 11:21 ?        00:00:00 [rcu_par_gp]
 ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 
 ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 
mxpkf8      2383    2382  0 11:22 ?        00:00:00 dbus-broker --log 4 --controller 9 --machine-
mxpkf8      2387    1946  0 11:22 ?        00:00:01 /usr/libexec/at-spi2-registryd --use-gnome-se
mxpkf8      2392       1  0 11:22 ?        00:00:00 /usr/bin/gpg-agent --sh --daemon --write-env-
mxpkf8      2393    2149  0 11:22 tty2     00:01:18 xfwm4
 ... ... ... ... ... ...  ... ... ... ... ... ... 
 ... ... ... ... ... ...  ... ... ... ... ... ... 
</pre>
</div>

<p>
Mac OSX:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ps -ef 
  UID   PID  PPID   C STIME   TTY           TIME CMD
    0     1     0   0 11:56AM ??         0:16.58 /sbin/launchd
    0    86     1   0 11:58AM ??         0:01.13 /usr/sbin/syslogd
    0    87     1   0 11:58AM ??         0:03.44 /usr/libexec/UserEventAgent (System)
    0    90     1   0 11:58AM ??         0:01.11 /System/Library/PrivateFrameworks/Uninstall.framework/Resources/uninstalld
    0    91     1   0 11:58AM ??         0:05.95 /usr/libexec/kextd
    0    92     1   0 11:58AM ??         0:09.31 /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/FSEvents.framework/Versions/A/Support/fseventsd
    0    93     1   0 11:58AM ??         0:00.32 /System/Library/PrivateFrameworks/MediaRemo
 ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 
 ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 
  501  6102     1   0  1:29PM ??         0:00.26 /System/Library/CoreServices/CoreServicesUIAgent.app/Contents/MacOS/CoreServicesUIAgent
  501  6813     1   0  1:45PM ??         0:01.12 /System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/CVMCompiler 2
    0  6795   319   0  1:32PM ttys000    0:00.06 login -pf unix
  501  6796  6795   0  1:32PM ttys000    0:00.38 -zsh
    0  6816  6796   0  1:46PM ttys000    0:00.01 ps -ef
</pre>
</div>

<ul class="org-ul">
<li><b>env</b> - Show environment variables</li>
</ul>

<p>
Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ env
<span class="org-variable-name">IMSETTINGS_INTEGRATE_DESKTOP</span>=yes
<span class="org-variable-name">SHELL</span>=/bin/bash
<span class="org-variable-name">SESSION_MANAGER</span>=local/unix:@/tmp/.ICE-unix/2149,unix/unix:/tmp/.ICE-unix/2149
<span class="org-variable-name">WINDOWID</span>=52428803
<span class="org-variable-name">COLORTERM</span>=truecolor
<span class="org-variable-name">XDG_CONFIG_DIRS</span>=/etc/xdg
<span class="org-variable-name">HISTCONTROL</span>=ignoredups
<span class="org-variable-name">XDG_MENU_PREFIX</span>=xfce-
 ... .. ... ..  ... .. ... ..  ... .. ...
 ... .. ... ..  ... .. ... ..  ... .. ...
</pre>
</div>

<p>
Mac OSX: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ env 

<span class="org-variable-name">TMPDIR</span>=/var/folders/jh/w00bgbps79bddlbqwkv31d9m0000gn/T/
<span class="org-variable-name">XPC_FLAGS</span>=0x0
<span class="org-variable-name">LaunchInstanceID</span>=433A53AA-AB93-4CF7-9700-BA15B57FFDAC
<span class="org-variable-name">TERM</span>=xterm-256color
<span class="org-variable-name">LANG</span>=en_US.UTF-8
 ... ... ... ... ... ... ... 
 ... ... ... ... ... ... ... 
<span class="org-variable-name">SHELL</span>=/bin/zsh
<span class="org-variable-name">HOME</span>=/Users/unix
<span class="org-variable-name">LOGNAME</span>=unix
<span class="org-variable-name">USER</span>=unix
<span class="org-variable-name">PATH</span>=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
<span class="org-variable-name">SHLVL</span>=1
<span class="org-variable-name">PWD</span>=/Volumes/data/unix-explore
<span class="org-variable-name">OLDPWD</span>=/Volumes/data
<span class="org-variable-name">PS1</span>= $&gt; 
<span class="org-variable-name">_</span>=/usr/bin/env
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org504f18c" class="outline-3">
<h3 id="org504f18c"><span class="section-number-3">1.3</span> Widely used functions for strings and buffers in low level codes</h3>
<div class="outline-text-3" id="text-1-3">
<p>
This section provides a recapitulation of the most widely used C
functions in low level code bases and legacy C codes. Those functions
are in the header &lt;string.h&gt; for C or &lt;cstring&gt; for C++.
</p>


<ul class="org-ul">
<li><span class="underline">strlen()</span> =&gt; Get length of null-terminated character array.
<ul class="org-ul">
<li>Docs: $ man strlen</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">size_t</span> <span class="org-function-name">strlen</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">s</span><span class="org-rainbow-delimiters-depth-1">)</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>39<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* st1 = <span class="org-string">"unix posix irix linux"</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>40<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* st2 = <span class="org-string">"bsd msdos"</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>41<span class="org-rainbow-delimiters-depth-1">]</span> strlen<span class="org-rainbow-delimiters-depth-1">(</span>st1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-1">)</span> 21

root <span class="org-rainbow-delimiters-depth-1">[</span>42<span class="org-rainbow-delimiters-depth-1">]</span> strlen<span class="org-rainbow-delimiters-depth-1">(</span>st2<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">unsigned</span> <span class="org-type">long</span><span class="org-rainbow-delimiters-depth-1">)</span> 9
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">strdup()</span> =&gt; Copy a C-string allocating the copy with malloc.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span>* <span class="org-function-name">strdup</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">s</span><span class="org-rainbow-delimiters-depth-1">)</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>39<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* st1 = <span class="org-string">"unix posix irix linux"</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>43<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span>* p_copy = strdup<span class="org-rainbow-delimiters-depth-1">(</span>st1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"unix posix irix linux"</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Release memory for heap-allocated string </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>47<span class="org-rainbow-delimiters-depth-1">]</span> free<span class="org-rainbow-delimiters-depth-1">(</span>p_copy<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">strcmp()</span> =&gt; Compare two C-strings null-terminated (terminated with
'\0' or 0x00 null char) array of characters. This function returns
0 if the two strings are equal.
<ul class="org-ul">
<li>Docs: $ man strcmp</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">strcmp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">s1</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">s2</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------- USAGE --------------------------//</span>
<span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">(</span> strmcp<span class="org-rainbow-delimiters-depth-2">(</span>STRING_A, STRING_B<span class="org-rainbow-delimiters-depth-2">)</span> == 0 <span class="org-rainbow-delimiters-depth-1">)</span>
    puts<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">" =&gt; Strings are equal"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">else</span> 
    puts<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">" =&gt; Strins are not equal"</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------ CERN's Root REPL Session -------// </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span> #<span class="org-type">include</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span>string.h<span class="org-rainbow-delimiters-depth-1">&gt;</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* s1 = <span class="org-string">"hello"</span>; 
root <span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* s2 = <span class="org-string">"world"</span>; 
root <span class="org-rainbow-delimiters-depth-1">[</span>3<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* s3 = <span class="org-string">"world C++17 c11 ADA spark"</span>; 
root <span class="org-rainbow-delimiters-depth-1">[</span>4<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* s4 = <span class="org-string">"hello"</span>; 

root <span class="org-rainbow-delimiters-depth-1">[</span>5<span class="org-rainbow-delimiters-depth-1">]</span> strcmp<span class="org-rainbow-delimiters-depth-1">(</span>s1, s2<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> -15

root <span class="org-rainbow-delimiters-depth-1">[</span>6<span class="org-rainbow-delimiters-depth-1">]</span> strcmp<span class="org-rainbow-delimiters-depth-1">(</span>s1, s3<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> -15

root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> strcmp<span class="org-rainbow-delimiters-depth-1">(</span>s1, s4<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">strcasecmp()</span> =&gt; Compare two string ignoring case sensitivity. This
function returns 0 if the string arguments are equal. Othewise, it
returns anything other than 0.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">strcasecmp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">string1</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">string2</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">---- USAGE ------------------------------------------// </span>

<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> strcasecmp<span class="org-rainbow-delimiters-depth-2">(</span>stringA, stringB<span class="org-rainbow-delimiters-depth-2">)</span> == 0 <span class="org-rainbow-delimiters-depth-1">)</span>
   printf<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">" Strings are equal Ok. \n"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">else</span> 
   printf<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">" Strings are not equal. \n"</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">----- CERN's ROOT REPL session ----------------------// </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Strings not equal </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>21<span class="org-rainbow-delimiters-depth-1">]</span> strcasecmp<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"app"</span>, <span class="org-string">"Application"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> -108

<span class="org-comment-delimiter">// </span><span class="org-comment">Strings are equal </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>22<span class="org-rainbow-delimiters-depth-1">]</span> strcasecmp<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"application"</span>, <span class="org-string">"Application"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

root <span class="org-rainbow-delimiters-depth-1">[</span>23<span class="org-rainbow-delimiters-depth-1">]</span> strcasecmp<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"AppLiCatION"</span>, <span class="org-string">"Application"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0
root <span class="org-rainbow-delimiters-depth-1">[</span>24<span class="org-rainbow-delimiters-depth-1">]</span> 
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">sprintf()</span> =&gt; Print string to a buffer. (Headers: &lt;cstdio&gt; in C++ or
&lt;stdio.h&gt; in C). Note: this function is vulnerable to buffer
overflow, if the data copied to the buffer is larger than its
size.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">sprintf</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-variable-name">str</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">format</span>, ...<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">---- CERN's ROOT REPL session ----------------------// </span>

root <span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buffer<span class="org-rainbow-delimiters-depth-1">[</span>300<span class="org-rainbow-delimiters-depth-1">]</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span> memset<span class="org-rainbow-delimiters-depth-1">(</span>buffer, 0x00, 300<span class="org-rainbow-delimiters-depth-1">)</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>4<span class="org-rainbow-delimiters-depth-1">]</span> sprintf<span class="org-rainbow-delimiters-depth-1">(</span>buffer, <span class="org-string">"The root of %d is equal to %f"</span>, 2, 2.0<span class="org-rainbow-delimiters-depth-1">)</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>5<span class="org-rainbow-delimiters-depth-1">]</span> buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>300<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"The root of 2 is equal to 2.000000\0\0\0\0\0\0\0\.... ... \0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" buffer = &lt;"</span> &lt;&lt; buffer &lt;&lt; <span class="org-string">"&gt;"</span> &lt;&lt; <span class="org-string">'\n'</span>;
buffer = <span class="org-rainbow-delimiters-depth-1">&lt;</span>The <span class="org-type">root</span> <span class="org-variable-name">of</span> 2 is equal to 2.000000<span class="org-rainbow-delimiters-depth-1">&gt;</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">snprintf()</span> =&gt; Print string to a buffer limiting the number of
characters that are copied to the buffer. The limitation of the
number characters copied helps protecting against buffer overflow
vulnerabilities.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">snprintf</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-variable-name">str</span>, <span class="org-type">size_t</span> <span class="org-variable-name">size</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">format</span>, ...<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">---- CERN's ROOT REPL session ----------------------------//</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buf<span class="org-rainbow-delimiters-depth-1">[</span>200<span class="org-rainbow-delimiters-depth-1">]</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span> memset<span class="org-rainbow-delimiters-depth-1">(</span>buf, <span class="org-string">'\0'</span>, 200<span class="org-rainbow-delimiters-depth-1">)</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">Initialize buffer</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>6<span class="org-rainbow-delimiters-depth-1">]</span> snprintf<span class="org-rainbow-delimiters-depth-1">(</span>buf, 10, <span class="org-string">"The square root of %f is equal to %.3f "</span>, 10.0, sqrt<span class="org-rainbow-delimiters-depth-2">(</span>10.0<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> 
root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> buf
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>200<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"The squar\0\0\0\0\0... ...\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>8<span class="org-rainbow-delimiters-depth-1">]</span> snprintf<span class="org-rainbow-delimiters-depth-1">(</span>buf, 25, <span class="org-string">"The square root of %f is equal to %.3f "</span>, 10.0, sqrt<span class="org-rainbow-delimiters-depth-2">(</span>10.0<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> 
root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> buf
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>200<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"The square root of 10.00\0\0\0...\0\0"</span>


root <span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span> snprintf<span class="org-rainbow-delimiters-depth-1">(</span>buf, 125, <span class="org-string">"The square root of %f is equal to %.3f "</span>, 10.0, sqrt<span class="org-rainbow-delimiters-depth-2">(</span>10.0<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> 
root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> buf
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>200<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"The square root of 10.000000 is equal to 3.162 \0\0\0..\0\0"</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">strcpy()</span> =&gt; Copy string 'src' parameter (null-terminated array of
characters) to a buffer.
<ul class="org-ul">
<li>Docs: $ man strcpy</li>
<li>Note: It is vulnerable to buffer
overflow, if the size of the string is bigger than the
buffer. This function is often used to for copying string literals
to a buffer.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span>* <span class="org-function-name">strcpy</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">char</span>*       <span class="org-variable-name">p_buffer</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to buffer (array of chars)</span>
             ,<span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">c_string_src</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">C-string </span>
           <span class="org-rainbow-delimiters-depth-1">)</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buffer<span class="org-rainbow-delimiters-depth-1">[</span>200<span class="org-rainbow-delimiters-depth-1">]</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span> buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>200<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0 ...... \0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> strcpy<span class="org-rainbow-delimiters-depth-1">(</span>buffer, <span class="org-string">"Hello world C++17 C++20 ADA Rust"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello world C++17 C++20 ADA Rust"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>12<span class="org-rainbow-delimiters-depth-1">]</span> buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>200<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello world C++17 C++20 ADA Rust\0\0\0\0\0\0\0 ... ... \0\0\0"</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">strncpy()</span> =&gt; Copy N characters from string to buffer.
<ul class="org-ul">
<li>Docs: $ man strncpy</li>
<li>Linux mapage: "The strcpy() function copies the string pointed
to by src, including the terminating null byte ('\0'), to the
buffer pointed to by dest.  The strings may not overlap, and the
destination string dest must be large enough to receive the
copy. Beware of buffer overruns!  (See BUGS.)"</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span>* <span class="org-function-name">strncpy</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">char</span>*       <span class="org-variable-name">dest</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to buffer </span>
             , <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">src</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">C-string (null-terminated) that will be copied </span>
             , <span class="org-type">size_t</span>      <span class="org-variable-name">n</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Number of chars (bytes) from src that will be copied</span>
             <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">---------- CERN's ROOT Repl Session ------------//</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>13<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buff1<span class="org-rainbow-delimiters-depth-1">[</span>30<span class="org-rainbow-delimiters-depth-1">]</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>14<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buff2<span class="org-rainbow-delimiters-depth-1">[</span>30<span class="org-rainbow-delimiters-depth-1">]</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>15<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* cstr = <span class="org-string">"Hello world C++17 embedded systems real time control systems"</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>16<span class="org-rainbow-delimiters-depth-1">]</span> buff1
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>30<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>17<span class="org-rainbow-delimiters-depth-1">]</span> buff2
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>30<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>18<span class="org-rainbow-delimiters-depth-1">]</span> strncpy<span class="org-rainbow-delimiters-depth-1">(</span>buff1, cstr, 10<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worl"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>19<span class="org-rainbow-delimiters-depth-1">]</span> buff1 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>30<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worl\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>20<span class="org-rainbow-delimiters-depth-1">]</span> strncpy<span class="org-rainbow-delimiters-depth-1">(</span>buff2, cstr, 25<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello world C++17 embedde"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>21<span class="org-rainbow-delimiters-depth-1">]</span> buff2
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>30<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello world C++17 embedde\0\0\0"</span>
</pre>
</div>


<ul class="org-ul">
<li><span class="underline">strcat()</span> =&gt; Manpage: "The strcat() function appends the src string
to the dest string, over‐ writing the terminating null byte ('\0')
at the end of dest, and then adds a terminating null byte.  The
strings may not overlap, and the dest string must have enough
space for the result.  If dest is not large enough, program
behavior is unpredictable; buffer overruns (aka buffer overflow)
are a favorite avenue for attacking secure program"

<ul class="org-ul">
<li>Note: This function is unsafe and can introduce buffer overflow
vulnerability if the size of the <span class="underline">src</span> string is not limited.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span> *<span class="org-function-name">strcat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-variable-name">dest</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">src</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------------- CERN Root REPL  ------------------//</span>
<span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">null_terminated_char_array1</span>= <span class="org-string">"C++1z KALMAN FILTER sensor fusion data"</span>;
<span class="org-type">char</span> <span class="org-variable-name">buffer1</span><span class="org-rainbow-delimiters-depth-1">[</span>100<span class="org-rainbow-delimiters-depth-1">]</span> = <span class="org-string">"Append cstring: "</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>3<span class="org-rainbow-delimiters-depth-1">]</span> buffer1
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Append cstring: \0\0\0\0\0\0\0\0\0\0\0\0\0...\0\0"</span>


root <span class="org-rainbow-delimiters-depth-1">[</span>4<span class="org-rainbow-delimiters-depth-1">]</span> strcat<span class="org-rainbow-delimiters-depth-1">(</span>buffer1, null_terminated_char_array1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Append cstring: C++1z KALMAN FILTER sensor fusion data"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>5<span class="org-rainbow-delimiters-depth-1">]</span> buffer1
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Append cstring: C++1z KALMAN FILTER sensor fusion data\0\0....\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>6<span class="org-rainbow-delimiters-depth-1">]</span> strcat<span class="org-rainbow-delimiters-depth-1">(</span>buffer1, <span class="org-string">" string literal "</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Append cstring: C++1z KALMAN FILTER sensor fusion data string literal "</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> buffer1 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Append cstring: C++1z KALMAN FILTER sensor fusion data string literal \0\0\0\0...\0\0"</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">strncat()</span> =&gt; Similar to strcat, but it limits the number of
character to be copied from <span class="underline">src</span> to a buffer.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span>* <span class="org-function-name">strncat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-variable-name">dest</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">src</span>, <span class="org-type">size_t</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------------ CERN's Root REPL session ----------------------// </span>
<span class="org-comment-delimiter">// </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Stack-allocated buffer </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>8<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buff<span class="org-rainbow-delimiters-depth-1">[</span>100<span class="org-rainbow-delimiters-depth-1">]</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> memset<span class="org-rainbow-delimiters-depth-1">(</span>buff, 100, 0x00<span class="org-rainbow-delimiters-depth-1">)</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">Initialize buffer</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>12<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* str1 = <span class="org-string">"Hello world APL C++1z ADA RUST DLang OCaml"</span>;

root <span class="org-rainbow-delimiters-depth-1">[</span>13<span class="org-rainbow-delimiters-depth-1">]</span> buff
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"\0\0\0\0\0\0\0\0\0\0\0\0\0\0...\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>14<span class="org-rainbow-delimiters-depth-1">]</span> strncat<span class="org-rainbow-delimiters-depth-1">(</span>buff, str1, 10<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worl"</span>


root <span class="org-rainbow-delimiters-depth-1">[</span>15<span class="org-rainbow-delimiters-depth-1">]</span> buff
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worl\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0 .. \0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>16<span class="org-rainbow-delimiters-depth-1">]</span> strncat<span class="org-rainbow-delimiters-depth-1">(</span>buff, str1, 20<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worlHello world APL C++1"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>17<span class="org-rainbow-delimiters-depth-1">]</span> buff
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worlHello world APL C++1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0....\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>18<span class="org-rainbow-delimiters-depth-1">]</span> strncat<span class="org-rainbow-delimiters-depth-1">(</span>buff, str1 + 25, 30<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worlHello world APL C++1 RUST DLang OCaml"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>19<span class="org-rainbow-delimiters-depth-1">]</span> buff
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>100<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Hello worlHello world APL C++1 RUST DLang OCaml\0\0...\0\0"</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">memset()</span> =&gt; Fill some memory area (buffer) with a constant byte.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>*  <span class="org-function-name">memset</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-variable-name">s</span>, <span class="org-type">int</span> <span class="org-variable-name">c</span>, <span class="org-type">size_t</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------ CERN's ROOT REPL session -------------// </span>
<span class="org-comment-delimiter">// </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Create a heap-allocated buffer containing 6 characters. </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span>* char_heap_buffer = <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-1">)</span> malloc<span class="org-rainbow-delimiters-depth-1">(</span>6 * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"@\x0e"</span> <span class="org-string">"e\x01"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'@'</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-warning">'</span>0x0e<span class="org-warning">'</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>3<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'e'</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Intialize buffer char_hepa_buffer </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> memset<span class="org-rainbow-delimiters-depth-1">(</span>char_heap_buffer, <span class="org-string">'z'</span>, 6<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-rainbow-delimiters-depth-1">)</span> 0x128c760

root <span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'z'</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'z'</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>12<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'z'</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>13<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>3<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">'z'</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>14<span class="org-rainbow-delimiters-depth-1">]</span> char_heap_buffer 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> *<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"zzzzzz"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>15<span class="org-rainbow-delimiters-depth-1">]</span> free<span class="org-rainbow-delimiters-depth-1">(</span>char_heap_buffer<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">memcmp()</span>  =&gt; Compare the first N bytes of two buffers. It returns
0 if all the first N bytes from two buffers are equal. Note: This
function can only compare buffers containing POD data (Plain-Old
Data) without any internal pointer or heap-allocated data.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp">  <span class="org-type">int</span> <span class="org-function-name">memcmp</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">s1</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to the beginning of buffer 1 </span>
             , <span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">s2</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to the beginning of buffer 2 </span>
             , <span class="org-type">size_t</span> <span class="org-variable-name">n</span>       <span class="org-comment-delimiter">// </span><span class="org-comment">Number of bytes that will be compared </span>
           <span class="org-rainbow-delimiters-depth-1">)</span>;  

<span class="org-comment-delimiter">// </span><span class="org-comment">-------- CERN's ROOT REPL Session -----------------------// </span>
 root <span class="org-rainbow-delimiters-depth-1">[</span>22<span class="org-rainbow-delimiters-depth-1">]</span> uint8_t bf1<span class="org-rainbow-delimiters-depth-1">[]</span> = <span class="org-rainbow-delimiters-depth-1">{</span> 0x01, 0xAB, 0x2C, 0x3C, 0xFF <span class="org-rainbow-delimiters-depth-1">}</span>;
 root <span class="org-rainbow-delimiters-depth-1">[</span>26<span class="org-rainbow-delimiters-depth-1">]</span> uint8_t bf2<span class="org-rainbow-delimiters-depth-1">[]</span> = <span class="org-rainbow-delimiters-depth-1">{</span> 0x01, 0xAB, 0x2C, 0x3C, 0xFF, 0x85, 0x2A, 0x45 <span class="org-rainbow-delimiters-depth-1">}</span>;
 root <span class="org-rainbow-delimiters-depth-1">[</span>30<span class="org-rainbow-delimiters-depth-1">]</span> uint8_t bfx<span class="org-rainbow-delimiters-depth-1">[]</span> = <span class="org-rainbow-delimiters-depth-1">{</span> 0x3A, 0xF8, 0x25 <span class="org-rainbow-delimiters-depth-1">}</span> 

 <span class="org-comment-delimiter">// </span><span class="org-comment">Result: Non-zero =&gt; First 3 bytes of two buffers are not equal. </span>
 root <span class="org-rainbow-delimiters-depth-1">[</span>32<span class="org-rainbow-delimiters-depth-1">]</span> memcmp<span class="org-rainbow-delimiters-depth-1">(</span>bf1, bfx, 3<span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> -57

 <span class="org-comment-delimiter">// </span><span class="org-comment">Result: Zero =&gt; First 5 bytes of two buffers are equal. </span>
 root <span class="org-rainbow-delimiters-depth-1">[</span>36<span class="org-rainbow-delimiters-depth-1">]</span> memcmp<span class="org-rainbow-delimiters-depth-1">(</span>bf1, bf2, 5<span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

 <span class="org-comment-delimiter">// </span><span class="org-comment">Result: Zero =&gt; First 2 bytes of two buffers are equal. </span>
 root <span class="org-rainbow-delimiters-depth-1">[</span>37<span class="org-rainbow-delimiters-depth-1">]</span> memcmp<span class="org-rainbow-delimiters-depth-1">(</span>bf1, bf2, 2<span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

 root <span class="org-rainbow-delimiters-depth-1">[</span>13<span class="org-rainbow-delimiters-depth-1">]</span> free<span class="org-rainbow-delimiters-depth-1">(</span>heap_buffer<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">memcpy()</span> =&gt; Copy N bytes from a memory area (or buffer) src to a
memory area dest. This function can only copy POD (Plain Old Data)
types, it cannot copy anything which contains pointers or
heap-allocated data.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>* <span class="org-function-name">memcpy</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span>* <span class="org-variable-name">dest</span>, <span class="org-keyword">const</span> <span class="org-type">void</span>* <span class="org-variable-name">src</span>, <span class="org-type">size_t</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------- CERN's ROOT Repl session ---------------// </span>
<span class="org-comment-delimiter">// </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Char array --------//</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>51<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buf1<span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span> = <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-string">'h'</span>, <span class="org-string">'e'</span>, <span class="org-string">'l'</span>, <span class="org-string">'l'</span>, <span class="org-string">'o'</span>, <span class="org-string">' '</span>, <span class="org-string">'c'</span>, <span class="org-string">'p'</span>, <span class="org-string">'p'</span>, <span class="org-string">'\0'</span> <span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"hello cpp"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>53<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buf2<span class="org-rainbow-delimiters-depth-1">[</span>15<span class="org-rainbow-delimiters-depth-1">]</span> 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>15<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"\0\0\0\0\0\0\0\0\0\0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>54<span class="org-rainbow-delimiters-depth-1">]</span> memcpy<span class="org-rainbow-delimiters-depth-1">(</span>buf2, buf1, 10 * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-rainbow-delimiters-depth-1">)</span> 0x7f5c5cd7d1b5

root <span class="org-rainbow-delimiters-depth-1">[</span>55<span class="org-rainbow-delimiters-depth-1">]</span> buf2
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>15<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"hello cpp\0\0\0\0"</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Int array -------//</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>56<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">int</span> arr1<span class="org-rainbow-delimiters-depth-1">[</span>5<span class="org-rainbow-delimiters-depth-1">]</span> = <span class="org-rainbow-delimiters-depth-1">{</span> 10, 20, 25, 100, -2<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-2">[</span>5<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span> 10, 20, 25, 100, -2 <span class="org-rainbow-delimiters-depth-1">}</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>57<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">int</span> arr2<span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 <span class="org-rainbow-delimiters-depth-1">}</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>58<span class="org-rainbow-delimiters-depth-1">]</span> memcpy<span class="org-rainbow-delimiters-depth-1">(</span>arr2, arr1, 5 * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-rainbow-delimiters-depth-1">)</span> 0x7f5c5cd7d1f0

root <span class="org-rainbow-delimiters-depth-1">[</span>59<span class="org-rainbow-delimiters-depth-1">]</span> arr2
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span> 10, 20, 25, 100, -2, 0, 0, 0, 0, 0 <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">bzero()</span> =&gt; Zero-initialize some memory area. In the words of
manpage: "The bzero() function erases the data in the n bytes of
the memory starting at the location pointed to by s, by writing
zeros (bytes containing '\0') to that area."</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span> <span class="org-function-name">bzero</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-variable-name">s</span>, <span class="org-type">size_t</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">------------ CERN's ROOT REPL session --------------//</span>
<span class="org-comment-delimiter">//    </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Heap-allocated buffer with 5 integers</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">int</span>* heap_buffer = <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span>*<span class="org-rainbow-delimiters-depth-1">)</span> malloc<span class="org-rainbow-delimiters-depth-1">(</span>5 * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span> 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> *<span class="org-rainbow-delimiters-depth-1">)</span> 0x2c50ea0

root <span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 37832720

root <span class="org-rainbow-delimiters-depth-1">[</span>3<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

root <span class="org-rainbow-delimiters-depth-1">[</span>4<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 51513872

<span class="org-comment-delimiter">// </span><span class="org-comment">Initialize buffer, filling it with zeroes. </span>
root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> bzero<span class="org-rainbow-delimiters-depth-1">(</span>heap_buffer, 5 * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>8<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> *<span class="org-rainbow-delimiters-depth-1">)</span> 0x2c50ea0

root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

root <span class="org-rainbow-delimiters-depth-1">[</span>10<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

root <span class="org-rainbow-delimiters-depth-1">[</span>11<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0

root <span class="org-rainbow-delimiters-depth-1">[</span>12<span class="org-rainbow-delimiters-depth-1">]</span> heap_buffer<span class="org-rainbow-delimiters-depth-1">[</span>4<span class="org-rainbow-delimiters-depth-1">]</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 0
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">bcopy()</span> =&gt; Manpage: "The bcopy() function copies n bytes from src
to dest.  The result is correct, even when both areas overlap."
<ul class="org-ul">
<li>Note: Despite the manpage state that the function is deprecated
it is still used by many legacy codes, so it is still worth
knowing about it.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span> <span class="org-function-name">bcopy</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">void</span> *<span class="org-variable-name">src</span>, <span class="org-type">void</span> *<span class="org-variable-name">dest</span>, <span class="org-type">size_t</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">----------- CERN's ROOT Repl Session --------------// </span>

root <span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-type">char</span> buffer<span class="org-rainbow-delimiters-depth-1">[</span>50<span class="org-rainbow-delimiters-depth-1">]</span>;
root <span class="org-rainbow-delimiters-depth-1">[</span>1<span class="org-rainbow-delimiters-depth-1">]</span> bzero<span class="org-rainbow-delimiters-depth-1">(</span>buffer, 50 * <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">char</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>2<span class="org-rainbow-delimiters-depth-1">]</span> buffer 
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>50<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"\0\0\0\0\0\0\0\0\0\0\0... ...\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Null terminated array of chars</span>
root <span class="org-rainbow-delimiters-depth-1">[</span>3<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* src1 = <span class="org-string">"This is the buffer 1"</span>; 

root <span class="org-rainbow-delimiters-depth-1">[</span>4<span class="org-rainbow-delimiters-depth-1">]</span> bcopy<span class="org-rainbow-delimiters-depth-1">(</span>src1, buffer, 10<span class="org-rainbow-delimiters-depth-1">)</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>5<span class="org-rainbow-delimiters-depth-1">]</span> buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>50<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"This is th\0\0\0\0\0\0\0\0... ...0\0\0\0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>6<span class="org-rainbow-delimiters-depth-1">]</span> bcopy<span class="org-rainbow-delimiters-depth-1">(</span>src1, buffer, 25<span class="org-rainbow-delimiters-depth-1">)</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>7<span class="org-rainbow-delimiters-depth-1">]</span> buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>50<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"This is the buffer 1\0\0\0\0\x14\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>8<span class="org-rainbow-delimiters-depth-1">]</span> bcopy<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"control system Modelica / state space model / SIMULINK"</span>, buffer, 40<span class="org-rainbow-delimiters-depth-1">)</span>

root <span class="org-rainbow-delimiters-depth-1">[</span>9<span class="org-rainbow-delimiters-depth-1">]</span> buffer
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span> <span class="org-rainbow-delimiters-depth-2">[</span>50<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"control system Modelica / state space mo\0\0\0\0\0\0\0\0"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc9a194a" class="outline-3">
<h3 id="orgc9a194a"><span class="section-number-3">1.4</span> Creating Portable Binaries for Linux / GLIBC Dependency Hell</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-org21508d6" class="outline-4">
<h4 id="org21508d6"><span class="section-number-4">1.4.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
One of the greatest challenges of Linux desktop is building and
deploying portable applications and native executable which work on
any Linux distribution. Even if an application totally statically
linked against all dependencies or it is bundled with all its shared
libraries dependencies via LD_LIBRARY_PATH environment variable or
RPATH, the program may still fail to run in other Linux distribution
due to the GLIBC (GNU C library runtime) dependency. A GLIBC is <span class="underline">forward</span>
<span class="underline">compatible</span>, but not <span class="underline">backward compatible</span>, the GLIBC runtime failure is
more likely to happen if the application was built on a Linux
distribution using a newer version of GLIBC, but the program is
deployed in a distribution using an older version of GLIBC.
</p>

<ul class="org-ul">
<li>Side Note 1:
<ul class="org-ul">
<li>Applications built with GO (Golang) programming
language are less likely to be affected by the GLIBC-issue, as GO
compiler often does not link against the GLIBC and builds
statically linked binaries which can be deployed everywhere.</li>
</ul></li>

<li>Side Note 2:
<ul class="org-ul">
<li>The GLIBC issue do not only affect C++, all programming
languages which generates native Linux executables, for
instance, D-lang, Rust, OCaml, Haskell are also affected
by the GLIBC compability problem.</li>
</ul></li>

<li>Side Note 3:
<ul class="org-ul">
<li>Even <a href="https://appimage.org/">AppImage</a>, which is a solution for distributing binaries on
Linux is affected by the GLIBC-problem. As a result, the
AppImage documentation recommends building AppImage on Linux
distributions with older versions of GlibC.</li>
</ul></li>

<li>Side Node 4:
<ul class="org-ul">
<li>The GLIBC can be bypassed if the application invokes
system-calls directly using assembly or inline assembly. On
Linux, this is possible because the system calls are stable and well
documented. This might be the approach used by Golang for
avoiding the GLIBC dependency.</li>
</ul></li>
</ul>

<p>
Possible Solutions: 
</p>

<ol class="org-ol">
<li>Link against an older version of GLIBC
<ul class="org-ul">
<li>Build the application in a system with the oldest possible version
of GLIBC. <span class="underline">System</span> in this context means: a linux virtual machine; a
chroot environment or a docker image with an older version of
GLIBC.</li>
</ul></li>

<li>Link against MUSL (CRT - C Runtime Library)
<ul class="org-ul">
<li>The MUSL library, is an alternative to GLIBC, which was
designed for embedded systems and static linking, allows
building statically linked binaries that does not suffer from
the GLIBC compatibility problems. The drawback of this
procedure is that dynamic loading with <span class="underline">dlopen</span> API (dlopen,
dlclose, dlsym functions) is still not supported.</li>
</ul></li>

<li>Deploy via Docker
<ul class="org-ul">
<li>Deploy the application via docker image. While this solution is
acceptable for compilers, building environments, servers and
command line applications, Docker is not suitable for games or
Desktop GUI (Graphical User Interface) applications intended
to be used by non-technical users.</li>
<li>Advantage:
<ul class="org-ul">
<li>Pack application, dependencies and configuration.</li>
<li>The deployment environment can be reproduced everywhere.</li>
</ul></li>
</ul></li>

<li>Distribute as source and recompile from source on every
deployment machine.</li>

<li>Distribute the application via Linux distribution repositories
<ul class="org-ul">
<li>Distribute the application via official Linux distribution
repositories by creating distribution-specific packages for
every supported distribution. It means creating (.deb) Debian packages for
Debian-based distributions; (.rpm) packages for Fedora and
Centos; (.apk) alpine packages for Alpine.</li>
</ul></li>
</ol>

<p>
<b>Further Reading</b> 
</p>

<p>
General reading about Linux CRT (C Runtime Library), GlibC and alternatives:
</p>

<ul class="org-ul">
<li><a href="https://abi-laboratory.pro/index.php?view=timeline&amp;l=glibc">API/ABI changes review for glibc</a></li>

<li><a href="https://www.etalabs.net/compare_libcs.html">Comparison of C/POSIX standard library implementations for Linux</a>
<ul class="org-ul">
<li>Brief: "The table below and notes which follow are a comparison
of some of the different standard library implementations
available for Linux, with a particular focus on the balance
between feature-richness and bloat. I have tried to be fair and
objective, but as I am the author of musl, that may have
influenced my choice of which aspects to compare. Future
directions for this comparison include detailed performance
benchmarking and inclusion of additional library
implementations, especially Google's Bionic and other BSD libc
ports."</li>
</ul></li>

<li><a href="https://lwn.net/Articles/488847/">A turning point for GNU libc [LWN.net</a>] - Jonathan Corbet
<ul class="org-ul">
<li>Brief: "The kernel may be the core of a Linux system, but neither
users nor applications deal with the kernel directly. Instead,
almost all interactions with the kernel are moderated through the
C library, which is charged with providing a standards-compliant
interface to the kernel's functionality. There are a number of C
library implementations available, but, outside of the embedded
sphere, most Linux systems use the GNU C library, often just
called "glibc." The development project behind glibc has a long
and interesting history which took a new turn with the
dissolution of its steering committee on March 26. &#x2026; &#x2026;"</li>
</ul></li>

<li><a href="https://lwn.net/Articles/771441/">C library system-call wrappers, or the lack thereof [LWN.net</a>] - Jonathan Corbet
<ul class="org-ul">
<li>Brief: "User-space developers may be accustomed to thinking of
system calls as direct calls into the kernel. Indeed, the first
edition of The C Programming Language described read() and
write() as "a direct entry into the operating system". In
truth, user-level "system calls" are just functions in the C
library like any other. But what happens when the developers of
the C library refuse to provide access to system calls they
don't like? The result is an ongoing conflict that has recently
flared up again; it shows some of the difficulties that can
arise when the system as a whole has no ultimate designer and
the developers are not talking to each other. &#x2026; "</li>
</ul></li>

<li><a href="https://akkadia.org/drepper/symbol-versioning">ELF Symbol Versioning</a> - <span class="underline">Ulrich Drepper</span>
<ul class="org-ul">
<li>Brief: "The symbol versioning implementation used on Linux with glibc
2.1 o up is an extension of Sun's versioning.  It provides most
of the functionality Sun has plus one decisive new element:
symbol-level versioning with multiple definitions of a
symbol. The implementation allows every DSO to either use
versions for their symbols or not.  Depending on whether the
DSO an object is linked against had symbols or not, the
reference to the DSO requires symbols or not.  This is recorded
in the binary by three new sections: &#x2026; &#x2026;"</li>
</ul></li>

<li><a href="https://events.static.linuxfound.org/sites/events/files/slides/libc-talk.pdf">Choosing System C library</a> - Khem Raj (Comcast) - Embedded Linux
Conference	Europe 2014 Düsseldorf Germany.</li>

<li><a href="https://wiki.osdev.org/C_Library">Wikidev - C Library</a>
<ul class="org-ul">
<li>Brief: "The C standard library provides string manipulation
(string.h), basic I/O (stdio.h), memory allocation (stdlib.h),
and other basic functionality to C programs. The interface is
described in the C standard, with further additions described
in POSIX as well as vendor extensions. On Unix platforms, the
library is named libc and is linked automatically into every
executable. &#x2026; ."</li>
</ul></li>

<li><a href="https://www.lightofdawn.org/wiki/wiki.cgi/NewAppsOnOldGlibc">Running new applications on old glibc - (lightofdawn)</a>
<ul class="org-ul">
<li>Brief: "Glibc (short for GNU Libc, or GNU C Library) is a
library that provides the interface between application
programs and the Linux kernel. Although its official name is
the "C" library (library for programs written in the "C"
language), virtually all dynamically linked program binaries
depend on it - it is the de-facto system library in almost all
Linux operating systems. &#x2026; "</li>
</ul></li>

<li><a href="https://stackoverflow.com/questions/847179/multiple-glibc-libraries-on-a-single-host">linux - Multiple glibc libraries on a single host - Stack Overflow</a>
<ul class="org-ul">
<li>Brief: "Multiple glibc libraries on a single host. My linux
(SLES-8) server currently has glibc-2.2.5-235, but I have a
program which won't work on this version and requires
glibc-2.3.3. Is it possible to have multiple glibcs installed
on the same host? This is the error I get when I run my program
on the old glibc: &#x2026;"</li>
</ul></li>

<li><a href="https://wiki.musl-libc.org/">musl libc Wiki</a> [EMBEDDED-SYSTEMS] (Alternative to GLIBC - allows
creating fully statically linked and self-contained binaries)
<ul class="org-ul">
<li>Brief: "musl is a C standard library implementation for
Linux. This is a wiki maintained by the enthusiastic user
community of musl. Some of musl’s major advantages over glibc
and uClibc/uClibc-ng are its size, correctness, static
linking support, and clean code."</li>
</ul></li>

<li><a href="https://github.com/ifduyue/musl">GitHub - ifduyue/musl</a> - Unofficial mirror of MUSL (CRT)</li>

<li><a href="https://wiki.musl-libc.org/projects-using-musl.html">musl libc - Projects using musl</a> - List of projects using MUSL
libC instead of GLIBC (GNU C Library)</li>

<li><a href="https://sourceware.org/newlib/">The Newlib Homepage</a> [EMBEDDED-SYSTEMS] (Alternative to GLIBC)
<ul class="org-ul">
<li>Brief: "Newlib is a C library intended for use on embedded
systems. It is a conglomeration of several library parts, all
under free software licenses that make them easily usable on
embedded products. Newlib is only available in source form. It
can be compiled for a wide array of processors, and will
usually work on any architecture with the addition of a few
low-level routines."</li>
</ul></li>

<li><a href="https://github.com/hwoarang/uClibc">GitHub - hwoarang/uClibc</a> [EMBEDDED-SYSTEMS] (Alternative to GLIBC)
<ul class="org-ul">
<li>Brief: "uClibc (aka µClibc/pronounced yew-see-lib-see) is a C
library for developing embedded Linux systems.  It is much
smaller than the GNU C Library, but nearly all applications
supported by glibc also work perfectly with uClibc.  Porting
applications from glibc to uClibc typically involves just
recompiling the source code. uClibc even supports shared
libraries and threading.  It currently runs on standard Linux
and MMU-less (also known as µClinux) systems with support for
alpha, ARM, cris, e1, h8300, i386, i960, m68k, microblaze,
mips/mipsel, PowerPC, SH, SPARC, and v850 processors. &#x2026;"</li>
</ul></li>
</ul>

<p>
System Calls and GlibC: 
</p>

<ul class="org-ul">
<li><a href="https://sys.readthedocs.io/en/latest/doc/07_calling_system_calls.html">Calling System Calls — Glibc and System Calls 1.0 documentation</a></li>

<li><a href="https://www.linuxplumbersconf.org/event/7/contributions/703/attachments/687/1271/lpc-syscalls-20200828.pdf">glibc and system call wrappers</a> - Florian Weimer, Red Hat Platform Tools Team</li>

<li><a href="https://lwn.net/Articles/655028/">Glibc wrappers for (nearly all) Linux system calls [LWN.net</a>] - Jonathan Corbet
<ul class="org-ul">
<li>Brief: " &#x2026; A C programmer working with glibc now would look in vain
for for a straightforward way to invoke a number of Linux system
calls, including futex(), gettid(), getrandom(), renameat2(),
execveat(), bpf(), kcmp(), seccomp(), and a number of
others. The only way to get at these system calls is via the
syscall() function. Over the years, there have been requests to
add wrappers for a number of these system calls; in some cases,
such as gettid() and futex(), the requests were summarily
rejected by the (at-the-time) glibc maintainer in fairly typical
style. &#x2026;"</li>
</ul></li>

<li><a href="https://12000.org/my_notes/system_calls_in_linux/system_call_in_linux.htm">How system calls work in Linux</a> - Nasser M. Abbasi.</li>
</ul>

<p>
Utilities to Patch and modify ELF binaries and other general utilities: 
</p>

<ul class="org-ul">
<li><a href="https://github.com/NixOS/patchelf">GitHub - NixOS/patchelf</a>
<ul class="org-ul">
<li>Brief: "PatchELF is a simple utility for modifying existing ELF
executables and libraries. In particular, it can do the
following: Change the dynamic loader ("ELF interpreter") of
executables; Change the RPATH of executables and libraries;
Shrink the RPATH of executables and libraries."</li>
</ul></li>

<li><a href="https://github.com/wheybags/glibc_version_header/">GitHub - wheybags/glibc_version_header</a> (Utility for ignoring ELF
symbol version - note: it is not safe). 
<ul class="org-ul">
<li>Brief: "Build portable Linux binaries, no more linker errors on users'
older machines from incompatible glibc versions. Essentially,
this is a tool that allows you to specify the glibc version
that you want to link against, regardless of what version is
installed on your machine. This allows you to make portable
Linux binaries, without having to build your binaries on an
ancient distro (which is the current standard practice). "</li>
</ul></li>

<li><a href="https://github.com/emk/rust-musl-builder">GitHub - emk/rust-musl-builder</a>
<ul class="org-ul">
<li>Brief: ": Docker images for compiling static Rust binaries
using musl-libc and musl-gcc, with static versions of useful C
libraries. Supports openssl and diesel crates. "</li>
</ul></li>
</ul>

<p>
Reports of GLIBC dependency hell (Version mismatch): 
</p>

<ul class="org-ul">
<li><a href="https://users.rust-lang.org/t/i-often-run-into-issues-with-glibc-versions-on-the-target-machine-is-there-anything-i-can-do-to-prevent-that/32242">I often run into issues with glibc versions on the target machine is there anything i can do to prevent that?</a></li>

<li><a href="https://web.archive.org/save/https://www.dropboxforum.com/t5/Dropbox-installs-integrations/Cannot-run-latest-dropboxd-on-Centos-7-with-glibc-2-17-and/td-p/431544">Cannot run latest dropboxd on Centos 7 with glibc 2.17, and flatpak version crashes</a></li>
</ul>
</div>
</div>

<div id="outline-container-org5f8c31b" class="outline-4">
<h4 id="org5f8c31b"><span class="section-number-4">1.4.2</span> The GLIBC Problem</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
<b>GLIBC - Problem Illustration with a Sample Project</b> 
</p>

<p>
GIST Containing all files used in this experiment: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/0557cd0fa1d5370723b015e443a7c036">https://gist.github.com/0557cd0fa1d5370723b015e443a7c036</a></li>
</ul>

<p>
File: Makefile
</p>

<div class="org-src-container">
<pre class="src src-make">build:
        cmake --config Debug -H. -B_build2
        cmake --build _build2 --target 
</pre>
</div>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(Simple_Cmake_Project)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-comment">#========== Targets Configurations ============#</span>
        <span class="org-function-name">add_executable</span>( filesys filesys.cpp )
<span class="org-function-name">target_link_libraries</span>( filesys stdc++fs)
</pre>
</div>

<p>
File: filesys.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iterator</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iomanip</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">filesystem</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">namespace</span> <span class="org-constant">fs</span> = <span class="org-constant">std</span>::filesystem;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Range</span>, <span class="org-keyword">typename</span> <span class="org-type">Function</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">dotimes</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">size_t</span> <span class="org-variable-name">n</span>, <span class="org-type">Range</span>&amp;&amp; <span class="org-variable-name">iterable</span>, <span class="org-type">Function</span> <span class="org-variable-name">fun</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">size_t</span> <span class="org-variable-name">i</span> = 0;
    <span class="org-keyword">auto</span> <span class="org-variable-name">it</span> = <span class="org-constant">fs</span>::begin<span class="org-rainbow-delimiters-depth-2">(</span>iterable<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">end</span> = <span class="org-constant">fs</span>::end<span class="org-rainbow-delimiters-depth-2">(</span>iterable<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>i &lt; n &amp;&amp; it != end <span class="org-rainbow-delimiters-depth-2">){</span>
            fun<span class="org-rainbow-delimiters-depth-3">(</span>it<span class="org-rainbow-delimiters-depth-3">)</span>;
            ++it;
            i++;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(){</span>

     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n ===== Listing directory /etc ====="</span> &lt;&lt; <span class="org-constant">std</span>::endl;
     <span class="org-comment-delimiter">// </span><span class="org-comment">Show first 10 files of directory /etc </span>
     dotimes<span class="org-rainbow-delimiters-depth-2">(</span>10, <span class="org-constant">fs</span>::directory_iterator<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/etc"</span><span class="org-rainbow-delimiters-depth-3">)</span>,
             <span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-keyword">auto</span> <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-3">){</span>
                  <span class="org-keyword">auto</span> <span class="org-variable-name">path</span> = p-&gt;path<span class="org-rainbow-delimiters-depth-4">()</span>;
                  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::left
                            &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>0<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; path.filename<span class="org-rainbow-delimiters-depth-4">()</span>.string<span class="org-rainbow-delimiters-depth-4">()</span>
                            &lt;&lt; <span class="org-string">" "</span> &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>35<span class="org-rainbow-delimiters-depth-4">)</span>
                            &lt;&lt; <span class="org-constant">std</span>::right &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>40<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; path
                            &lt;&lt; <span class="org-constant">std</span>::endl;               
             <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;        
     <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Steps for reproducing the problem</b> 
</p>

<p>
STEP 1: Get current machine infomation. 
</p>

<ul class="org-ul">
<li>GLIBC Version is: 2.34-2.fc32</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Current machine </span>
$ cat /etc/fedora-release 
Fedora release 32 (Thirty Two)

<span class="org-comment-delimiter"># </span><span class="org-comment">Current GLIBC Version </span>
$ ld --version
GNU ld version 2.34-2.fc32
... ... ... ... 
</pre>
</div>

<p>
STEP 2: Build the application. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/0557cd0fa1d5370723b015e443a7c036 gist &amp;&amp; <span class="org-builtin">cd</span> gist 
$ cmake --config Debug -H. -B_build1
$ cmake --build _build1 --target 

$ file _build1/filesys 
<span class="org-function-name">_build1/filesys</span>: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, 
interpreter /lib64/ld-linux-x86-64.so.2, <span class="org-variable-name">BuildID</span>[sha1]=d1a3628f794c66bcfb29303cfa4a528910f4e3e2
, for GNU/Linux 3.2.0, not stripped
</pre>
</div>

<p>
STEP 3: Run in the current machine (newer version of GLIBC)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build1/filesys 

 ===== Listing directory /etc =====
chrony.conf                       <span class="org-string">"/etc/chrony.conf"</span>
xl2tpd                            <span class="org-string">"/etc/xl2tpd"</span>
group                             <span class="org-string">"/etc/group"</span>
profile.d                         <span class="org-string">"/etc/profile.d"</span>
kde4rc                            <span class="org-string">"/etc/kde4rc"</span>
resolv.conf.8LUAL0                <span class="org-string">"/etc/resolv.conf.8LUAL0"</span>
geoclue                           <span class="org-string">"/etc/geoclue"</span>
bash_completion.d                 <span class="org-string">"/etc/bash_completion.d"</span>
cups                              <span class="org-string">"/etc/cups"</span>
mime.types                        <span class="org-string">"/etc/mime.types"</span>
</pre>
</div>

<p>
STEP 4: Attempt to run the binary in a distribution using an older
version of GLIBC. The distribution used was a QEMU-KVM virtual
machine running MX-Linux 19.2, distribution based on Debian, with
GLIBC version .
</p>

<p>
GLIBC Failure on MX-Linux Virtual Machine: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">---------- Failure!! GLIC Incompa ------------------------------------#</span>
 $ _build1/filesys 
 _build1/filesys: /lib/x86_64-linux-gnu/libstdc++.so.6: version 
  <span class="org-string">'GLIBCXX_3.4.26'</span> not found (required by _build1/filesys)
</pre>
</div>

<p>
Virtual Machine Information: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">----------- Machine Info (MX Linux 19.2) -------------#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Kernel version </span>
$ uname -r
4.19.0-9-amd64

<span class="org-comment-delimiter"># </span><span class="org-comment">Distro name </span>
$ cat /etc/issue 
Welcome to MX 19.2 (patito feo) 64-bit! Powered by Debian.
... ... ... ... ............ .... ... ... .. 

$ ld --version
GNU ld (GNU Binutils for Debian) 2.31.1
... ... ... ... ... ... ... ... ... ... ... ... 
</pre>
</div>
</div>
</div>

<div id="outline-container-org52e26db" class="outline-4">
<h4 id="org52e26db"><span class="section-number-4">1.4.3</span> Solution 1 - via linking against older GLIBC</h4>
<div class="outline-text-4" id="text-1-4-3">
<p>
As GLIBC is <span class="underline">forward compatible</span>, but not <span class="underline">backward compatible</span>. The
solution for this issue is to build the application on a <span class="underline">system</span> with
the oldest possible version of GLIBC. System in this context, means: a
Linux virtual machine; a Chroot environment; or Docker image with an
older version of GLIBC. Other alternative is to replace GLIBC with
<span class="underline">MUSL</span> CRT (C Runtime library), but the drawback is that MUSL does not
support dynamic loading (_dlopen_, <span class="underline">dlsym</span> APIs). 
</p>

<p>
The solution adopted for solving this issue was to use a Docker image
based on <a href="https://github.com/phusion/holy-build-box">holy-build-box</a>, which is a Docker image based on Centos 6
Linux distribution containing a modern version of GCC compiler, CMake
and an older version of GLIBC.
</p>

<p>
See: 
</p>
<ul class="org-ul">
<li><a href="https://github.com/phusion/holy-build-box">https://github.com/phusion/holy-build-box</a></li>
</ul>

<p>
<span class="underline">File: Dockerfile</span> (Available at <a href="https://gist.github.com/0557cd0fa1d5370723b015e443a7c036">gist url</a>)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">$ docker run -it --rm -v $PWD:/work -w /work phusion/holy-build-box-64:latest bash </span>
FROM phusion/holy-build-box-64:latest

ENTRYPOINT [ <span class="org-string">"/hbb_exe/activate-exec"</span>, <span class="org-string">"bash"</span>  ]
</pre>
</div>

<p>
Build docker image: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Run at the directory where is Dockerfile </span>
$ docker build -f Dockerfile -t linux-build . 
</pre>
</div>

<p>
Enter in the docker image shell: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker run --rm -it -v $<span class="org-variable-name">PWD</span>:/cwd -w /cwd linux-build 
Holy build box activated
<span class="org-function-name">Prefix</span>: /hbb_exe
<span class="org-function-name">CFLAGS/CXXFLAGS</span>: -g -O2 -fvisibility=hidden -I/hbb_exe/include 
<span class="org-function-name">LDFLAGS</span>: -L/hbb_exe/lib -static-libstdc++
<span class="org-function-name">STATICLIB_CFLAGS</span>: -g -O2 -fvisibility=hidden -I/hbb_exe/include 
<span class="org-function-name">SHLIB_CFLAGS</span>: -g -O2 -fvisibility=hidden -I/hbb_exe/include 
<span class="org-function-name">SHLIB_LDFLAGS</span>: -L/hbb_exe/lib -static-libstdc++

[root@88c9630a2008 cwd]# ls
_build1  CMakeLists.txt   Dockerfile   filesys.cpp   Makefile
</pre>
</div>

<p>
Building the application: 
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@88c9630a2008 cwd]# make 
cmake --config Debug -H. -B_build2
-- Configuring done
-- Generating done
-- Build files have been written to: /cwd/_build2
cmake --build _build2 --target 
<span class="org-function-name">gmake</span>[<span class="org-compilation-line-number">1</span>]: Entering directory <span class="org-string">'/cwd/_build2'</span>
/hbb/bin/cmake -S/cwd -B/cwd/_build2 --check-build-system CMakeFiles/Makefile.cmake 0
... ... ... ... ... ... ... ... ... 
... ... ... ... ... ... ... ... ... ... ... ... 

[root@88c9630a2008 cwd]# ls _build2
CMakeCache.txt  CMakeFiles  cmake_install.cmake  filesys  Makefile
</pre>
</div>

<p>
Running the application _build2/filesys in MX-Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Built on Fedora 32 with newer version of GLIBC [FAILURE]</span>
$ _build1/filesys
<span class="org-function-name">_build1/filesys</span>: /lib/x86_64-linux-gnu/libstdc++.so.6: 
version <span class="org-string">'GLIBCXX_3.4.26'</span> not found (required by _build1/filesys)


<span class="org-comment-delimiter"># </span><span class="org-comment">Built on Centos6 docker with older version of GLIBC [OK, WORKS]</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">--------------------------------------</span>
$ _build2/filesys

 ===== Listing directory /etc =====
.java                             <span class="org-string">"/etc/.java"</span>
.pwd.lock                         <span class="org-string">"/etc/.pwd.lock"</span>
ImageMagick-6                     <span class="org-string">"/etc/ImageMagick-6"</span>
NetworkManager                    <span class="org-string">"/etc/NetworkManager"</span>
UPower                            <span class="org-string">"/etc/UPower"</span>
X11                               <span class="org-string">"/etc/X11"</span>
acpi                              <span class="org-string">"/etc/acpi"</span>
adduser.conf                      <span class="org-string">"/etc/adduser.conf"</span>
adjtime                           <span class="org-string">"/etc/adjtime"</span>
alsa                              <span class="org-string">"/etc/alsa"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc63ca24" class="outline-4">
<h4 id="orgc63ca24"><span class="section-number-4">1.4.4</span> Solution 2 - via linking against MUSL libC</h4>
<div class="outline-text-4" id="text-1-4-4">
<p>
Other alternative to avoid the GLIBC dependency problem is to build
the application statically linking against <a href="https://www.musl-libc.org/">MUSL - LibC</a> which is an CRT
(C runtime library), initially developed for embedded systems, but that has
become an alternative to GLIBC. The easiest way to build statically
linking against MUSL is to use an Alpine docker image: 
</p>

<ul class="org-ul">
<li>Note: CRT - is a central component of Unix-like operating
systems. It encapsulates system-calls and other operating system
services for user-space applications.</li>
</ul>

<p>
See: 
</p>
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Musl">Musl - Wikipedia</a></li>
<li><a href="https://wiki.debian.org/musl">Musl - Debian</a></li>
<li><a href="https://www.arangodb.com/2018/04/static-binaries-c-plus-plus-application/">Static Binaries for a C++ Application - ArangoDB</a></li>
<li><a href="https://doc.rust-lang.org/edition-guide/rust-2018/platform-and-target-support/musl-support-for-fully-static-binaries.html">MUSL support for fully static binaries - Rust Docs</a></li>
<li><a href="http://www.etalabs.net/compare_libcs.html">Comparison of C/POSIX standard library implementations for Linux</a></li>
<li><a href="https://elinux.org/images/8/8b/Room_For_Cooperation-_Bionic_and_musl.pdf">Elinux/Linaro - Bionic and musl - room for cooperation?</a></li>
</ul>

<p>
File: MuslBuilder.docker (<a href="https://gist.github.com/0557cd0fa1d5370723b015e443a7c036">Available at gist</a>)
</p>

<div class="org-src-container">
<pre class="src src-docker">FROM alpine:latest
RUN apk add musl cmake make g++
</pre>
</div>

<p>
<b>Building:</b> 
</p>

<p>
Buildilg the docker containing MUSL and development tools:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/0557cd0fa1d5370723b015e443a7c036 &amp;&amp; <span class="org-builtin">cd</span> gist 
$ docker build -f MuslBuilder.docker -t musl-builder . 
</pre>
</div>

<p>
Running a container of this docker image: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker run -it --rm -v $(<span class="org-sh-quoted-exec">pwd</span>):/cwd -w /cwd -e <span class="org-variable-name">UID</span>=$(<span class="org-sh-quoted-exec">id</span> -u) -e <span class="org-variable-name">GID</span>=$(<span class="org-sh-quoted-exec">id</span> -g) musl-builder 
/cwd $ cmake --config Debug -H. -B_build-musl -DCMAKE_EXE_LINKER_FLAGS=<span class="org-string">"-static -Os"</span>
/cwd $ cmake --build _build-musl --target 
</pre>
</div>

<p>
Exiting from the container and check the executable:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ du -h _build-musl/filesys 
8.7M    _build-musl/filesys
8.7M    total

$ file _build-musl/filesys 
<span class="org-function-name">_build-musl/filesys</span>: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV)
, statically linked, with debug_info, not stripped

<span class="org-comment-delimiter"># </span><span class="org-comment">Check dependencies </span>
$ ldd _build-musl/filesys 
        statically linked
</pre>
</div>

<p>
Attempt to run from MX-Linux 19.2 (Older GLIBC)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build-musl/filesys 

 ===== Listing directory /etc =====
.java                             <span class="org-string">"/etc/.java"</span>
.pwd.lock                         <span class="org-string">"/etc/.pwd.lock"</span>
ImageMagick-6                     <span class="org-string">"/etc/ImageMagick-6"</span>
NetworkManager                    <span class="org-string">"/etc/NetworkManager"</span>
UPower                            <span class="org-string">"/etc/UPower"</span>
X11                               <span class="org-string">"/etc/X11"</span>
acpi                              <span class="org-string">"/etc/acpi"</span>
adduser.conf                      <span class="org-string">"/etc/adduser.conf"</span>
adjtime                           <span class="org-string">"/etc/adjtime"</span>
alsa                              <span class="org-string">"/etc/alsa"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org775c0f4" class="outline-4">
<h4 id="org775c0f4"><span class="section-number-4">1.4.5</span> Portable binary using Golang</h4>
<div class="outline-text-4" id="text-1-4-5">
<p>
Applications built with GO programming language are not affect by
GLIBC compatibility problems since the GO compiler implementation
performs system calls without relying on the GLIBC. This feature
allows deploying GO binaries in any Linux distribution without
worrying about GLIBC binary compatibility. 
</p>

<p>
<b>Further Reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://stackoverflow.com/questions/55735864/how-does-go-make-system-calls">How does Go make system calls? - Stack Overflow</a></li>

<li><a href="https://news.ycombinator.com/item?id=21736342">The Go runtime scheduler's way of dealing with system calls | Hacker News</a></li>

<li id="[[<a href="https://utcc.utoronto.ca/~cks/space/blog/programming/GoSchedulerAndSyscalls">https://utcc.utoronto.ca/~cks/space/blog/programming/GoSchedulerAndSyscalls</a>][Chris's Wiki">blog/programming/GoSchedulerAndSyscalls]]</li>

<li><a href="https://stackoverflow.com/questions/41720090/does-golang-depend-on-c-runtime">go - Does golang depend on c runtime? - Stack Overflow</a></li>

<li><a href="https://lwn.net/Articles/806776/">OpenBSD system-call-origin verification [LWN.net</a>]</li>

<li><a href="https://github.com/golang/go/issues/36435">all: stop using direct syscalls on OpenBSD · Issue #36435 · golang/go · GitHub</a></li>

<li><a href="https://golang.org/src/syscall/">src/syscall/ - The Go Programming Language</a> (GOLang Source Code - Syscalls)</li>

<li><a href="https://lobste.rs/s/6a6zne/some_reasons_for_go_not_make_system_calls">Some reasons for Go to not make system calls through the standard C library | Lobsters</a></li>

<li></li>
</ul>

<p>
Utilities to Patch and modify ELF binaries and other general utilities: 
</p>

<ul class="org-ul">
<li><a href="https://github.com/NixOS/patchelf">GitHub - NixOS/patchelf</a>
<ul class="org-ul">
<li>"PatchELF is a simple utility for modifying existing ELF
executables and libraries. In particular, it can do the
following: Change the dynamic loader ("ELF interpreter") of
executables; Change the RPATH of executables and libraries;
Shrink the RPATH of executables and libraries."</li>
</ul></li>

<li><a href="https://github.com/wheybags/glibc_version_header/">GitHub - wheybags/glibc_version_header</a> (Utility for ignoring ELF
symbol version - note: it is not safe). 
<ul class="org-ul">
<li>Brief: "Build portable Linux binaries, no more linker errors on users'
older machines from incompatible glibc versions. Essentially,
this is a tool that allows you to specify the glibc version
that you want to link against, regardless of what version is
installed on your machine. This allows you to make portable
Linux binaries, without having to build your binaries on an
ancient distro (which is the current standard practice). "</li>
</ul></li>

<li><a href="https://github.com/emk/rust-musl-builder">GitHub - emk/rust-musl-builder</a>
<ul class="org-ul">
<li>Brief: ": Docker images for compiling static Rust binaries
using musl-libc and musl-gcc, with static versions of useful C
libraries. Supports openssl and diesel crates. "</li>
</ul></li>
</ul>

<p>
Reports of GLIBC dependency hell (Version mismatch): 
</p>

<ul class="org-ul">
<li><a href="https://users.rust-lang.org/t/i-often-run-into-issues-with-glibc-versions-on-the-target-machine-is-there-anything-i-can-do-to-prevent-that/32242">I often run into issues with glibc versions on the target machine is there anything i can do to prevent that?</a></li>

<li><a href="https://web.archive.org/save/https://www.dropboxforum.com/t5/Dropbox-installs-integrations/Cannot-run-latest-dropboxd-on-Centos-7-with-glibc-2-17-and/td-p/431544">Cannot run latest dropboxd on Centos 7 with glibc 2.17, and flatpak version crashes</a></li>
</ul>
</div>
</div>

<div id="outline-container-org02e9b01" class="outline-4">
<h4 id="org02e9b01"><span class="section-number-4">1.4.6</span> The GLIBC Problem</h4>
<div class="outline-text-4" id="text-1-4-6">
<p>
<b>GLIBC - Problem Illustration with a Sample Project</b> 
</p>

<p>
GIST Containing all files used in this experiment: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/0557cd0fa1d5370723b015e443a7c036">https://gist.github.com/0557cd0fa1d5370723b015e443a7c036</a></li>
</ul>

<p>
File: Makefile
</p>

<div class="org-src-container">
<pre class="src src-make">build:
        cmake --config Debug -H. -B_build2
        cmake --build _build2 --target 
</pre>
</div>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(Simple_Cmake_Project)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-comment">#========== Targets Configurations ============#</span>
        <span class="org-function-name">add_executable</span>( filesys filesys.cpp )
<span class="org-function-name">target_link_libraries</span>( filesys stdc++fs)
</pre>
</div>

<p>
File: filesys.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iterator</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iomanip</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">filesystem</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">namespace</span> <span class="org-constant">fs</span> = <span class="org-constant">std</span>::filesystem;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Range</span>, <span class="org-keyword">typename</span> <span class="org-type">Function</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">dotimes</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">size_t</span> <span class="org-variable-name">n</span>, <span class="org-type">Range</span>&amp;&amp; <span class="org-variable-name">iterable</span>, <span class="org-type">Function</span> <span class="org-variable-name">fun</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">size_t</span> <span class="org-variable-name">i</span> = 0;
    <span class="org-keyword">auto</span> <span class="org-variable-name">it</span> = <span class="org-constant">fs</span>::begin<span class="org-rainbow-delimiters-depth-2">(</span>iterable<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">end</span> = <span class="org-constant">fs</span>::end<span class="org-rainbow-delimiters-depth-2">(</span>iterable<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>i &lt; n &amp;&amp; it != end <span class="org-rainbow-delimiters-depth-2">){</span>
            fun<span class="org-rainbow-delimiters-depth-3">(</span>it<span class="org-rainbow-delimiters-depth-3">)</span>;
            ++it;
            i++;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(){</span>

     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n ===== Listing directory /etc ====="</span> &lt;&lt; <span class="org-constant">std</span>::endl;
     <span class="org-comment-delimiter">// </span><span class="org-comment">Show first 10 files of directory /etc </span>
     dotimes<span class="org-rainbow-delimiters-depth-2">(</span>10, <span class="org-constant">fs</span>::directory_iterator<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/etc"</span><span class="org-rainbow-delimiters-depth-3">)</span>,
             <span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-keyword">auto</span> <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-3">){</span>
                  <span class="org-keyword">auto</span> <span class="org-variable-name">path</span> = p-&gt;path<span class="org-rainbow-delimiters-depth-4">()</span>;
                  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::left
                            &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>0<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; path.filename<span class="org-rainbow-delimiters-depth-4">()</span>.string<span class="org-rainbow-delimiters-depth-4">()</span>
                            &lt;&lt; <span class="org-string">" "</span> &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>35<span class="org-rainbow-delimiters-depth-4">)</span>
                            &lt;&lt; <span class="org-constant">std</span>::right &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>40<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; path
                            &lt;&lt; <span class="org-constant">std</span>::endl;               
             <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;        
     <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Steps for reproducing the problem</b> 
</p>

<p>
STEP 1: Get current machine infomation. 
</p>

<ul class="org-ul">
<li>GLIBC Version is: 2.34-2.fc32</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Current machine </span>
$ cat /etc/fedora-release 
Fedora release 32 (Thirty Two)

<span class="org-comment-delimiter"># </span><span class="org-comment">Current GLIBC Version </span>
$ ld --version
GNU ld version 2.34-2.fc32
... ... ... ... 
</pre>
</div>

<p>
STEP 2: Build the application. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/0557cd0fa1d5370723b015e443a7c036 gist &amp;&amp; <span class="org-builtin">cd</span> gist 
$ cmake --config Debug -H. -B_build1
$ cmake --build _build1 --target 

$ file _build1/filesys 
<span class="org-function-name">_build1/filesys</span>: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, 
interpreter /lib64/ld-linux-x86-64.so.2, <span class="org-variable-name">BuildID</span>[sha1]=d1a3628f794c66bcfb29303cfa4a528910f4e3e2
, for GNU/Linux 3.2.0, not stripped
</pre>
</div>

<p>
STEP 3: Run in the current machine (newer version of GLIBC)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build1/filesys 

 ===== Listing directory /etc =====
chrony.conf                       <span class="org-string">"/etc/chrony.conf"</span>
xl2tpd                            <span class="org-string">"/etc/xl2tpd"</span>
group                             <span class="org-string">"/etc/group"</span>
profile.d                         <span class="org-string">"/etc/profile.d"</span>
kde4rc                            <span class="org-string">"/etc/kde4rc"</span>
resolv.conf.8LUAL0                <span class="org-string">"/etc/resolv.conf.8LUAL0"</span>
geoclue                           <span class="org-string">"/etc/geoclue"</span>
bash_completion.d                 <span class="org-string">"/etc/bash_completion.d"</span>
cups                              <span class="org-string">"/etc/cups"</span>
mime.types                        <span class="org-string">"/etc/mime.types"</span>
</pre>
</div>

<p>
STEP 4: Attempt to run the binary in a distribution using an older
version of GLIBC. The distribution used was a QEMU-KVM virtual
machine running MX-Linux 19.2, distribution based on Debian, with
GLIBC version .
</p>

<p>
GLIBC Failure on MX-Linux Virtual Machine: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">---------- Failure!! GLIC Incompa ------------------------------------#</span>
 $ _build1/filesys 
 _build1/filesys: /lib/x86_64-linux-gnu/libstdc++.so.6: version 
  <span class="org-string">'GLIBCXX_3.4.26'</span> not found (required by _build1/filesys)
</pre>
</div>

<p>
Virtual Machine Information: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">----------- Machine Info (MX Linux 19.2) -------------#</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Kernel version </span>
$ uname -r
4.19.0-9-amd64

<span class="org-comment-delimiter"># </span><span class="org-comment">Distro name </span>
$ cat /etc/issue 
Welcome to MX 19.2 (patito feo) 64-bit! Powered by Debian.
... ... ... ... ............ .... ... ... .. 

$ ld --version
GNU ld (GNU Binutils for Debian) 2.31.1
... ... ... ... ... ... ... ... ... ... ... ... 
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd3a48c4" class="outline-4">
<h4 id="orgd3a48c4"><span class="section-number-4">1.4.7</span> Solution 1 - via linking against older GLIBC</h4>
<div class="outline-text-4" id="text-1-4-7">
<p>
As GLIBC is <span class="underline">forward compatible</span>, but not <span class="underline">backward compatible</span>. The
solution for this issue is to build the application on a <span class="underline">system</span> with
the oldest possible version of GLIBC. System in this context, means: a
Linux virtual machine; a Chroot environment; or Docker image with an
older version of GLIBC. Other alternative is to replace GLIBC with
<span class="underline">MUSL</span> CRT (C Runtime library), but the drawback is that MUSL does not
support dynamic loading (_dlopen_, <span class="underline">dlsym</span> APIs). 
</p>

<p>
The solution adopted for solving this issue was to use a Docker image
based on <a href="https://github.com/phusion/holy-build-box">holy-build-box</a>, which is a Docker image based on Centos 6
Linux distribution containing a modern version of GCC compiler, CMake
and an older version of GLIBC.
</p>

<p>
See: 
</p>
<ul class="org-ul">
<li><a href="https://github.com/phusion/holy-build-box">https://github.com/phusion/holy-build-box</a></li>
</ul>

<p>
<span class="underline">File: Dockerfile</span> (Available at <a href="https://gist.github.com/0557cd0fa1d5370723b015e443a7c036">gist url</a>)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">$ docker run -it --rm -v $PWD:/work -w /work phusion/holy-build-box-64:latest bash </span>
FROM phusion/holy-build-box-64:latest

ENTRYPOINT [ <span class="org-string">"/hbb_exe/activate-exec"</span>, <span class="org-string">"bash"</span>  ]
</pre>
</div>

<p>
Build docker image: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Run at the directory where is Dockerfile </span>
$ docker build -f Dockerfile -t linux-build . 
</pre>
</div>

<p>
Enter in the docker image shell: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker run --rm -it -v $<span class="org-variable-name">PWD</span>:/cwd -w /cwd linux-build 
Holy build box activated
<span class="org-function-name">Prefix</span>: /hbb_exe
<span class="org-function-name">CFLAGS/CXXFLAGS</span>: -g -O2 -fvisibility=hidden -I/hbb_exe/include 
<span class="org-function-name">LDFLAGS</span>: -L/hbb_exe/lib -static-libstdc++
<span class="org-function-name">STATICLIB_CFLAGS</span>: -g -O2 -fvisibility=hidden -I/hbb_exe/include 
<span class="org-function-name">SHLIB_CFLAGS</span>: -g -O2 -fvisibility=hidden -I/hbb_exe/include 
<span class="org-function-name">SHLIB_LDFLAGS</span>: -L/hbb_exe/lib -static-libstdc++

[root@88c9630a2008 cwd]# ls
_build1  CMakeLists.txt   Dockerfile   filesys.cpp   Makefile
</pre>
</div>

<p>
Building the application: 
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@88c9630a2008 cwd]# make 
cmake --config Debug -H. -B_build2
-- Configuring done
-- Generating done
-- Build files have been written to: /cwd/_build2
cmake --build _build2 --target 
<span class="org-function-name">gmake</span>[<span class="org-compilation-line-number">1</span>]: Entering directory <span class="org-string">'/cwd/_build2'</span>
/hbb/bin/cmake -S/cwd -B/cwd/_build2 --check-build-system CMakeFiles/Makefile.cmake 0
... ... ... ... ... ... ... ... ... 
... ... ... ... ... ... ... ... ... ... ... ... 

[root@88c9630a2008 cwd]# ls _build2
CMakeCache.txt  CMakeFiles  cmake_install.cmake  filesys  Makefile
</pre>
</div>

<p>
Running the application _build2/filesys in MX-Linux: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Built on Fedora 32 with newer version of GLIBC [FAILURE]</span>
$ _build1/filesys
<span class="org-function-name">_build1/filesys</span>: /lib/x86_64-linux-gnu/libstdc++.so.6: 
version <span class="org-string">'GLIBCXX_3.4.26'</span> not found (required by _build1/filesys)


<span class="org-comment-delimiter"># </span><span class="org-comment">Built on Centos6 docker with older version of GLIBC [OK, WORKS]</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">--------------------------------------</span>
$ _build2/filesys

 ===== Listing directory /etc =====
.java                             <span class="org-string">"/etc/.java"</span>
.pwd.lock                         <span class="org-string">"/etc/.pwd.lock"</span>
ImageMagick-6                     <span class="org-string">"/etc/ImageMagick-6"</span>
NetworkManager                    <span class="org-string">"/etc/NetworkManager"</span>
UPower                            <span class="org-string">"/etc/UPower"</span>
X11                               <span class="org-string">"/etc/X11"</span>
acpi                              <span class="org-string">"/etc/acpi"</span>
adduser.conf                      <span class="org-string">"/etc/adduser.conf"</span>
adjtime                           <span class="org-string">"/etc/adjtime"</span>
alsa                              <span class="org-string">"/etc/alsa"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org78584d9" class="outline-4">
<h4 id="org78584d9"><span class="section-number-4">1.4.8</span> Solution 2 - via linking against MUSL libC</h4>
<div class="outline-text-4" id="text-1-4-8">
<p>
Other alternative to avoid the GLIBC dependency problem is to build
the application statically linking against <a href="https://www.musl-libc.org/">MUSL - LibC</a> which is an CRT
(C runtime library), initially developed for embedded systems, but that has
become an alternative to GLIBC. The easiest way to build statically
linking against MUSL is to use an Alpine docker image: 
</p>

<ul class="org-ul">
<li>Note: CRT - is a central component of Unix-like operating
systems. It encapsulates system-calls and other operating system
services for user-space applications.</li>
</ul>

<p>
See: 
</p>
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Musl">Musl - Wikipedia</a></li>
<li><a href="https://wiki.debian.org/musl">Musl - Debian</a></li>
<li><a href="https://www.arangodb.com/2018/04/static-binaries-c-plus-plus-application/">Static Binaries for a C++ Application - ArangoDB</a></li>
<li><a href="https://doc.rust-lang.org/edition-guide/rust-2018/platform-and-target-support/musl-support-for-fully-static-binaries.html">MUSL support for fully static binaries - Rust Docs</a></li>
<li><a href="http://www.etalabs.net/compare_libcs.html">Comparison of C/POSIX standard library implementations for Linux</a></li>
<li><a href="https://elinux.org/images/8/8b/Room_For_Cooperation-_Bionic_and_musl.pdf">Elinux/Linaro - Bionic and musl - room for cooperation?</a></li>
</ul>

<p>
File: MuslBuilder.docker (<a href="https://gist.github.com/0557cd0fa1d5370723b015e443a7c036">Available at gist</a>)
</p>

<div class="org-src-container">
<pre class="src src-docker">FROM alpine:latest
RUN apk add musl cmake make g++
</pre>
</div>

<p>
<b>Building:</b> 
</p>

<p>
Buildilg the docker containing MUSL and development tools:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/0557cd0fa1d5370723b015e443a7c036 &amp;&amp; <span class="org-builtin">cd</span> gist 
$ docker build -f MuslBuilder.docker -t musl-builder . 
</pre>
</div>

<p>
Running a container of this docker image: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker run -it --rm -v $(<span class="org-sh-quoted-exec">pwd</span>):/cwd -w /cwd -e <span class="org-variable-name">UID</span>=$(<span class="org-sh-quoted-exec">id</span> -u) -e <span class="org-variable-name">GID</span>=$(<span class="org-sh-quoted-exec">id</span> -g) musl-builder 
/cwd $ cmake --config Debug -H. -B_build-musl -DCMAKE_EXE_LINKER_FLAGS=<span class="org-string">"-static -Os"</span>
/cwd $ cmake --build _build-musl --target 
</pre>
</div>

<p>
Exiting from the container and check the executable:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ du -h _build-musl/filesys 
8.7M    _build-musl/filesys
8.7M    total

$ file _build-musl/filesys 
<span class="org-function-name">_build-musl/filesys</span>: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV)
, statically linked, with debug_info, not stripped

<span class="org-comment-delimiter"># </span><span class="org-comment">Check dependencies </span>
$ ldd _build-musl/filesys 
        statically linked
</pre>
</div>

<p>
Attempt to run from MX-Linux 19.2 (Older GLIBC)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build-musl/filesys 

 ===== Listing directory /etc =====
.java                             <span class="org-string">"/etc/.java"</span>
.pwd.lock                         <span class="org-string">"/etc/.pwd.lock"</span>
ImageMagick-6                     <span class="org-string">"/etc/ImageMagick-6"</span>
NetworkManager                    <span class="org-string">"/etc/NetworkManager"</span>
UPower                            <span class="org-string">"/etc/UPower"</span>
X11                               <span class="org-string">"/etc/X11"</span>
acpi                              <span class="org-string">"/etc/acpi"</span>
adduser.conf                      <span class="org-string">"/etc/adduser.conf"</span>
adjtime                           <span class="org-string">"/etc/adjtime"</span>
alsa                              <span class="org-string">"/etc/alsa"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org4e15465" class="outline-4">
<h4 id="org4e15465"><span class="section-number-4">1.4.9</span> Portable binary using Golang</h4>
<div class="outline-text-4" id="text-1-4-9">
<p>
Applications built with GO programming language are not affect by
GLIBC compatibility problems since the GO compiler implementation
performs system calls without relying on the GLIBC. This feature
allows deploying GO binaries in any Linux distribution without
worrying about GLIBC binary compatibility. 
</p>

<p>
<b>Further Reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://stackoverflow.com/questions/55735864/how-does-go-make-system-calls">How does Go make system calls? - Stack Overflow</a></li>

<li><a href="https://news.ycombinator.com/item?id=21736342">The Go runtime scheduler's way of dealing with system calls | Hacker News</a></li>

<li id="[[<a href="https://utcc.utoronto.ca/~cks/space/blog/programming/GoSchedulerAndSyscalls">https://utcc.utoronto.ca/~cks/space/blog/programming/GoSchedulerAndSyscalls</a>][Chris's Wiki">blog/programming/GoSchedulerAndSyscalls]]</li>

<li><a href="https://stackoverflow.com/questions/41720090/does-golang-depend-on-c-runtime">go - Does golang depend on c runtime? - Stack Overflow</a></li>

<li><a href="https://lwn.net/Articles/806776/">OpenBSD system-call-origin verification [LWN.net</a>]</li>

<li><a href="https://github.com/golang/go/issues/36435">all: stop using direct syscalls on OpenBSD · Issue #36435 · golang/go · GitHub</a></li>

<li><a href="https://golang.org/src/syscall/">src/syscall/ - The Go Programming Language</a> (GOLang Source Code - Syscalls)</li>

<li><a href="http://garrett.damore.org/2015/09/on-go-portability-and-system-interfaces.html">/dev/dump: On Go, Portability, and System Interfaces</a></li>

<li><a href="http://lsub.org/export/gort.html">Notes on the Go 1.4 Run-Time</a> - Francisco J. Ballesteros - TR LSUB-15-2 (rev 1)
<ul class="org-ul">
<li>"This TR contains notes about the Go run time as of Go
1.4. They are intended to aid in the construction of a kernel
for Clive. The description here will be updated in the future
without publising a new TR, the TR revision number can be used
to see if the version is up to date or not."</li>
</ul></li>
</ul>

<p>
<b>Demonstration</b> 
</p>

<p>
File: <span class="underline">goapp.go</span> 
</p>

<div class="org-src-container">
<pre class="src src-c++">package <span class="org-type">main</span> 

<span class="org-variable-name">import</span> <span class="org-rainbow-delimiters-depth-1">(</span>
    <span class="org-string">"fmt"</span>
    <span class="org-string">"io/ioutil"</span>
    <span class="org-string">"net/http"</span>
    _ <span class="org-string">"bufio"</span>
    _ <span class="org-string">"log"</span>
<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-type">func</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-rainbow-delimiters-depth-1">{</span>

    fmt.Println<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" =&gt; Started Ok"</span><span class="org-rainbow-delimiters-depth-2">)</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">------- List root directory ---------//</span>
    fmt.Println<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" ---- List Root Directory ------"</span><span class="org-rainbow-delimiters-depth-2">)</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">No error handler for the sake of breviety. </span>
    files, _ := ioutil.ReadDir<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/"</span><span class="org-rainbow-delimiters-depth-2">)</span>

    <span class="org-keyword">for</span> _, fn := range files <span class="org-rainbow-delimiters-depth-2">{</span> 
        fmt.Println<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" =&gt; "</span> + fn.Name<span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-rainbow-delimiters-depth-3">)</span>         
    <span class="org-rainbow-delimiters-depth-2">}</span> 

    <span class="org-comment-delimiter">// </span><span class="org-comment">---- Http Request ------------------// </span>
    fmt.Println<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" ------- Http Request -------------"</span><span class="org-rainbow-delimiters-depth-2">)</span>
    resp, _ := http.Get<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"https://www.httpbin.org/get"</span><span class="org-rainbow-delimiters-depth-2">)</span>
    body, _ := ioutil.ReadAll<span class="org-rainbow-delimiters-depth-2">(</span>resp.Body<span class="org-rainbow-delimiters-depth-2">)</span>
    fmt.Println<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-variable-name">body</span><span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Compile sample GO application: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> <span class="org-comment-delimiter"># </span><span class="org-comment">Compiled  </span>
 $ go build goapp.go    

 <span class="org-comment-delimiter"># </span><span class="org-comment">Remove debug symbols </span>
 $ strip goapp 

 <span class="org-comment-delimiter"># </span><span class="org-comment">Get file size in megabytes    </span>
 $ &gt;&gt; du -h goapp
 4.9M    goapp

 <span class="org-comment-delimiter"># </span><span class="org-comment">Check binary </span>
 $ &gt;&gt; file goapp
 goapp: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter 
 /lib64/ld-linux-x86-64.so.2, 
 Go <span class="org-variable-name">BuildID</span>=rXh5UDymAYyqH6QHp4N5/KktyZonaNBes2MLq_8eV/4lmCJtW64uAqpYg_AIb_/5S4-otZPFzRnjGyq3bBL
, not stripped

<span class="org-comment-delimiter"># </span><span class="org-comment">Check shared libraries dependencies </span>
 $ &gt;&gt; ldd goapp
        linux-vdso.so.1 (0x00007ffee9b99000)
        libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007fc87c0c6000)
        libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fc87befc000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fc87c10d000)
</pre>
</div>

<p>
Run application in Fedora 32 distribution (Newer version of GLIBC): 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./goapp 
 =&gt; Started Ok
 ---- List Root Directory ------
 =&gt; .autorelabel
 =&gt; bin
 =&gt; boot
 =&gt; dev
 =&gt; etc
 ... ... ... ... ... ... ... ... ... 
 ... ... ... ... ... ... ... ... ... 
 =&gt; usr
 =&gt; var
 ------- Http Request -------------
{
  <span class="org-string">"args"</span>: {}, 
  <span class="org-string">"headers"</span>: {
    <span class="org-string">"Accept-Encoding"</span>: <span class="org-string">"gzip"</span>, 
    <span class="org-string">"Host"</span>: <span class="org-string">"www.httpbin.org"</span>, 
    <span class="org-string">"User-Agent"</span>: <span class="org-string">"Go-http-client/2.0"</span>, 
    <span class="org-string">"X-Amzn-Trace-Id"</span>: <span class="org-string">"Root=2-5f5650e9-4830a22ac821b598c22defbc"</span>
  }, 
  <span class="org-string">"url"</span>: <span class="org-string">"https://www.httpbin.org/get"</span>
}
</pre>
</div>

<p>
Run application in MX-Linux distribution, based on Debian (Older version of GLIBC):
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./goapp
 =&gt; Started Ok
 ---- List Root Directory ------
 =&gt; .cache
 =&gt; .config
 =&gt; .fehbg
 =&gt; bin
 =&gt; boot
 ... ... ... ... .... ... ... ... ... .... ... 
 ... ... ... ... .... ... ... ... ... .... ... 
 =&gt; var
 =&gt; vmlinuz
 ------- Http Request -------------
{
  <span class="org-string">"args"</span>: {}, 
  <span class="org-string">"headers"</span>: {
    <span class="org-string">"Accept-Encoding"</span>: <span class="org-string">"gzip"</span>, 
    <span class="org-string">"Host"</span>: <span class="org-string">"www.httpbin.org"</span>, 
    <span class="org-string">"User-Agent"</span>: <span class="org-string">"Go-http-client/2.0"</span>, 
    <span class="org-string">"X-Amzn-Trace-Id"</span>: <span class="org-string">"Root=1-5f56523a-6cfd5015acb4421e26947afe"</span>
  }, 
  <span class="org-string">"url"</span>: <span class="org-string">"https://www.httpbin.org/get"</span>
}

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org75faa69" class="outline-3">
<h3 id="org75faa69"><span class="section-number-3">1.5</span> Fully Statically linked executables for embedded Linux systems</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-orgcd81790" class="outline-4">
<h4 id="orgcd81790"><span class="section-number-4">1.5.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-5-1">
<p>
This sections presents a procedure for cross-compiling a fully
statically linked executable, without any dependency, that can be
deployed on any ARMV7-based Embedded Linux system, including
Beaglebone Black development board and Android (Armv7 based
processor).
</p>

<p>
This procedure uses  <a href="https://hub.docker.com/layers/muslcc/i686/arm-linux-musleabi/images/sha256-818ac763b91e0112f7a38e34949c69a91d24852dc794372e905c70bb48370d0b?context=explore">muslcc/i686:arm-linux-musleabi</a> docker image
which contains a cross-compiling toolchain capable of compiling
C or C++ applications for Linux kernel running on Armv7 based
processors. This toolchain also uses Musl libC, instead of glibC (GNU
C runtime library). Musl allows building fully statically applications
that does not rely on any system dependency. As a result,
applications, built with  Musl, can be run on any Linux
distribution without being affected by GNU GlibC mismatch problems which
arises when an application or object-code, that was built linked
against an newer version of GlibC, is run on a system using an older
version of GlibC resulting in a runtime linking error.
</p>

<p>
References and reading: 
</p>

<ul class="org-ul">
<li><a href="https://hub.docker.com/r/muslcc/i686/tags">https://hub.docker.com/r/muslcc/i686/tags</a></li>

<li>More toolchains at: <a href="https://elinux.org/Toolchains">https://elinux.org/Toolchains</a></li>

<li><a href="https://cmake.org/pipermail/cmake/2011-October/046743.html">[CMake] Fwd: Save stripped debugging information</a></li>

<li><a href="https://stackoverflow.com/questions/6687630/how-to-remove-unused-c-c-symbols-with-gcc-and-ld">How to remove unused C/C++ symbols with GCC and ld? - Stack Overflow</a></li>

<li><a href="https://ownyourbits.com/2018/06/13/transparently-running-binaries-from-any-architecture-in-linux-with-qemu-and-binfmt_misc/">Transparently running binaries from any architecture in Linux with QEMU and binfmt_misc – Own your bits</a></li>
</ul>
</div>
</div>

<div id="outline-container-org6fc0f82" class="outline-4">
<h4 id="org6fc0f82"><span class="section-number-4">1.5.2</span> Project Files</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
All files are available at: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/b411be3b2a4364c7d4de18edd37da6a3">https://gist.github.com/b411be3b2a4364c7d4de18edd37da6a3</a></li>
</ul>


<p>
File: <span class="underline">Dockerfil.docker</span>
</p>

<div class="org-src-container">
<pre class="src src-sh">FROM muslcc/i686:armv7l-linux-musleabihf
RUN  apk add make cmake 

<span class="org-comment-delimiter"># </span><span class="org-comment">ENTRYPOINT ["cmake"]</span>
</pre>
</div>

<p>
File: <span class="underline">Makefile</span> 
</p>

<ul class="org-ul">
<li>Makefile for running project commands and documenting the building
process.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-variable-name">DOCKER_COMMAND</span>=docker run -e <span class="org-variable-name">UID</span>=$(<span class="org-sh-quoted-exec">shell</span> id -u) -e <span class="org-variable-name">GID</span>=$(<span class="org-sh-quoted-exec">shell</span> id -g) --volume=$(<span class="org-sh-quoted-exec">shell</span> pwd):/cwd  --workdir=/cwd musl-armv7

<span class="org-comment-delimiter"># </span><span class="org-comment">Builds docker image: musl-armv7</span>
<span class="org-function-name">docker</span>:
        docker build -f Dockerfile.docker -t musl-armv7 .

<span class="org-comment-delimiter"># </span><span class="org-comment">Build testing application </span>
<span class="org-function-name">build</span>:
        ${<span class="org-variable-name">DOCKER_COMMAND</span>} cmake -H. -B_build-armv7 -DCMAKE_BUILD_TYPE=Debug
        ${<span class="org-variable-name">DOCKER_COMMAND</span>} cmake --build _build-armv7 --target 

<span class="org-function-name">clean</span>:
        rm -rf -v _build-armv7
</pre>
</div>

<p>
File: <span class="underline">CMakeLists.txt</span> 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(embedded-linux-armv7)

<span class="org-builtin">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-builtin">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-comment-delimiter">#</span><span class="org-comment">====== Global compiler and linker settings ======#</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">(-static)           =&gt; Fully statically link Musl-LibC</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">(-Wl,--gc-sections) =&gt; Remove unused code</span>
<span class="org-comment-delimiter">#                        </span><span class="org-comment">(requires: -fdata-sections and -ffunction-sections)</span>
<span class="org-builtin">set</span>(CMAKE_EXE_LINKER_FLAGS <span class="org-string">"-static -Wl,--gc-sections"</span>)

<span class="org-comment-delimiter"># </span><span class="org-comment">Separate data and code sections in order to reduce binary size. </span>
<span class="org-function-name">add_definitions</span>( -fdata-sections -ffunction-sections )

<span class="org-comment-delimiter"># </span><span class="org-comment">Copy target executable, for instance my-exe to my-exe.debug </span>
<span class="org-comment-delimiter"># </span><span class="org-comment">and strip debugging symbols from my-exe.</span>
<span class="org-comment-delimiter"># </span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Reference: https://cmake.org/pipermail/cmake/2011-October/046743.html</span>
<span class="org-function-name">macro</span>(STRIP_DEBUG_SYMBOLS target)
  ADD_CUSTOM_COMMAND(TARGET ${<span class="org-variable-name">target</span>} POST_BUILD
    COMMAND ${<span class="org-variable-name">CMAKE_COMMAND</span>} -E copy $&lt;TARGET_FILE:${<span class="org-variable-name">target</span>}&gt; ${<span class="org-variable-name">CMAKE_BINARY_DIR</span>}/${<span class="org-variable-name">target</span>}.debug
    COMMAND ${<span class="org-variable-name">CMAKE_STRIP</span>} -g $&lt;TARGET_FILE:${<span class="org-variable-name">target</span>}&gt;
  )
<span class="org-function-name">endmacro</span>()

<span class="org-comment-delimiter">#</span><span class="org-comment">========== Targets Configurations ============#</span>

        add_executable( app portable-app.cpp )
 target_link_libraries( app stdc++fs)
   STRIP_DEBUG_SYMBOLS( app )

</pre>
</div>

<p>
File: <span class="underline">portable-app.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">algorithm</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iomanip</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">filesystem</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-keyword">namespace</span> <span class="org-constant">fs</span> = <span class="org-constant">std</span>::filesystem;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

  assert<span class="org-rainbow-delimiters-depth-2">(</span> argc &gt;= 2 &amp;&amp; <span class="org-string">"Supposed to have at least one arguments"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha;
  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">command</span> = argv<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"version"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span> 
      <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/proc/version"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
      assert<span class="org-rainbow-delimiters-depth-3">(</span> ifs.good<span class="org-rainbow-delimiters-depth-4">()</span> &amp;&amp; <span class="org-string">"File supposed to exist"</span> <span class="org-rainbow-delimiters-depth-3">)</span>;  
      <span class="org-constant">std</span>::cout &lt;&lt; ifs.rdbuf<span class="org-rainbow-delimiters-depth-3">()</span>;
      <span class="org-keyword">return</span> EXIT_SUCCESS;
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n ===== Listing directory /etc ====="</span> &lt;&lt; <span class="org-constant">std</span>::endl;

  <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"list"</span><span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">Show first 10 files of directory /etc </span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">iter</span> = <span class="org-constant">fs</span>::directory_iterator<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-constant">std</span>::for_each<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">fs</span>::begin<span class="org-rainbow-delimiters-depth-4">(</span>iter<span class="org-rainbow-delimiters-depth-4">)</span>, <span class="org-constant">fs</span>::end<span class="org-rainbow-delimiters-depth-4">(</span>iter<span class="org-rainbow-delimiters-depth-4">)</span>
                 ,<span class="org-rainbow-delimiters-depth-4">[](</span><span class="org-keyword">auto</span> <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-4">){</span>
                   <span class="org-keyword">auto</span> <span class="org-variable-name">path</span> = p.path<span class="org-rainbow-delimiters-depth-5">()</span>;
                   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::left
                             &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-5">(</span>0<span class="org-rainbow-delimiters-depth-5">)</span> &lt;&lt; path.filename<span class="org-rainbow-delimiters-depth-5">()</span>.string<span class="org-rainbow-delimiters-depth-5">()</span>
                             &lt;&lt; <span class="org-string">" "</span> &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-5">(</span>35<span class="org-rainbow-delimiters-depth-5">)</span>
                             &lt;&lt; <span class="org-constant">std</span>::right &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-5">(</span>40<span class="org-rainbow-delimiters-depth-5">)</span> &lt;&lt; path
                             &lt;&lt; <span class="org-constant">std</span>::endl;              
                 <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;    
    <span class="org-keyword">return</span> EXIT_FAILURE;    
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc0f6071" class="outline-4">
<h4 id="orgc0f6071"><span class="section-number-4">1.5.3</span> Building and running</h4>
<div class="outline-text-4" id="text-1-5-3">
<p>
<b>STEP 1:</b> Downloading the source code. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/b411be3b2a4364c7d4de18edd37da6a3 musl-armv7 &amp;&amp; <span class="org-builtin">cd</span> musl-armv7
</pre>
</div>

<p>
<b>STEP 2:</b> Building the docker image: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker build -f Dockerfile.docker -t musl-armv7 .

Sending build context to Docker daemon  7.168kB
Step 1/2 : FROM muslcc/i686:armv7l-linux-musleabihf
 ---&gt; 4141d3dcca3f
Step 2/2 : RUN  apk add make cmake
 ---&gt; Using cache
 ---&gt; c18ba0aa2335
Successfully built c18ba0aa2335
Successfully tagged musl-armv7:latest
</pre>
</div>

<p>
<b>STEP 3:</b> Cross-compile the sample application: 
</p>

<p>
Cross-compiling from command line: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Run the docker shell (sh)</span>
$ docker run --interactive --tty -e <span class="org-variable-name">UID</span>=$(<span class="org-sh-quoted-exec">id</span> -u) -e <span class="org-variable-name">GID</span>=$(<span class="org-sh-quoted-exec">id</span> -g) --volume=$(<span class="org-sh-quoted-exec">pwd</span>):/cwd  --workdir=/cwd musl-armv7
/cwd <span class="org-comment-delimiter"># </span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Build the application </span>
/cwd $ cmake -H. -B_build-armv7 -DCMAKE_BUILD_TYPE=Debug
/cwd $ cmake --build _build-armv7 --target

<span class="org-comment-delimiter"># </span><span class="org-comment">Exit the docker shell </span>
/cwd $ cmake --build _build-armv7 --target
</pre>
</div>

<p>
Cross-compile in a single step using the helper Makefile: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ make build 
</pre>
</div>

<p>
Check the compiled executables: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ls _build-armv7/
CMakeFiles/  app*  app.debug*  CMakeCache.txt  cmake_install.cmake  Makefile

<span class="org-comment-delimiter"># </span><span class="org-comment">Version with debug symbols </span>
$ file _build-armv7/app
<span class="org-function-name">_build-armv7/app</span>: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, not stripped

$ du -h _build-armv7/app
736K    _build-armv7/app
736K    total

<span class="org-comment-delimiter"># </span><span class="org-comment">Version without debugging symbols </span>
$ file _build-armv7/app.debug 
<span class="org-function-name">_build-armv7/app.debug</span>: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV)
, statically linked, with debug_info, not stripped

$ du -h _build-armv7/app.debug 
9.4M    _build-armv7/app.debug
9.4M    total
</pre>
</div>

<p>
<b>STEP 4:</b> Attempt to run the built executable on different machines.
</p>

<p>
Attempt to run the previous executables on the host machine (x86-64
processor - 64 bits):
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build-armv7/app
<span class="org-function-name">bash</span>: _build-armv7/app: cannot execute binary file: Exec format error

$ _build-armv7/app.debug 
<span class="org-function-name">bash</span>: _build-armv7/app.debug: cannot execute binary file: Exec format error
</pre>
</div>

<p>
Run ARMv7 Linux binary on a x86-64 host machine using <a href="https://www.qemu.org/">QEMU</a> emulator: <a href="https://ownyourbits.com/2018/06/13/transparently-running-binaries-from-any-architecture-in-linux-with-qemu-and-binfmt_misc/">(OwnYourBits)</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Install Fedora Packages </span>
$ sudo dnf install -y qemu-user.x86_64 qemu-user-static.x86_64

<span class="org-comment-delimiter"># </span><span class="org-comment">Run the Armv7 binary using QEMU-user </span>
$ qemu-arm ./_build-armv7/app version 
Linux version 5.8.4-200.fc32.x86_64 (mockbuild@bkernel01.iad2.fedoraproject.org) ... ... 

$ qemu-arm ./_build-armv7/app list /

 ===== Listing directory /etc =====
srv                                   <span class="org-string">"/srv"</span>
sys                                   <span class="org-string">"/sys"</span>
opt                                   <span class="org-string">"/opt"</span>
run                                   <span class="org-string">"/run"</span>
media                                 <span class="org-string">"/media"</span>
bin                                   <span class="org-string">"/bin"</span>
.autorelabel                          <span class="org-string">"/.autorelabel"</span>
root                                  <span class="org-string">"/root"</span>
var                                   <span class="org-string">"/var"</span>
etc                                   <span class="org-string">"/etc"</span>
tmp                                   <span class="org-string">"/tmp"</span>
</pre>
</div>

<p>
Run application in <span class="underline">Beaglebone Black</span> (Armv7) embedded linux development
board, similar to Raspberry-Pi, but with more IO ports, peripherals
and ADC analog-to-digital converters: 
</p>

<div class="org-src-container">
<pre class="src src-sh">debian@beaglebone:~$ file app
<span class="org-function-name">app</span>: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, not stripped

debian@beaglebone:~$ du -h app
736K    app

debian@beaglebone:~$ file app
<span class="org-function-name">app</span>: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, not stripped
debian@beaglebone:~$ 

debian@beaglebone:~$ ./app 
Assertion failed: argc &gt;= 2 &amp;&amp; <span class="org-string">"Supposed to have at least one arguments"</span> (/cwd/portable-app.cpp: main: 14)
Aborted
debian@beaglebone:~$ 

debian@beaglebone:~$ ./app version 
Linux version 4.14.71-ti-r80 (root@b2-am57xx-beagle-x15-2gb) (gcc version 6.3.0 20170516 (Debian 6.3.0-18+deb9u1)) <span class="org-comment-delimiter">#</span><span class="org-comment">1 SMP PREEMPT Fri Oct 5 23:50:11 UTC 2018</span>
debian@beaglebone:~$ 

debian@beaglebone:~$ ./app list /

 ===== Listing directory /etc =====
sys                                   <span class="org-string">"/sys"</span>
opt                                   <span class="org-string">"/opt"</span>
sbin                                  <span class="org-string">"/sbin"</span>
home                                  <span class="org-string">"/home"</span>
dev                                   <span class="org-string">"/dev"</span>
nfs-uEnv.txt                          <span class="org-string">"/nfs-uEnv.txt"</span>
usr                                   <span class="org-string">"/usr"</span>
bin                                   <span class="org-string">"/bin"</span>
etc                                   <span class="org-string">"/etc"</span>
proc                                  <span class="org-string">"/proc"</span>
boot                                  <span class="org-string">"/boot"</span>
 ... ... ...  ... ... ...  ... ... ... 
 ... ... ...  ... ... ...  ... ... ... 

</pre>
</div>

<p>
Run in Android Armv-7 phone via <a href="https://developer.android.com/studio/command-line/adb">ADB</a> (Android Debug Bridge): 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Transver application to phone via ADB </span>
 $ adb push _build-armv7/app.debug /data/local/tmp 
<span class="org-function-name">_build-armv7/app.debug</span>: 1 file pushed. 11.1 MB/s (9793936 bytes<span class="org-keyword"> in</span> 0.842s)

<span class="org-comment-delimiter"># </span><span class="org-comment">Enter ADB shell and run the application. </span>
 $ &gt;&gt; adb shell 
<span class="org-function-name">bali</span>:/ $ cd /data/local/tmp

<span class="org-function-name">bali</span>:/data/local/tmp $ file app.debug                                                                                                       
<span class="org-function-name">app.debug</span>: ELF executable, 32-bit LSB arm, static, not stripped

<span class="org-function-name">bali</span>:/data/local/tmp $ du -h app.debug
9.3M    app.debug

134|bali:/data/local/tmp $ ./app.debug version                                                                                              
Linux version 4.4.146+ (jenkins@jenkins-bali-wxg)  ... ... 
<span class="org-function-name">bali</span>:/data/local/tmp $ 


1|bali:/data/local/tmp $ ./app.debug list /dev                                                                                              

 ===== Listing directory /etc =====
wmtWifi                           <span class="org-string">"/dev/wmtWifi"</span>
stpgps                            <span class="org-string">"/dev/stpgps"</span>
fm                                <span class="org-string">"/dev/fm"</span>
stpbt                             <span class="org-string">"/dev/stpbt"</span>
stpwmt                            <span class="org-string">"/dev/stpwmt"</span>
wmtdetect                         <span class="org-string">"/dev/wmtdetect"</span>
radio                             <span class="org-string">"/dev/radio"</span>
ttyGS3                            <span class="org-string">"/dev/ttyGS3"</span>
ttyGS2                            <span class="org-string">"/dev/ttyGS2"</span>
ttyGS1                            <span class="org-string">"/dev/ttyGS1"</span>
ttyGS0                            <span class="org-string">"/dev/ttyGS0"</span>
mtp_usb                           <span class="org-string">"/dev/mtp_usb"</span>
usb_accessory                     <span class="org-string">"/dev/usb_accessory"</span>
 ... ... ...  ... ... ...  ... ... ...  ... ... ... 
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga03560c" class="outline-3">
<h3 id="orga03560c"><span class="section-number-3">1.6</span> Creating command line applications with CLI11 C++ Library</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-org8a2ee1a" class="outline-4">
<h4 id="org8a2ee1a"><span class="section-number-4">1.6.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-6-1">
<p>
Despite that GUI Graphical user interfaces applications are more used
nowadays than CLI command line applications, it still worth developing
CLI applications. Among other things, the benefits of CLI applications
over GUI can be summarized as: 
</p>

<ul class="org-ul">
<li>More precision
<ul class="org-ul">
<li>They are more precise than GUI for performing task. It is easier
to guide someone by showing the command line steps rather than
describing all buttons, menus, context menus that someone should
click in order to accomplish some task.</li>
</ul></li>

<li>Scriptability
<ul class="org-ul">
<li>CLI applications are scriptable and they can be automated;
called from other applications or scripts.</li>
</ul></li>

<li>Reproducibility 
<ul class="org-ul">
<li>Unlike GUIs, CLI applications are reproducible and the sequence
of steps for performing some task can be stored as text and
later replayed by pasting the commands in a terminal or running
them from a script.</li>
</ul></li>

<li>They can be combined
<ul class="org-ul">
<li>Unlike GUI, CLI applications can be combined with each other via
stdout, stderr redirection. Example: CLI tools such as 'grep',
'echo', 'ls', 'find', 'awk', 'sed' are often combined with each
other in shell scripts for system configuration or automation.</li>
</ul></li>
</ul>


<p>
<b>Anotomy of CLI Applications</b> 
</p>

<p>
Simple command line application: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./&lt;COMMAND&gt; &lt;P0&gt; &lt;P1&gt; ... &lt;PN&gt; --flag0 --flag1 --switch0 value0 --switch1 value1 --switch value2 ... 

<span class="org-comment-delimiter"># </span><span class="org-comment">Or: </span>
$ ./&lt;COMMAND&gt; &lt;P0&gt; &lt;P1&gt; ... &lt;PN&gt; <span class="org-sh-escaped-newline">\</span>
     --flag0 --flag1 <span class="org-sh-escaped-newline">\</span>
     --switch0 value0 --switch1 value1 --switch value2 ... 

$ ./&lt;COMMAND&gt; &lt;P0&gt; &lt;P1&gt; ... &lt;PN&gt; --flag0 --flag1 <span class="org-sh-escaped-newline">\</span>
     --switch0=value0 --switch1=value1 --switch=value2 ... 
</pre>
</div>

<p>
Command line application with multiple subcommands: (i.e: git, docker)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./&lt;COMMAND&gt; &lt;SUBCOMMAND&gt; &lt;P0&gt; &lt;P1&gt; ... &lt;PN&gt; <span class="org-sh-escaped-newline">\</span>
     --flag0 --flag1 <span class="org-sh-escaped-newline">\</span>
     --switch0 value0 --switch1 value1 --switch value2 ... 

<span class="org-comment-delimiter"># </span><span class="org-comment">OR: </span>
$ ./&lt;COMMAND&gt; &lt;SUBCOMMAND&gt; &lt;P0&gt; &lt;P1&gt; ... &lt;PN&gt; <span class="org-sh-escaped-newline">\</span>
     --flag0 --flag1 <span class="org-sh-escaped-newline">\</span>
     --switch0=value0 --switch1=value1 --switch=value2 ... 
</pre>
</div>

<p>
Where: 
</p>

<ul class="org-ul">
<li>&lt;COMMAND&gt;
<ul class="org-ul">
<li>Appplication or executable.</li>
</ul></li>

<li>&lt;SUBCOMMAND&gt;
<ul class="org-ul">
<li>Metaphor: an action or verb performed on subjects (positional
arguments).</li>
<li>Subcommand, similar to 'git checkout' or'docker run'. A
subcommand or command represents an</li>
</ul></li>

<li>&lt;P0&gt;, &lt;P1&gt;, &#x2026;, &lt;PN&gt;
<ul class="org-ul">
<li>Metaphor: subjects</li>
<li>Positional arguments (without '-' dash prefix) - they are
essential (required) arguments for running an application. If
they are not provided, an error happens.</li>
</ul></li>

<li>-flag0 -flag1 &#x2026;.
<ul class="org-ul">
<li>Metaphor: adjectives</li>
<li>A flag is an optional command line switch which represents a
boolean value. The usage of a flag sets the represented value
as true and absence, sets the represented value as false.</li>
</ul></li>

<li>&#x2013;switch0=value0 &#x2013;switch1=value1 &#x2026;.
<ul class="org-ul">
<li>Metaphor: adjectives</li>
<li>Switches are optional command line arguments associated to some
program state.</li>
</ul></li>
</ul>

<p>
<b>Example</b> - Breaking down command line parts:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ docker run -i -t --rm --volume=$<span class="org-variable-name">PWD</span>:/cwd -w=/cwd xdxd/docker-binwalk bash     
</pre>
</div>

<ul class="org-ul">
<li>Command:
<ul class="org-ul">
<li>docker</li>
</ul></li>

<li>Sub-command:
<ul class="org-ul">
<li>run</li>
</ul></li>

<li>Positional arguments:
<ul class="org-ul">
<li>(xdxd/docker-binwalk) and (bash)</li>
</ul></li>

<li>Flags:
<ul class="org-ul">
<li>(-i), (-t), (&#x2013;rm)</li>
</ul></li>

<li>Switches:
<ul class="org-ul">
<li>(&#x2013;volume), (-w)</li>
</ul></li>
</ul>


<p>
<b>General recommendations</b> 
</p>

<ul class="org-ul">
<li><span class="underline">DO ONLY ONE THING</span> =&gt; The application should only do one thing. If
it needs to perform more than one task, the best choice is to
create a subcommand for every task.</li>

<li><span class="underline">STATUS CODE</span> =&gt; The status code allows scripts or any other
application calling the current one to know whether the process
execution was successful. 
<ul class="org-ul">
<li>=&gt; Return status code '0' (EXIT_SUCCESS) when the
applications is terminated successfully</li>
<li>=&gt; Return any other value different than zero in case of failure.</li>
</ul></li>

<li><span class="underline">DEFAULT VALUES</span>
<ul class="org-ul">
<li>Use reasonable default values for command line switches values
and flags.</li>
<li>Show the default values of command line switches</li>
</ul></li>

<li><span class="underline">EXAMPLES</span>
<ul class="org-ul">
<li>Add commands that shows usage examples.</li>
</ul></li>

<li><span class="underline">SIMPLE TASKS SHOULD BE SIMPLE</span>
<ul class="org-ul">
<li>Create subcommands for the most common use-cases for making
simple tasks simple: make simple things simple and complex
things possible (borrowed from Alan Kay).</li>
</ul></li>

<li><span class="underline">STDERR</span> - for non essential information
<ul class="org-ul">
<li>Print non essential, logging or debug information to <span class="underline">stderr</span>,
standard error output as it allows discarding separating the
stdout (standard output) from stderr, redirecting stderr to
file or discarding it by redirecting stderr to /dev/null.</li>
</ul></li>

<li><span class="underline">VERSION</span> (&#x2013;version)
<ul class="org-ul">
<li>Add switch for printing application version.</li>
</ul></li>

<li><span class="underline">DRY-RUN</span> (&#x2013;dry-run)
<ul class="org-ul">
<li>Create a flag option (&#x2013;dry-run) if the command performs any
permanent non-reversible change, such as remove file. When the
application receives the &#x2013;dry-run option, the application only shows the
non-reversible actions that would be executed, without actually
performing them.</li>
</ul></li>
</ul>

<p>
Subcommand for common tasks (Simple tasks should be simple): 
</p>

<p>
For instance, an alternative docker client could have a subcommand
'shell' for just running the shell as entrypoint. <span class="underline">$ dockw shell IMAGE</span> could
be translated as the following docker command line. The subcommand
'shell' could assume that the current directory ($PWD) is mounted to
the directory /cwd in the docker image and this option could be
changed using the command line switch <code>--workdir=&lt;SOME_DIR&gt;</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">'dockw shell MY_DOCKER_IMAGE ' subcommand from a hypothetical dockw tool </span>
<span class="org-comment-delimiter"># </span><span class="org-comment">is translated as: </span>
$ docker run --rm -it -v $<span class="org-variable-name">PWD</span>:/cwd -w /cwd --entrypoint=sh MY_DOCKER_IMAGE 
</pre>
</div>
</div>
</div>

<div id="outline-container-org5b9b7ea" class="outline-4">
<h4 id="org5b9b7ea"><span class="section-number-4">1.6.2</span> Sample application with multiple sub-comamnds</h4>
<div class="outline-text-4" id="text-1-6-2">
<p>
The following code contains a sample CLI application containing
multiple sub-commands:. 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/caiorss/1b6826b9722ba07667eefed2f82d667e">https://gist.github.com/caiorss/1b6826b9722ba07667eefed2f82d667e</a></li>
</ul>

<p>
CLI11 Library Documentation: 
</p>

<ul class="org-ul">
<li><a href="https://cliutils.gitlab.io/CLI11Tutorial/">Introduction · CLI11 Tutorial</a></li>

<li><a href="https://cliutils.gitlab.io/CLI11Tutorial/chapters/subcommands.html">Subcommands and the App · CLI11 Tutorial</a></li>

<li><a href="https://indico.cern.ch/event/619465/contributions/2507949/attachments/1448567/2232649/20170424-diana-2.pdf">CLI11: Command line parsing made simple</a></li>
</ul>

<p>
<b>Files</b> 
</p>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(cliapp)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)
<span class="org-function-name">set</span>(CMAKE_CXX_EXTENSIONS OFF)

<span class="org-comment"># ------------ Download CPM CMake Script ----------------#</span>

<span class="org-comment">## Automatically donwload and use module CPM.cmake</span>
<span class="org-function-name">file</span>(DOWNLOAD https://raw.githubusercontent.com/TheLartians/CPM.cmake/v0.26.2/cmake/CPM.cmake
                 <span class="org-string">"${</span><span class="org-variable-name">CMAKE_BINARY_DIR</span><span class="org-string">}/CPM.cmake"</span>)
<span class="org-function-name">include</span>(<span class="org-string">"${</span><span class="org-variable-name">CMAKE_BINARY_DIR</span><span class="org-string">}/CPM.cmake"</span>)

<span class="org-comment">#----------- Add dependencies --------------------------#</span>

<span class="org-function-name">CPMAddPackage</span>(
    NAME cli11
    URL  https://github.com/CLIUtils/CLI11/archive/v1.9.0.zip
    DOWNLOAD_ONLY YES
)

<span class="org-function-name">include_directories</span>( ${<span class="org-variable-name">cli11_SOURCE_DIR</span>}/include )

<span class="org-function-name">message</span>([TRACE] <span class="org-string">" cli11_SOURCE_DIR =  ${</span><span class="org-variable-name">cli11_SOURCE_DIR</span><span class="org-string">} "</span>)

<span class="org-comment">#----------- Set targets -------------------------------#</span>

<span class="org-function-name">add_executable</span>(cliapp cliapp.cpp)
<span class="org-function-name">target_link_libraries</span>(cliapp stdc++fs)

<span class="org-function-name">install</span>( TARGETS cliapp 
         RUNTIME DESTINATION bin)

</pre>
</div>

<p>
File: cliapp.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">filesystem</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">CLI/CLI.hpp</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">std</span>::<span class="org-constant">string_literals</span>;
<span class="org-keyword">namespace</span> <span class="org-constant">fs</span> = <span class="org-constant">std</span>::filesystem;

<span class="org-keyword">struct</span> <span class="org-type">Command_list</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m_path</span> = <span class="org-string">"."</span>;
    <span class="org-type">bool</span> <span class="org-variable-name">m_filter_file</span> = <span class="org-constant">false</span>;
    <span class="org-type">bool</span> <span class="org-variable-name">m_filter_dir</span>  = <span class="org-constant">false</span>; 
    <span class="org-type">bool</span> <span class="org-variable-name">m_recursive</span>   = <span class="org-constant">false</span>; 

    <span class="org-function-name">Command_list</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">CLI</span>::<span class="org-type">App</span>&amp; <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;install<span class="org-rainbow-delimiters-depth-3">(</span>app, name<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">install</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">CLI</span>::<span class="org-type">App</span>&amp; <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">CLI</span>::<span class="org-type">App</span>* <span class="org-variable-name">cmd</span> = app.add_subcommand<span class="org-rainbow-delimiters-depth-3">(</span>
            name, <span class="org-string">"List directory"</span>
        <span class="org-rainbow-delimiters-depth-3">)</span>;

        cmd-&gt;callback<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">[</span><span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-4">](){</span>
            <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-5">{</span>
                <span class="org-keyword">this</span>-&gt;list_directory<span class="org-rainbow-delimiters-depth-6">()</span>;
                <span class="org-comment-delimiter">// </span><span class="org-comment">Status code  0 =&gt; OK finished successfuly </span>
                <span class="org-keyword">return</span> <span class="org-constant">true</span>; 
            <span class="org-rainbow-delimiters-depth-5">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-5">(</span><span class="org-constant">std</span>::<span class="org-type">exception</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-5">{</span>
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Error: "</span> &lt;&lt; ex.what<span class="org-rainbow-delimiters-depth-6">()</span> &lt;&lt; <span class="org-string">'\n'</span>;
                <span class="org-keyword">return</span> <span class="org-constant">false</span>; 
            <span class="org-rainbow-delimiters-depth-5">}</span>
        <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        cmd-&gt;add_option<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"&lt;PATH&gt;"</span>,        m_path,        <span class="org-string">"Directory to be listed."</span> <span class="org-rainbow-delimiters-depth-3">)</span>-&gt;required<span class="org-rainbow-delimiters-depth-3">()</span>;
        cmd-&gt;add_flag<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"-f,--file"</span>,       m_filter_file, <span class="org-string">"Only list files"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        cmd-&gt;add_flag<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"-d,--directory"</span>,  m_filter_dir,  <span class="org-string">"Only list directories"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        cmd-&gt;add_flag<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"-r,--recursive"</span>,  m_recursive,   <span class="org-string">"List direcotyr in recursive way"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-function-name">private</span>:

    <span class="org-type">void</span> <span class="org-function-name">list_directory</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_filter_file &amp;&amp; m_filter_dir<span class="org-rainbow-delimiters-depth-3">)</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: --file and --dir flags cannot be simultaneously true."</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">using</span> <span class="org-type">Predfun</span> = <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">fs</span>::<span class="org-type">path</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>;
        <span class="org-keyword">auto</span> <span class="org-variable-name">predicate</span> = Predfun<span class="org-rainbow-delimiters-depth-3">{}</span>;

        <span class="org-keyword">auto</span> <span class="org-variable-name">iterate_dir</span> = <span class="org-rainbow-delimiters-depth-3">[</span>&amp;<span class="org-variable-name">predicate</span><span class="org-rainbow-delimiters-depth-3">](</span><span class="org-keyword">auto</span>&amp;&amp; <span class="org-variable-name">iterable</span><span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span> :  iterable <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span>predicate<span class="org-rainbow-delimiters-depth-6">(</span>path<span class="org-rainbow-delimiters-depth-6">)</span><span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"  =&gt; %s\n"</span>, path.path<span class="org-rainbow-delimiters-depth-6">()</span>.c_str<span class="org-rainbow-delimiters-depth-6">()</span><span class="org-rainbow-delimiters-depth-5">)</span>; 
            <span class="org-rainbow-delimiters-depth-4">}</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">using</span> <span class="org-type">ptr</span> = <span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">fs</span>::<span class="org-type">path</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span>m_filter_file &amp;&amp; <span class="org-negation-char">!</span>m_filter_dir<span class="org-rainbow-delimiters-depth-3">)</span> 
            predicate = <span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-constant">fs</span>::<span class="org-type">path</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-3">){</span> <span class="org-keyword">return</span> <span class="org-constant">true</span>; <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_filter_file<span class="org-rainbow-delimiters-depth-3">)</span> 
            predicate = <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">ptr</span><span class="org-rainbow-delimiters-depth-3">)</span> &amp;<span class="org-constant">fs</span>::is_regular_file;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_filter_dir<span class="org-rainbow-delimiters-depth-3">)</span>
            predicate = <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">ptr</span><span class="org-rainbow-delimiters-depth-3">)</span> &amp;<span class="org-constant">fs</span>::is_directory;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span>m_recursive<span class="org-rainbow-delimiters-depth-3">)</span>
            iterate_dir<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">fs</span>::<span class="org-type">directory_iterator</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-variable-name">m_path</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">else</span> 
            iterate_dir<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">fs</span>::<span class="org-type">recursive_directory_iterator</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-variable-name">m_path</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>   
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">class</span> <span class="org-type">MiniWebServer</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span>         <span class="org-variable-name">m_port</span> = 8080; 
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m_host</span> = <span class="org-string">"0.0.0.0"</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m_path</span> = <span class="org-string">"."</span>; 
    <span class="org-type">bool</span>        <span class="org-variable-name">m_auth</span> = <span class="org-constant">false</span>; 
<span class="org-function-name">public</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">Set server TCP Port </span>
    <span class="org-type">void</span> <span class="org-function-name">set_port</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">port</span>         <span class="org-rainbow-delimiters-depth-2">){</span> m_port = port; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Hostnames that server will listen to </span>
    <span class="org-type">void</span> <span class="org-function-name">set_host</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">host</span> <span class="org-rainbow-delimiters-depth-2">){</span> m_host = host; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Set path containing server data </span>
    <span class="org-type">void</span> <span class="org-function-name">set_path</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">path</span> <span class="org-rainbow-delimiters-depth-2">){</span> m_path = path; <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">set_auth</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">bool</span> <span class="org-variable-name">flag</span>        <span class="org-rainbow-delimiters-depth-2">){</span> m_auth = flag; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">int</span>  <span class="org-function-name">get_port</span><span class="org-rainbow-delimiters-depth-2">(){</span> <span class="org-keyword">return</span> m_port; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">run_server</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [INFO] Running web server =&gt; port = %d ; host = %s; path = %s \n"</span>
            , m_port, m_host.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, m_path.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [INFO] Server has authentication =&gt; %s \n"</span>, m_auth ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span>, <span class="org-keyword">typename</span> <span class="org-type">Klass</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">bind_setter</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Klass</span>&amp; <span class="org-variable-name">cls</span>, <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">Klass</span>::* <span class="org-type">setter</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">T</span>&amp;&amp;<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-2">[</span>&amp;<span class="org-rainbow-delimiters-depth-2">](</span><span class="org-type">T</span>&amp;&amp; <span class="org-variable-name">q</span><span class="org-rainbow-delimiters-depth-2">){</span> 
        <span class="org-rainbow-delimiters-depth-3">(</span>cls.*setter<span class="org-rainbow-delimiters-depth-3">)(</span> <span class="org-constant">std</span>::forward<span class="org-rainbow-delimiters-depth-4">(</span>q<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span>, <span class="org-keyword">typename</span> <span class="org-type">Klass</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">auto</span> <span class="org-function-name">bind_setter</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Klass</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">cls</span>, <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">Klass</span>::* <span class="org-type">setter</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">T</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">return</span> <span class="org-rainbow-delimiters-depth-2">[</span>cls, setter<span class="org-rainbow-delimiters-depth-2">](</span><span class="org-type">T</span> <span class="org-variable-name">q</span><span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-rainbow-delimiters-depth-4">(</span>*cls<span class="org-rainbow-delimiters-depth-4">)</span>.*setter<span class="org-rainbow-delimiters-depth-3">)(</span>q<span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">command_server</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-constant">CLI</span>::<span class="org-type">App</span>&amp;  <span class="org-variable-name">app</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>    

    <span class="org-constant">CLI</span>::<span class="org-type">App</span>* <span class="org-variable-name">cmd</span> = app.add_subcommand<span class="org-rainbow-delimiters-depth-2">(</span>
        <span class="org-string">"server"</span>, <span class="org-string">"Run HTTP server for sharing files from some folder."</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;

    cmd-&gt;footer<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Run local file sharing web server"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Created with shared_ptr in order to the object survive this scope</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">and avoid reference to destroyed object when it is referenced from callback. </span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">server</span> = <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">MiniWebServer</span><span class="org-rainbow-delimiters-depth-2">&gt;()</span>;

    cmd-&gt;callback<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[</span>=<span class="org-rainbow-delimiters-depth-3">]</span>
    <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] ----- Callback invoked OK ------ \n"</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>server-&gt;get_port<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-5">&lt;</span> 0 || server-&gt;get_port<span class="org-rainbow-delimiters-depth-6">()</span> <span class="org-rainbow-delimiters-depth-5">&gt;</span> 65535<span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] "</span> &lt;&lt; <span class="org-string">" Invalid TCP port range. "</span> &lt;&lt; <span class="org-string">'\n'</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">Returns non-zero status code</span>
            <span class="org-keyword">return</span> <span class="org-constant">false</span>;
        <span class="org-rainbow-delimiters-depth-4">}</span>
        server-&gt;run_server<span class="org-rainbow-delimiters-depth-4">()</span>;
        <span class="org-keyword">return</span> <span class="org-constant">true</span>;
    <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    cmd-&gt;add_option_function<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>
          <span class="org-string">"&lt;PATH&gt;"</span>
        , bind_setter<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>server, &amp;<span class="org-constant">MiniWebServer</span>::set_path<span class="org-rainbow-delimiters-depth-3">)</span>
        , <span class="org-string">"Directory to be shared in the web server."</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>-&gt;required<span class="org-rainbow-delimiters-depth-2">()</span>;

    cmd-&gt;add_option_function<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> 
        <span class="org-string">"-p,--port"</span>
      , <span class="org-rainbow-delimiters-depth-3">[</span>=<span class="org-rainbow-delimiters-depth-3">](</span><span class="org-keyword">auto</span> <span class="org-variable-name">q</span><span class="org-rainbow-delimiters-depth-3">){</span> server-&gt;set_port<span class="org-rainbow-delimiters-depth-4">(</span>q<span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
      , <span class="org-string">"Server TCP port, default: 8080"</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;

    cmd-&gt;add_option_function<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> 
        <span class="org-string">"--host"</span>
      , <span class="org-rainbow-delimiters-depth-3">[</span>=<span class="org-rainbow-delimiters-depth-3">](</span><span class="org-keyword">auto</span> <span class="org-variable-name">q</span><span class="org-rainbow-delimiters-depth-3">){</span> server-&gt;set_host<span class="org-rainbow-delimiters-depth-4">(</span>q<span class="org-rainbow-delimiters-depth-4">)</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
      , <span class="org-string">"Hostname that server will listen to (default: 0.0.0.0)"</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;

    cmd-&gt;add_flag<span class="org-rainbow-delimiters-depth-2">(</span> 
        <span class="org-string">"-a,--auth"</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">, [](auto q){ server-&gt;set_auth(q); }        </span>
       , bind_setter<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>server, &amp;<span class="org-constant">MiniWebServer</span>::set_auth<span class="org-rainbow-delimiters-depth-3">)</span>
       , <span class="org-string">"Shows the command line parameters passed to QEMU."</span>
    <span class="org-rainbow-delimiters-depth-2">)</span>;   
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">command_version</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-constant">CLI</span>::<span class="org-type">App</span>&amp;  <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">cmd</span> = app.add_subcommand<span class="org-rainbow-delimiters-depth-2">(</span>name, <span class="org-string">"Show application version."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    cmd-&gt;callback<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[</span>=<span class="org-rainbow-delimiters-depth-3">]{</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"cliapp version 0.1 - Your favorite U-NIX swiss army knife \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Return true for idnicating successful status code </span>
        <span class="org-keyword">return</span> <span class="org-constant">true</span>; 
    <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">CLI</span>::<span class="org-type">App</span> <span class="org-variable-name">app</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"cliapp"</span><span class="org-rainbow-delimiters-depth-2">)</span>;        
    app.footer<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n Command line demo toolbox."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    command_version<span class="org-rainbow-delimiters-depth-2">(</span>app, <span class="org-string">"version"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    command_version<span class="org-rainbow-delimiters-depth-2">(</span>app, <span class="org-string">"v"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">Command_list</span> <span class="org-variable-name">cmd_list1</span><span class="org-rainbow-delimiters-depth-2">(</span>app, <span class="org-string">"ls"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">Command_list</span> <span class="org-variable-name">cmd_list2</span><span class="org-rainbow-delimiters-depth-2">(</span>app, <span class="org-string">"list"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    command_server<span class="org-rainbow-delimiters-depth-2">(</span>app<span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Parse Arguments ---------------//</span>
    <span class="org-keyword">try</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>argc == 1<span class="org-rainbow-delimiters-depth-3">){</span> 
            <span class="org-constant">std</span>::cout &lt;&lt; app.help<span class="org-rainbow-delimiters-depth-4">()</span> &lt;&lt; <span class="org-string">"\n"</span>;
            <span class="org-keyword">return</span> 0;
         <span class="org-rainbow-delimiters-depth-3">}</span>
        app.require_subcommand<span class="org-rainbow-delimiters-depth-3">()</span>;
        app.validate_positionals<span class="org-rainbow-delimiters-depth-3">()</span>;
        app.parse<span class="org-rainbow-delimiters-depth-3">(</span>argc, argv<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">CLI</span>::<span class="org-type">ParseError</span> &amp;<span class="org-variable-name">e</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>

        <span class="org-keyword">return</span> app.exit<span class="org-rainbow-delimiters-depth-3">(</span>e<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">catch</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">exception</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; ex.what<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-constant">std</span>::endl;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
<b>Building on MacOSX</b> 
</p>

<p>
Install GCC 9.0 via <b>brew</b>. Note: Apple's default Clang compiler does
not have the C++17 file system library. 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ brew install gcc@9
</pre>
</div>

<p>
Get the code: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/caiorss/1b6826b9722ba07667eefed2f82d667e src 
$ cd src 
</pre>
</div>

<p>
Override CMake default compiler: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ export <span class="org-variable-name">CC</span>=/usr/local/Cellar/gcc@9/9.3.0/bin/gcc-9
$ export <span class="org-variable-name">CXX</span>=/usr/local/Cellar/gcc@9/9.3.0/bin/g++-9
</pre>
</div>

<p>
Configuration step: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cmake --config Release -H. -B_build
  ... .... ... ... .. ... ...
-- Checking whether CXX compiler supports OSX deployment target flag - yes
-- Check for working CXX compiler: /usr/local/Cellar/gcc@9/9.3.0/bin/g++-9
-- Check for working CXX compiler: /usr/local/Cellar/gcc@9/9.3.0/bin/g++-9 - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- CPM: adding package cli11@ ()

[TRACE] cli11_SOURCE_DIR =  /Volumes/data/cliapp/_build/_deps/cli11-src 
-- Configuring done
-- Generating done
-- Build files have been written to: /Volumes/data/cliapp/_build
</pre>
</div>

<p>
Building step: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cmake --build _build --target 
 ... ... ... ... ... ... ... ... 
 ... ... ... ... ... ... ... ... 
[ 50%] Building CXX object CMakeFiles/cliapp.dir/cliapp.cpp.o
/usr/local/Cellar/gcc@9/9.3.0/bin/g++-9   -I/Volumes/data/cliapp/_build/_deps/cli11-src/include  -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk   -std=c++17 -o <span class="org-keyword">CMakeFiles/cliapp.dir/cliapp.cpp.o</span> -c /Volumes/data/cliapp/cliapp.cpp
[100%] Linking CXX executable cliapp
/usr/local/Cellar/cmake/3.17.3/bin/cmake -E cmake_link_script CMakeFiles/cliapp.dir/link.txt --verbose=1
/usr/local/Cellar/gcc@9/9.3.0/bin/g++-9   -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk -Wl,-search_paths_first -Wl,-headerpad_max_install_names  CMakeFiles/cliapp.dir/cliapp.cpp.o  -o <span class="org-keyword">cliapp</span>  -lstdc++fs 
[100%] Built target cliapp
/usr/local/Cellar/cmake/3.17.3/bin/cmake -E cmake_progress_start /Volumes/data/cliapp/_build/CMakeFiles 0
</pre>
</div>

<p>
Check executable: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ file _build/cliapp
<span class="org-function-name">_build/cliapp</span>: Mach-O 64-bit executable x86_64
</pre>
</div>

<p>
Show command line help: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/cliapp 

cliapp
<span class="org-function-name">Usage</span>: [OPTIONS] [SUBCOMMAND]

<span class="org-function-name">Options</span>:
  -h,--help                   Print this help message and exit

<span class="org-function-name">Subcommands</span>:
  version                     Show application version.
  ls                          List directory
  list                        List directory
  server                      Run HTTP server for sharing files from some folder.


 Command line demo toolbox.
</pre>
</div>

<p>
Show help for 'server' subcommands: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/cliapp server -h
Run HTTP server for sharing files from some folder.
<span class="org-function-name">Usage</span>: _build/cliapp server [OPTIONS] &lt;PATH&gt;

<span class="org-function-name">Positionals</span>:
  &lt;PATH&gt; TEXT REQUIRED        Directory to be shared<span class="org-keyword"> in</span> the web server.

<span class="org-function-name">Options</span>:
  -h,--help                   Print this help message and exit
  -p,--port INT               Server TCP port, default: 8080
  --host TEXT                 Hostname that server will listen to (default: 0.0.0.0)
  -a,--auth                   Shows the command line parameters passed to QEMU.

Run local file sharing web server
</pre>
</div>

<p>
Show help for 'ls' subcommand: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/cliapp ls -h
List directory
<span class="org-function-name">Usage</span>: _build/cliapp ls [OPTIONS] &lt;PATH&gt;

<span class="org-function-name">Positionals</span>:
  &lt;PATH&gt; TEXT REQUIRED        Directory to be listed.

<span class="org-function-name">Options</span>:
  -h,--help                   Print this help message and exit
  -f,--file                   Only list files
  -d,--directory              Only list directories
  -r,--recursive              List direcotyr<span class="org-keyword"> in</span> recursive way


 Command line demo toolbox.
</pre>
</div>

<p>
Run <span class="underline">server</span> subcommand: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/cliapp server /var/www 
 [TRACE] ----- Callback invoked OK ------ 
 [INFO] Running web server =&gt; port = 8080 ; host = 0.0.0.0; path = /var/www 
 [INFO] Server has authentication =&gt; FALSE 

$ _build/cliapp server /var/www --port 9010 --host 127.0.0.1
 [TRACE] ----- Callback invoked OK ------ 
 [INFO] Running web server =&gt; port = 9010 ; host = 127.0.0.1; path = /var/www 
 [INFO] Server has authentication =&gt; FALSE 

$ _build/cliapp server /var/www --port 9010 --host 127.0.0.1 --auth
 [TRACE] ----- Callback invoked OK ------ 
 [INFO] Running web server =&gt; port = 9010 ; host = 127.0.0.1; path = /var/www 
 [INFO] Server has authentication =&gt; TRUE 

$ _build/cliapp server /var/www --port=9010 --host=127.0.0.1 --auth
 [TRACE] ----- Callback invoked OK ------ 
 [INFO] Running web server =&gt; port = 9010 ; host = 127.0.0.1; path = /var/www 
 [INFO] Server has authentication =&gt; TRUE 
</pre>
</div>

<p>
Run <span class="underline">ls</span> subcommand: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ _build/cliapp ls
&lt;PATH&gt; is required
Run with --help for more information.


$ _build/cliapp ls /System/Applications
  =&gt; /System/Applications/Siri.app
  =&gt; /System/Applications/Music.app
  =&gt; /System/Applications/FindMy.app
  =&gt; /System/Applications/QuickTime Player.app
  =&gt; /System/Applications/Chess.app
  =&gt; /System/Applications/Photo Booth.app
  =&gt; /System/Applications/Books.app
... ... ... ... ... ... ... ... 
... ... ... ... ... ... ... ... ... 

$ _build/cliapp ls /System/Applications/Utilities/Terminal.app --file --recursive
... ... ... ... ... ... ... ... 
... ... ... ... ... ... ... ... ... 

  =&gt; /System/Applications/Utilities/Terminal.app/Contents/Resources/ca.lproj/TTFindPanel.strings
  =&gt; /System/Applications/Utilities/Terminal.app/Contents/Info.plist
  =&gt; /System/Applications/Utilities/Terminal.app/Contents/PkgInfo
  =&gt; /System/Applications/Utilities/Terminal.app/Contents/version.plist


</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgaca1bb4" class="outline-3">
<h3 id="orgaca1bb4"><span class="section-number-3">1.7</span> System information via virtual file systems</h3>
<div class="outline-text-3" id="text-1-7">
</div>
<div id="outline-container-org3724c11" class="outline-4">
<h4 id="org3724c11"><span class="section-number-4">1.7.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-7-1">
<p>
The Linux kernel provides two official APIs (Application Programming
Interfaces) for user-space applications. The system-calls, that are
stable and well documented and often made available via GLIBC (GNU C
library). And VSF - virtual file system, which are in-memory pseudo
file systems which allow user-space applications to retrieve system
information; tune kernel runtime parameters and control device drivers
by reading and writing VSF files. 
</p>

<p>
The following code demonstrates, retrives several system information
by reading files in Linux's /proc (procfs) and /sys (sysfs) virtual
file systems.
</p>

<p>
<b>Useful files in procfs or (/proc) file system</b> 
</p>

<p>
Some files that contains useful system information are: 
</p>

<ul class="org-ul">
<li><b>/proc/version</b>
<ul class="org-ul">
<li>=&gt; Linux Kernel Version</li>
</ul></li>

<li><b>/proc/cpuinfo</b>
<ul class="org-ul">
<li>=&gt; Contains information about current CPU, such as vendor;
architecture; supported vector (SIMD) extensions; number of
cores and so on.</li>
</ul></li>

<li><b>/proc/mounts</b> (command: $ mounts )
<ul class="org-ul">
<li>=&gt; Lists all mount points and mounted file systems.</li>
</ul></li>

<li><b>/proc/partitions</b>
<ul class="org-ul">
<li>=&gt; Contain all system partitons (sda, sda1, &#x2026;, sda[N])</li>
</ul></li>

<li><b>/proc/filesystems</b>
<ul class="org-ul">
<li>=&gt; Lists all supported file system types by the current kernel.</li>
</ul></li>

<li><b>/proc/modules</b> (command: $ lsmod)
<ul class="org-ul">
<li>=&gt; Contains listing of all kernel modules loaded by the
kernel. The CLI tool <span class="underline">lsmod</span> uses this file to display the loaded
modules.</li>
</ul></li>

<li><b>/proc/meminfo</b> (command: $ free -m)
<ul class="org-ul">
<li>=&gt; Contains information about current memory.</li>
</ul></li>

<li><b>/proc/uptime</b> (command: $ uptime)
<ul class="org-ul">
<li>=&gt; Stores the CPU uptime, how long the machine is running since
boot time.</li>
</ul></li>

<li><b>/proc/loadvg</b> (command: $ uptime)
<ul class="org-ul">
<li>=&gt; Shows system load average.</li>
<li>See:</li>
</ul></li>

<li><b><i>proc/sys/kernel</i></b> (Directory) - The tool <a href="https://wiki.archlinux.org/index.php/sysctl">sysctl</a>, for tweaking
Kernel parameters, manipulates the file in this directory.

<ul class="org-ul">
<li>=&gt; This directory contains, several files which allows tuning
kernel parameters at runtime, by just reading or writing to
those files.</li>
</ul></li>

<li><b>/proc/sys/kernel/hostname</b>
<ul class="org-ul">
<li>=&gt; Contains current machine hostname, that can be changed by
writiing to this file.</li>
</ul></li>

<li><b>/proc/sys/kernel/ostype</b>
<ul class="org-ul">
<li>=&gt; Operating system type, always set to "Linux".</li>
</ul></li>

<li><b>/proc/sys/kernel/osrelease</b>
<ul class="org-ul">
<li>=&gt; Linux kernel version.</li>
</ul></li>

<li><b>/proc/sys/kernel/sysrq</b>
<ul class="org-ul">
<li>=&gt; If this file is set to '1', it allows using the magic SysRQ
key makes possible to kill hogging processes when the machine
hangs or freeze due to high memory usage.</li>
</ul></li>
</ul>

<p>
<b>Further Reading</b> 
</p>

<p>
General: 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man5/proc.5.html">proc(5) - Linux manual page</a> - PROCFS - pseudo file sytem.</li>

<li><a href="https://web.mit.edu/rhel-doc/5/RHEL-5-manual/Deployment_Guide-en-US/s1-proc-directories.html">3.3. Directories within <i>proc</i></a></li>

<li><a href="https://source.android.com/devices/architecture/kernel/reqs-interfaces">Interface Requirements  |  Android Open Source Project</a></li>

<li><a href="https://wiki.gentoo.org/wiki/Procfs">procfs - Gentoo Wiki</a></li>

<li><a href="http://0pointer.de/blog/projects/ids.html">On IDs</a> (Forensic information from Linux machines)</li>
</ul>

<p>
Kernel Runtime Settings (/proc/sys/kernel) and sysctl tool:
</p>

<ul class="org-ul">
<li><a href="http://www.linux-admins.net/2010/09/all-you-need-to-know-about-procsys.html">Linux Administration: All you need to know about /proc/sys to manipulate a running kernel</a></li>

<li><a href="https://linuxreviews.org/Kernel_panic">Kernel panic - LinuxReviews</a></li>

<li><a href="https://www.thegeekdiary.com/how-to-use-sysrq-tool-in-centos-rhel/">How to use Magic SysRq tool in CentOS / RHEL – The Geek Diary</a></li>

<li><a href="https://wiki.archlinux.org/index.php/sysctl">sysctl - ArchWiki</a> (Manipulates kernel parameters at runtime - directory: /proc/sys/kernel)</li>

<li><a href="https://linux-audit.com/linux-hardening-with-sysctl/">Linux hardening with sysctl settings - Linux Audit</a></li>
</ul>

<p>
Linux Load Average (/proc/loadavg)
</p>

<ul class="org-ul">
<li><a href="http://www.brendangregg.com/blog/2017-08-08/linux-load-averages.html">Linux Load Averages: Solving the Mystery</a> (Brendan Gregg)</li>

<li><a href="https://stackoverflow.com/questions/11987495/linux-proc-loadavg">linux /proc/loadavg - Stack Overflow</a> (How to interpret the file
/proc/loadavg)</li>

<li><a href="https://docs.fedoraproject.org/en-US/Fedora/17/html/System_Administrators_Guide/s2-proc-loadavg.html">E.2.15.  /proc/loadavg</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgbae45dd" class="outline-4">
<h4 id="orgbae45dd"><span class="section-number-4">1.7.2</span> Sample Code</h4>
<div class="outline-text-4" id="text-1-7-2">
<p>
Code available at: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/2527d1402ea1469f67fba9ab172f05e5">https://gist.github.com/2527d1402ea1469f67fba9ab172f05e5</a></li>
</ul>

<p>
File: <span class="underline">linux-info.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">/* </span><span class="org-comment">Summary: Gets Linux runtime information from VSF virtual file system. </span>
<span class="org-comment"> *</span>
<span class="org-comment-delimiter"> */</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iomanip</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">std::seprecision, std::fixed </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">See: https://man7.org/linux/man-pages/man2/sysinfo.2.html</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/sysinfo.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span>        <span class="org-function-name">get_memory_info</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span>        <span class="org-function-name">show_sysinfo1</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span>        <span class="org-function-name">show_uptime</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span>        <span class="org-function-name">show_mount_points</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span>        <span class="org-function-name">show_kernel_runtime_config</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-function-name">std</span>::string readFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">){</span>
          <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Usage: $ "</span> &lt;&lt; argv<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span> &lt;&lt; <span class="org-string">" &lt;COMMAND&gt; "</span> &lt;&lt; <span class="org-string">'\n'</span>;
          <span class="org-keyword">return</span> EXIT_FAILURE;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">auto</span> <span class="org-variable-name">command</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">{</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span> <span class="org-rainbow-delimiters-depth-2">}</span>;

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"version"</span><span class="org-rainbow-delimiters-depth-2">){</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"===== Kernel Version ===================================="</span> &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-keyword">auto</span> <span class="org-variable-name">version</span> = readFile<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/proc/version"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" System version = "</span> &lt;&lt; version &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-keyword">return</span> EXIT_SUCCESS;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"memory"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ==== Memory (Reported by command $ free -m ) ========"</span> &lt;&lt; <span class="org-string">'\n'</span>;
           get_memory_info<span class="org-rainbow-delimiters-depth-3">()</span>;
           <span class="org-keyword">return</span> EXIT_SUCCESS;
       <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-comment-delimiter">// </span><span class="org-comment">Using the header: &lt;sys/sysinfo.h&gt;  </span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">Note: this information is reported by the command $ free -m </span>
      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"sysinfo1"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ===== System Info 1 (Reported by $ free -m and $ uptime ) === "</span> &lt;&lt; <span class="org-string">'\n'</span>;
           show_sysinfo1<span class="org-rainbow-delimiters-depth-3">()</span>;
           <span class="org-keyword">return</span> EXIT_SUCCESS;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"uptime"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"===== System uptime since boot (Reported by $ uptime) ===="</span> &lt;&lt; <span class="org-string">'\n'</span>;
           show_uptime<span class="org-rainbow-delimiters-depth-3">()</span>;
           <span class="org-keyword">return</span> EXIT_SUCCESS;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"load-avg"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ==== System Load Average ================================"</span> &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-keyword">auto</span> <span class="org-variable-name">loadavg</span> = readFile<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/proc/loadavg"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Load average = "</span> &lt;&lt; loadavg &lt;&lt; <span class="org-string">'\n'</span>;   
           <span class="org-keyword">return</span> EXIT_SUCCESS;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"mount"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ====== System mount points ( Reported by command $ mount ) ===== "</span> &lt;&lt; <span class="org-string">'\n'</span>;
           show_mount_points<span class="org-rainbow-delimiters-depth-3">()</span>;
           <span class="org-keyword">return</span> EXIT_SUCCESS;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"sysctl"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ===== Kernel Runtime Information (Reported by $ sysctl ) ======= "</span> &lt;&lt; <span class="org-string">'\n'</span>;
           show_kernel_runtime_config<span class="org-rainbow-delimiters-depth-3">()</span>;
           <span class="org-keyword">return</span> EXIT_SUCCESS;
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"dmesg"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ===== Kernel debug message (Reported by $ dmesg ) =========="</span> &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/dev/kmsg"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
           <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>;
           <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-4">(</span>ifs, line<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">){</span>
                   <span class="org-constant">std</span>::cout &lt;&lt; line &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-rainbow-delimiters-depth-3">}</span>
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>command == <span class="org-string">"cpuinfo"</span><span class="org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"======= CPU Information ====================================="</span> &lt;&lt; <span class="org-string">'\n'</span>;

           <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"/proc/cpuinfo"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
           <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>;
           <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-4">(</span>ifs, line<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">){</span>
                   <span class="org-constant">std</span>::cout &lt;&lt; line &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-rainbow-delimiters-depth-3">}</span>        
      <span class="org-rainbow-delimiters-depth-2">}</span>

      <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">get_memory_info</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-keyword">constexpr</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">meminfo_file</span> = <span class="org-string">"/proc/meminfo"</span>;
     <span class="org-comment-delimiter">// </span><span class="org-comment">factor = 1 Gigabytes = 1024 * 1024 kbytes </span>
     <span class="org-keyword">constexpr</span> <span class="org-type">double</span> <span class="org-variable-name">factor</span> = 1024 * 1024;

     <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-2">{</span>meminfo_file<span class="org-rainbow-delimiters-depth-2">}</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>ifs.good<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">){</span>
             <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to memory-info file."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>, <span class="org-variable-name">label</span>;
     <span class="org-constant">std</span>::<span class="org-type">uint64_t</span> <span class="org-variable-name">value</span>; 
     <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-3">(</span>ifs, line<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>      
          <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span><span class="org-rainbow-delimiters-depth-3">{</span>line<span class="org-rainbow-delimiters-depth-3">}</span>;   
          ss &gt;&gt; label &gt;&gt; value;

          <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>label == <span class="org-string">"MemTotal:"</span><span class="org-rainbow-delimiters-depth-3">)</span>
                  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"     Total memory (Gb) = "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span>value / factor<span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

          <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>label == <span class="org-string">"MemAvailable:"</span><span class="org-rainbow-delimiters-depth-3">)</span>      
                  <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Memory Available (Gb) = "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span>value / factor<span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">show_sysinfo1</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-keyword">struct</span> <span class="org-type">sysinfo</span> <span class="org-variable-name">info</span>;
     ::sysinfo<span class="org-rainbow-delimiters-depth-2">(</span>&amp;info<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">1 Gigabyte = 1024 megabytes = 1024 * 1024 kbytes = 1024 * 1024 * 1024 bytes;</span>
     <span class="org-keyword">constexpr</span> <span class="org-type">double</span> <span class="org-variable-name">factor</span> = 1024 * 1024 * 1024;
     <span class="org-keyword">constexpr</span> <span class="org-constant">std</span>::<span class="org-type">uint64_t</span> <span class="org-variable-name">one_day_to_seconds</span> = 24 * 60 * 60;

     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] System uptime since boot (seconds) = "</span> &lt;&lt; info.uptime &lt;&lt; <span class="org-string">'\n'</span>
                       &lt;&lt; <span class="org-string">" [*] System uptime since boot    (days) = "</span> &lt;&lt; info.uptime    / one_day_to_seconds &lt;&lt; <span class="org-string">'\n'</span>
                       &lt;&lt; <span class="org-string">" [*]              Total RAM memory (Gb) = "</span> &lt;&lt; info.totalram  / factor &lt;&lt; <span class="org-string">'\n'</span>
                       &lt;&lt; <span class="org-string">" [*]              Free  RAM memory (Gb) = "</span> &lt;&lt; info.freeram   / factor &lt;&lt; <span class="org-string">'\n'</span>
                       &lt;&lt; <span class="org-string">" [*]                    Total SWAP (Gb) = "</span> &lt;&lt; info.totalswap / factor &lt;&lt; <span class="org-string">'\n'</span>                 
                       &lt;&lt; <span class="org-string">" [*]                     Free SWAP (Gb) = "</span> &lt;&lt; info.freeswap  / factor &lt;&lt; <span class="org-string">'\n'</span>                                 
                       &lt;&lt; <span class="org-string">" [*]        Number of processes running = "</span> &lt;&lt; info.procs &lt;&lt; <span class="org-string">'\n'</span>
                       &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Reported by command $ uptime </span>
<span class="org-type">void</span> <span class="org-function-name">show_uptime</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
     <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/proc/uptime"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>ifs.good<span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to open uptime file "</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-type">double</span> <span class="org-variable-name">seconds</span>;
     ifs &gt;&gt; seconds; 
     <span class="org-type">uint64_t</span> <span class="org-variable-name">factor</span> = 24 * 60 * 60;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"   Uptime in hours = "</span> &lt;&lt; seconds / <span class="org-rainbow-delimiters-depth-2">(</span> 60 * 60<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"    Uptime in days = "</span> &lt;&lt; seconds / factor &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">void</span> <span class="org-function-name">show_kernel_runtime_config</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">show_field</span>= <span class="org-rainbow-delimiters-depth-2">[](</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">label</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [*] "</span> 
                   &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-3">(</span>40<span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; <span class="org-constant">std</span>::right &lt;&lt; <span class="org-rainbow-delimiters-depth-3">(</span>label + <span class="org-string">" =&gt; "</span><span class="org-rainbow-delimiters-depth-3">)</span>
                   &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-3">(</span>50<span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; <span class="org-constant">std</span>::left  &lt;&lt; readFile<span class="org-rainbow-delimiters-depth-3">(</span>file<span class="org-rainbow-delimiters-depth-3">)</span>
                   &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">'\n'</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Machine Hostname"</span>,                <span class="org-string">"/proc/sys/kernel/hostname"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Kernel Version"</span>,                  <span class="org-string">"/proc/sys/kernel/osrelease"</span><span class="org-rainbow-delimiters-depth-2">)</span>;    
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Os type"</span>,                         <span class="org-string">"/proc/sys/kernel/ostype"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Boot unique ID identifier"</span>,       <span class="org-string">"/proc/sys/kernel/random/boot_id"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Date which kernel was compiled"</span>,  <span class="org-string">"/proc/sys/kernel/version"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Sysrq enabled (Emergency keys)"</span>,  <span class="org-string">"/proc/sys/kernel/sysrq"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Max number of Cgroups namespaces"</span>, <span class="org-string">"/proc/sys/user/max_cgroup_namespaces"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    show_field<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Max number of Mount namespaces"</span>,   <span class="org-string">"/proc/sys/user/max_net_namespaces"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">void</span> <span class="org-function-name">show_network_interfaces</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: not implemented yet."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Show mounted file systems, but ignore 'cgroup', 'overlay', 'fusectl'   </span>
<span class="org-type">void</span> <span class="org-function-name">show_mount_points</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/proc/mounts"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>ifs<span class="org-rainbow-delimiters-depth-2">){</span> 
             <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to open file /proc/mounts"</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">'\n'</span>;
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"    "</span> 
               &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-2">(</span>20<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; <span class="org-string">"File system"</span> 
               &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-2">(</span>20<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; <span class="org-string">"Type"</span>
               &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-2">(</span>10<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; <span class="org-string">"Mount point"</span>
               &lt;&lt; <span class="org-string">'\n'</span>;

     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"    "</span> 
               &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-2">(</span>20<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; <span class="org-string">"------------"</span> 
               &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-2">(</span>20<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; <span class="org-string">"----"</span>
               &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-2">(</span>10<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; <span class="org-string">"-----------"</span>
               &lt;&lt; <span class="org-string">'\n'</span>;

     <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>, <span class="org-variable-name">fsystem</span>, <span class="org-variable-name">type</span>, <span class="org-variable-name">mount_directory</span>;  

     <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-3">(</span>ifs, line<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">ss</span> = <span class="org-constant">std</span>::stringstream<span class="org-rainbow-delimiters-depth-3">(</span>line<span class="org-rainbow-delimiters-depth-3">)</span>;
        ss &gt;&gt; fsystem &gt;&gt; mount_directory &gt;&gt; type;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> type != <span class="org-string">"cgroup"</span> &amp;&amp; type != <span class="org-string">"overlay"</span> &amp;&amp; type != <span class="org-string">"cgroup2"</span><span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"   "</span> 
                      &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>20<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; fsystem 
                      &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>20<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; type 
                      &lt;&lt; <span class="org-constant">std</span>::setw<span class="org-rainbow-delimiters-depth-4">(</span>10<span class="org-rainbow-delimiters-depth-4">)</span> &lt;&lt; <span class="org-constant">std</span>::left &lt;&lt; mount_directory 
                      &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
     <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Requires: &lt;string&gt;, &lt;stream&gt;, &lt;sstream&gt;</span>
<span class="org-function-name">std</span>::string readFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">file</span><span class="org-rainbow-delimiters-depth-1">)</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">ifstream</span> <span class="org-variable-name">is</span><span class="org-rainbow-delimiters-depth-2">(</span>file<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-negation-char">!</span>is.good<span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: stream has errors."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-constant">std</span>::<span class="org-type">stringstream</span> <span class="org-variable-name">ss</span>;
    ss &lt;&lt; is.rdbuf<span class="org-rainbow-delimiters-depth-2">()</span>;   
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Remove ending line character '\n' or '\r\n'.</span>
        <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-2">(</span>ss, m<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> m;
<span class="org-rainbow-delimiters-depth-1">}</span> 

</pre>
</div>
</div>
</div>

<div id="outline-container-orgca04156" class="outline-4">
<h4 id="orgca04156"><span class="section-number-4">1.7.3</span> Running</h4>
<div class="outline-text-4" id="text-1-7-3">
<p>
<b>Building:</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ linux-info.cpp -o <span class="org-keyword">linux-info</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
<b>Running</b>  (Tested on Linux distribution <a href="https://pop.system76.com/">PopOS</a> Live CD running in a virtual machine)
</p>

<p>
Get Kernel Version: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./linux-info 
 [ERROR] Usage: $ ./linux-info &lt;COMMAND&gt; 

 $ &gt;&gt; ./linux-info version <span class="org-comment-delimiter"># </span><span class="org-comment">Get Kernel version</span>
===== Kernel Version ====================================
 System version = Linux version 5.4.0-7634-generic (buildd@lcy01-amd64-003) (gcc version 9.3.0 (Ubuntu 9.3.0-10ubuntu2)) <span class="org-comment-delimiter">#</span><span class="org-comment">38~1591219791~20.04~6b1c5de-Ubuntu SMP Thu Jun 4 02:56:10 UTC 2</span>
 $ &gt;&gt; 
</pre>
</div>

<p>
Get RAM memory available (equivalent to $ free -m)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./linux-info memory <span class="org-comment-delimiter"># </span><span class="org-comment">RAM memory </span>
==== Memory (Reported by command $ free -m ) ========
    Total memory (Gb) = 1.9175
Memory Available (Gb) = 1.01926
</pre>
</div>

<p>
System uptime and RAM memory available: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./linux-info sysinfo1 
===== System Info 1 (Reported by $ free -m and $ uptime ) === 
[*] System uptime since boot (seconds) = 760
[*] System uptime since boot    (days) = 0
[*]              Total RAM memory (Gb) = 1.9175
[*]              Free  RAM memory (Gb) = 0.20657
[*]                    Total SWAP (Gb) = 0
[*]                     Free SWAP (Gb) = 0
[*]        Number of processes running = 444
</pre>
</div>

<p>
Load average: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./linux-info load-avg
 ==== System Load Average ================================
Load average = 0.27 0.28 0.28 4/443 2532

</pre>
</div>

<p>
Mounted file systems (file: /proc/mounts)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./linux-info mount 
====== System mount points ( Reported by command $ mount ) ===== 

   File system         Type                Mount point
   ------------        ----                -----------
  sysfs               sysfs               /sys      
  proc                proc                /proc     
  udev                devtmpfs            /dev      
  devpts              devpts              /dev/pts  
  tmpfs               tmpfs               /run      
  /dev/sr0            iso9660             /cdrom    
  /dev/loop0          squashfs            /rofs     
  securityfs          securityfs          /sys/kernel/security
  tmpfs               tmpfs               /dev/shm  
  tmpfs               tmpfs               /run/lock 

 ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 
 ...  ...  ...  ...  ...  ...  ...  ...  ...  ... 

  debugfs             debugfs             /sys/kernel/debug
  tracefs             tracefs             /sys/kernel/tracing
  fusectl             fusectl             /sys/fs/fuse/connections
  configfs            configfs            /sys/kernel/config
  tmpfs               tmpfs               /tmp      
  tmpfs               tmpfs               /run/user/999
  gvfsd-fuse          fuse.gvfsd-fuse     /run/user/999/gvfs
  /dev/fuse           fuse                /run/user/999/doc
  /dev/fuse           fuse                /root/.cache/doc
  gvfsd-fuse          fuse.gvfsd-fuse     /root/.cache/gvfs
  binfmt_misc         binfmt_misc         /proc/sys/fs/binfmt_misc
</pre>
</div>

<p>
Kernel runtime information (directory <span class="underline">/proc/sys/kernel</span>)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./linux-info sysctl <span class="org-comment-delimiter"># </span><span class="org-comment">Show some kernel runtime options</span>
===== Kernel Runtime Information (Reported by $ sysctl ) ======= 

[*]                     Machine Hostname =&gt; pop-os                                            
[*]                       Kernel Version =&gt; 5.4.0-7634-generic                                
[*]                              Os type =&gt; Linux                                             
[*]            Boot unique ID identifier =&gt; 756989d9-f596-4e4f-ac50-d5c3026d041a              
[*]       Date which kernel was compiled =&gt; <span class="org-comment-delimiter">#</span><span class="org-comment">38~1591219791~20.04~6b1c5de-Ubuntu SMP Thu Jun 4 02:56:10 UTC 2</span>
[*]       Sysrq enabled (Emergency keys) =&gt; 176                                               
[*]     Max number of Cgroups namespaces =&gt; 7490                                              
[*]       Max number of Mount namespaces =&gt; 7490                                              
</pre>
</div>

<p>
Kernel messages (file: <span class="underline">/dev/kmsg</span>)
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./linux-info dmesg

 ===== Kernel debug message (Reported by $ dmesg ) ==========
5,0,0,-;Linux version 5.4.0-7634-generic (buildd@lcy01-amd64-003) (gcc version 9.3.0 (Ubuntu 9.3.0-10ubuntu2)) <span class="org-comment-delimiter">#</span><span class="org-comment">38~1591219791~20.04~6b1c5de-Ubuntu SMP Thu Jun 4 02:56:10 UTC 2 (Ubuntu 5.4.0-7634.38~1591219791~20.04~6b1c5de-generic 5.4.41)</span>
6,1,0,-;Command line: <span class="org-variable-name">BOOT_IMAGE</span>=/casper_pop-os_20.04_amd64_intel_debug_19/vmlinuz.efi <span class="org-variable-name">initrd</span>=/casper_pop-os_20.04_amd64_intel_debug_19/initrd.gz <span class="org-variable-name">boot</span>=casper live-media-path=/casper_pop-os_20.04_amd64_intel_debug_19 <span class="org-variable-name">hostname</span>=pop-os <span class="org-variable-name">username</span>=pop-os noprompt  ---
6,2,0,-;KERNEL supported cpus:
6,3,0,-;  Intel GenuineIntel
  ....   ....   ....   ....   ....   ....   .... 
  ....   ....   ....   ....   ....   ....   .... 

 <span class="org-variable-name">DEVICE</span>=+hdaudio:hdaudioC0D0
6,649,16644546,-;snd_hda_codec_generic hdaudioC0D0:    inputs:
 <span class="org-variable-name">SUBSYSTEM</span>=hdaudio
 <span class="org-variable-name">DEVICE</span>=+hdaudio:hdaudioC0D0
7,650,25338660,-;rfkill: input handler disabled
5,651,40422354,-;random: crng init done
5,652,40422357,-;random: 7 urandom warning(s) missed due to ratelimiting
</pre>
</div>

<p>
<b>Testing with Fedora 32 x86-64 (64 bits)</b> 
</p>

<p>
Get mount points (file: <span class="underline">/proc/mounts</span>)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./linux-info mount
 ====== System mount points ( Reported by command $ mount ) ===== 

    File system         Type                Mount point
    ------------        ----                -----------
   sysfs               sysfs               /sys      
   proc                proc                /proc     
   devtmpfs            devtmpfs            /dev      
   securityfs          securityfs          /sys/kernel/security
   tmpfs               tmpfs               /dev/shm  
   devpts              devpts              /dev/pts  
   tmpfs               tmpfs               /run      
   tmpfs               tmpfs               /sys/fs/cgroup
   pstore              pstore              /sys/fs/pstore
   efivarfs            efivarfs            /sys/firmware/efi/efivars
   none                bpf                 /sys/fs/bpf
   configfs            configfs            /sys/kernel/config
   /dev/sda3           ext4                /         
   systemd-1           autofs              /proc/sys/fs/binfmt_misc
   tmpfs               tmpfs               /tmp      
   fusectl             fusectl             /sys/fs/fuse/connections
   /dev/sda1           vfat                /boot/efi 
   sunrpc              rpc_pipefs          /var/lib/nfs/rpc_pipefs
   tmpfs               tmpfs               /run/user/42
   tmpfs               tmpfs               /run/user/1000
   gvfsd-fuse          fuse.gvfsd-fuse     /run/user/1000/gvfs
   nsfs                nsfs                /run/docker/netns/77290c7a4863
   binfmt_misc         binfmt_misc         /proc/sys/fs/binfmt_misc
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org95f6c94" class="outline-3">
<h3 id="org95f6c94"><span class="section-number-3">1.8</span> Disk Space Usage on Linux and BSD-variants</h3>
<div class="outline-text-3" id="text-1-8">
<p>
The following code gets the disk space usage on Linux-derived
operating systems by iterating over the file <span class="underline">/proc/mounts</span> for
determining mounted file systems and then uses the <span class="underline">statfs()</span> function
for getting disk usage information from each file system mount
point. Unlike, Linux On BSD variants such, as FreeBSD, OpenBSD and
Mac-OSX, there is no PROCFS virtual file system. On those operating
systems, the information about disk space usage can be obtained in a
single step by using the function <a href="https://www.freebsd.org/cgi/man.cgi?query=getmntinfo&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">getmntinfo()</a>.
</p>

<p>
<b>Functions used</b> 
</p>

<ul class="org-ul">
<li>Documentation: $ man statfs</li>
<li>The functions <span class="underline">statfs</span> and <span class="underline">fstatfs</span> provide information about
mounted file systems. The parameter buf, must be allocated by the
caller. When the function fails, it returns (-1).</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/vfs.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    <span class="org-comment-delimiter">/* </span><span class="org-comment">or &lt;sys/statfs.h&gt;</span><span class="org-comment-delimiter"> */</span>

<span class="org-type">int</span> <span class="org-function-name">statfs</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">path</span>, <span class="org-keyword">struct</span> <span class="org-type">statfs</span> *<span class="org-variable-name">buf</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">int</span> <span class="org-function-name">fstatfs</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">struct</span> <span class="org-type">statfs</span> *<span class="org-variable-name">buf</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">struct</span> <span class="org-type">statfs</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">__fsword_t</span> <span class="org-variable-name">f_type</span>;    <span class="org-comment-delimiter">/* </span><span class="org-comment">Type of filesystem (see below)</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">__fsword_t</span> <span class="org-variable-name">f_bsize</span>;   <span class="org-comment-delimiter">/* </span><span class="org-comment">Optimal transfer block size</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">fsblkcnt_t</span> <span class="org-variable-name">f_blocks</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">Total data blocks in filesystem</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">fsblkcnt_t</span> <span class="org-variable-name">f_bfree</span>;   <span class="org-comment-delimiter">/* </span><span class="org-comment">Free blocks in filesystem</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">fsblkcnt_t</span> <span class="org-variable-name">f_bavail</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">Free blocks available to</span>
<span class="org-comment">                             unprivileged user</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">fsfilcnt_t</span> <span class="org-variable-name">f_files</span>;   <span class="org-comment-delimiter">/* </span><span class="org-comment">Total file nodes in filesystem</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">fsfilcnt_t</span> <span class="org-variable-name">f_ffree</span>;   <span class="org-comment-delimiter">/* </span><span class="org-comment">Free file nodes in filesystem</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">fsid_t</span>     <span class="org-variable-name">f_fsid</span>;    <span class="org-comment-delimiter">/* </span><span class="org-comment">Filesystem ID</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">__fsword_t</span> <span class="org-variable-name">f_namelen</span>; <span class="org-comment-delimiter">/* </span><span class="org-comment">Maximum length of filenames</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">__fsword_t</span> <span class="org-variable-name">f_frsize</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">Fragment size (since Linux 2.6)</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">__fsword_t</span> <span class="org-variable-name">f_flags</span>;   <span class="org-comment-delimiter">/* </span><span class="org-comment">Mount flags of filesystem</span>
<span class="org-comment">                             (since Linux 2.6.36)</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">__fsword_t</span> <span class="org-variable-name">f_spare</span><span class="org-rainbow-delimiters-depth-2">[</span>xxx<span class="org-rainbow-delimiters-depth-2">]</span>;
                    <span class="org-comment-delimiter">/* </span><span class="org-comment">Padding bytes reserved for future use</span><span class="org-comment-delimiter"> */</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
<b>Sample Code</b> 
</p>

<p>
File: <span class="underline">df-size.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">----- Get Disk Space Usage -------------// </span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">algorithm</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iomanip</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cmath</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">------ Unix Headers ----//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/vfs.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    <span class="org-comment-delimiter">/* </span><span class="org-comment">Get statfs()</span><span class="org-comment-delimiter"> */</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">limits.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">struct</span> <span class="org-type">mount_point</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">File System </span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">fsystem</span>; 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Mounting directroy </span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">mount_directory</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">File system type </span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">type</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">MountpointConsumer</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> 
<span class="org-type">void</span> <span class="org-function-name">iterate_mount_points</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">MountpointConsumer</span>&amp;&amp; <span class="org-variable-name">consumer</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">auto</span> <span class="org-function-name">read_symlink</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> ;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

   iterate_mount_points<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">[](</span><span class="org-type">mount_point</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">mnt</span><span class="org-rainbow-delimiters-depth-3">)</span>
   <span class="org-rainbow-delimiters-depth-3">{</span>
       <span class="org-keyword">struct</span> <span class="org-type">statfs</span> <span class="org-variable-name">fs</span>;
       <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">mount_dir</span> = mnt.mount_directory.c_str<span class="org-rainbow-delimiters-depth-4">()</span>;

       <span class="org-comment-delimiter">// </span><span class="org-comment">=&gt;&gt;&gt; List of file system that will be ignored. </span>
       <span class="org-comment-delimiter">// </span><span class="org-comment">'static' keyworkd =&gt;  Variable allocated only once, when </span>
       <span class="org-comment-delimiter">// </span><span class="org-comment">this function is called for the first time. </span>
       <span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-keyword">auto</span> <span class="org-variable-name">ignored_fsystem</span> = <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-4">&gt;{</span>
             <span class="org-string">"cgroup"</span>, <span class="org-string">"cgroup2"</span>, <span class="org-string">"proc"</span>, <span class="org-string">"sysfs"</span>, <span class="org-string">"tmpfs"</span>, <span class="org-string">"devtmpfs"</span>
           , <span class="org-string">"configfs"</span>, <span class="org-string">"bpf"</span>, <span class="org-string">"mqueue"</span>, <span class="org-string">"hugetlbfs"</span>, <span class="org-string">"tracefs"</span>
           , <span class="org-string">"fuse.gvfsd-fuse"</span>, <span class="org-string">"rpc_pipefs"</span>, <span class="org-string">"debugfs"</span>
           , <span class="org-string">"overlay"</span>, <span class="org-string">"securityfs"</span>, <span class="org-string">"devpts"</span>, <span class="org-string">"pstore"</span>, <span class="org-string">"efivarfs"</span>
           , <span class="org-string">"autofs"</span>, <span class="org-string">"binfmt_misc"</span>, <span class="org-string">"tmpfs"</span>, <span class="org-string">"fusectl"</span>, <span class="org-string">"nsfs"</span>
           , <span class="org-string">"selinuxfs"</span>, <span class="org-string">"functionfs"</span>
        <span class="org-rainbow-delimiters-depth-4">}</span>;

       <span class="org-comment-delimiter">// </span><span class="org-comment">Ignore the following types of file-system, mostly VSF (Virtual File Systems)</span>
       <span class="org-comment-delimiter">// </span><span class="org-comment">or in-memory file systems.</span>
       <span class="org-keyword">auto</span> <span class="org-variable-name">iter</span> = <span class="org-constant">std</span>::find<span class="org-rainbow-delimiters-depth-4">(</span>ignored_fsystem.cbegin<span class="org-rainbow-delimiters-depth-5">()</span>, ignored_fsystem.cend<span class="org-rainbow-delimiters-depth-5">()</span>, mnt.type <span class="org-rainbow-delimiters-depth-4">)</span>;
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> iter != ignored_fsystem.end<span class="org-rainbow-delimiters-depth-5">()</span> <span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-keyword">return</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-variable-name">statfs</span><span class="org-rainbow-delimiters-depth-5">(</span>mount_dir, &amp;fs<span class="org-rainbow-delimiters-depth-5">)</span> == -1 <span class="org-rainbow-delimiters-depth-4">)</span>
       <span class="org-rainbow-delimiters-depth-4">{</span>
           <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [ERROR] Unable to get file system statistics for: "</span> 
                     &lt;&lt; <span class="org-string">" Mount point =&gt; "</span> &lt;&lt; mnt.mount_directory 
                     &lt;&lt; <span class="org-string">" / "</span> &lt;&lt; mnt.fsystem.c_str<span class="org-rainbow-delimiters-depth-5">()</span> 
                     &lt;&lt; <span class="org-string">'\n'</span>;
           <span class="org-keyword">return</span>;
       <span class="org-rainbow-delimiters-depth-4">}</span>

       <span class="org-keyword">const</span> <span class="org-type">size_t</span> <span class="org-variable-name">block_size</span> = fs.f_bsize;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Total disk space in Gigabytes </span>
       <span class="org-keyword">const</span> <span class="org-type">double</span> <span class="org-variable-name">total_space</span> = <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>fs.f_blocks<span class="org-rainbow-delimiters-depth-4">)</span> * block_size / <span class="org-rainbow-delimiters-depth-4">(</span>1024 * 1024 * 1024<span class="org-rainbow-delimiters-depth-4">)</span>;
       <span class="org-comment-delimiter">// </span><span class="org-comment">Free disk space in Gigabytes </span>
       <span class="org-keyword">const</span> <span class="org-type">double</span> <span class="org-variable-name">available_space</span> = <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>fs.f_bavail<span class="org-rainbow-delimiters-depth-4">)</span> * block_size / <span class="org-rainbow-delimiters-depth-4">(</span>1024 * 1024 * 1024<span class="org-rainbow-delimiters-depth-4">)</span>;
       <span class="org-comment-delimiter">// </span><span class="org-comment">Disk space usage in Gigabytes </span>
       <span class="org-keyword">const</span> <span class="org-type">double</span> <span class="org-variable-name">used_space</span> = total_space - available_space;

       <span class="org-comment-delimiter">// </span><span class="org-comment">Disk space usage in percent (%) </span>
       <span class="org-keyword">const</span> <span class="org-type">double</span> <span class="org-variable-name">used_space_pct</span> = <span class="org-rainbow-delimiters-depth-4">(</span>1.0 - available_space / total_space<span class="org-rainbow-delimiters-depth-4">)</span> * 100.0;

       <span class="org-keyword">auto</span> <span class="org-variable-name">fsystem_abspath</span> = read_symlink<span class="org-rainbow-delimiters-depth-4">(</span>mnt.fsystem<span class="org-rainbow-delimiters-depth-4">)</span>;

       <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"      File System: "</span> &lt;&lt; fsystem_abspath      &lt;&lt; <span class="org-string">'\n'</span>
                 &lt;&lt; <span class="org-string">"             Type: "</span> &lt;&lt; mnt.type             &lt;&lt; <span class="org-string">'\n'</span>       
                 &lt;&lt; <span class="org-string">"      Mount Point: "</span> &lt;&lt; mnt.mount_directory  &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>total_space &gt; 1.0<span class="org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Total space (Gb): "</span> &lt;&lt; total_space            &lt;&lt; <span class="org-string">'\n'</span>
                      &lt;&lt; <span class="org-string">"  Free space (Gb): "</span> &lt;&lt; available_space        &lt;&lt; <span class="org-string">'\n'</span>
                      &lt;&lt; <span class="org-string">"  Used space (Gb): "</span> &lt;&lt; used_space             &lt;&lt; <span class="org-string">'\n'</span>                      
                      &lt;&lt; <span class="org-string">"   Used space (%): "</span> &lt;&lt; used_space_pct &lt;&lt;  <span class="org-string">"%"</span> &lt;&lt; <span class="org-string">'\n'</span>
                      &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-4">{</span>
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  Free space (Mb): "</span> &lt;&lt; available_space * 1024  &lt;&lt; <span class="org-string">'\n'</span>
                      &lt;&lt; <span class="org-string">" Total space (Mb): "</span> &lt;&lt; total_space * 1024      &lt;&lt; <span class="org-string">'\n'</span>
                      &lt;&lt; <span class="org-string">"  Used space (Gb): "</span> &lt;&lt; used_space * 1024       &lt;&lt; <span class="org-string">'\n'</span>                                            
                      &lt;&lt; <span class="org-string">"   Used space (%): "</span> &lt;&lt; used_space_pct &lt;&lt; <span class="org-string">"%"</span>   &lt;&lt; <span class="org-string">'\n'</span>
                      &lt;&lt; <span class="org-string">'\n'</span>;

        <span class="org-rainbow-delimiters-depth-4">}</span>
   <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;

        <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">----------------------------------------------------------------------//</span>

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">MountpointConsumer</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> 
<span class="org-type">void</span> <span class="org-function-name">iterate_mount_points</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">MountpointConsumer</span>&amp;&amp; <span class="org-variable-name">consumer</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">ifs</span> = <span class="org-constant">std</span>::ifstream<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/proc/mounts"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>ifs<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: unable to open file /proc/mounts"</span><span class="org-rainbow-delimiters-depth-2">)</span>;     
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>, <span class="org-variable-name">fsystem</span>, <span class="org-variable-name">mount_directory</span>, <span class="org-variable-name">type</span>; 

    <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-3">(</span>ifs, line<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">ss</span> = <span class="org-constant">std</span>::stringstream<span class="org-rainbow-delimiters-depth-3">(</span>line<span class="org-rainbow-delimiters-depth-3">)</span>;
        ss &gt;&gt; fsystem &gt;&gt; mount_directory &gt;&gt; type;
        consumer<span class="org-rainbow-delimiters-depth-3">(</span> mount_point<span class="org-rainbow-delimiters-depth-4">{</span> fsystem, mount_directory, type <span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">//</span><span class="org-comment">if( type != "cgroup" &amp;&amp; type != "overlay" &amp;&amp; type != "cgroup2")        </span>
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Get absolute path to file or symbolic link </span>
<span class="org-keyword">auto</span> <span class="org-function-name">read_symlink</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Create a buffer with size PATH_MAX + 1 filled with 0 ('\0'), null characters</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">(</span>PATH_MAX, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">ssize_t readlink(const char *pathname, char *buf, size_t bufsiz);</span>
    <span class="org-type">ssize_t</span> <span class="org-variable-name">nread</span> = ::readlink<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, PATH_MAX<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>nread == -1<span class="org-rainbow-delimiters-depth-2">){</span> <span class="org-keyword">return</span> path; <span class="org-rainbow-delimiters-depth-2">}</span>
    buffer.resize<span class="org-rainbow-delimiters-depth-2">(</span>nread<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> buffer;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
<b>Building and Running on Fedora Linux 32 x86-64</b> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; g++ df-size.cpp -o <span class="org-keyword">df-size.bin</span> -std=c++1z -Wall -Wextra -g 

$ &gt;&gt; ./df-size.bin 
     File System: /dev/sda3
            Type: ext4
     Mount Point: /
Total space (Gb): 49.06
 Free space (Gb): 23.9494
 Used space (Gb): 25.1106
  Used space (%): 51.1835%

     File System: /dev/sda4
            Type: ext4
     Mount Point: /home
Total space (Gb): 846.607
 Free space (Gb): 510.182
 Used space (Gb): 336.424
  Used space (%): 39.738%

     File System: /dev/sda1
            Type: vfat
     Mount Point: /boot/efi
 Free space (Mb): 279.422
Total space (Mb): 299.82
 Used space (Gb): 20.3984
  Used space (%): 6.80355%
</pre>
</div>

<p>
Disk space via (df) command line tool: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; df -h 
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs        7.8G     0  7.8G   0% /dev
tmpfs           7.8G  315M  7.5G   4% /dev/shm
tmpfs           7.8G  2.1M  7.8G   1% /run
tmpfs           7.8G     0  7.8G   0% /sys/fs/cgroup
/dev/sda3        50G   23G   24G  49% /
tmpfs           7.8G   11M  7.8G   1% /tmp
/dev/sda4       847G  294G  511G  37% /home
/dev/sda1       300M   21M  280M   7% /boot/efi
tmpfs           1.6G   16K  1.6G   1% /run/user/42
tmpfs           1.6G   80K  1.6G   1% /run/user/1000
</pre>
</div>

<p>
<b>Cross-compiling to Linux Armv7 and run on Android via ADB</b>
</p>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ export <span class="org-variable-name">DOCKER_COMMAND</span>=<span class="org-string">"docker run -e UID=$(</span><span class="org-sh-quoted-exec">id</span><span class="org-string"> -u) -e GID=$(</span><span class="org-sh-quoted-exec">id</span><span class="org-string"> -g) --volume=$PWD:/cwd --workdir=/cwd muslcc/i686:armv7l-linux-musleabihf "</span>
$ $<span class="org-variable-name">DOCKER_COMMAND</span> g++ df-size.cpp -o <span class="org-keyword">df-size.armv7</span> -std=c++1z -static -Wall -Wextra
$ $<span class="org-variable-name">DOCKER_COMMAND</span> strip df-size.armv7 

$ file df-size.armv7 
<span class="org-function-name">df-size.armv7</span>: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, stripped

$ du -h df-size.armv7 
820K    df-size.armv7
820K    total
</pre>
</div>

<p>
Transfer executable to Android: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ adb push df-size.armv7 /data/local/tmp
<span class="org-function-name">df-size.armv7</span>: 1 file pushed. 12.1 MB/s (839348 bytes<span class="org-keyword"> in</span> 0.066s)
</pre>
</div>

<p>
Running on Android vai adb shell: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ adb shell
<span class="org-function-name">bali</span>:/ $ 
<span class="org-function-name">bali</span>:/ $ cd /data/local/tmp
<span class="org-function-name">bali</span>:/data/local/tmp $ 

<span class="org-comment-delimiter"># </span><span class="org-comment">Confirm disk space usage metrics </span>
<span class="org-function-name">bali</span>:/data/local/tmp $ df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/root             2.6G  2.2G  450M  84% /
tmpfs                 931M  1.3M  930M   1% /dev
tmpfs                 931M     0  931M   0% /mnt
/dev/block/dm-1       1.4G  207M  1.2G  15% /vendor
/dev/block/mmcblk0p39  23G   12G   11G  53% /data
/dev/block/mmcblk0p38 402M  6.4M  383M   2% /cache
/data/media            23G   12G   11G  53% /storage/emulated

<span class="org-comment-delimiter"># </span><span class="org-comment">Run application </span>
<span class="org-function-name">bali</span>:/data/local/tmp $ ./df-size.armv7  2&gt; /dev/null                                                         
      File System: /dev/root
             Type: ext4
      Mount Point: /
 Total space (Gb): 2.66402
  Free space (Gb): 0.439049
  Used space (Gb): 2.22497
   Used space (%): 83.5193%

      File System: /dev/block/dm-1
             Type: ext4
      Mount Point: /vendor
 Total space (Gb): 1.45304
  Free space (Gb): 1.23495
  Used space (Gb): 0.218094
   Used space (%): 15.0094%

      File System: /dev/block/mmcblk0p39
             Type: f2fs
      Mount Point: /data
 Total space (Gb): 23.4941
  Free space (Gb): 11.2018
  Used space (Gb): 12.2923
   Used space (%): 52.3209%

      File System: /dev/block/mmcblk0p38
             Type: ext4
      Mount Point: /cache
  Free space (Mb): 383.078
 Total space (Mb): 402.445
  Used space (Gb): 19.3672
   Used space (%): 4.81238%

      File System: /dev/block/mmcblk0p35
             Type: ext4
      Mount Point: /product
  Free space (Mb): 444.348
 Total space (Mb): 476.59
  Used space (Gb): 32.2422
   Used space (%): 6.76519%

      File System: /data/media
             Type: sdcardfs
      Mount Point: /storage/emulated
 Total space (Gb): 23.4941
  Free space (Gb): 11.2018
  Used space (Gb): 12.2923
   Used space (%): 52.3209%
</pre>
</div>

<p>
<b>Further Reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://pubs.opengroup.org/onlinepubs/009695399/functions/statvfs.html">Unix OpenGroup - fstatvfs</a></li>

<li><a href="https://utcc.utoronto.ca/~cks/space/blog/unix/StatfsPeculiarities">Chris's Wiki - blog/unix/StatfsPeculiarities</a></li>

<li><a href="https://ownyourbits.com/2018/05/02/understanding-disk-usage-in-linux/">Understanding disk usage in Linux – Own your bits</a></li>

<li><a href="https://ownyourbits.com/2018/05/02/understanding-disk-usage-in-linux/">Understanding disk usage in Linux – Own your bits</a> (Web Archive)</li>

<li><a href="https://unix.stackexchange.com/questions/429155/how-is-free-disk-space-on-ext4-calculated">filesystems - How is free disk space on ext4 calculated? - Unix &amp; Linux Stack Exchange</a></li>

<li><a href="https://stackoverflow.com/questions/3899894/how-to-obtain-total-available-disk-space-in-posix-systems">c++ - How to obtain total available disk space in Posix systems? - Stack Overflow</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=getmntinfo&amp;manpath=FreeBSD+12.1-RELEASE+and+Ports">FreeBSD Docs / getmntinfo()</a> =&gt; get information about mounted file systems</li>

<li><a href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man3/getmntinfo.3.html">MacOSX / getmntinfo()</a></li>

<li><a href="http://www.edenwaith.com/blog/index.php?p=67">Edenwaith : Blog - Calculating Free Space on macOS</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgbe9074b" class="outline-3">
<h3 id="orgbe9074b"><span class="section-number-3">1.9</span> Low level IO functions overview</h3>
<div class="outline-text-3" id="text-1-9">
<p>
C-Library functions which encapsulates file-related systems calls.
</p>

<p>
Headers: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
</pre>
</div>

<p>
<b>Special File Descriptors</b> 
</p>

<ul class="org-ul">
<li>STDOUT_FILENO =&gt; File descritor for stdout (process standard output)</li>
<li>STDERR_FILENO =&gt; File descritor for stderr (process standard error output)</li>
<li>STDIN_FILENO =&gt; File descritor for stdin (process standard input)</li>
</ul>

<p>
<b>Functions</b> 
</p>

<ul class="org-ul">
<li>close() =&gt; Close a file descriptor.
<ul class="org-ul">
<li>Doc: $ man 2 close</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">close</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>open() =&gt; Encapsulates open system call =&gt; Returns a file descritor
number. When fails, it returns (-1) setting the global variable
<span class="underline">errno</span>.
<ul class="org-ul">
<li>Doc: $ man 2 open</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">open</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">pathname</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>creat() =&gt; Create file
<ul class="org-ul">
<li>Doc: $ man 2 creat</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">creat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">pathname</span>, <span class="org-type">mode_t</span> <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>


<ul class="org-ul">
<li>read() =&gt; Read bytes from a file descriptor into a buffer, returning the
number of bytes read. If there is an error, the functions returns
(-1) setting the global variable <span class="underline">errno</span>.
<ul class="org-ul">
<li>Doc: $ man 2 read</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">ssize_t</span> <span class="org-function-name">read</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">void</span> *<span class="org-variable-name">buf</span>, <span class="org-type">size_t</span> <span class="org-variable-name">count</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>write() =&gt; Write N bytes from a buffer to a file descriptor.
<ul class="org-ul">
<li>Doc: $ man 2 write</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">ssize_t</span> <span class="org-function-name">write</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">const</span> <span class="org-type">void</span> *<span class="org-variable-name">buf</span>, <span class="org-type">size_t</span> <span class="org-variable-name">count</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgea07ca1" class="outline-3">
<h3 id="orgea07ca1"><span class="section-number-3">1.10</span> Low level IO - open(), read(), write() syscall functions</h3>
<div class="outline-text-3" id="text-1-10">
<p>
This code demonstrates the usage of the open(), read(), write(),
close() low-level IO library-calls for file descriptors which
encapsulates system-calls with the same name. 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/05fbba6475cca1dbdd50bbb2bd5ac8ae">https://gist.github.com/05fbba6475cca1dbdd50bbb2bd5ac8ae</a></li>
</ul>

<p>
File: unix-low-level-io.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">Import: char* strerror(in errnum);</span>

<span class="org-keyword">const</span> <span class="org-type">char</span>* 
<span class="org-function-name">errno_to_cstring</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">No such file or directory </span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == ENOENT<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">return</span> <span class="org-string">"ENOENT"</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Operation not permitted </span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EPERM<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"EPERM"</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Onput/Output error </span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EIO<span class="org-rainbow-delimiters-depth-2">)</span>    <span class="org-keyword">return</span> <span class="org-string">"EIO"</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EAGAIN<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">return</span> <span class="org-string">"EAGAIN"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EPERM<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"EPERM"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>err == EPIPE<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"EPIPE"</span>;

    <span class="org-keyword">return</span> <span class="org-string">"&lt;UNKNOWN&gt;"</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>   


<span class="org-doc">/** Check whether file descriptor is regular file */</span>
<span class="org-type">bool</span> <span class="org-function-name">fd_is_regular_file</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>       
     <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">fd_info</span>; 
     <span class="org-comment-delimiter">// </span><span class="org-comment">int fstat(int fd, struct stat *statbuf);</span>
     <span class="org-type">int</span> <span class="org-variable-name">r</span> = fstat<span class="org-rainbow-delimiters-depth-2">(</span>fd, &amp;fd_info<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> S_ISREG<span class="org-rainbow-delimiters-depth-2">(</span>fd_info.st_mode<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">bool</span> <span class="org-function-name">fd_is_directory</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">fd_info</span>; 
    <span class="org-comment-delimiter">// </span><span class="org-comment">int fstat(int fd, struct stat *statbuf);</span>
    <span class="org-type">int</span> <span class="org-variable-name">r</span> = fstat<span class="org-rainbow-delimiters-depth-2">(</span>fd, &amp;fd_info<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> S_ISDIR<span class="org-rainbow-delimiters-depth-2">(</span>fd_info.st_mode<span class="org-rainbow-delimiters-depth-2">)</span>;    
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr , <span class="org-string">"\n   =&gt;    errno(int) = %d"</span> 
                          <span class="org-string">"\n   =&gt;    errno(str) = %s"</span>
                          <span class="org-string">"\n   =&gt; errno message = %s \n"</span>
                          , err, errno_to_cstring<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span>, strerror<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-constant">std</span>::fflush<span class="org-rainbow-delimiters-depth-2">(</span>stderr<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program started. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 3<span class="org-rainbow-delimiters-depth-2">){</span>
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Usage:                             \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"  =&gt; To read a file:                \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"    $ %s file &lt;FILE&gt;                \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"  =&gt; To read stdin (console input): \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"    $ %s file -stdin                \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">return</span> 0;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Compare two c-strings return 0 (zero) when they are equal.</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">int strcmp(const char *s1, const char *s2)</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> strcmp<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>, <span class="org-string">"file"</span><span class="org-rainbow-delimiters-depth-3">)</span> != 0 <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] Expected command file. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Variable for holding a file descriptor </span>
    <span class="org-type">int</span> <span class="org-variable-name">fd</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">The library-call open() attempts to open a file  and returns a "file-descriptor" </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">(integer number ) when the operation is successful. The library-call </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">returns (-1) when the operation fails. </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: It encapsulates the 'open' system call. </span>
    <span class="org-comment-delimiter">//  </span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> strcmp<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>2<span class="org-rainbow-delimiters-depth-4">]</span>, <span class="org-string">"-stdin"</span><span class="org-rainbow-delimiters-depth-3">)</span> == 0<span class="org-rainbow-delimiters-depth-2">)</span>
            fd = STDIN_FILENO; 
    <span class="org-keyword">else</span> 
            fd = open<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span>, O_RDONLY<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>fd == -1<span class="org-rainbow-delimiters-depth-2">){</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">Get error flag 'errno' to get more details about current error.</span>
            <span class="org-type">int</span> <span class="org-variable-name">err</span> = errno;
            <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr ,<span class="org-string">" [ERROR] Failed to open file. "</span><span class="org-rainbow-delimiters-depth-3">)</span>;
            print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [INFO] ?? File is regular file = %s \n"</span>
                              , fd_is_regular_file<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span> ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span>  <span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [INFO] ?? File is directory file = %s \n"</span>
                              , fd_is_directory<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span> ? <span class="org-string">"TRUE"</span> : <span class="org-string">"FALSE"</span>  <span class="org-rainbow-delimiters-depth-2">)</span>;                
    <span class="org-comment-delimiter">// </span><span class="org-comment">Flush file =&gt; Force changes to be immeditely written.</span>
    <span class="org-constant">std</span>::fflush<span class="org-rainbow-delimiters-depth-2">(</span>stdout<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer maximum size in bytes </span>
    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_MAX_SIZE</span> = 200;     
    <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>BUFFER_MAX_SIZE<span class="org-rainbow-delimiters-depth-2">]</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Stream BUFFER_MAX_SIZE bytes from file descriptor </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">to STDOUT_FILENO (file descriptor).</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------</span>
    <span class="org-type">ssize_t</span> <span class="org-variable-name">ret</span>; 
    <span class="org-keyword">do</span> <span class="org-rainbow-delimiters-depth-2">{</span>
            ret = read<span class="org-rainbow-delimiters-depth-3">(</span>fd, buffer, BUFFER_MAX_SIZE<span class="org-rainbow-delimiters-depth-3">)</span>;        
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>ret == -1<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
                    <span class="org-type">int</span> <span class="org-variable-name">err</span> = errno; 
                    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [ERROR] An error has happened =&gt; "</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                    print_errno_details<span class="org-rainbow-delimiters-depth-4">(</span>err<span class="org-rainbow-delimiters-depth-4">)</span>;
                    close<span class="org-rainbow-delimiters-depth-4">(</span>fd<span class="org-rainbow-delimiters-depth-4">)</span>;
                    <span class="org-keyword">return</span> EXIT_FAILURE;
            <span class="org-rainbow-delimiters-depth-3">}</span>       
            ::write<span class="org-rainbow-delimiters-depth-3">(</span>STDOUT_FILENO, buffer, ret<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span> ret != 0<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Always close the file descriptor.</span>
    close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-low-level-io.cpp -o <span class="org-keyword">unix-low-level-io.bin</span> -std=c++1z -Wall -Wextra
</pre>
</div>

<p>
Running:
</p>

<ul class="org-ul">
<li>Run 1</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./unix-low-level-io.bin 
[INFO] Program started. 
<span class="org-function-name">Usage</span>:                             
 =&gt; To read a file:                
   $ ./unix-low-level-io.bin file &lt;FILE&gt;                
 =&gt; To read stdin (console input): 
   $ ./unix-low-level-io.bin file -stdin                
</pre>
</div>

<ul class="org-ul">
<li>Run 2:</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./unix-low-level-io.bin file /proc/filesystems 
 [INFO] Program started. 
 [INFO] ?? File is regular file = TRUE 
 [INFO] ?? File is directory file = FALSE 
nodev   sysfs
nodev   tmpfs
nodev   bdev
nodev   proc
nodev   cgroup
nodev   cgroup2
... ... ... 

$ &gt;&gt; ./unix-low-level-io.bin file /etc/resolv.conf 
 [INFO] Program started. 
 [INFO] ?? File is regular file = TRUE 
 [INFO] ?? File is directory file = FALSE 
<span class="org-comment-delimiter"># </span><span class="org-comment">Generated by NetworkManager</span>
nameserver 194.165.12.10
</pre>
</div>

<ul class="org-ul">
<li>Run 3: (Error)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./unix-low-level-io.bin file /etc/resosad
[INFO] Program started. 
[ERROR] Failed to open file. 
  =&gt;    errno(int) = 2
  =&gt;    errno(str) = ENOENT
  =&gt; errno message = No such file or directory 

$ &gt;&gt; ./unix-low-level-io.bin file /etc/shadow
[INFO] Program started. 
[ERROR] Failed to open file. 
  =&gt;    errno(int) = 13
  =&gt;    errno(str) = &lt;UNKNOWN&gt;
  =&gt; errno message = Permission denied 

$ &gt;&gt; ./unix-low-level-io.bin file /
[INFO] Program started. 
[INFO] ?? File is regular file = FALSE 
[INFO] ?? File is directory file = TRUE 
[ERROR] An error has happened =&gt; 
  =&gt;    errno(int) = 21
  =&gt;    errno(str) = &lt;UNKNOWN&gt;
  =&gt; errno message = Is a directory 
</pre>
</div>

<ul class="org-ul">
<li>Run 4 - read stdin file descriptor <span class="underline">STDIN_FILENO</span></li>
</ul>

<pre class="example">
 $ &gt;&gt; ./unix-low-level-io.bin file -stdin
 [INFO] Program started. 
 [INFO] ?? File is regular file = FALSE 
 [INFO] ?? File is directory file = FALSE 


Hello world
Hello world
 Unix-linux file descriptors - Low level IO
 Unix-linux file descriptors - Low level IO

# User types Ctrl+D to close STDIN 
</pre>
</div>
</div>

<div id="outline-container-orgd47c91a" class="outline-3">
<h3 id="orgd47c91a"><span class="section-number-3">1.11</span> Low level IO - creat()</h3>
<div class="outline-text-3" id="text-1-11">
<p>
Creates a file using Unix-low level IO function creat() which
encapsulates the creat() system-call.
</p>

<p>
File: unix-creat.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">File is created with read, write permissions for owner </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">,groups and others</span>
    <span class="org-type">mode_t</span> <span class="org-variable-name">mode</span> = S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH;

    <span class="org-type">int</span> <span class="org-variable-name">fd</span> = creat<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/tmp/my-sample-file.txt"</span>, mode<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>fd  == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_SIZE</span> = 500;
    <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>BUFFER_SIZE<span class="org-rainbow-delimiters-depth-2">]</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Fill the whole buffer with '\0' null char characters</span>
    memset<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">'\0'</span>, BUFFER_SIZE<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">strcpy =&gt; Copy string literal to buffer. </span>
    strcpy<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">" [LINE 0] Write this message to buffer\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" Buffer size (non blank chars) = %zu \n"</span>, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Write strlen(buffer) bytes to file descriptor </span>
    write<span class="org-rainbow-delimiters-depth-2">(</span>fd, buffer, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    strcpy<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX, AIX, POSIX\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" Buffer size (non blank chars) = %zu \n"</span>, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" Buffer content = '%s' \n"</span>, buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Write strlen(buffer) bytes to file descriptor </span>
    write<span class="org-rainbow-delimiters-depth-2">(</span>fd, buffer, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    strcpy<span class="org-rainbow-delimiters-depth-2">(</span>buffer, <span class="org-string">" [LINE 2] FreeRTOS Linux RTAI Real-time RTMES QNX\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    write<span class="org-rainbow-delimiters-depth-2">(</span>fd, buffer, strlen<span class="org-rainbow-delimiters-depth-3">(</span>buffer<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Ruires: #include &lt;string&gt;</span>
<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr , <span class="org-string">"\n   =&gt;    errno(int) = %d"</span> 
                              <span class="org-string">"\n   =&gt; errno message = %s \n"</span>
                            , err, strerror<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::fflush<span class="org-rainbow-delimiters-depth-2">(</span>stderr<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-creat.cpp -o <span class="org-keyword">unix-creat.bin</span> -std=c++1z -Wall -Wextra -g 
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./unix-creat.bin 
 Buffer size (non blank chars) = 39 
 Buffer size (non blank chars) = 44 
 Buffer content = <span class="org-string">' [LINE 1] Unix, BSD, OSX, LINUX, AIX, POSIX</span>
<span class="org-string">'</span>
</pre>
</div>

<p>
Content of generated file: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; cat /tmp/my-sample-file.txt 
[LINE 0] Write this message to buffer
[LINE 1] Unix, BSD, OSX, LINUX, AIX, POSIX
[LINE 2] FreeRTOS Linux RTAI Real-time RTMES QNX
</pre>
</div>

<p>
Trace library-calls with <span class="underline">ltrace</span> application: 
</p>

<ul class="org-ul">
<li>$ ltrace ./unix-creat.bin</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ltrace ./unix-creat.bin

<span class="org-function-name">_ZNSt8ios_base4InitC1Ev</span>(0x4040a9, 0xffff, 0x7ffcfe326598, 224) = 0
<span class="org-function-name">__cxa_atexit</span>(0x4010e0, 0x4040a9, 0x402008, 6)                  = 0
<span class="org-function-name">creat</span>(0x402010, 420, 0x7ffcfe326598, 256)                      = 3
<span class="org-function-name">memset</span>(0x7ffcfe326280, <span class="org-string">'\0'</span>, 500)                              = 0x7ffcfe326280
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 0] Write this message to "</span>...)                  = 39
<span class="org-function-name">fprintf</span>(0x7f95f2612500, <span class="org-string">" Buffer size (non blank chars) ="</span>..., 39 Buffer size (non blank chars) = 39 
) = 37
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 0] Write this message to "</span>...)                  = 39
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 0] Write this message to "</span>..., 39)            = 39
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>...)                  = 44
<span class="org-function-name">fprintf</span>(0x7f95f2612500, <span class="org-string">" Buffer size (non blank chars) ="</span>..., 44 Buffer size (non blank chars) = 44 
) = 37
<span class="org-function-name">fprintf</span>(0x7f95f2612500, <span class="org-string">" Buffer content = '%s' \n"</span>, <span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>... Buffer content = <span class="org-string">' [LINE 1] Unix, BSD, OSX, LINUX, AIX, POSIX</span>
<span class="org-string">'</span> 
) = 66
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>...)                  = 44
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>..., 44)            = 44
<span class="org-function-name">strlen</span>(<span class="org-string">" [LINE 2] FreeRTOS Linux RTAI Re"</span>...)                  = 50
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 2] FreeRTOS Linux RTAI Re"</span>..., 50)            = 50
<span class="org-function-name">close</span>(3)                                                       = 0
<span class="org-function-name">_ZNSt8ios_base4InitD1Ev</span>(0x4040a9, 0, 0x4010e0, 1)              = 0x7f95f2965e40
+++ exited (status 0) +++

</pre>
</div>

<p>
Trace system-calls with <span class="underline">strace</span> application: 
</p>

<ul class="org-ul">
<li>$ strace ./unix-creat.bin</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ strace ./unix-creat.bin 

<span class="org-function-name">execve</span>(<span class="org-string">"./unix-creat.bin"</span>, [<span class="org-string">"./unix-creat.bin"</span>], 0x7fff489b8e40 /* 83 vars */) = 0
<span class="org-function-name">brk</span>(NULL)                               = 0x57c000
<span class="org-function-name">arch_prctl</span>(0x3001 /* ARCH_??? */, 0x7fff751bd910) = -1 EINVAL (Invalid argument)
<span class="org-function-name">access</span>(<span class="org-string">"/etc/ld.so.preload"</span>, R_OK)      = -1 ENOENT (No such file or directory)
 ... ... ... ... ... ... ... ... ... ... ... ... ... ...
 ... ... ... ... ... ... ... ... ... ... ... ... ... ...

<span class="org-function-name">mprotect</span>(0x7fed4e032000, 4096, PROT_READ) = 0
<span class="org-function-name">munmap</span>(0x7fed4dfe4000, 136250)          = 0
<span class="org-function-name">brk</span>(NULL)                               = 0x57c000
<span class="org-function-name">brk</span>(0x59d000)                           = 0x59d000
<span class="org-function-name">creat</span>(<span class="org-string">"/tmp/my-sample-file.txt"</span>, 0644)  = 3
<span class="org-function-name">fstat</span>(1, {<span class="org-variable-name">st_mode</span>=S_IFCHR|0620, <span class="org-variable-name">st_rdev</span>=makedev(0x88, 0xc), ...}) = 0
<span class="org-function-name">write</span>(1, <span class="org-string">" Buffer size (non blank chars) ="</span>..., 37) = 37
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 0] Write this message to "</span>..., 39) = 39
<span class="org-function-name">write</span>(1, <span class="org-string">" Buffer size (non blank chars) ="</span>..., 37) = 37
<span class="org-function-name">write</span>(1, <span class="org-string">" Buffer content = ' [LINE 1] Uni"</span>..., 63) = 63
<span class="org-function-name">write</span>(1, <span class="org-string">"' \n"</span>, 3)                     = 3
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 1] Unix, BSD, OSX, LINUX,"</span>..., 44) = 44
<span class="org-function-name">write</span>(3, <span class="org-string">" [LINE 2] FreeRTOS Linux RTAI Re"</span>..., 50) = 50
<span class="org-function-name">close</span>(3)                                = 0
<span class="org-function-name">exit_group</span>(0)                           = ?
+++ exited with 0 +++
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb1afc89" class="outline-3">
<h3 id="orgb1afc89"><span class="section-number-3">1.12</span> Process Inputs, Outputs and States and PROCFS on Linux</h3>
<div class="outline-text-3" id="text-1-12">
<p>
Any process may have the following inputs, outputs and states: 
</p>

<p>
<b>Some Processes States:</b>
</p>

<ul class="org-ul">
<li><span class="underline">Native executable</span> used for creating the process. Every
process has a native executable. A python process is the Python
interpreter (python.exe on Windows) running python scripts. A Java
process is the Java virtual machine (java.exe) running java
*.class bytecodes or *.jar java packages.</li>

<li><span class="underline">CWD</span> =&gt; Current Working Directory
<ul class="org-ul">
<li>There is a single current working directory for every
process. On Unix, the functions <a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/getcwd.html">getcwd()</a> and <a href="http://man7.org/linux/man-pages/man2/chdir.2.html">chdir()</a> gets and
sets the current working directory.</li>
</ul></li>

<li><span class="underline">IP</span> =&gt; Instruction Pointer (process context) =&gt; CPU registry that
stores the current machine instruction to be run.</li>

<li><span class="underline">SP</span> =&gt; Stack Poitner (process context) =&gt; CPU registry used for
keeping track of the process call stack.</li>

<li>Note: all thoses states can be viewed and manipulated with a
debugger, such as GDB, LLDB or Windows Debugger. A debugger can
monitor, explore and manipulate the virtual memory of any process.</li>
</ul>

<p>
<b>Inputs:</b>
</p>

<ul class="org-ul">
<li><span class="underline">Stdin</span> (Standard Input) =&gt; User input read from console in some
shell (cmd.exe on Windows) or bash, zsh on Unix-like OSes.</li>

<li>Command line argument passed to main function</li>

<li>Environment variables set during the process instantiation with env
or export commands on Unix-like operating systems.</li>

<li>Configuration files =&gt; read at a default fixed location such as
<code>/.bashrc (bash configuration file at ~/home/user/.bashrc/</code> on Linux
); ~/.vimrc (vim configuration file)</li>

<li>Windows Registry entry for configuration during process
initialization</li>

<li>Input files read after initialization.</li>
</ul>

<p>
<b>Outputs:</b>
</p>

<ul class="org-ul">
<li><span class="underline">Stdout</span> (Standard Output) =&gt; Process output print by functions such
as printf; std::cout &lt;&lt; &#x2026; visible in a terminal. (Unix heritage)</li>

<li><span class="underline">Stderr</span> (Standard Error Ouput) =&gt; Process error or logging output
print by default in a terminal. stderr exists for allowing
separating the output (stdout) from the error or logging output (stderr).</li>

<li>Statuds code =&gt; Value returned by function <span class="underline">int main(int argc, char** argv)</span>
<ul class="org-ul">
<li>Value 0 indicates success and that the process terminated
successfuly.</li>
<li>Value different than zero indicates that the process terminated
with errors.</li>
</ul></li>

<li>Output file(s)</li>
</ul>

<p>
<b>Both Input/Output:</b>
</p>

<ul class="org-ul">
<li>Sockets</li>

<li>IPC Inter Process Communication</li>

<li>GUI - Graphical User Interface</li>
</ul>


<div class="org-src-container">
<pre class="src src-text">         Command line arguments            
         int arc, char** argv (input)                  Configuration file: 
           &gt;&gt;-------+                         +--&lt;&lt;--  Input file read at fixed location
                     \                       /         Or Windows Registry entry 
                      \                      |
                      |                      |    
                      \/                    \ /   
                     +---------------------------------+
                     |   Process:                      |      
                     |                                 +---------&gt;&gt; Stdout (output)
         ----------&gt;&gt;|     EXE = /bin/some/executable  |            
       Stdin (input) |     PID = 9381 (Unique ID)      +---------&gt;&gt; Stderr (output)
                     |     CWD = /home/user/some/data  |       
                     |                                 |
                     |     IP - Instruction Pointer    +---------&gt;&gt;&gt; Process status code: (output)
         ----------&gt;&gt;|     SP - Stack pointer          |    
Environment          +-----------------------+--------+    int main(int argc, char** argv)
Variables (input)                            |              {
                                             |                  .... ... ...
export PATH=$PATH:/opt/bin/program/bin       |                  int status_code = 0 
export APP_LOG_LEVEL=INFO                    |                  return status_code;
                                            \ /              }
                                      Output File 
</pre>
</div>

<p>
<b>Example: View Process Information on Linux</b> 
</p>

<p>
All mentioned process internal states can be viewed with a debugger
such as GDB (GNU Debugger). On Linux, they can also be accessed with
the <b>/proc</b> pseudo-file system created by the Linux kernel which exposes
many processes informations. 
</p>

<p>
Example: View information about the process which the PID is <b>19529</b> 
</p>

<ul class="org-ul">
<li>Start a Kotlin REPL process and get a PID:</li>
</ul>

<div class="org-src-container">
<pre class="src src-java">$ kotlinc-jvm
Welcome to Kotlin version 1.3.50 <span class="org-rainbow-delimiters-depth-1">(</span>JRE 1.8.0_162-b12<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-function-name">Type</span> :help <span class="org-keyword">for</span> help, :quit <span class="org-keyword">for</span> quit
&gt;&gt;&gt; 
&gt;&gt;&gt; <span class="org-constant">java</span>.<span class="org-constant">lang</span>.<span class="org-constant">management</span>.ManagementFactory.getRuntimeMXBean<span class="org-rainbow-delimiters-depth-1">()</span>.getName<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-function-name">res1</span>: <span class="org-constant">kotlin</span>.String<span class="org-negation-char">!</span> = 23127@localhost.localdomain
&gt;&gt;&gt; 
</pre>
</div>

<ul class="org-ul">
<li>Proc-File system for PID <span class="underline">23127</span></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ls /proc/23127
attr/       cmdline          loginuid       personality   statm
fd/         comm             maps           projid_map    status
fdinfo/     coredump_filter  mem            root@         syscall
map_files/  cpuset           mountinfo      sched         timers
net/        cwd@             mounts         schedstat     timerslack_ns
ns/         environ          mountstats     sessionid     uid_map
task/       exe@             numa_maps      setgroups     wchan
autogroup   gid_map          oom_adj        smaps
auxv        io               oom_score      smaps_rollup
cgroup      latency          oom_score_adj  stack
clear_refs  limits           pagemap        stat
</pre>
</div>

<ul class="org-ul">
<li>Get process executable: 
<ul class="org-ul">
<li>File: <span class="underline">/proc/&lt;PID&gt;/exe</span> is a symbolic link to the process' native executable.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ readlink /proc/23127/exe 
/home/archbox/opt/java/bin/java
</pre>
</div>

<ul class="org-ul">
<li>Get process current directory:
<ul class="org-ul">
<li>File: <span class="underline">/proc/&lt;PID&gt;/cwd</span> is a symbolic link to process' current directory.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ readlink /proc/23127/cwd
/home/archbox/projects/appdroid/build
</pre>
</div>

<ul class="org-ul">
<li>Get command line arguments used to start the process.
<ul class="org-ul">
<li>File: <span class="underline">/proc/&lt;PID&gt;/cmdline</span> contains the command line arguments
used to start the process, passed to main(int argc, char** argv).</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ cat /proc/23127/cmdline | strings -1

/home/archbox/opt/java/bin/java
-Xmx256M
-Xms32M
-noverify
-cp
/home/archbox/.sdkman/candidates/kotlin/1.3.50/lib/kotlin-preloader.jar
org.jetbrains.kotlin.preloading.Preloader
-cp
/home/archbox/.sdkman/candidates/kotlin/1.3.50/lib/kotlin-compiler.jar
org.jetbrains.kotlin.cli.jvm.K2JVMCompiler
</pre>
</div>

<ul class="org-ul">
<li>Get process environment variables.
<ul class="org-ul">
<li>File: <span class="underline">/proc/&lt;PID&gt;/environ</span> contains process' environment
variables.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ cat /proc/23127/environ | strings -1

<span class="org-variable-name">QTINC</span>=/usr/lib64/qt-3.3/include
<span class="org-variable-name">LC_ALL</span>=en_US.UTF-8
...    ...    ...    ...    ... 
...    ...    ...    ...    ... 
<span class="org-variable-name">USERNAME</span>=archbox
<span class="org-variable-name">JAVA_HOME</span>=/home/archbox/opt/java
<span class="org-variable-name">KDEDIRS</span>=/usr
<span class="org-variable-name">KOTLIN_HOME</span>=/home/archbox/.sdkman/candidates/kotlin/1.3.50
<span class="org-variable-name">XDG_VTNR</span>=2
<span class="org-variable-name">SSH_AUTH_SOCK</span>=/tmp/ssh-7z2L0gyqQeeP/agent.3961
<span class="org-variable-name">ROOTSYS</span>=/home/archbox/opt/root
<span class="org-variable-name">XDG_SESSION_ID</span>=2
<span class="org-variable-name">MODULES_CMD</span>=/usr/share/Modules/libexec/modulecmd.tcl
<span class="org-variable-name">ENV</span>=/usr/share/Modules/init/profile.sh
<span class="org-variable-name">DESKTOP_SESSION</span>=lxqt
<span class="org-variable-name">IMSETTINGS_MODULE</span>=none
<span class="org-variable-name">PWD</span>=/home/archbox/projects/appdroid/build
</pre>
</div>

<ul class="org-ul">
<li>List all process' file descriptors.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ls /proc/23127/fd
0@  10@  12@  14@  16@  18@  2@   21@  24@  28@  3@   31@  4@  6@  8@
1@  11@  13@  15@  17@  19@  20@  22@  27@  29@  30@  33@  5@  7@  9@

$ ls -l /proc/23127/fd
total 0
lrwx------ 1 archbox archbox 64 Nov  4 12:11 0 -&gt; /dev/pts/4
lrwx------ 1 archbox archbox 64 Nov  4 12:11 1 -&gt; /dev/pts/4
lr-x------ 1 archbox archbox 64 Nov  4 12:11 10 -&gt; /home/archbox/.sdkman/candidates/kotlin/1.3.50/lib/kotlin-script-runtime.jar
lr-x------ 1 archbox archbox 64 Nov  4 12:11 11 -&gt; /home/archbox/.sdkman/candidates/kotlin/1.3.50/lib/trove4j.jar
lr-x------ 1 archbox archbox 64 Nov  4 12:11 12 -&gt; /home/archbox/opt/java/jre/lib/jsse.jar
lr-x------ 1 archbox archbox 64 Nov  4 12:11 13 -&gt; /dev/random
lr-x------ 1 archbox archbox 64 Nov  4 12:11 14 -&gt; /dev/urandom
... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... 
... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... 
lr-x------ 1 archbox archbox 64 Nov  4 12:11 8 -&gt; /home/archbox/.sdkman/candidates/kotlin/1.3.50/lib/kotlin-stdlib.jar
lr-x------ 1 archbox archbox 64 Nov  4 12:11 9 -&gt; /home/archbox/.sdkman/candidates/kotlin/1.3.50/lib/kotlin-reflect.jar
</pre>
</div>

<ul class="org-ul">
<li>List shared libraries loaded by process: <a href="https://stackoverflow.com/questions/5103443/how-to-check-what-shared-libraries-are-loaded-at-run-time-for-a-given-process">(Reference 5103443)</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ cat /proc/23127/maps | awk <span class="org-string">'{print $6}'</span> | grep <span class="org-string">'\.so'</span> | sort | uniq

/home/archbox/opt/java/jre/lib/amd64/libjava.so
/home/archbox/opt/java/jre/lib/amd64/libmanagement.so
...    ...    ...    ...    ...    ... 
...    ...    ...    ...    ...    ... 
/usr/lib64/libc-2.27.so
/usr/lib64/libdl-2.27.so
/usr/lib64/libm-2.27.so
/usr/lib64/libnss_files-2.27.so
/usr/lib64/libpthread-2.27.so
/usr/lib64/librt-2.27.so
/usr/lib64/libutil-2.27.so
</pre>
</div>

<p>
See also: 
</p>

<ul class="org-ul">
<li><a href="http://man7.org/linux/man-pages/man5/proc.5.html">proc(5) - Linux manual page</a></li>

<li><a href="https://www.tecmint.com/exploring-proc-file-system-in-linux/">Exploring /proc File System in Linux</a></li>

<li><a href="https://www.geeksforgeeks.org/proc-file-system-linux/">proc file system in Linux - GeeksforGeeks</a></li>
</ul>
</div>
</div>

<div id="outline-container-org790b042" class="outline-3">
<h3 id="org790b042"><span class="section-number-3">1.13</span> Information about file permissions, owner and group - fstat and stat syscalls</h3>
<div class="outline-text-3" id="text-1-13">
</div>
<div id="outline-container-org80ee7c7" class="outline-4">
<h4 id="org80ee7c7"><span class="section-number-4">1.13.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-13-1">
<p>
The following family of common UNIX functions allows obtaining
information about file permissions, owner, group and stick bits,
namely, set-uid and set-gid special bits. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Obtain permission and file information from file path </span>
<span class="org-type">int</span> <span class="org-function-name">stat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> * <span class="org-variable-name">path</span>, <span class="org-keyword">struct</span> <span class="org-type">stat</span>* <span class="org-variable-name">sb</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Obtain permission and file information from file path </span>
<span class="org-type">int</span> <span class="org-function-name">lstat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">path</span>, <span class="org-keyword">struct</span> <span class="org-type">stat</span>* <span class="org-variable-name">sb</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Obtain permission and file information from file-descriptor </span>
<span class="org-type">int</span> <span class="org-function-name">fstat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">struct</span> <span class="org-type">stat</span> *<span class="org-variable-name">sb</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">fstatat</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">path</span>, <span class="org-keyword">struct</span> <span class="org-type">stat</span> *<span class="org-variable-name">sb</span>, <span class="org-type">int</span> <span class="org-variable-name">flag</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Fstat manpage: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">dev_t</span>     <span class="org-variable-name">st_dev</span>;         <span class="org-comment-delimiter">/* </span><span class="org-comment">ID of device containing file</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">ino_t</span>     <span class="org-variable-name">st_ino</span>;         <span class="org-comment-delimiter">/* </span><span class="org-comment">Inode number</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">mode_t</span>    <span class="org-variable-name">st_mode</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">File type and mode</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">nlink_t</span>   <span class="org-variable-name">st_nlink</span>;       <span class="org-comment-delimiter">/* </span><span class="org-comment">Number of hard links</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">uid_t</span>     <span class="org-variable-name">st_uid</span>;         <span class="org-comment-delimiter">/* </span><span class="org-comment">User ID of owner</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">gid_t</span>     <span class="org-variable-name">st_gid</span>;         <span class="org-comment-delimiter">/* </span><span class="org-comment">Group ID of owner</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">dev_t</span>     <span class="org-variable-name">st_rdev</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">Device ID (if special file)</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">off_t</span>     <span class="org-variable-name">st_size</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">Total size, in bytes</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">blksize_t</span> <span class="org-variable-name">st_blksize</span>;     <span class="org-comment-delimiter">/* </span><span class="org-comment">Block size for filesystem I/O</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">blkcnt_t</span>  <span class="org-variable-name">st_blocks</span>;      <span class="org-comment-delimiter">/* </span><span class="org-comment">Number of 512B blocks allocated</span><span class="org-comment-delimiter"> */</span>

    <span class="org-comment-delimiter">/* </span><span class="org-comment">Since Linux 2.6, the kernel supports nanosecond</span>
<span class="org-comment">       precision for the following timestamp fields.</span>
<span class="org-comment">       For the details before Linux 2.6, see NOTES.</span><span class="org-comment-delimiter"> */</span>

    <span class="org-keyword">struct</span> <span class="org-type">timespec</span> <span class="org-variable-name">st_atim</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">Time of last access</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">struct</span> <span class="org-type">timespec</span> <span class="org-variable-name">st_mtim</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">Time of last modification</span><span class="org-comment-delimiter"> */</span>
    <span class="org-keyword">struct</span> <span class="org-type">timespec</span> <span class="org-variable-name">st_ctim</span>;  <span class="org-comment-delimiter">/* </span><span class="org-comment">Time of last status change</span><span class="org-comment-delimiter"> */</span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">st_atime</span> st_atim.tv_sec      <span class="org-comment-delimiter">/* </span><span class="org-comment">Backward compatibility</span><span class="org-comment-delimiter"> */</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">st_mtime</span> st_mtim.tv_sec
<span class="org-preprocessor">#define</span> <span class="org-variable-name">st_ctime</span> st_ctim.tv_sec
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
See also: 
</p>

<ul class="org-ul">
<li><a href="https://www.liquidweb.com/kb/how-do-i-set-up-setuid-setgid-and-sticky-bits-on-linux/">How Do I Set Up Setuid, Setgid, and Sticky Bits on Linux? | Liquid Web</a></li>
</ul>

<p>
Documentation: 
</p>

<ul class="org-ul">
<li><a href="https://linux.die.net/man/2/fstat">Linux Manpage - fstat</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=stat&amp;sektion=2">FreeBSD sytem calls - stat, lstat, fstat - Get file status</a></li>

<li><a href="https://man7.org/linux/man-pages/man3/getgrgid.3p.html">Linux Manpage - getgrgid()</a> - Query /etc/group database</li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=getgrgid">FreeBSD - getgrid()</a> - Query /etc/group database.</li>

<li><a href="https://pubs.opengroup.org/onlinepubs/009695399/functions/getpwuid.html">OpenGroup - Unix Specification  - getpwuid()</a></li>
</ul>
</div>
</div>
<div id="outline-container-org5bc547a" class="outline-4">
<h4 id="org5bc547a"><span class="section-number-4">1.13.2</span> Sample code</h4>
<div class="outline-text-4" id="text-1-13-2">
<p>
<b>File:</b> file-info.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">functional</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">-- Unix-specific Headers -------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">pwd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">grp.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-function-name">std</span>::string 
get_descriptor_type<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">fs</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span> <span class="org-variable-name">ftype</span> = fs.st_mode &amp; S_IFMT;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFDIR<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"Directory"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFREG<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"Regular file"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFLNK<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"Symbolic link"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFBLK<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"Block device file"</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFCHR<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"Character device file"</span>;    
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFIFO<span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-keyword">return</span> <span class="org-string">"FIFO or pipe"</span>; 
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>ftype == S_IFSOCK<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">return</span> <span class="org-string">"Socket"</span>;
    <span class="org-keyword">return</span> <span class="org-string">"Unknown"</span>;    
<span class="org-rainbow-delimiters-depth-1">}</span>; 

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc != 2<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" Usage: %s &lt;FILE&gt; \n"</span>, argv<span class="org-rainbow-delimiters-depth-4">[</span>0<span class="org-rainbow-delimiters-depth-4">]</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> 0;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">fs</span>; 
    <span class="org-keyword">struct</span> <span class="org-type">passwd</span>* <span class="org-variable-name">fs_user</span> = <span class="org-constant">nullptr</span>; 
    <span class="org-keyword">struct</span> <span class="org-type">group</span>*  <span class="org-variable-name">fs_group</span> = <span class="org-constant">nullptr</span>;


    <span class="org-comment-delimiter">//</span><span class="org-comment">int fd = open(argv[1], O_RDONLY);</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> ::stat<span class="org-rainbow-delimiters-depth-3">(</span>argv<span class="org-rainbow-delimiters-depth-4">[</span>1<span class="org-rainbow-delimiters-depth-4">]</span>, &amp;fs <span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to open file =&gt; error = %s \n"</span>, strerror<span class="org-rainbow-delimiters-depth-4">(</span>errno<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> -1;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-rainbow-delimiters-depth-3">(</span> fs_user = ::getpwuid<span class="org-rainbow-delimiters-depth-4">(</span>fs.st_uid<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to get owner information \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> -1;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-rainbow-delimiters-depth-3">(</span> fs_group = ::getgrgid<span class="org-rainbow-delimiters-depth-4">(</span>fs.st_gid<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to get group information \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> -1;
    <span class="org-rainbow-delimiters-depth-2">}</span>


    <span class="org-comment-delimiter">// </span><span class="org-comment">Print boolean as 'true' or 'false'</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*]  File size in bytes: "</span> &lt;&lt; fs.st_size &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*]  File size in Kilo bytes: "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>fs.st_size<span class="org-rainbow-delimiters-depth-2">)</span> / 1024 &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*]  File size in Mega bytes: "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>fs.st_size<span class="org-rainbow-delimiters-depth-2">)</span> / <span class="org-rainbow-delimiters-depth-2">(</span>1024 * 1024<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*]           File type: "</span> &lt;&lt; get_descriptor_type<span class="org-rainbow-delimiters-depth-2">(</span>fs<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n TEST FILE TYPE \n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] ?      Is regular file =&gt;&gt; "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> S_ISREG<span class="org-rainbow-delimiters-depth-3">(</span>fs.st_mode<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] ?         Is directory =&gt;&gt; "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> S_ISDIR<span class="org-rainbow-delimiters-depth-3">(</span>fs.st_mode<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] ?     Is symbolic link =&gt;&gt; "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> S_ISLNK<span class="org-rainbow-delimiters-depth-3">(</span>fs.st_mode<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] ?     Is block device  =&gt;&gt; "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> S_ISBLK<span class="org-rainbow-delimiters-depth-3">(</span>fs.st_mode<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] ? Is character device  =&gt;&gt; "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> S_ISCHR<span class="org-rainbow-delimiters-depth-3">(</span>fs.st_mode<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n ACCESS TIME \n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] Time =&gt;   last change: "</span> &lt;&lt; ctime<span class="org-rainbow-delimiters-depth-2">(</span>&amp;fs.st_ctime<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] Time =&gt;   last access: "</span> &lt;&lt; ctime<span class="org-rainbow-delimiters-depth-2">(</span>&amp;fs.st_atime<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] Time =&gt; last modified: "</span> &lt;&lt; ctime<span class="org-rainbow-delimiters-depth-2">(</span>&amp;fs.st_mtime<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt;  <span class="org-string">"\n OWNER and GROUP \n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] Owner: uid = "</span> &lt;&lt; fs.st_uid &lt;&lt; <span class="org-string">" ;  user = "</span> &lt;&lt; fs_user-&gt;pw_name  &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  [*] Group: gid = "</span> &lt;&lt; fs.st_gid &lt;&lt; <span class="org-string">" ; group = "</span> &lt;&lt; fs_group-&gt;gr_name  &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n FILE PERMISSIONS \n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  =&gt;&gt;  Stick Bits: "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_ISUID ? <span class="org-string">"suid"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span> 
              &lt;&lt; <span class="org-string">"  "</span>                  &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_ISGID ? <span class="org-string">"sgid"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>
              &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  =&gt;&gt;  Owner: "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IRUSR  ? <span class="org-string">"r"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">File is readable   (can be read)</span>
              &lt;&lt; <span class="org-string">" "</span>         &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IWUSR  ? <span class="org-string">"w"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>        <span class="org-comment-delimiter">// </span><span class="org-comment">File is writeable  (can be written)</span>
              &lt;&lt; <span class="org-string">" "</span>         &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IXUSR  ? <span class="org-string">"x"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>        <span class="org-comment-delimiter">// </span><span class="org-comment">File is executable (can be executed - execv syscall)</span>
              &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  =&gt;&gt;  Group: "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IRGRP  ? <span class="org-string">"r"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>  
              &lt;&lt; <span class="org-string">" "</span>            &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IWGRP  ? <span class="org-string">"w"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>  
              &lt;&lt; <span class="org-string">" "</span>            &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IXGRP  ? <span class="org-string">"x"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>
              &lt;&lt; <span class="org-string">'\n'</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  =&gt;&gt; Others: "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IROTH  ? <span class="org-string">"r"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>  
              &lt;&lt; <span class="org-string">" "</span>             &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IWOTH  ? <span class="org-string">"w"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>  
              &lt;&lt; <span class="org-string">" "</span>             &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>fs.st_mode &amp; S_IXOTH  ? <span class="org-string">"x"</span> : <span class="org-string">"-"</span><span class="org-rainbow-delimiters-depth-2">)</span>
              &lt;&lt; <span class="org-string">'\n'</span>;    
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" \n- Note: (r - read) ; (w - write); (x - execute) ; (suid - set-UID bit set) ; (sgid - set-GID bit set) \n"</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Build using GNU GCC (G++) compiler </span>
$ g++ file-info.cpp -o <span class="org-keyword">file-info</span> -std=c++1z -g -Wall -Wextra

<span class="org-comment-delimiter"># </span><span class="org-comment">Build using LLVM/Clang compiler </span>
$ clang++ file-info.cpp -o <span class="org-keyword">file-info</span> -std=c++1z -g -Wall -Wextra
</pre>
</div>

<p>
Running:
</p>

<ul class="org-ul">
<li>Inspect directory /etc</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ./file-info /etc
  [*]  File size<span class="org-keyword"> in</span> bytes: 12288
  [*]  File size<span class="org-keyword"> in</span> Kilo bytes: 12
  [*]  File size<span class="org-keyword"> in</span> Mega bytes: 0.0117188
  [*]           File type: Directory

 TEST FILE TYPE 
  [*] ?      Is regular file =&gt;&gt; false
  [*] ?         Is directory =&gt;&gt; true
  [*] ?     Is symbolic link =&gt;&gt; false
  [*] ?     Is block device  =&gt;&gt; false
  [*] ? Is character device  =&gt;&gt; false

 ACCESS TIME 
  [*] Time =&gt;   last change: Sun Aug  2 05:19:31 2020
  [*] Time =&gt;   last access: Wed Aug  5 04:50:20 2020
  [*] Time =&gt; last modified: Sun Aug  2 05:19:31 2020

 OWNER and GROUP 
  [*] Owner: uid = 0 ;  user = root
  [*] Group: gid = 0 ; group = root

 FILE PERMISSIONS 
  =&gt;&gt;  Stick Bits: -  -
  =&gt;&gt;  Owner: r w x
  =&gt;&gt;  Group: r - x
  =&gt;&gt; Others: r - x

- Note: (r - read) ; (w - write); (x - execute) ; (suid - set-UID bit set) ; (sgid - set-GID bit set) 
</pre>
</div>

<ul class="org-ul">
<li>Inspect executable file: /bin/sudo</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ./file-info /bin/sudo
  [*]  File size<span class="org-keyword"> in</span> bytes: 182456
  [*]  File size<span class="org-keyword"> in</span> Kilo bytes: 178.18
  [*]  File size<span class="org-keyword"> in</span> Mega bytes: 0.174004
  [*]           File type: Regular file

 TEST FILE TYPE 
  [*] ?      Is regular file =&gt;&gt; true
  [*] ?         Is directory =&gt;&gt; false
  [*] ?     Is symbolic link =&gt;&gt; false
  [*] ?     Is block device  =&gt;&gt; false
  [*] ? Is character device  =&gt;&gt; false

 ACCESS TIME 
  [*] Time =&gt;   last change: Tue May 12 01:52:08 2020
  [*] Time =&gt;   last access: Sun Aug  2 05:20:57 2020
  [*] Time =&gt; last modified: Fri Mar 27 05:50:36 2020

 OWNER and GROUP 
  [*] Owner: uid = 0 ;  user = root
  [*] Group: gid = 0 ; group = root

 FILE PERMISSIONS 
  =&gt;&gt;  Stick Bits: suid  -
  =&gt;&gt;  Owner: - - x
  =&gt;&gt;  Group: - - x
  =&gt;&gt; Others: - - x

- Note: (r - read) ; (w - write); (x - execute) ; (suid - set-UID bit set) ; (sgid - set-GID bit set) 
</pre>
</div>

<ul class="org-ul">
<li>Inspect regular file: ~/bin/fserver.jsh</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ./file-info ~/bin/fserver.jsh 
  [*]  File size<span class="org-keyword"> in</span> bytes: 9968346
  [*]  File size<span class="org-keyword"> in</span> Kilo bytes: 9734.71
  [*]  File size<span class="org-keyword"> in</span> Mega bytes: 9.50656
  [*]           File type: Regular file

 TEST FILE TYPE 
  [*] ?      Is regular file =&gt;&gt; true
  [*] ?         Is directory =&gt;&gt; false
  [*] ?     Is symbolic link =&gt;&gt; false
  [*] ?     Is block device  =&gt;&gt; false
  [*] ? Is character device  =&gt;&gt; false

 ACCESS TIME 
  [*] Time =&gt;   last change: Tue May 12 12:35:32 2020
  [*] Time =&gt;   last access: Tue Aug  4 03:21:06 2020
  [*] Time =&gt; last modified: Mon May 11 22:52:14 2020

 OWNER and GROUP 
  [*] Owner: uid = 1000 ;  user = myuser 
  [*] Group: gid = 1000 ; group = myuser 

 FILE PERMISSIONS 
  =&gt;&gt;  Stick Bits: -  -
  =&gt;&gt;  Owner: r w x
  =&gt;&gt;  Group: r w -
  =&gt;&gt; Others: r - -

- Note: (r - read) ; (w - write); (x - execute) ; (suid - set-UID bit set) ; (sgid - set-GID bit set) 
</pre>
</div>

<ul class="org-ul">
<li>Inspect block <span class="underline">device file</span> /dev/sda that represets the main disk
partition.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ./file-info /dev/sda
  [*]  File size<span class="org-keyword"> in</span> bytes: 0
  [*]  File size<span class="org-keyword"> in</span> Kilo bytes: 0
  [*]  File size<span class="org-keyword"> in</span> Mega bytes: 0
  [*]           File type: Block device file

 TEST FILE TYPE 
  [*] ?      Is regular file =&gt;&gt; false
  [*] ?         Is directory =&gt;&gt; false
  [*] ?     Is symbolic link =&gt;&gt; false
  [*] ?     Is block device  =&gt;&gt; true
  [*] ? Is character device  =&gt;&gt; false

 ACCESS TIME 
  [*] Time =&gt;   last change: Wed Jul  8 13:48:48 2020
  [*] Time =&gt;   last access: Wed Jul  8 13:49:09 2020
  [*] Time =&gt; last modified: Wed Jul  8 13:48:48 2020

 OWNER and GROUP 
  [*] Owner: uid = 0 ;  user = root
  [*] Group: gid = 6 ; group = disk

 FILE PERMISSIONS 
  =&gt;&gt;  Stick Bits: -  -
  =&gt;&gt;  Owner: r w -
  =&gt;&gt;  Group: r w -
  =&gt;&gt; Others: - - -

- Note: (r - read) ; (w - write); (x - execute) ; (suid - set-UID bit set) ; (sgid - set-GID bit set) 

</pre>
</div>

<ul class="org-ul">
<li>Inspect character <span class="underline">device file</span>  /dev/mem that represents the
physical memory (RAM memory).</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ ./file-info /dev/mem
  [*]  File size<span class="org-keyword"> in</span> bytes: 0
  [*]  File size<span class="org-keyword"> in</span> Kilo bytes: 0
  [*]  File size<span class="org-keyword"> in</span> Mega bytes: 0
  [*]           File type: Character device file

 TEST FILE TYPE 
  [*] ?      Is regular file =&gt;&gt; false
  [*] ?         Is directory =&gt;&gt; false
  [*] ?     Is symbolic link =&gt;&gt; false
  [*] ?     Is block device  =&gt;&gt; false
  [*] ? Is character device  =&gt;&gt; true

 ACCESS TIME 
  [*] Time =&gt;   last change: Wed Jul  8 13:48:49 2020
  [*] Time =&gt;   last access: Wed Jul  8 13:48:49 2020
  [*] Time =&gt; last modified: Wed Jul  8 13:48:49 2020

 OWNER and GROUP 
  [*] Owner: uid = 0 ;  user = root
  [*] Group: gid = 9 ; group = kmem

 FILE PERMISSIONS 
  =&gt;&gt;  Stick Bits: -  -
  =&gt;&gt;  Owner: r w -
  =&gt;&gt;  Group: r - -
  =&gt;&gt; Others: - - -

- Note: (r - read) ; (w - write); (x - execute) ; (suid - set-UID bit set) ; (sgid - set-GID bit set) 
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org72c0b14" class="outline-3">
<h3 id="org72c0b14"><span class="section-number-3">1.14</span> Information about current process</h3>
<div class="outline-text-3" id="text-1-14">
<p>
File: current-process.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">limits.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">PATH_MAX constant (macro)</span>

<span class="org-keyword">auto</span> <span class="org-function-name">get_cwd</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;
<span class="org-keyword">auto</span> <span class="org-function-name">set_cwd</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">void</span>;
<span class="org-keyword">auto</span> <span class="org-function-name">read_symlink</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Unique process ID (identifier) number </span>
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"   =&gt; Process PID = %d \n"</span>, ::getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">PID for parent process</span>
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"   =&gt; Process PID = %d \n"</span>, ::getppid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Current directory </span>
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"   =&gt; Current directory = %s \n"</span>, get_cwd<span class="org-rainbow-delimiters-depth-3">()</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"\n Change the curren directory to /etc \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    set_cwd<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/etc"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"   =&gt; Current directory = %s \n"</span>, get_cwd<span class="org-rainbow-delimiters-depth-3">()</span>.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: It only works on Linux. The directory /proc/self is a pseudo-directory </span>
    <span class="org-comment-delimiter">//       </span><span class="org-comment">whith pseudo-files containing information about the current process. </span>
    <span class="org-comment-delimiter">// </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">the file /proc/self/exe is a symbolic link to the current executable.</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">exe_file</span> = read_symlink<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/proc/self/exe"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"  =&gt; Absolute Path of current executable = %s \n"</span>, exe_file.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Current directory </span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">exe_dir</span> = read_symlink<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/proc/self/cwd"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">"  =&gt; Current directory of this executable = %s \n"</span>, exe_dir.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stdout, <span class="org-string">" [INFO] Finish Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----------- Functions Implementations ------------// </span>
<span class="org-comment-delimiter">// </span>

<span class="org-doc">/** Get current working directory of current process */</span>
<span class="org-keyword">auto</span> <span class="org-function-name">get_cwd</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">char</span>* <span class="org-variable-name">buffer</span> = ::getcwd<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">cwd</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note buffer was allocated with malloc </span>
    free<span class="org-rainbow-delimiters-depth-2">(</span>buffer<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> cwd;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-doc">/** Set current working directory for current process. */</span>
<span class="org-keyword">auto</span> <span class="org-function-name">set_cwd</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">void</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">int</span> <span class="org-variable-name">status</span> = ::chdir<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>status &lt; 0<span class="org-rainbow-delimiters-depth-2">)</span>
         <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Failed to change directory."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-doc">/** Read value of symbolic link </span>
<span class="org-doc"> *  </span>
<span class="org-doc"> * Requires: &lt;limits.h&gt;, &lt;sys/types.h&gt;, &lt;sys/stats.h&gt;</span>
<span class="org-doc"> */</span>
<span class="org-keyword">auto</span> <span class="org-function-name">read_symlink</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Create a buffer with size PATH_MAX + 1 filled with 0 ('\0'), null characters</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">(</span>PATH_MAX, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">ssize_t readlink(const char *pathname, char *buf, size_t bufsiz);</span>
    <span class="org-type">ssize_t</span> <span class="org-variable-name">nread</span> = ::readlink<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, &amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, PATH_MAX<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>nread == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: %s \n"</span>, strerror<span class="org-rainbow-delimiters-depth-4">(</span>errno<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to read symlink. Check 'errno' variable"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    buffer.resize<span class="org-rainbow-delimiters-depth-2">(</span>nread<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> buffer;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; g++ current-process.cpp -o <span class="org-keyword">current-process.elf</span> -Wall -Wextra -ggdb
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./current-process.elf 
  =&gt; Process PID = 719155 
  =&gt; Process PID = 678179 
  =&gt; Current directory = /home/mxpkf8/temp-projects/unix-explore 

Change the curren directory to /etc 
  =&gt; Current directory = /etc 
 =&gt; Absolute Path of current executable = /home/mxpkf8/temp-projects/unix-explore/current-process.elf 
 =&gt; Current directory of this executable = /etc 
[INFO] Finish Ok.
</pre>
</div>
</div>
</div>

<div id="outline-container-org3eb2be7" class="outline-3">
<h3 id="org3eb2be7"><span class="section-number-3">1.15</span> Dynamic Loading Shared Libraries / dlopen() API</h3>
<div class="outline-text-3" id="text-1-15">
</div>
<div id="outline-container-org50d7658" class="outline-4">
<h4 id="org50d7658"><span class="section-number-4">1.15.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-15-1">
<p>
The dlopen API provide access to the <span class="underline">dynamic linker</span> services allowing
the current process to load and unload shared objects or shared
libraries in its address space (virtual memory).
</p>

<p>
This API for loading shared libraries is not only available on Linux,
it also can be found in FreeBSD, NetBSD, MacOSX, Android and so on.
</p>

<p>
Use cases: 
</p>

<ul class="org-ul">
<li>Load new code at-runtime</li>

<li>Load third-party code a runtime</li>

<li>Plugin systems, extensions or addons.</li>

<li>Load native code extensions in languages with interpreters written
in C, such as Python, Ruby, Lua and so on. Note: Python native
extensions are shared libraries.</li>
</ul>

<p>
The Dlopen() API is available on most Unix-like operating systems,
such as: 
</p>

<ul class="org-ul">
<li>Linux</li>
<li>MacOSX</li>
<li>FreeBDS</li>
<li>NetBSD</li>
<li>OpenBSD</li>
<li>QNX</li>
</ul>

<p>
Documentation: 
</p>

<ul class="org-ul">
<li><a href="http://gnu.wiki/man3/dlopen.3.php">http://gnu.wiki/man3/dlopen.3.php</a></li>

<li><a href="https://man7.org/linux/man-pages/man3/dlopen.3.html">Dlopen API - Linux Manpages</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=dlopen&amp;apropos=0&amp;sektion=0&amp;manpath=SuSE+Linux%252Fi386+7.3&amp;format=html">Free BSD - dlopen API documentation</a></li>

<li><a href="https://docs.oracle.com/cd/E19048-01/chorus5/806-7014/6jftsjfdq/index.html">Dlopen - Oracle Documentation</a></li>

<li><a href="http://www.qnx.com/developers/docs/6.5.0SP1.update/com.qnx.doc.neutrino_lib_ref/d/dlopen.html">Dlopen - QNX documentation</a></li>

<li><a href="https://dwheeler.com/program-library/Program-Library-HOWTO/x172.html">Dynamically Loaded (DL) Libraries</a></li>
</ul>


<p>
Further Reading: 
</p>

<ul class="org-ul">
<li><a href="https://cseweb.ucsd.edu/~gbournou/CSE131/the_inside_story_on_shared_libraries_and_dynamic_loading.pdf">Inside the history on shared libraries and dynamic loading</a></li>

<li><a href="https://hackaday.com/2018/07/12/its-all-in-the-libs-building-a-plugin-system-using-dynamic-loading/">It 's all in the libs - Building a Plugin system using Dynamic Loading</a></li>

<li><a href="http://docencia.ac.upc.edu/FIB/USO/Bibliografia/unix-c-libraries.html">Building And Using Static And Shared "C" Libraries</a></li>

<li><a href="https://www.informit.com/articles/article.aspx?p=22435">More Shared Libraries-Dynamic Loading and Unloading</a></li>

<li><a href="https://grugq.github.io/docs/subversiveld.pdf">https://grugq.github.io/docs/subversiveld.pdf</a></li>

<li><a href="https://github.com/mgood7123/universal-dynamic-loader">universal-dynamic-loader</a> for Linux - "min-dl: minimal dynamic linker implementation"</li>
</ul>


<p>
Headers and libraries: 
</p>

<ul class="org-ul">
<li>Header:  #include &lt;dlfcn.h&gt;</li>
<li>Linking: (-ldl) flag</li>
</ul>

<p>
<span class="underline">Function dlopen()</span>:
</p>

<ul class="org-ul">
<li>Doc: $ man dlopen</li>
<li>Loads a shared library and returns a <span class="underline">handle</span> or <span class="underline">opaque pointer</span>
casted as void pointer. The term <span class="underline">opaque</span> means that the
implementation is hidden and the pointer is only meant to be
passed around to other functions.</li>
<li>Note: When this function fails, it returns null pointer.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>* <span class="org-function-name">dlopen</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<span class="underline">Function dlsym()</span>:
</p>

<ul class="org-ul">
<li>Doc: $ man dlsym</li>
<li>Obtains address of a shared library symbol from <span class="underline">handle</span> (from
dlopen).</li>
<li>Params:
<ul class="org-ul">
<li>handle =&gt; Shared library handle obtained from <span class="underline">dlopen</span></li>
<li>symbol  =&gt; Name of symbol to be loaded.</li>
</ul></li>
<li>Return:
<ul class="org-ul">
<li>Address of symbol casted as void*. It can be a function-pointer
or a pointer to global variable. If the symbol is not found, the
function returns a null pointer.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>* <span class="org-function-name">dlsym</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span>* <span class="org-variable-name">handle</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">symbol</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<span class="underline">Function dlvsym()</span>:
</p>

<ul class="org-ul">
<li>Doc: $ man dlvsym
<ul class="org-ul">
<li>Loads a specific version of a symbol.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span>* <span class="org-function-name">dlvsym</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-variable-name">handle</span>, <span class="org-type">char</span> *<span class="org-variable-name">symbol</span>, <span class="org-type">char</span> *<span class="org-variable-name">version</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<span class="underline">Function dlclose()</span>: 
</p>

<ul class="org-ul">
<li>Doc: $ man dlclose()</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">dlclose</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span> *<span class="org-variable-name">handle</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<span class="underline">Function dlerror()</span> 
</p>
<ul class="org-ul">
<li>Obtaines error messages from dlopen API.</li>
<li>Doc: $ man dlerror()</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">char</span>* <span class="org-function-name">dlerror</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Simplified type signatures with a C++-friendly notation</b>
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Opaque pointer for shared library (shared object) handle </span>
<span class="org-keyword">using</span> <span class="org-type">HND</span> = <span class="org-type">void</span>* ; 
<span class="org-comment-delimiter">// </span><span class="org-comment">Opaque pointer for shared library symbol </span>
<span class="org-keyword">using</span> <span class="org-type">SYM</span> = <span class="org-type">void</span>* ; 

<span class="org-type">HND</span>  <span class="org-function-name">dlopen</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">SYM</span>   <span class="org-function-name">dlsym</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HND</span> <span class="org-variable-name">handle</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">symbol</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">SYM</span>  <span class="org-function-name">dlvsym</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HND</span> <span class="org-variable-name">handle</span>, <span class="org-type">char</span> *<span class="org-variable-name">symbol</span>, <span class="org-type">char</span> *<span class="org-variable-name">version</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">int</span> <span class="org-function-name">dlclose</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">HND</span> <span class="org-variable-name">handle</span> <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Usage example</b> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Opaque pointer for shared library (shared object) handle </span>
<span class="org-keyword">using</span> <span class="org-type">HND</span> = <span class="org-type">void</span>* ; 
<span class="org-comment-delimiter">// </span><span class="org-comment">Opaque pointer for shared library symbol </span>
<span class="org-keyword">using</span> <span class="org-type">SYM</span> = <span class="org-type">void</span>* ; 

<span class="org-type">void</span> <span class="org-function-name">load_library</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Load shared library </span>
    <span class="org-type">HND</span> <span class="org-variable-name">hnd</span> = dlopen<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"/path/to/shared-library.so"</span>, RTLD_LAZY | RTLD_GLOBAL<span class="org-rainbow-delimiters-depth-2">)</span>; 
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hnd == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">"  [ERROR] "</span> &lt;&lt; dlerror<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-string">"\n"</span>;
       <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to load shared library"</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Load symbol </span>
    <span class="org-type">SYM</span> <span class="org-variable-name">hsym</span> = dlsym<span class="org-rainbow-delimiters-depth-2">(</span>hnd, <span class="org-string">"name_of_function"</span><span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">if(!hsym)</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hsym == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: symbol not found"</span><span class="org-rainbow-delimiters-depth-3">)</span>; 
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for function pointer in modern C++ </span>
    <span class="org-comment-delimiter">//  </span><span class="org-comment">=&gt; Note: The function to be loaded can only have C-linkage. </span>
    <span class="org-keyword">using</span> <span class="org-type">name_of_function_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">param0</span>, <span class="org-type">double</span> <span class="org-variable-name">param1</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">param3</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for function pointer in old C++ (C++98)</span>
    <span class="org-keyword">typedef</span> <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-type">name_of_function_t</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">param0</span>, <span class="org-type">double</span> <span class="org-variable-name">param1</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">param3</span><span class="org-rainbow-delimiters-depth-2">)</span>;       

    <span class="org-keyword">auto</span> <span class="org-variable-name">name_of_function_ptr</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">name_of_function_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hsym<span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">Call loaded function (Function pointer)</span>
    name_of_function_ptr<span class="org-rainbow-delimiters-depth-2">(</span>100, 2.51, <span class="org-string">"string"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Unload shared library </span>
    dlclose<span class="org-rainbow-delimiters-depth-2">(</span>hsym<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org19d2959" class="outline-4">
<h4 id="org19d2959"><span class="section-number-4">1.15.2</span> GTK3/GTK2 GUI using dynamic loading - low level</h4>
<div class="outline-text-4" id="text-1-15-2">
<p>
The following sample code is a GTk3 or GTK2 GUI graphical user
interface application with GTK functions loaded from a GTK shared
library, without any compile-time linking. The advantage of this
approach is the greater portability across different versions of GTk
and the ability to switch between GT3 and GT2.
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/d81dd9c422dc93ad4104b5e79259afdf">https://gist.github.com/d81dd9c422dc93ad4104b5e79259afdf</a></li>
</ul>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(gtk-sample)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

       <span class="org-function-name">add_executable</span>( gtk-dlopen gtk-dlopen.cpp)
<span class="org-function-name">target_link_libraries</span>( gtk-dlopen dl )   
</pre>
</div>

<p>
File: gtk-dlopen.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Uses: dlopen(), dlclose(), ... </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Copied from GTK headers ------// </span>
<span class="org-keyword">typedef</span> <span class="org-type">char</span>            <span class="org-type">gchar</span>;
<span class="org-keyword">typedef</span> <span class="org-type">short</span>           <span class="org-type">gshort</span>;
<span class="org-keyword">typedef</span> <span class="org-type">long</span>            <span class="org-type">glong</span>;
<span class="org-keyword">typedef</span> <span class="org-type">int</span>             <span class="org-type">gint</span>;
<span class="org-keyword">typedef</span> <span class="org-type">gint</span>            <span class="org-type">gboolean</span>;
<span class="org-keyword">typedef</span> <span class="org-type">unsigned</span> <span class="org-type">char</span>   <span class="org-type">guchar</span>;
<span class="org-keyword">typedef</span> <span class="org-type">unsigned</span> <span class="org-type">short</span>  <span class="org-type">gushort</span>;
<span class="org-keyword">typedef</span> <span class="org-type">unsigned</span> <span class="org-type">long</span>   <span class="org-type">gulong</span>;
<span class="org-keyword">typedef</span> <span class="org-type">unsigned</span> <span class="org-type">int</span>    <span class="org-type">guint</span>;
<span class="org-keyword">typedef</span> <span class="org-type">float</span>           <span class="org-type">gfloat</span>;
<span class="org-keyword">typedef</span> <span class="org-type">double</span>          <span class="org-type">gdouble</span>;
<span class="org-keyword">typedef</span> <span class="org-type">void</span>*           <span class="org-type">gpointer</span>;
<span class="org-keyword">typedef</span> <span class="org-keyword">const</span> <span class="org-type">void</span>*     <span class="org-type">gconstpointer</span>;

<span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkWindowType</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-variable-name">GTK_WINDOW_TOPLEVEL</span>,
    <span class="org-variable-name">GTK_WINDOW_POPUP</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GConnectFlags</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-variable-name">G_CONNECT_AFTER</span>   = 1 &lt;&lt; 0,
  <span class="org-variable-name">G_CONNECT_SWAPPED</span> = 1 &lt;&lt; 1
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-type">TFun</span> <span class="org-function-name">load_symbol</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span>* <span class="org-variable-name">hnd</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">symbol</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">void</span>* <span class="org-variable-name">hSym</span> = dlsym<span class="org-rainbow-delimiters-depth-2">(</span>hnd, symbol.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hSym == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span> = <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [Error] symbol not found: "</span><span class="org-rainbow-delimiters-depth-3">)</span> + symbol;
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span>msg<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>    
    <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hSym<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Opaque type (aka incomplete type)</span>
<span class="org-keyword">struct</span> <span class="org-type">GClosure</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">-------- Function Pointers type aliases -------------------//</span>
<span class="org-keyword">using</span> <span class="org-type">GCallback</span>      = <span class="org-type">void</span>  <span class="org-rainbow-delimiters-depth-1">(</span>*<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">using</span> <span class="org-type">GClosureNotify</span> = <span class="org-type">void</span>  <span class="org-rainbow-delimiters-depth-1">(</span>*<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">gpointer</span> <span class="org-variable-name">data</span>, <span class="org-type">GClosure</span>* <span class="org-variable-name">closure</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">using</span> <span class="org-type">g_signal_connect_data_t</span> =  gulong <span class="org-rainbow-delimiters-depth-1">(</span>*<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">(</span>   <span class="org-type">gpointer</span> <span class="org-variable-name">instance</span>
                                              , <span class="org-keyword">const</span> <span class="org-type">gchar</span>*    <span class="org-variable-name">detailed_signal</span>
                                              , <span class="org-type">GCallback</span>       <span class="org-variable-name">c_handler</span>
                                              , <span class="org-type">gpointer</span>        <span class="org-variable-name">data</span>
                                              , <span class="org-type">GClosureNotify</span>  <span class="org-variable-name">destroy_data</span>
                                              , <span class="org-type">GConnectFlags</span>   <span class="org-variable-name">connect_flags</span>
                                          <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>    
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">shared_lib</span> =  <span class="org-rainbow-delimiters-depth-2">[</span>&amp;<span class="org-rainbow-delimiters-depth-2">]()</span> -&gt; <span class="org-constant">std</span>::string 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">return</span> <span class="org-string">"libgtk-3.so.0"</span>;
        <span class="org-keyword">return</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>;
    <span class="org-rainbow-delimiters-depth-2">}()</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Loading shared library: "</span> &lt;&lt; shared_lib &lt;&lt; <span class="org-string">"\n"</span>;

    <span class="org-comment-delimiter">//  </span><span class="org-comment">void *dlopen(const char *filename, int flags);</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Handle to shared library </span>
    <span class="org-type">void</span>* <span class="org-variable-name">hnd</span> = dlopen<span class="org-rainbow-delimiters-depth-2">(</span>shared_lib.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, RTLD_NOW | RTLD_GLOBAL<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>hnd == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">){</span> fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"%s\n"</span>, dlerror<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;  <span class="org-rainbow-delimiters-depth-2">}</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span> hnd != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">void</span>* <span class="org-variable-name">hSym</span> = <span class="org-constant">nullptr</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Load gtk_init_check function pointer ------- // </span>
    hSym = dlsym<span class="org-rainbow-delimiters-depth-2">(</span>hnd, <span class="org-string">"gtk_init_check"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span>hSym != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">using</span> <span class="org-type">gtk_init_check_t</span> = gboolean <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span>* <span class="org-variable-name">argc</span>, <span class="org-type">char</span>*** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_init_check</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">gtk_init_check_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hSym<span class="org-rainbow-delimiters-depth-2">)</span>;   

    <span class="org-comment-delimiter">// </span><span class="org-comment">------- Load remaining function pointers (symbols) --------// </span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">-----------------------------------------------------------//</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">opaque pointer </span>
    <span class="org-keyword">struct</span> <span class="org-type">GtkWidget</span>;

    <span class="org-keyword">using</span> <span class="org-type">gkt_window_new_t</span> = GtkWidget* <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_window_new</span>  = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">gkt_window_new_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_window_new"</span><span class="org-rainbow-delimiters-depth-2">)</span>;    
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_widget_show</span> = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GtkWidget</span>*<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_widget_show"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_main</span>        = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_main"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">using</span> <span class="org-type">gtk_window_set_title_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">GtkWidget</span>* <span class="org-variable-name">window</span>, <span class="org-keyword">const</span> <span class="org-type">gchar</span>* <span class="org-variable-name">title</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_window_set_title</span> = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">gtk_window_set_title_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_window_set_title"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">using</span> <span class="org-type">gtk_widget_set_size_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">GtkWidget</span>*, gint, gint<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_widget_set_size</span> = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">gtk_widget_set_size_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_widget_set_size_request"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_main_quit</span> = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"gtk_main_quit"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk_signal_connect_data</span> 
          = load_symbol<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">g_signal_connect_data_t</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>hnd, <span class="org-string">"g_signal_connect_data"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-doc">/** ------- Build Window GUI - Graphical User Interface ----------**/</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Call function pointer </span>
    gtk_init_check<span class="org-rainbow-delimiters-depth-2">(</span>&amp;argc, &amp;argv<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">GtkWidget</span>* <span class="org-variable-name">window</span> = gtk_window_new<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-constant">GtkWindowType</span>::GTK_WINDOW_TOPLEVEL<span class="org-rainbow-delimiters-depth-2">)</span>;
    gtk_widget_set_size<span class="org-rainbow-delimiters-depth-2">(</span>window, 400, 500<span class="org-rainbow-delimiters-depth-2">)</span>;
    gtk_window_set_title<span class="org-rainbow-delimiters-depth-2">(</span>window, <span class="org-string">"My GTK Window"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    gtk_widget_show<span class="org-rainbow-delimiters-depth-2">(</span>window<span class="org-rainbow-delimiters-depth-2">)</span>;    

    gtk_signal_connect_data<span class="org-rainbow-delimiters-depth-2">(</span>  window         <span class="org-comment-delimiter">// </span><span class="org-comment">Widget </span>
                            , <span class="org-string">"destroy"</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">Event name </span>
                            , gtk_main_quit  <span class="org-comment-delimiter">// </span><span class="org-comment">Callback                             </span>
                            , <span class="org-constant">nullptr</span>        <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to data (closure )</span>
                            , <span class="org-constant">nullptr</span> 
                            , <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GConnectFlags</span><span class="org-rainbow-delimiters-depth-3">)</span> 0 <span class="org-comment-delimiter">// </span><span class="org-comment">GConnect flags </span>
                            <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Window running. OK! "</span> &lt;&lt; <span class="org-string">"\n"</span>;
    gtk_main<span class="org-rainbow-delimiters-depth-2">()</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Always close shared library handler.</span>
    dlclose<span class="org-rainbow-delimiters-depth-2">(</span>hnd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Shutdown gracefully. Ok. \n"</span> ;
    <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://gist.github.com/d81dd9c422dc93ad4104b5e79259afdf &amp;&amp; <span class="org-builtin">cd</span> gist 
$ g++ gtk-dlopen.cpp -o <span class="org-keyword">gtk-dlopen.bin</span> -std=c++1z -ldl -ggdb -Wall -Wextra   
</pre>
</div>

<p>
Checking the dependencies of gtk-dlopen.bin 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ldd gtk-dlopen.bin 
       linux-vdso.so.1 (0x00007ffd23fc4000)
       libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f6a78428000)
       libstdc++.so.6 =&gt; /lib64/libstdc++.so.6 (0x00007f6a78238000)
       libm.so.6 =&gt; /lib64/libm.so.6 (0x00007f6a780f2000)
       libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007f6a780d7000)
       libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f6a77f0d000)
       /lib64/ld-linux-x86-64.so.2 (0x00007f6a78453000)
</pre>
</div>

<p>
Running: (load GTK shared library /lib64/libgtk-3.so.0)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./gtk-dlopen.bin 
[INFO] Loading shared library: /lib64/libgtk-3.so.0
[INFO] Window running. OK! 
[INFO] Shutdown gracefully. Ok. 
</pre>
</div>

<p>
Running: (load GK2 shared library )
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./gtk-dlopen.bin /usr/lib64/libgtk-x11-2.0.so 
[INFO] Loading shared library: /usr/lib64/libgtk-x11-2.0.so
[INFO] Window running. OK! 
[INFO] Shutdown gracefully. Ok. 
</pre>
</div>

<p>
Verify exported symbols by gtk3 shared library: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; nm -D /lib64/libgtk-3.so.0 | grep init
       ... ... ... ... ..
       ... ... ... ... ..
       U g_async_initable_new_async
       U g_async_initable_new_finish
       U g_datalist_init
       U g_hash_table_iter_init
       U g_initable_get_type
       U g_initable_new
       U g_initially_unowned_get_type
       U g_mutex_init
       U g_once_init_enter
      ... ... ... ... ..
      ... ... ... ... ..
</pre>
</div>
</div>
</div>

<div id="outline-container-org4836c66" class="outline-4">
<h4 id="org4836c66"><span class="section-number-4">1.15.3</span> GTK3/GTK2 GUI using dynamic loading - high level C++ wrapper</h4>
<div class="outline-text-4" id="text-1-15-3">
<p>
This proof-of-concept code contains a high-level wrapper class
SharedLibrary for abstracting away the dlopen() API. This class is
used for loading GTK3 or GTk2 shared library at runtime and then
showing modal notifications dialogs. The advantage of the dynamic
loading approach is the flexibility, portability and easier deployment
as the binary does not depends on any particular GTK shared library
version.
</p>

<p>
Note: 
</p>

<ul class="org-ul">
<li>The code of the class SharedLibrary can be reused on any other
unix-like operating system with dlopen() API, such as FreeBDS,
NetBSD, MacOSX and so on.</li>

<li>The Windows API for dynamic loading is LoadLibrary(),
GetProcAddress().</li>
</ul>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/6bbb3b9491d4fad01d3875a559b7365b">https://gist.github.com/6bbb3b9491d4fad01d3875a559b7365b</a></li>
</ul>

<p>
<b>Project Files</b> 
</p>

<p>
File: CMakeLists.txt 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(gtk-dynamic-load-dialog)

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-comment"># ---- TARGETS Configuration ---------------#</span>
       <span class="org-function-name">add_executable</span>( gtk-dialog gtk-dialog.cpp gtk_types.hpp)
<span class="org-function-name">target_link_libraries</span>( gtk-dialog dl ) 
</pre>
</div>

<p>
File: gtk-dialog.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Uses: dlopen(), dlclose(), ... </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string">"gtk_types.hpp"</span>

<span class="org-doc">/** Requires header: &lt;dlfcn.h&gt; and linking flag (-ldl) */</span>
<span class="org-keyword">class</span> <span class="org-type">SharedLibrary</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
    <span class="org-keyword">using</span> <span class="org-type">HND</span>  = <span class="org-type">void</span>*; 
    <span class="org-keyword">using</span> <span class="org-type">HSYM</span> = <span class="org-type">void</span>*;
<span class="org-function-name">private</span>:
    <span class="org-type">HND</span>         <span class="org-variable-name">m_hnd</span>  = <span class="org-constant">nullptr</span>; 
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">m_lib</span> = <span class="org-string">""</span> ; 
    <span class="org-type">int</span>         <span class="org-variable-name">m_flags</span> = 0;
<span class="org-function-name">public</span>:
    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(){}</span>    
    ~<span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(){</span> <span class="org-keyword">this</span>-&gt;unload<span class="org-rainbow-delimiters-depth-3">()</span>; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Constructor delegation </span>
    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">library</span><span class="org-rainbow-delimiters-depth-2">)</span>
        : SharedLibrary<span class="org-rainbow-delimiters-depth-2">(</span>library, RTLD_NOW | RTLD_GLOBAL<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>  <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">library</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;load<span class="org-rainbow-delimiters-depth-3">(</span>library, flags<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy constructor and copy-assignment operator </span>
    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">SharedLibrary</span> <span class="org-keyword">const</span> &amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;
    <span class="org-type">SharedLibrary</span>&amp; <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">SharedLibrary</span> <span class="org-keyword">const</span> &amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Move constructor </span>
    <span class="org-function-name">SharedLibrary</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">SharedLibrary</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, rhs.m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_lib, rhs.m_lib<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_flags, rhs.m_flags<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Move assignment operator </span>
    <span class="org-type">SharedLibrary</span>&amp; <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">SharedLibrary</span>&amp;&amp; <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;unload<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, rhs.m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_lib, rhs.m_lib<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::swap<span class="org-rainbow-delimiters-depth-3">(</span>m_flags, rhs.m_flags<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">HND</span>         <span class="org-function-name">handler</span><span class="org-rainbow-delimiters-depth-2">()</span>   <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_hnd; <span class="org-rainbow-delimiters-depth-2">}</span>    
    <span class="org-type">bool</span>        <span class="org-function-name">is_loaded</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_hnd != <span class="org-constant">nullptr</span>; <span class="org-rainbow-delimiters-depth-2">}</span>    
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-function-name">library</span><span class="org-rainbow-delimiters-depth-2">()</span>   <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_lib; <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-doc">/** Retrieve symbol from shared library */</span>
    <span class="org-type">HSYM</span> <span class="org-function-name">symbol_ptr</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> ::dlsym<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, name.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-doc">/** </span><span class="org-doc"><span class="org-constant">@brief</span></span><span class="org-doc"> Get symbol from shared library</span>
<span class="org-doc">     * Note: The caller is resposible for checking if the symbol is (null) nullptr.</span>
<span class="org-doc">     */</span>
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-type">TFun</span> <span class="org-function-name">symbol</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-type">HSYM</span> <span class="org-variable-name">sym</span> = ::dlsym<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, name.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>sym<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-doc">/** </span><span class="org-doc"><span class="org-constant">@brief</span></span><span class="org-doc"> Attempts to load symbol and throws exception, if symbol is not found. */</span>
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-type">TFun</span> <span class="org-function-name">symbol_or_fail</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-type">HSYM</span> <span class="org-variable-name">sym</span> = ::dlsym<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd, name.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span>sym<span class="org-rainbow-delimiters-depth-3">){</span> 
            <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span> = <span class="org-string">" [ERROR] Dlopen / dlsym() =&gt; unable find symbol"</span>;
            msg = msg + <span class="org-string">" &lt;"</span> + name + <span class="org-string">"&gt;"</span>;
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span>msg<span class="org-rainbow-delimiters-depth-4">)</span>; 
        <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">TFun</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>sym<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">load</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">library</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span><span class="org-keyword">this</span>-&gt;is_loaded<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">this</span>-&gt;unload<span class="org-rainbow-delimiters-depth-4">()</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        m_lib   = library;
        m_flags = flags;
        m_hnd = dlopen<span class="org-rainbow-delimiters-depth-3">(</span>library.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, RTLD_NOW | RTLD_GLOBAL<span class="org-rainbow-delimiters-depth-3">)</span>;        
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_hnd == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">){</span> 
            <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span> = <span class="org-string">" [ERROR] DlopenError: "</span>;
            msg = msg + dlerror<span class="org-rainbow-delimiters-depth-4">()</span>;
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span>msg<span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>    

    <span class="org-type">void</span> <span class="org-function-name">reload</span><span class="org-rainbow-delimiters-depth-2">()</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">this</span>-&gt;unload<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-keyword">this</span>-&gt;load<span class="org-rainbow-delimiters-depth-3">(</span>m_lib, m_flags<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">void</span> <span class="org-function-name">unload</span><span class="org-rainbow-delimiters-depth-2">()</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-negation-char">!</span><span class="org-keyword">this</span>-&gt;is_loaded<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span> <span class="org-keyword">return</span>; <span class="org-rainbow-delimiters-depth-3">}</span>
        ::dlclose<span class="org-rainbow-delimiters-depth-3">(</span>m_hnd<span class="org-rainbow-delimiters-depth-3">)</span>;        
        m_hnd = <span class="org-constant">nullptr</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of class SharedLibrary() ---- //</span>

<span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">GtkPP</span>::<span class="org-constant">fpointer</span>;
<span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">GtkPP</span>::<span class="org-constant">enums</span>;

<span class="org-keyword">struct</span> <span class="org-type">GtkLib</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">SharedLibrary</span> <span class="org-variable-name">slib</span>;

    <span class="org-function-name">GtkLib</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">library</span><span class="org-rainbow-delimiters-depth-2">)</span>
        : slib<span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-3">(</span>SharedLibrary<span class="org-rainbow-delimiters-depth-4">(</span>library<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span> 
        gtk_init_check         = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_init_check_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_init_check"</span><span class="org-rainbow-delimiters-depth-3">)</span>;       
        gtk_main_quit          = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_main_quit_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_main_quit"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">gtk_main               = slib.symbol_or_fail&lt;void (*) ()&gt;("gtk_main");</span>
        gtk_message_dialog_new = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_message_dialog_new_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_message_dialog_new"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        gtk_widget_destroy     = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_widget_destroy_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_widget_destroy"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        gtk_dialog_run         = slib.symbol_or_fail<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_dialog_run_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_dialog_run"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        gtk_window_set_title   = slib.symbol<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">gtk_window_set_title_t</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-string">"gtk_window_set_title"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">gtk_init_check_t</span>         <span class="org-variable-name">gtk_init_check</span>; 
    <span class="org-type">gtk_main_quit_t</span>          <span class="org-variable-name">gtk_main_quit</span>; 
    <span class="org-comment-delimiter">// </span><span class="org-comment">gtk_main_t               gtk_main;</span>
    <span class="org-type">gtk_message_dialog_new_t</span> <span class="org-variable-name">gtk_message_dialog_new</span>;
    <span class="org-type">gtk_widget_destroy_t</span>     <span class="org-variable-name">gtk_widget_destroy</span>;
    <span class="org-type">gtk_dialog_run_t</span>         <span class="org-variable-name">gtk_dialog_run</span>;
    <span class="org-type">gtk_window_set_title_t</span>   <span class="org-variable-name">gtk_window_set_title</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Message box notification </span>
    <span class="org-type">void</span> <span class="org-function-name">msgbox</span><span class="org-rainbow-delimiters-depth-2">(</span>  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">title</span>
                , <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">text</span> 
                , <span class="org-type">GtkMessageType</span> <span class="org-variable-name">mtype</span> = <span class="org-constant">GtkMessageType</span>::GTK_MESSAGE_INFO 
                <span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-type">GtkWidget</span>* <span class="org-variable-name">dialog</span> = <span class="org-keyword">this</span>-&gt;gtk_message_dialog_new<span class="org-rainbow-delimiters-depth-3">(</span>  <span class="org-constant">nullptr</span> 
                                                , <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-constant">GtkDialogFlags</span>::GTK_DIALOG_MODAL
                                                , <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span> mtype 
                                                , <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-constant">GtkButtonsType</span>::GTK_BUTTONS_OK
                                                , text.c_str<span class="org-rainbow-delimiters-depth-4">()</span>
                                                <span class="org-rainbow-delimiters-depth-3">)</span>;                                            
        assert<span class="org-rainbow-delimiters-depth-3">(</span> dialog != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-3">)</span>;    
        <span class="org-keyword">this</span>-&gt;gtk_window_set_title<span class="org-rainbow-delimiters-depth-3">(</span>dialog, title.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">this</span>-&gt;gtk_dialog_run<span class="org-rainbow-delimiters-depth-3">(</span>dialog<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Dialog destroyed OK "</span> &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-keyword">this</span>-&gt;gtk_widget_destroy<span class="org-rainbow-delimiters-depth-3">(</span>dialog<span class="org-rainbow-delimiters-depth-3">)</span>;   
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>        
    <span class="org-comment-delimiter">// </span><span class="org-comment">User can select his own GTK shared library, if it is not </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">found. He can also select GTK2 shared library. </span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">shared_lib</span> =  <span class="org-rainbow-delimiters-depth-2">[</span>&amp;<span class="org-rainbow-delimiters-depth-2">]()</span> -&gt; <span class="org-constant">std</span>::string 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">return</span> <span class="org-string">"libgtk-3.so.0"</span>;
        <span class="org-keyword">return</span> argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>;
    <span class="org-rainbow-delimiters-depth-2">}()</span>;

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Loading shared library: "</span> &lt;&lt; shared_lib &lt;&lt; <span class="org-string">"\n"</span>;   
    <span class="org-keyword">auto</span> <span class="org-variable-name">gtk</span> = GtkLib<span class="org-rainbow-delimiters-depth-2">{</span>shared_lib<span class="org-rainbow-delimiters-depth-2">}</span>;   

    <span class="org-comment-delimiter">// </span><span class="org-comment">Alwas start the library before calling any GTK function </span>
    gtk.gtk_init_check<span class="org-rainbow-delimiters-depth-2">(</span>&amp;argc, &amp;argv<span class="org-rainbow-delimiters-depth-2">)</span>;    

    gtk.msgbox<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"User notification"</span>, <span class="org-string">"Download completed. Ok."</span>,     <span class="org-constant">GtkMessageType</span>::GTK_MESSAGE_INFO <span class="org-rainbow-delimiters-depth-2">)</span>;    
    gtk.msgbox<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Runtime error"</span>,     <span class="org-string">"KERNEL PANIC!! Reboot NOW!!"</span>, <span class="org-constant">GtkMessageType</span>::GTK_MESSAGE_ERROR <span class="org-rainbow-delimiters-depth-2">)</span>;        

    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Shutdown gracefully. Ok. \n"</span> ;
    <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
File: gtk_types.hpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">------ C++ Wrappers for dynamically loading GTK ----- //</span>
<span class="org-preprocessor">#if</span><span class="org-negation-char"><span class="org-preprocessor">n</span></span><span class="org-preprocessor">def</span> _GTK_TYPES_HPP
<span class="org-preprocessor">#define</span> <span class="org-variable-name">_GTK_TYPES_HPP</span>

<span class="org-keyword">namespace</span> <span class="org-constant">GtkPP</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">namespace</span> <span class="org-constant">base</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">using</span> <span class="org-type">gchar</span>    = <span class="org-type">char</span>;
        <span class="org-keyword">using</span> <span class="org-type">gshort</span>   = <span class="org-type">short</span>;
        <span class="org-keyword">using</span> <span class="org-type">glong</span>    = <span class="org-type">long</span>;
        <span class="org-keyword">using</span> <span class="org-type">gint</span>     = <span class="org-type">int</span>;
        <span class="org-keyword">using</span> <span class="org-type">gboolean</span> = gint;
        <span class="org-keyword">using</span> <span class="org-type">guchar</span>   = <span class="org-type">unsigned</span> <span class="org-type">short</span>;
        <span class="org-keyword">using</span> <span class="org-type">gulong</span>   = <span class="org-type">unsigned</span> <span class="org-type">long</span>;
        <span class="org-keyword">using</span> <span class="org-type">guint</span>    = <span class="org-type">unsigned</span> <span class="org-type">int</span>;
        <span class="org-keyword">using</span> <span class="org-type">gfloat</span>   = <span class="org-type">float</span>;
        <span class="org-keyword">using</span> <span class="org-type">gdouble</span>  = <span class="org-type">double</span>;
        <span class="org-keyword">using</span> <span class="org-type">gpointer</span> = <span class="org-type">void</span>*;          
        <span class="org-keyword">using</span> <span class="org-type">gconstpointer</span> = <span class="org-keyword">const</span> <span class="org-type">void</span>*;

    <span class="org-rainbow-delimiters-depth-2">}</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">------- Opaque Types / incomplete types ---------//</span>
    <span class="org-keyword">namespace</span> <span class="org-constant">widget</span> <span class="org-rainbow-delimiters-depth-2">{</span>        
        <span class="org-keyword">struct</span> <span class="org-type">GtkWidget</span>;
        <span class="org-keyword">struct</span> <span class="org-type">GClosure</span>;
        <span class="org-keyword">struct</span> <span class="org-type">GtkWidget</span>;
        <span class="org-keyword">struct</span> <span class="org-type">GtkWindow</span>;
        <span class="org-keyword">struct</span> <span class="org-type">GtkDialog</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-keyword">namespace</span> <span class="org-constant">enums</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkWindowType</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-variable-name">GTK_WINDOW_TOPLEVEL</span>,
            <span class="org-variable-name">GTK_WINDOW_POPUP</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GConnectFlags</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-variable-name">G_CONNECT_AFTER</span> = 1 &lt;&lt; 0,
        <span class="org-variable-name">G_CONNECT_SWAPPED</span>   = 1 &lt;&lt; 1
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkMessageType</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-variable-name">GTK_MESSAGE_INFO</span>,
        <span class="org-variable-name">GTK_MESSAGE_WARNING</span>,
        <span class="org-variable-name">GTK_MESSAGE_QUESTION</span>,
        <span class="org-variable-name">GTK_MESSAGE_ERROR</span>,
        <span class="org-variable-name">GTK_MESSAGE_OTHER</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkButtonsType</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-variable-name">GTK_BUTTONS_NONE</span>,
        <span class="org-variable-name">GTK_BUTTONS_OK</span>,
        <span class="org-variable-name">GTK_BUTTONS_CLOSE</span>,
        <span class="org-variable-name">GTK_BUTTONS_CANCEL</span>,
        <span class="org-variable-name">GTK_BUTTONS_YES_NO</span>,
        <span class="org-variable-name">GTK_BUTTONS_OK_CANCEL</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>;

        <span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">GtkDialogFlags</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
        <span class="org-variable-name">GTK_DIALOG_MODAL</span>               = 1 &lt;&lt; 0,
        <span class="org-variable-name">GTK_DIALOG_DESTROY_WITH_PARENT</span> = 1 &lt;&lt; 1,
        <span class="org-variable-name">GTK_DIALOG_USE_HEADER_BAR</span>      = 1 &lt;&lt; 2
        <span class="org-rainbow-delimiters-depth-3">}</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-doc">/** </span><span class="org-doc"><span class="org-constant">@brief</span></span><span class="org-doc"> Function pointers type aliases  */</span>
    <span class="org-keyword">namespace</span> <span class="org-constant">fpointer</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">base</span>;
        <span class="org-keyword">using</span> <span class="org-keyword">namespace</span> <span class="org-constant">widget</span>;
        <span class="org-keyword">using</span> <span class="org-constant">enums</span>::<span class="org-type">GConnectFlags</span>;

        <span class="org-keyword">using</span> <span class="org-type">GtkDialogFlags_t</span> = <span class="org-type">int</span>; 
        <span class="org-keyword">using</span> <span class="org-type">GtkMessageType_t</span> = <span class="org-type">int</span>; 
        <span class="org-keyword">using</span> <span class="org-type">GtkButtonsType_t</span> = <span class="org-type">int</span>;

        <span class="org-keyword">using</span> <span class="org-type">gtk_init_check_t</span> = gboolean <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span>* <span class="org-variable-name">argc</span>, <span class="org-type">char</span>*** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">gtk_dialog_run_t</span>       = gint <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">void</span>* <span class="org-variable-name">dialog</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">gtk_widget_destroy_t</span>   = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GtkWidget</span>* <span class="org-variable-name">widget</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">gtk_window_set_title_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GtkWidget</span>* <span class="org-variable-name">window</span>, <span class="org-keyword">const</span> <span class="org-type">gchar</span>* <span class="org-variable-name">title</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">gtk_main_quit_t</span>        = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">()</span>;

        <span class="org-keyword">using</span> <span class="org-type">gtk_window_set_title_t</span> = <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">GtkWidget</span>* <span class="org-variable-name">window</span>, <span class="org-keyword">const</span> <span class="org-type">gchar</span>* <span class="org-variable-name">title</span><span class="org-rainbow-delimiters-depth-3">)</span>;


        <span class="org-keyword">using</span> <span class="org-type">GCallback</span>      = <span class="org-type">void</span>  <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">GClosureNotify</span> = <span class="org-type">void</span>  <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">gpointer</span> <span class="org-variable-name">data</span>, <span class="org-type">GClosure</span>* <span class="org-variable-name">closure</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">using</span> <span class="org-type">g_signal_connect_data_t</span> =  gulong <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-type">gpointer</span>        <span class="org-variable-name">instance</span>
                                                    , <span class="org-keyword">const</span> <span class="org-type">gchar</span>*    <span class="org-variable-name">detailed_signal</span>
                                                    , <span class="org-type">GCallback</span>       <span class="org-variable-name">c_handler</span>
                                                    , <span class="org-type">gpointer</span>          <span class="org-variable-name">data</span>
                                                    , <span class="org-type">GClosureNotify</span>  <span class="org-variable-name">destroy_data</span>
                                                    , <span class="org-type">GConnectFlags</span> <span class="org-variable-name">connect_flags</span>
                                                    <span class="org-rainbow-delimiters-depth-3">)</span>;


        <span class="org-keyword">using</span> <span class="org-type">gtk_message_dialog_new_t</span> = GtkWidget* <span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-type">GtkWindow</span>       *<span class="org-variable-name">parent</span>,
                                                          <span class="org-type">GtkDialogFlags_t</span>  <span class="org-variable-name">flags</span>,
                                                          <span class="org-type">GtkMessageType_t</span>  <span class="org-variable-name">type</span>,
                                                          <span class="org-type">GtkButtonsType_t</span>  <span class="org-variable-name">buttons</span>,
                                                          <span class="org-keyword">const</span> <span class="org-type">gchar</span>*    <span class="org-variable-name">message_format</span>
                                                        <span class="org-rainbow-delimiters-depth-3">)</span>;


    <span class="org-rainbow-delimiters-depth-2">}</span>;

<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-preprocessor">#endif</span> 
</pre>
</div>

<p>
Building and running: 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Download </span>
$ &gt;&gt; git clone https://gist.github.com/6bbb3b9491d4fad01d3875a559b7365b gtk-dialog &amp;&amp; <span class="org-builtin">cd</span> gtk-dialog 

<span class="org-comment-delimiter"># </span><span class="org-comment">Configure </span>
$ &gt;&gt; cmake --config Debug -H. -B_build

<span class="org-comment-delimiter"># </span><span class="org-comment">Build </span>
$ &gt;&gt; cmake --build _build --target 

<span class="org-comment-delimiter"># </span><span class="org-comment">Run </span>
$ &gt;&gt; _build/gtk-dialog 
[INFO] Loading shared library: libgtk-3.so.0
[INFO] Dialog destroyed OK 
[INFO] Dialog destroyed OK 
[INFO] Shutdown gracefully. Ok. 

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org17fa151" class="outline-3">
<h3 id="org17fa151"><span class="section-number-3">1.16</span> Library calls hooking/interception with LD_PRELOAD</h3>
<div class="outline-text-3" id="text-1-16">
</div>
<div id="outline-container-orgdf1ce8e" class="outline-4">
<h4 id="orgdf1ce8e"><span class="section-number-4">1.16.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-16-1">
<p>
The dynamic linker of many Unix-like operating systems, including
Linux-based ones and BSD variants, provide a LD_PRELOAD mechanism,
which allows intercepting and overriding (aka hooking) library calls
performed by applications withou any source code modification. A
library call can be overriden by setting the LD_PRELOAD environment
variable with a colon (':') separated list containing full paths of
shared libraries containing symbols with the same name as the
overriden functions.
</p>

<p>
Some use-cases of this feature are: 
</p>

<ul class="org-ul">
<li>Override library calls and modify the behavior of library calls.</li>
<li>Performance analysis.</li>
<li>Instrument library calls.</li>
<li>Log library-calls</li>
<li>Trace memory allocation by overrading calloc, malloc and free
functions.</li>
<li>Patch executables without any source code modification or
recompilation.</li>
</ul>

<p>
Notes and limitations: 
</p>

<ul class="org-ul">
<li>The dynamic linker LD_PRELOAD feature do not intercept kernel's
system-calls, it can only intercept library calls (aka function
calls) or GlibC (GNU C library) or any other CRT (C - Runtime
Library) wrappers for <span class="underline">system calls</span>, informally called
<span class="underline">syscalls</span>.</li>

<li>LD_PRELOAD trick cannot intercept functions of executables owned
by root and with SETUID bit set.</li>
</ul>
</div>
</div>

<div id="outline-container-org88f82a1" class="outline-4">
<h4 id="org88f82a1"><span class="section-number-4">1.16.2</span> Sample code and experiment</h4>
<div class="outline-text-4" id="text-1-16-2">
<p>
All sources available at GIST: 
</p>

<ul class="org-ul">
<li>GIST: <a href="https://gist.github.com/751fad7bf7707949e824ed2c19a73752">https://gist.github.com/751fad7bf7707949e824ed2c19a73752</a></li>
</ul>

<p>
File: <span class="underline">build.sh</span> (Build script)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/</span><span class="org-keyword">env</span><span class="org-comment"> sh</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Build unix/Linux executable</span>
gcc unix-executable.c -o unix-executable.bin

<span class="org-comment-delimiter"># </span><span class="org-comment">Build Linux shared library: hook-files-a.so</span>
gcc hook-files-a.c -o <span class="org-keyword">hook-files-a.so</span> -fpic -shared -ldl -Wall

<span class="org-comment-delimiter"># </span><span class="org-comment">Build Linux shared library: hook-files-b.so</span>
g++ hook-files-b.cpp -o <span class="org-keyword">hook-files-b.so</span> -fpic -Wall -shared -ldl
</pre>
</div>


<p>
File: <span class="underline">hook-files-a.c</span>  / C-version  (Shared library, aka shared object, hook-files-a.so)
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#define</span> <span class="org-variable-name">_GNU_SOURCE</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Enables RTLD_NEXT constant.</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdio.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">assert.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdint.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix-specific headers ------- //</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Annotation for internal symbols not visible outside</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">this compilation unit (static storage class).</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">HIDDEN</span> <span class="org-keyword">static</span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Anotation for calling function whenever the shared library</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">is loaded by some process. Note: this is a specific GNU </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">language extension. </span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">ON_LIBRARY_LOADED</span> <span class="org-keyword">__attribute__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>constructor<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-keyword">typedef</span> <span class="org-type">uint32_t</span> <span class="org-type">pid_t</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint32_t</span> <span class="org-type">mode_t</span>;

<span class="org-keyword">extern</span>  <span class="org-type">pid_t</span> <span class="org-function-name">getpid</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">__attribute__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>constructor<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">static</span> 
<span class="org-type">void</span> <span class="org-function-name">init_library1</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [INFO] init_library1() / Library loaded Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

HIDDEN ON_LIBRARY_LOADED 
<span class="org-type">void</span> <span class="org-function-name">init_library2</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [INFO] init_library2() / Library loaded Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-doc">/** Intercepts (aka hooks) and overrides </span><span class="org-doc"><span class="org-constant">open()</span></span><span class="org-doc"> function </span>
<span class="org-doc"> *  from libC (GLIBC) that encapsulates </span><span class="org-doc"><span class="org-constant">open()</span></span><span class="org-doc"> system-call </span>
<span class="org-doc"> *  (aka syscall).</span>
<span class="org-doc"> *---------------------------------------------------------*/</span>
<span class="org-type">int</span> <span class="org-function-name">open</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">pathname</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span>, <span class="org-type">mode_t</span> <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for function pointer with same</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">signature as the open() function. </span>
   <span class="org-keyword">typedef</span> <span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-2">(</span>* <span class="org-type">open_t</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span>  <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">pathname</span>
                           , <span class="org-type">int</span>         <span class="org-variable-name">flags</span>
                           , <span class="org-type">mode_t</span>      <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Load old symbol of original C function that was overriden</span>
   <span class="org-type">open_t</span> <span class="org-variable-name">open_real</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">open_t</span><span class="org-rainbow-delimiters-depth-2">)</span> dlsym<span class="org-rainbow-delimiters-depth-2">(</span>RTLD_NEXT, <span class="org-string">"open"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Sanity checking =&gt; calls abort() if symbol is not found.</span>
   assert<span class="org-rainbow-delimiters-depth-2">(</span> open_real <span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Log intercepted functional call</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">pid =&gt;&gt; Process ID of process that loaded this</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">shared library. </span>
   fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr
            , <span class="org-string">" [TRACE] pid = %d / open() -&gt;&gt; File = %s \n"</span>
            , getpid<span class="org-rainbow-delimiters-depth-3">()</span>, pathname<span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Pass control back to intercepted (hooked) function. </span>
   <span class="org-keyword">return</span> open_real<span class="org-rainbow-delimiters-depth-2">(</span>pathname, flags, mode<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">FILE</span>* <span class="org-function-name">fopen64</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">type</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
      <span class="org-keyword">typedef</span> <span class="org-type">FILE</span>* <span class="org-rainbow-delimiters-depth-2">(</span>* <span class="org-type">fopen64_t</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span>  <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>
                                   , <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">type</span><span class="org-rainbow-delimiters-depth-2">)</span>;

      <span class="org-type">fopen64_t</span> <span class="org-variable-name">old_fun</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">fopen64_t</span><span class="org-rainbow-delimiters-depth-2">)</span> dlsym<span class="org-rainbow-delimiters-depth-2">(</span>RTLD_NEXT, <span class="org-string">"fopen64"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
      assert<span class="org-rainbow-delimiters-depth-2">(</span> old_fun != <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;

      fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr
               , <span class="org-string">" [TRACE] pid = %d / fopen64() -&gt;&gt; File = %s \n"</span>
               , getpid<span class="org-rainbow-delimiters-depth-3">()</span>, filename<span class="org-rainbow-delimiters-depth-2">)</span>;     

      <span class="org-keyword">return</span> old_fun<span class="org-rainbow-delimiters-depth-2">(</span>filename, type<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>


<p>
File: <span class="underline">hook-files-b.cpp</span>  / C++-version  (Shared library <i>hook-files-b.so</i> )
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Equivalent to C-header &lt;stdint.h&gt; std::uint32_t ... and so on.</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdint</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix-specific headers ------- //</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dlfcn.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Annotqtion for defining functions with C-linkage</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">that must conform to C ABI and calling conventions.</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">EXTERN_C</span> <span class="org-keyword">extern</span> <span class="org-string">"C"</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Annotation for internal symbols not visible outside</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">this compilation unit (static storage class).</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">HIDDEN</span> <span class="org-keyword">static</span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Anotation for calling function whenever the shared library</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">is loaded by some process. Note: this is a specific GNU </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">language extension. </span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">ON_LIBRARY_LOADED</span> <span class="org-keyword">__attribute__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>constructor<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">This symbol will be resolved at linking-time by the Linker </span>
<span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-type">pid_t</span> <span class="org-function-name">getpid</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;


<span class="org-keyword">__attribute__</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span>constructor<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">static</span> 
<span class="org-type">void</span> <span class="org-function-name">init_library1</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr,<span class="org-string">" [INFO] init_library1() / Library loaded Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

HIDDEN ON_LIBRARY_LOADED 
<span class="org-type">void</span> <span class="org-function-name">init_library2</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
  fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr, <span class="org-string">" [INFO] init_library2() / Library loaded Ok. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-doc">/** Intercepts (aka hooks) and overrides </span><span class="org-doc"><span class="org-constant">open()</span></span><span class="org-doc"> function </span>
<span class="org-doc"> *  from libC (GLIBC) that encapsulates </span><span class="org-doc"><span class="org-constant">open()</span></span><span class="org-doc"> system-call </span>
<span class="org-doc"> *  (aka syscall).</span>
<span class="org-doc"> *---------------------------------------------------------*/</span>
EXTERN_C
<span class="org-type">int</span> <span class="org-function-name">open</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">pathname</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span>, <span class="org-type">mode_t</span> <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">Type alias for function pointer with same</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">signature as the open() function. </span>
   <span class="org-keyword">using</span> <span class="org-type">open_t</span> = <span class="org-type">int</span> <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span>  <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">pathname</span>
                           , <span class="org-type">int</span>         <span class="org-variable-name">flags</span>
                           , <span class="org-type">mode_t</span>      <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Load old symbol of original C function that was overriden</span>
   <span class="org-type">open_t</span> <span class="org-variable-name">open_real</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">open_t</span><span class="org-rainbow-delimiters-depth-2">)</span> dlsym<span class="org-rainbow-delimiters-depth-2">(</span>RTLD_NEXT, <span class="org-string">"open"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Sanity checking =&gt; calls abort() if symbol is not found.</span>
   assert<span class="org-rainbow-delimiters-depth-2">(</span> open_real != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Log intercepted functional call</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">pid =&gt;&gt; Process ID of process that loaded this</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">shared library. </span>
   <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr
                , <span class="org-string">" [TRACE] pid = %d / open() -&gt;&gt; File = %s \n"</span>
                , getpid<span class="org-rainbow-delimiters-depth-3">()</span>, pathname<span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Pass control back to intercepted (hooked) function. </span>
   <span class="org-keyword">return</span> open_real<span class="org-rainbow-delimiters-depth-2">(</span>pathname, flags, mode<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

EXTERN_C
<span class="org-type">FILE</span>* <span class="org-function-name">fopen64</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">type</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">using</span> <span class="org-type">fopen64_real</span> = FILE* <span class="org-rainbow-delimiters-depth-2">(</span>*<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">(</span> <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">filename</span>
                                   , <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">type</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">auto</span> <span class="org-variable-name">old_fun</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">fopen64_real</span><span class="org-rainbow-delimiters-depth-2">)</span> dlsym<span class="org-rainbow-delimiters-depth-2">(</span>RTLD_NEXT, <span class="org-string">"fopen64"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span> old_fun != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span> stderr
                , <span class="org-string">" [TRACE] pid = %d / fopen64() -&gt;&gt; File = %s \n"</span>
                , getpid<span class="org-rainbow-delimiters-depth-3">()</span>, filename<span class="org-rainbow-delimiters-depth-2">)</span>;     

    <span class="org-keyword">return</span> old_fun<span class="org-rainbow-delimiters-depth-2">(</span>filename, type<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building executable and shared libraries (aka shared objects - 'unix
terminology'):
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; git clone https://gist.github.com/751fad7bf7707949e824ed2c19a73752 api-hooking &amp;&amp; <span class="org-builtin">cd</span> api-hooking 
$ &gt;&gt; sh build.sh

$ ls
build.sh  hook-files-a.c  hook-files-b.cpp  unix-executable.c

<span class="org-comment-delimiter"># </span><span class="org-comment">Check generated object-codes:</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">------------------------------------------------------------------#</span>
$ &gt;&gt; file hook-files-a.so 
<span class="org-function-name">hook-files-a.so</span>: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV) ... ...

$ &gt;&gt; file hook-files-b.so
<span class="org-function-name">hook-files-b.so</span>: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV) ... ...

$ &gt;&gt; file unix-executable.bin 
<span class="org-function-name">unix-executable.bin</span>: ELF 64-bit LSB executable, x86-64, ... ... ...
</pre>
</div>

<p>
Running executable <span class="underline">unix-executable.bin</span> 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ./unix-executable.bin  
<span class="org-function-name">unix-executable.bin</span>: unix-executable.c:8: main: Assertion <span class="org-sh-quoted-exec">`argc == 2 &amp;&amp; "Missing file argument"' failed.</span>
<span class="org-sh-quoted-exec">fish: &#8220;./unix-executable.bin&#8221; terminated by signal SIGABRT (Abort)</span>

<span class="org-sh-quoted-exec">$ &gt;&gt; ./unix-executable.bin /proc/devices </span>
<span class="org-sh-quoted-exec">[LINE] 1 = Character devices:</span>
<span class="org-sh-quoted-exec"> [LINE] 2 =   1 mem</span>
<span class="org-sh-quoted-exec"> [LINE] 3 =   4 /dev/vc/0</span>
<span class="org-sh-quoted-exec"> [LINE] 4 =   4 tty</span>
<span class="org-sh-quoted-exec">... ... ... ... ... </span>
<span class="org-sh-quoted-exec">... ... ... ... ... </span>
<span class="org-sh-quoted-exec"> [LINE] 67 = 253 device-mapper</span>
<span class="org-sh-quoted-exec"> [LINE] 68 = 254 mdp</span>
<span class="org-sh-quoted-exec"> [LINE] 69 = 259 blkext</span>
</pre>
</div>

<p>
Intercepting library-call (ak function) <span class="underline">fopen64()</span> using LD_PRELOAD.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Using hook-files-a.so (C version)</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">-------------------------------------------------</span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-a.so ./unix-executable.bin /proc/devices 
[INFO] init_library1() / Library loaded Ok. 
[INFO] init_library2() / Library loaded Ok. 
[TRACE] pid = 231690 / fopen64() -&gt;&gt; File = /proc/devices 
[LINE] 1 = Character devices:
 [LINE] 2 =   1 mem
 [LINE] 3 =   4 /dev/vc/0
 [LINE] 4 =   4 tty
 [LINE] 5 =   4 ttyS
 [LINE] 6 =   5 /dev/tty
 [LINE] 7 =   5 /dev/console
 ... ... ... ... 
... ... ... ... ... 

<span class="org-comment-delimiter"># </span><span class="org-comment">Using hook-files-b.so (C++ version)</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">-------------------------------------------------</span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-b.so ./unix-executable.bin /proc/devices
[INFO] init_library1() / Library loaded Ok. 
[INFO] init_library2() / Library loaded Ok. 
[TRACE] pid = 231790 / fopen64() -&gt;&gt; File = /proc/devices 
[LINE] 1 = Character devices:
 [LINE] 2 =   1 mem
 [LINE] 3 =   4 /dev/vc/0
 [LINE] 4 =   4 tty
 [LINE] 5 =   4 ttyS
 [LINE] 6 =   5 /dev/tty
 [LINE] 7 =   5 /dev/console
... ...  ... ...  ... ...  ... ...  ... ... 
... ...  ... ...  ... ...  ... ...  ... ... 
</pre>
</div>

<p>
Intercepting library-call (ak function) <span class="underline">fopen64()</span> using LD_PRELOAD,
but discarding <span class="underline">stdout</span> (standard console output) by redirecting it to
/dev/null in order to only display the <span class="underline">stderr</span> logged by the
replacement functions. 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">C version </span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-a.so ./unix-executable.bin /proc/devices &gt; /dev/null
[INFO] init_library1() / Library loaded Ok. 
[INFO] init_library2() / Library loaded Ok. 
[TRACE] pid = 231957 / fopen64() -&gt;&gt; File = /proc/devices 

<span class="org-comment-delimiter"># </span><span class="org-comment">C+++ version </span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-b.so ./unix-executable.bin /proc/devices &gt; /dev/null
[INFO] init_library1() / Library loaded Ok. 
[INFO] init_library2() / Library loaded Ok. 
[TRACE] pid = 231994 / fopen64() -&gt;&gt; File = /proc/devices 
</pre>
</div>

<p>
Tracing library calls with <span class="underline">ltrace</span> utility: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; ltrace ./unix-executable.bin /proc/devices
<span class="org-function-name">fopen64</span>(<span class="org-string">"/proc/devices"</span>, <span class="org-string">"r"</span>)                         = 0x19722a0
<span class="org-function-name">getline</span>(0x7fff02a9a640, 0x7fff02a9a638, 0x19722a0, 0x7fff02a9a638) = 19
<span class="org-function-name">fprintf</span>(0x7f50e3769500, <span class="org-string">" [LINE] %d = %s "</span>, 1, <span class="org-string">"Character devices:\n"</span> [LINE] 1 = Character devices:
) = 32
<span class="org-function-name">getline</span>(0x7fff02a9a640, 0x7fff02a9a638, 0x19722a0, 0x7fff02a9a638) = 8
<span class="org-function-name">fprintf</span>(0x7f50e3769500, <span class="org-string">" [LINE] %d = %s "</span>, 2, <span class="org-string">"  1 mem\n"</span>  [LINE] 2 =   1 mem
) = 21
<span class="org-function-name">getline</span>(0x7fff02a9a640, 0x7fff02a9a638, 0x19722a0, 0x7fff02a9a638) = 14
<span class="org-function-name">fprintf</span>(0x7f50e3769500, <span class="org-string">" [LINE] %d = %s "</span>, 3, <span class="org-string">"  4 /dev/vc/0\n"</span>  [LINE] 3 =   4 /dev/vc/0
) = 27
<span class="org-function-name">getline</span>(0x7fff02a9a640, 0x7fff02a9a638, 0x19722a0, 0x7fff02a9a638) = 8
<span class="org-function-name">fprintf</span>(0x7f50e3769500, <span class="org-string">" [LINE] %d = %s "</span>, 4, <span class="org-string">"  4 tty\n"</span>  [LINE] 4 =   4 tty
  ... ... ...   ... ... ...   ... ... ...   ... ... ...   ... ... ...   ... ... ... 
  ... ... ...   ... ... ...   ... ... ...   ... ... ...   ... ... ...   ... ... ... 
<span class="org-function-name">getline</span>(0x7fff02a9a640, 0x7fff02a9a638, 0x19722a0, 0x7fff02a9a638) = -1
<span class="org-function-name">free</span>(0x1972480)                                       = &lt;void&gt;
<span class="org-function-name">fclose</span>(0x19722a0)                                     = 0
 +++ exited (status 0) +++
</pre>
</div>

<p>
Tracing system-calls calls with <span class="underline">strace</span> utility: 
</p>

<pre class="example">
$ &gt;&gt; strace ./unix-executable.bin /proc/devices

execve("./unix-executable.bin", ["./unix-executable.bin", "/proc/devices"], 0x7ffc6f5c0ba8 /* 83 vars */) = 0
 ... ... ... ...  ... ... ... ... ... ... ... ... 
 ... ... ... ...  ... ... ... ... ... ... ... ... 

openat(AT_FDCWD, "/proc/devices", O_RDONLY) = 3
fstat(3, {st_mode=S_IFREG|0444, st_size=0, ...}) = 0
read(3, "Character devices:\n  1 mem\n  4 /"..., 1024) = 694
fstat(1, {st_mode=S_IFCHR|0620, st_rdev=makedev(0x88, 0xa), ...}) = 0
write(1, " [LINE] 1 = Character devices:\n", 31 [LINE] 1 = Character devices:
) = 31
write(1, "  [LINE] 2 =   1 mem\n", 21  [LINE] 2 =   1 mem
)  = 21
write(1, "  [LINE] 3 =   4 /dev/vc/0\n", 27  [LINE] 3 =   4 /dev/vc/0
) = 27
write(1, "  [LINE] 4 =   4 tty\n", 21  [LINE] 4 =   4 tty
)  = 21
 ... ... ...  ... ... ...  ... ... ...  ... ... ...  ... ... ... 
 ... ... ...  ... ... ...  ... ... ...  ... ... ...  ... ... ... 
</pre>

<p>
Determining files opened by <i>uptime</i> executable. 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ which uptime
 /usr/bin/uptime

 $ file $(<span class="org-sh-quoted-exec">which</span> uptime)
 /usr/bin/uptime: ELF 64-bit LSB shared object, x86-64, ... ... 

<span class="org-comment-delimiter"># </span><span class="org-comment">Indicates how long the machine is running: </span>
$ &gt;&gt; uptime 
<span class="org-function-name">15</span>:45:45 up 3 days, 19:39,  1 user,  load average: 0.32, 0.59, 0.58

<span class="org-comment-delimiter"># </span><span class="org-comment">Run 1 </span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-b.so uptime
[INFO] init_library1() / Library loaded Ok. 
[INFO] init_library2() / Library loaded Ok. 
[TRACE] pid = 232426 / open() -&gt;&gt; File = /proc/uptime 
[TRACE] pid = 232426 / open() -&gt;&gt; File = /proc/loadavg 
<span class="org-function-name">15</span>:46:39 up 3 days, 19:40,  1 user,  load average: 0.55, 0.61, 0.59

<span class="org-comment-delimiter"># </span><span class="org-comment">Run 2 - Discard stdout, preserving only stderr </span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-b.so uptime &gt; /dev/null
[INFO] init_library1() / Library loaded Ok. 
[INFO] init_library2() / Library loaded Ok. 
[TRACE] pid = 232456 / open() -&gt;&gt; File = /proc/uptime 
[TRACE] pid = 232456 / open() -&gt;&gt; File = /proc/loadavg 

$ &gt;&gt; cat /proc/uptime 
330114.72 1249234.16

$ &gt;&gt; cat /proc/loadavg 
0.40 0.55 0.57 1/1838 232504
</pre>
</div>

<p>
Determining files opened by <i>free</i> executable which indicates the amount
of free RAM memory in megabytes in the current machine:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ free -m
              total        used        free      shared  buff/cache   available
<span class="org-function-name">Mem</span>:          15897        6603        2236        1768        7057        7378
<span class="org-function-name">Swap</span>:             0           0           0

<span class="org-comment-delimiter"># </span><span class="org-comment">Intercept library calls </span>
<span class="org-comment-delimiter">#</span><span class="org-comment">--------------------------------------------------------------------</span>
$ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-b.so free -m
 [INFO] init_library1() / Library loaded Ok. 
 [INFO] init_library2() / Library loaded Ok. 
 [TRACE] pid = 232965 / open() -&gt;&gt; File = /proc/meminfo 
              total        used        free      shared  buff/cache   available
<span class="org-function-name">Mem</span>:          15897        6601        2238        1768        7058        7380
<span class="org-function-name">Swap</span>:             0           0           0

<span class="org-comment-delimiter"># </span><span class="org-comment">Intercept library calls and discard stdout</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">, keeping only stderr (standard error output)</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">--------------------------------------------------------------------</span>
 $ &gt;&gt; env <span class="org-variable-name">LD_PRELOAD</span>=$<span class="org-variable-name">PWD</span>/hook-files-b.so free -m &gt; /dev/null 
 [INFO] init_library1() / Library loaded Ok. 
 [INFO] init_library2() / Library loaded Ok. 
 [TRACE] pid = 233016 / open() -&gt;&gt; File = /proc/meminfo

<span class="org-comment-delimiter"># </span><span class="org-comment">Inspect file /proc/meminfo </span>
<span class="org-comment-delimiter">#</span><span class="org-comment">--------------------------------------------------------------------</span>
 $ &gt;&gt; cat /proc/meminfo 
<span class="org-function-name">MemTotal</span>:       16279408 kB
<span class="org-function-name">MemFree</span>:         2271428 kB
<span class="org-function-name">MemAvailable</span>:    7552036 kB
<span class="org-function-name">Buffers</span>:         1178620 kB
 ... ... ... ... ... ... 
 ... ... ... ... ... ... 
<span class="org-function-name">HugePages_Surp</span>:        0
<span class="org-function-name">Hugepagesize</span>:       2048 kB
<span class="org-function-name">Hugetlb</span>:               0 kB
<span class="org-function-name">DirectMap4k</span>:      604380 kB
<span class="org-function-name">DirectMap2M</span>:    12916736 kB
<span class="org-function-name">DirectMap1G</span>:     4194304 kB

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgabc9aa4" class="outline-3">
<h3 id="orgabc9aa4"><span class="section-number-3">1.17</span> Launching processes with exec and fork system-call wrappers</h3>
<div class="outline-text-3" id="text-1-17">
<p>
This code demonstrates the usage of exec and fork system-calls wrapper
functions, namely, execvp() and fork() functions. 
</p>

<p>
<b>Relevant functions signature</b> 
</p>

<p>
Fork
</p>
<ul class="org-ul">
<li>Linux Manpage: "fork() creates a new process by duplicating the
calling process.  The new process is referred to as the child
process.  The calling process is referred to as the parent
process."</li>
<li>Note: The function 'fork' is not the system call fork, but a
C wrapper around this sytem call provided by the C runtime
library. (GLIBC - GNU C library in the machine where this was tested.)</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">pid_t</span> <span class="org-function-name">fork</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Execvp (wraps exec system call)
</p>
<ul class="org-ul">
<li>The exec system calls is always called when a new process is
launched/created. It replaces the process image of the current
process with a new one from the launched executable.</li>
<li>Note: In addition to native executables, on Unix-like operating
systems, an executable can also be any scripting file starting
with shebang as first line such as "#!/usr/bin/env sh"</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">execvp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">file</span>, <span class="org-type">char</span> *<span class="org-keyword">const</span> <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-2">[]</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Waitpid =&gt; Waits for a state of change of a process.
</p>
<ul class="org-ul">
<li>It can be used for waiting for process termination.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">pid_t</span> <span class="org-function-name">waitpid</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">pid_t</span> <span class="org-variable-name">pid</span>, <span class="org-type">int</span> *<span class="org-variable-name">wstatus</span>, <span class="org-type">int</span> <span class="org-variable-name">options</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Documentation</b> 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man2/fork.2.html">fork() Linux Manpage</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=execvp">Execvp() =&gt; FreeBSD Manpage</a></li>
</ul>

<p>
<b>Further Reading</b>
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Fork_(system_call)">Fork (system call) - Wikipedia</a></li>

<li><a href="http://people.cs.pitt.edu/~aus/cs449/ts-lecture14.pdf">Fork() System Calland ProcessesCS449 Spring 2016</a></li>

<li><a href="https://www.cs.columbia.edu/~junfeng/11sp-w4118/lectures/unix.pdf">Chapter 0 - Operating system interfaces {PDF}</a></li>
</ul>

<p>
<b>Sample Code</b> 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/133e91ba3732718cb228310173368674">https://gist.github.com/133e91ba3732718cb228310173368674</a></li>
</ul>

<p>
File: unix-process.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">------ File: unix-process.cpp -----------------------------------------------------------//</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Description: Shows hows to launch processes on Unix with Exec and Fork syscall wrappers.</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">-------------------------------------------------------------------------------------------//</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/wait.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">Import: char* strerror(in errnum);</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">-------------- Declarations --------------------------//</span>

<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">void</span> <span class="org-function-name">execvp_test</span><span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-type">void</span> <span class="org-function-name">execvp_cpp</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Launch a new process without terminate this process. </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">It combines fork + exec system-calls. </span>
<span class="org-type">void</span> <span class="org-function-name">fork_exec</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">-------------  MAIN() ------------------------------//</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program started. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" Usage:  ./unix-process &lt;OPTION&gt;"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_SUCCESS;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">opt</span> = argv<span class="org-rainbow-delimiters-depth-2">[</span>1<span class="org-rainbow-delimiters-depth-2">]</span>;

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>opt == <span class="org-string">"0"</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
        execvp_test<span class="org-rainbow-delimiters-depth-3">()</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Test execvp </span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>opt == <span class="org-string">"1"</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         execvp_cpp<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"thunar"</span>, <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-string">"/etc"</span> <span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_SUCCESS;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Fork-exec </span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>opt == <span class="org-string">"2"</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         fork_exec<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"konsole"</span>, <span class="org-rainbow-delimiters-depth-4">{</span> <span class="org-string">"-e"</span>, <span class="org-string">"tmux"</span>, <span class="org-string">"a"</span><span class="org-rainbow-delimiters-depth-4">}</span> <span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>  

     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Finish execution. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">------------- Definitions ------------------------//</span>

<span class="org-type">void</span> <span class="org-function-name">print_errno_details</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">err</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr ,<span class="org-string">"\n   =&gt;    errno(int) = %d"</span> 
                             <span class="org-string">"\n   =&gt; errno message = %s \n"</span>
                            , err, strerror<span class="org-rainbow-delimiters-depth-3">(</span>err<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
        <span class="org-constant">std</span>::fflush<span class="org-rainbow-delimiters-depth-2">(</span>stderr<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">Test exec system-call wrapper function (execvp)</span>
<span class="org-type">void</span> <span class="org-function-name">execvp_test</span><span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">{</span>    
        <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">app</span>    = <span class="org-string">"thunar"</span>;

        <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">[]</span> = <span class="org-rainbow-delimiters-depth-2">{</span>  app     <span class="org-comment-delimiter">// </span><span class="org-comment">Process name, can be anything </span>
                               , <span class="org-string">"/etc"</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Arguments passed to the process </span>
                               , <span class="org-constant">nullptr</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Always terminate the argument array with null pointer </span>
                              <span class="org-rainbow-delimiters-depth-2">}</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Encapsulates execv system call. </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">int execvp(const char *file, char *const argv[]);</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> execvp<span class="org-rainbow-delimiters-depth-3">(</span>app, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">char</span> *<span class="org-keyword">const</span> *<span class="org-rainbow-delimiters-depth-4">)</span> args<span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-2">{</span>
              <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
              print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
              <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: failed to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">C++ wrapper for the exevp() library-call </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">It replaces the current process image with a new one </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">from other executable. </span>
<span class="org-type">void</span> <span class="org-function-name">execvp_cpp</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">app</span>
                , <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">const</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">pargs</span>;
     pargs.reserve<span class="org-rainbow-delimiters-depth-2">(</span>args.size<span class="org-rainbow-delimiters-depth-3">()</span> + 1<span class="org-rainbow-delimiters-depth-2">)</span>;
     pargs.push_back<span class="org-rainbow-delimiters-depth-2">(</span>app.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">a</span>: args<span class="org-rainbow-delimiters-depth-2">){</span> pargs.push_back<span class="org-rainbow-delimiters-depth-3">(</span>a.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
     pargs.push_back<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Signature: int execvp(const char *file, char *const argv[]);</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">execvp(app.c_str(), execvp(app.c_str(), (char* const *) pargs.data() )</span>
     <span class="org-type">int</span> <span class="org-variable-name">status</span> = execvp<span class="org-rainbow-delimiters-depth-2">(</span>app.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">char</span>* <span class="org-keyword">const</span>*<span class="org-rainbow-delimiters-depth-3">)</span> pargs.data<span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> status == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
          <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
          print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
          <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: failed to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">fork_exec</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">app</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] &lt;BEFORE FORK&gt; PID of parent process = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">PID of child process (copy of this process)</span>
     <span class="org-type">pid_t</span> <span class="org-variable-name">pid</span> = fork<span class="org-rainbow-delimiters-depth-2">()</span>;

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>pid == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to launch process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>pid == 0<span class="org-rainbow-delimiters-depth-2">){</span>
          <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [TRACE] Running on child process =&gt; PID_CHILD = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;  

          <span class="org-comment-delimiter">// </span><span class="org-comment">Close file descriptors, in order to disconnect the process from the terminal.</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">This procedure allows the process to be launched as a daemon (aka service).</span>
          close<span class="org-rainbow-delimiters-depth-3">(</span>STDOUT_FILENO<span class="org-rainbow-delimiters-depth-3">)</span>;
          close<span class="org-rainbow-delimiters-depth-3">(</span>STDERR_FILENO<span class="org-rainbow-delimiters-depth-3">)</span>;
          close<span class="org-rainbow-delimiters-depth-3">(</span>STDIN_FILENO <span class="org-rainbow-delimiters-depth-3">)</span>;

          <span class="org-comment-delimiter">// </span><span class="org-comment">Execvp system call, replace the image of this process with a new one</span>
          <span class="org-comment-delimiter">// </span><span class="org-comment">from an executable. </span>
          execvp_cpp<span class="org-rainbow-delimiters-depth-3">(</span>app, args<span class="org-rainbow-delimiters-depth-3">)</span>;        
          <span class="org-keyword">return</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] &lt;AFTER FORK&gt; PID of parent process = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">pid_t waitpid(pid_t pid, int *wstatus, int options);</span>
     <span class="org-type">int</span> <span class="org-variable-name">status</span>;

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Waiting for child process to finish. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Wait for child process termination.</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">From header: #include &lt;sys/wait.h&gt;</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>waitpid<span class="org-rainbow-delimiters-depth-3">(</span>pid, &amp;status, 0<span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         print_errno_details<span class="org-rainbow-delimiters-depth-3">(</span>errno<span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: cannot wait for child process"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Child process has been terminated Ok."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">-------- Parent process ----------------//</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; g++ unix-process.cpp -o <span class="org-keyword">unix-process.bin</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">~/t/unix-explore
$ &gt;&gt; ./unix-process.bin 0
[INFO] Program started. 

~/t/unix-explore
$ &gt;&gt; ./unix-process.bin 1
[INFO] Program started. 

~/t/unix-explore
$ &gt;&gt; ./unix-process.bin 2
[INFO] Program started. 
[TRACE] &lt;BEFORE FORK&gt; PID of parent process = 774929 
[TRACE] &lt;AFTER FORK&gt; PID of parent process = 774929 
[TRACE] Running on child process =&gt; PID_CHILD = 774930 
[TRACE] Waiting for child process to finish.  [TRACE] Child process has been terminated Ok. [TRACE] Finish execution. 
</pre>
</div>
</div>
</div>
<div id="outline-container-org8d8a81e" class="outline-3">
<h3 id="org8d8a81e"><span class="section-number-3">1.18</span> Reading subprocess output via Popen()</h3>
<div class="outline-text-3" id="text-1-18">
<p>
The convenience function popen(), which is a combination of fork() +
exec() and pipe() functions, allows reading a subprocess
output. Note: this function is also available on Windows.
</p>

<p>
Header: 
</p>
<ul class="org-ul">
<li>&lt;stdio.h&gt; in C</li>
<li>&lt;cstdio&gt; in C++</li>
</ul>

<p>
<b>Documentation</b>
</p>

<ul class="org-ul">
<li><a href="https://pubs.opengroup.org/onlinepubs/009695399/functions/popen.html">Popen - opengroup()</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=popen&amp;sektion=3&amp;manpath=freebsd-release-ports">FreeBSD Documentation</a></li>

<li><a href="https://en.m.wikipedia.org/wiki/Pipeline_(Unix)">Ppeline (Unix)</a></li>
</ul>

<p>
<b>Functions</b>
</p>

<p>
Popen: 
</p>
<ul class="org-ul">
<li>This function executes: 'sh -c &lt;COMMAND&gt;' via, fork() + exec()
and pipe(), returning a file stream. Note: sh is a unix-shell.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">FILE</span>* <span class="org-function-name">popen</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">command</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">mode</span><span class="org-rainbow-delimiters-depth-1">)</span>; 
</pre>
</div>

<p>
Pclose
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span>  <span class="org-function-name">pclose</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">FILE</span>* <span class="org-variable-name">stream</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Sample Application</b> 
</p>

<p>
File: popen-test.cpp
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">Provides; popen(), pclose()</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdio</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n === EXPERIMENT 1 - popen() using buffer ========\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-comment-delimiter">// </span><span class="org-comment">Equivalent to: fork() + exec() + pipe()</span>
         <span class="org-type">FILE</span>* <span class="org-variable-name">fd</span> = popen<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"ls /"</span>, <span class="org-string">"r"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>fd == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">){</span>
            fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">"Error: failed to run command. Check ERRNO variable. \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">return</span> EXIT_FAILURE;
         <span class="org-rainbow-delimiters-depth-3">}</span>

         <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFFER_SIZE</span> = 500;
         <span class="org-comment-delimiter">// </span><span class="org-comment">Buffer initialized with null char </span>
         <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-3">[</span>BUFFER_SIZE<span class="org-rainbow-delimiters-depth-3">]</span> = <span class="org-rainbow-delimiters-depth-3">{</span>0<span class="org-rainbow-delimiters-depth-3">}</span>;

         <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> fgets<span class="org-rainbow-delimiters-depth-4">(</span>buffer, BUFFER_SIZE, fd<span class="org-rainbow-delimiters-depth-4">)</span> != <span class="org-constant">nullptr</span> <span class="org-rainbow-delimiters-depth-3">)</span>
         <span class="org-rainbow-delimiters-depth-3">{</span>
            fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stdout, <span class="org-string">"%s"</span>, buffer<span class="org-rainbow-delimiters-depth-4">)</span>;
         <span class="org-rainbow-delimiters-depth-3">}</span>

         pclose<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span>;        
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n === EXPERIMENT 2 - popen() reading line-by-line ========\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-type">FILE</span>* <span class="org-variable-name">fd</span> = popen<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"ps -ef"</span>, <span class="org-string">"r"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-type">char</span>*   <span class="org-variable-name">pline</span> = <span class="org-constant">nullptr</span>; 
         <span class="org-type">size_t</span>  <span class="org-variable-name">size</span>  = 0; 
         <span class="org-type">ssize_t</span> <span class="org-variable-name">nread</span> = 0;
         <span class="org-type">int</span>     <span class="org-variable-name">count</span> = 0;
         <span class="org-keyword">do</span> <span class="org-rainbow-delimiters-depth-3">{</span>
            nread = getdelim<span class="org-rainbow-delimiters-depth-4">(</span>&amp;pline, &amp;size, <span class="org-string">'\n'</span>, fd<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  ["</span> &lt;&lt; count++ &lt;&lt; <span class="org-string">"]"</span> &lt;&lt; <span class="org-string">" =&gt; "</span> &lt;&lt; pline;
         <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span> nread != -1 &amp;&amp; count &lt; 8<span class="org-rainbow-delimiters-depth-3">)</span>;
         pclose<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ popen-test.cpp -o <span class="org-keyword">popen-test</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">  $ ./popen-test 

   === EXPERIMENT 1 - popen() using buffer ========

  bin
  boot
  dev
  etc
  home
<span class="org-builtin">.</span> .... ... ... ... 
  ... ... ... ... ...
  usr
  var

   === EXPERIMENT 2 - popen() reading line-by-line ========

    [0] =&gt; UID          PID    PPID  C STIME TTY          TIME CMD
    [1] =&gt; root           1       0  0 Jun08 ?        00:48:25 /usr/lib/systemd/systemd ... ... ...
    [2] =&gt; root           2       0  0 Jun08 ?        00:00:00 [kthreadd]
    [3] =&gt; root           3       2  0 Jun08 ?        00:00:00 [rcu_gp]
    [4] =&gt; root           4       2  0 Jun08 ?        00:00:00 [rcu_par_gp]
    [5] =&gt; root           6       2  0 Jun08 ?        00:00:00 [kworker/0:0H-events_highpri]
    [6] =&gt; root           9       2  0 Jun08 ?        00:00:00 [mm_percpu_wq]
    [7] =&gt; root          10       2  0 Jun08 ?        00:00:54 [ksoftirqd/0]
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd1bacc9" class="outline-3">
<h3 id="orgd1bacc9"><span class="section-number-3">1.19</span> Unix Pipes - Inter Process Communication</h3>
<div class="outline-text-3" id="text-1-19">
<p>
Unix pipe is an inter-process communication facility which allows the
output of a process to be the input of a another. It can be used for
reading the output of a subprocess. 
</p>

<p>
<b>Documentation</b> 
</p>

<ul class="org-ul">
<li><a href="https://www.freebsd.org/cgi/man.cgi?pipe(2)">FreeBSD - pipe()</a></li>

<li><a href="https://linuxhint.com/dup2_system_call_c/">Dup2 - system call</a></li>

<li><a href="https://en.wikipedia.org/wiki/Dup_(system_call)">Dup (system call)</a></li>

<li><a href="https://www.gnu.org/software/libc/manual/html_node/Duplicating-Descriptors.html">Duplicating Descriptors - GNU GlibC</a></li>

<li><a href="https://www-users.cs.umn.edu/~kauffman/4061/05-io-files-pipes.pdf">CSCI 4061: Input/Output with Files, Pipes</a></li>

<li><a href="http://unixwiz.net/techtips/remap-pipe-fds.html">http://unixwiz.net/techtips/remap-pipe-fds.html</a></li>

<li><a href="https://users.cs.cf.ac.uk/Dave.Marshall/C/node23.html">Inter Process Communication (IPC), pipes</a></li>

<li><a href="http://perugini.cps.udayton.edu/teaching/books/SPUC/www/lecture_notes/pipes.html">IPC - I/O Redirection &amp; IPC, &amp; Special Files: Unamed &amp; Named Pipes, FIFOs</a></li>

<li><a href="https://www.cs.purdue.edu/homes/grr/SystemsProgrammingBook/Book/Chapter5-WritingYourOwnShell.pdf">Chapter 5 - Writing Your Own Shell</a></li>
</ul>

<p>
<b>Main Functions</b> 
</p>

<p>
Function pipe()
</p>

<ul class="org-ul">
<li>Encapsulates: pipe() system-call</li>

<li>Linux Manpage: "pipe() creates a pipe, a unidirectional data
channel that can be used for interprocess communication.  The
array pipefd is used to return two file descriptors referring to
the ends of the pipe.  pipefd[0] refers to the read end of the
pipe.  pipefd[1] refers to the write end of the pipe."</li>

<li>pipefd[0] =&gt; File descriptor for reading the pipe.</li>

<li>pipefd[1] =&gt; File descriptor for writing to the pipe.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">int</span> <span class="org-function-name">pipe</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">pipefd</span><span class="org-rainbow-delimiters-depth-2">[</span>2<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Function dup2()
</p>

<ul class="org-ul">
<li>Encapsulates: dup2() system-call</li>

<li>Duplicate file descriptor, used for IO redirection.</li>

<li>dup2( fd1, STDOUT_FILENO ) =&gt; Example: redirect current process'
stdout to file descriptor fd1.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">dup2</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">oldfd</span>, <span class="org-type">int</span> <span class="org-variable-name">newfd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Sample Code</b> 
</p>

<p>
This code spawns a subprocess using fork() + exec() and uses pipes to
read the subprocess output which are stdout and stderr of the "ls -l -a /".  
</p>

<p>
File: pipe-test.cpp
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-comment-delimiter">// </span><span class="org-comment">---- Unix headers --------// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/wait.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
    <span class="org-doc">/** Application to be called or its absolute path */</span>
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">app</span> = <span class="org-string">"ls"</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Arguments ('-l' '-a' '/') for ls -l -a /</span>
    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">args</span> <span class="org-rainbow-delimiters-depth-2">[]</span> = <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">First argument - process name (can be anything)</span><span class="org-comment-delimiter">   */</span>  
                             <span class="org-string">"ls"</span> 
                            <span class="org-comment-delimiter">/* </span><span class="org-comment">Arguments passed to application</span><span class="org-comment-delimiter"> */</span>
                            , <span class="org-string">"-l"</span>, <span class="org-string">"-a"</span>, <span class="org-string">"/"</span>
                            <span class="org-comment-delimiter">/* </span><span class="org-comment">Sentinel value - always nullptr</span><span class="org-comment-delimiter"> */</span>
                            , <span class="org-constant">nullptr</span>  
                         <span class="org-rainbow-delimiters-depth-2">}</span>;

    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">PIPE_READ</span> = 0;
    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">PIPE_WRITE</span> = 1;

    <span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-2">[</span>2<span class="org-rainbow-delimiters-depth-2">]</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">----- Create pipe IPC channel --------//</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> pipe<span class="org-rainbow-delimiters-depth-3">(</span>fd<span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">){</span>
       <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: cannot create pipe \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Fork() ----------------//</span>

    <span class="org-type">pid_t</span> <span class="org-variable-name">cpid</span> = fork<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>cpid == -1<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to launch process \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;         
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>cpid == 0<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-doc">/** ------- BEGIN of child process ------ **/</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [TRACE] Child process =&gt; PID_CHILD = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;       

        <span class="org-comment-delimiter">// </span><span class="org-comment">Connect child process' stdin to read-end of the pipe.</span>
        dup2<span class="org-rainbow-delimiters-depth-3">(</span> fd<span class="org-rainbow-delimiters-depth-4">[</span>PIPE_READ<span class="org-rainbow-delimiters-depth-4">]</span>, STDIN_FILENO <span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Redirect child process' stdout (STDOUT_FILENO) to the write-end of the pipe. </span>
        dup2<span class="org-rainbow-delimiters-depth-3">(</span> fd<span class="org-rainbow-delimiters-depth-4">[</span>PIPE_WRITE<span class="org-rainbow-delimiters-depth-4">]</span>, STDOUT_FILENO <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Redirect child process' stderr to write-end of the pipe.</span>
        dup2<span class="org-rainbow-delimiters-depth-3">(</span> fd<span class="org-rainbow-delimiters-depth-4">[</span>PIPE_WRITE<span class="org-rainbow-delimiters-depth-4">]</span>, STDERR_FILENO <span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Run process - exec() syscall =&gt; the new process image </span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">has the same PID as the child process. </span>
        execvp<span class="org-rainbow-delimiters-depth-3">(</span>app, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">char</span> *<span class="org-keyword">const</span> *<span class="org-rainbow-delimiters-depth-4">)</span> args<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> 0;          
        <span class="org-doc">/** ------- END of child process ------ **/</span>
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">---- Continue parent process ---------//</span>

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] &lt;AFTER FORK&gt; PID of parent process = %d \n"</span>, getpid<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">BUFSIZE</span> = 200;
     <span class="org-type">ssize_t</span> <span class="org-variable-name">nread</span> = 0;
     <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">[</span>BUFSIZE<span class="org-rainbow-delimiters-depth-2">]</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Close unnused end of the pipe.</span>
     close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-3">[</span>PIPE_WRITE<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Write bytes read from the pipe (write-end), written by child process</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">, to the stdout.</span>
     <span class="org-keyword">do</span> <span class="org-rainbow-delimiters-depth-2">{</span>   
          nread = read<span class="org-rainbow-delimiters-depth-3">(</span> fd<span class="org-rainbow-delimiters-depth-4">[</span>PIPE_READ<span class="org-rainbow-delimiters-depth-4">]</span>, &amp;buffer, BUFSIZE<span class="org-rainbow-delimiters-depth-3">)</span>;
          write<span class="org-rainbow-delimiters-depth-3">(</span>STDOUT_FILENO, buffer, nread<span class="org-rainbow-delimiters-depth-3">)</span>;      
     <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">while</span> <span class="org-rainbow-delimiters-depth-2">(</span> nread &gt; 0<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [TRACE] Waiting for child process termination. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-3">[</span>PIPE_READ<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">Wait for child process termination </span>
     ::wait<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> EXIT_SUCCESS;

     <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">-- End of main() --- //</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-cpp">$ &gt;&gt; g++ pipe-test.cpp -o <span class="org-keyword">pipe-test.bin</span> -std=c++1z -g -Wall -Wextra
</pre>
</div>

<p>
Running:
</p>

<div class="org-src-container">
<pre class="src src-cpp"> $ &gt;&gt; ./pipe-test.bin 
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">AFTER</span> <span class="org-variable-name">FORK</span><span class="org-rainbow-delimiters-depth-1">&gt;</span> PID of parent process = 1352693 
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span> Child process =&gt; PID_CHILD = 1352694 
total 72
dr-xr-xr-x.  18 root root  4096 May 17 21:36 .
dr-xr-xr-x.  18 root root  4096 May 17 21:36 ..
-rw-r--r--    1 root root     0 May 17 21:36 .autorelabel
lrwxrwxrwx.   1 root root     7 Jan 28 15:30 bin -&gt; usr/bin
dr-xr-xr-x.   6 root root  4096 May 17 15:17 boot
drwxr-xr-x   21 root root  4200 Jun 28 19:22 dev
... ... ... ... ... ... ... ... ... ... 
... ... ... ... ... ... ... ... ... ... ... ... 
lrwxrwxrwx.   1 root root     8 Jan 28 15:30 sbin -&gt; usr/sbin
drwxr-xr-x.   2 root root  4096 May 12 14:50 srv
dr-xr-xr-x   13 root root     0 Jun  8 11:58 sys
drwxrwxrwt   31 root root   680 Jun 30 04:02 tmp
drwxr-xr-x.  12 root root  4096 Apr 22 19:35 usr
drwxr-xr-x.  22 root root  4096 Apr 22 19:39 var
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span> Waiting <span class="org-keyword">for</span> child process termination. 
</pre>
</div>
</div>
</div>

<div id="outline-container-org35b5c12" class="outline-3">
<h3 id="org35b5c12"><span class="section-number-3">1.20</span> Reading/Listings directory contents</h3>
<div class="outline-text-3" id="text-1-20">
<p>
API Documentations: 
</p>

<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man3/opendir.3.html">Linux Manpage - opendir()</a></li>

<li><a href="https://www.freebsd.org/cgi/man.cgi?query=opendir&amp;sektion=3">FreeBSD manpage - opendir()</a></li>

<li><a href="https://www.man7.org/linux/man-pages/man3/readdir.3.html">Linux manpage - readdir()</a></li>
</ul>

<p>
Functions used: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">DIR</span> *<span class="org-function-name">opendir</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-function-name">readdir</span><span class="org-rainbow-delimiters-depth-1">(</span>   <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">fd</span>
             , <span class="org-keyword">struct</span> <span class="org-type">old_linux_dirent</span>* <span class="org-variable-name">dirp</span>,
             , <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">count</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
File: unix-readdir.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">#include &lt;string&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">dirent.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Get function opendir</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">errno.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>


<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">Callback</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-type">void</span> <span class="org-function-name">iterate_directory</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">path</span>, <span class="org-type">Callback</span>&amp;&amp; <span class="org-variable-name">callback</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DIR</span> *<span class="org-variable-name">dir</span>;
    <span class="org-keyword">struct</span> <span class="org-type">dirent</span> *<span class="org-variable-name">dp</span>;

    dir = opendir<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span> ;

    <span class="org-comment-delimiter">// </span><span class="org-comment">To determine the cause of error - It is necessary to check the error code.</span>
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>dir == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: Cannot read directory"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">while</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span>dp = readdir<span class="org-rainbow-delimiters-depth-4">(</span>dir<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>path == <span class="org-string">"/"</span><span class="org-rainbow-delimiters-depth-3">)</span>
            callback<span class="org-rainbow-delimiters-depth-3">(</span>dp-&gt;d_name<span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-keyword">else</span> 
            callback<span class="org-rainbow-delimiters-depth-3">(</span>path + <span class="org-string">"/"</span> + dp-&gt;d_name<span class="org-rainbow-delimiters-depth-3">)</span>;      
    <span class="org-rainbow-delimiters-depth-2">}</span>;
    closedir<span class="org-rainbow-delimiters-depth-2">(</span>dir<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" List directory contents "</span> &lt;&lt; <span class="org-constant">std</span>::endl;

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Usage: ./unix-readdir &lt;DIRECTORY&gt;"</span> &lt;&lt; <span class="org-string">"\n"</span>;
         <span class="org-keyword">return</span> EXIT_SUCCESS;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-type">int</span> <span class="org-variable-name">idx</span> = 0;
     iterate_directory<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, <span class="org-rainbow-delimiters-depth-3">[</span>&amp;<span class="org-variable-name">idx</span><span class="org-rainbow-delimiters-depth-3">](</span><span class="org-keyword">auto</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-3">)</span>
     <span class="org-rainbow-delimiters-depth-3">{</span>
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"  ["</span> &lt;&lt; idx++  &lt;&lt; <span class="org-string">"] path =&gt; "</span> &lt;&lt; path &lt;&lt; <span class="org-string">"\n"</span>;
     <span class="org-rainbow-delimiters-depth-3">}</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-readdir.cpp -o <span class="org-keyword">unix-readdir.bin</span> -std=c++1z -g -Wall -Wextra 
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; ./unix-readdir.bin /
 List directory contents 
  [0] path =&gt; srv
  [1] path =&gt; sys
  [2] path =&gt; ..
  [3] path =&gt; opt
  [4] path =&gt; .
  [5] path =&gt; run
  [6] path =&gt; media
  ... ... ... 
  [18] path =&gt; lib
  [19] path =&gt; usr
  [20] path =&gt; boot
  [21] path =&gt; mnt
  [22] path =&gt; sbin
... .. .... ... ... 

 $ &gt;&gt; ./unix-readdir.bin /boot 
 List directory contents 
  [0] path =&gt; /boot/..
  [1] path =&gt; /boot/.
  [2] path =&gt; /boot/initramfs-5.6.12-300.fc32.x86_64.img
  [3] path =&gt; /boot/grub2
  [4] path =&gt; /boot/vmlinuz-0-rescue-a1ac43b933e24659bba5edf2b9cec1e1
  [5] path =&gt; /boot/memtest86+-5.01
  [6] path =&gt; /boot/initramfs-5.6.6-300.fc32.x86_64.img
   ... ... ...     ... ... ...     ... ... ...     ... ... ...     
</pre>
</div>
</div>
</div>
<div id="outline-container-org51b012c" class="outline-3">
<h3 id="org51b012c"><span class="section-number-3">1.21</span> Memory Mapped Files - mmap</h3>
<div class="outline-text-3" id="text-1-21">
</div>
<div id="outline-container-orgc8c57b1" class="outline-4">
<h4 id="orgc8c57b1"><span class="section-number-4">1.21.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-21-1">
<p>
File mapping is an operating system mechanism which maps a disk file
to a process virtual memory. This operating system feature allows
accessing the file as it was in the process memory. 
</p>

<p>
Benefits: 
</p>

<ul class="org-ul">
<li>Transparent access to file, allows accessing the file as it was an
ordinary memory. (the file is accessible by pointer)</li>

<li>Good for processing large files which does not fit in the machine
RAM memory.</li>
</ul>

<p>
Use-cases: 
</p>

<ul class="org-ul">
<li>Read large files</li>

<li>IPC - Inter-Process Communication</li>

<li>Process complicated binary files</li>

<li>Modify complex binary files. The file can be modified by just
changing a memory, in other words, modifying the contents of a
memory address.</li>

<li>Implement JIT - Just-In-Time compiler and execute assembly code at runtime.</li>
</ul>

<p>
The <span class="underline">mmap API</span> is available in most Unix-like operating systems: 
</p>

<ul class="org-ul">
<li>Linux</li>
<li>BSD-family: MacOSX, FreeBDS, NetBSD, OpenBSD</li>
<li>Solaris</li>
<li>QNX, AIX</li>
</ul>

<p>
<b>Mmap API functions</b>
</p>

<p>
File descriptors: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Returns file descriptor of a disk-file </span>
<span class="org-type">int</span> <span class="org-function-name">open</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">pathname</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Close file descriptor (release resource)</span>
<span class="org-type">int</span> <span class="org-function-name">close</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Mmap: 
</p>

<ul class="org-ul">
<li>Doc: $ man mmap</li>
<li>Linux Manpage Description: "mmap() creates a new mapping in the
virtual address space of the calling process.  The starting
address for the new mapping is specified in addr.  The length
argument speci‐ fies the length of the mapping (which must be
greater than 0)"</li>

<li>Argument: <span class="underline">prot</span> (Memory Protection)
<ul class="org-ul">
<li>PROT_READ  =&gt; Pages may be written (most used)</li>
<li>PROT_WRITE =&gt; Pages may be written (allows changing the file by writing to the mapped memory)</li>
<li>PROT_NONE  =&gt; Pages may not be accessed</li>
<li>PROT_EXEC  =&gt; Pages may be executed =&gt; Allows executing machine
code (assembly) at runtime. Use case: JIT - Just-In-Time
compiler</li>
</ul></li>

<li>Argument: <span class="underline">flags</span>
<ul class="org-ul">
<li>MAP_SHARED  =&gt; Multiple processes can share the same <span class="underline">file</span>
<span class="underline">mapping</span>. This flag is used for IPC - Inter Process
Communication.</li>
<li>MAP_PRIVATE =&gt; Only the current process can access the file mapping.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span>* <span class="org-function-name">mmap</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">void</span>*   <span class="org-variable-name">addr</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">(often nullptr) Address that the file will be mapped </span>
           , <span class="org-type">size_t</span>  <span class="org-variable-name">length</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">Length of file mapping (often the file size)</span>
           , <span class="org-type">int</span>     <span class="org-variable-name">prot</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Flags for memory protection </span>
           , <span class="org-type">int</span>     <span class="org-variable-name">flags</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">Flags for process access conttrol (private | shared)</span>
           , <span class="org-type">int</span>     <span class="org-variable-name">fd</span>      <span class="org-comment-delimiter">// </span><span class="org-comment">File descriptor to be mapped into virtual memory</span>
           , <span class="org-type">off_t</span>   <span class="org-variable-name">offset</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">(often zero) Offset from the beginning of the file </span>
          <span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
munmap:
</p>

<ul class="org-ul">
<li>Doc: $ man munmap</li>
<li>Linux Manpage doc: "The munmap() system call deletes the mappings
for the specified address range, and causes further references to
addresses within the range to generate invalid memory ref‐
erences.  The region is also automatically unmapped when the
process is terminated.  On the other hand, closing the file
descriptor does not unmap the region."</li>

<li>Param <span class="underline">addr</span>: Address of memory mapping (value returned by mmap)</li>

<li>Param <span class="underline">length:</span> length of file mapping, often it is the file size.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">For mmap and munmap </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>     

<span class="org-type">int</span> <span class="org-function-name">munmap</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-type">void</span> *<span class="org-variable-name">addr</span>, <span class="org-type">size_t</span> <span class="org-variable-name">length</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Hyperlinks to manpage documentation of related-functions: 
</p>

<ul class="org-ul">
<li><a href="https://linux.die.net/man/2/mmap">mmap</a> (Linux manpage)</li>

<li><a href="https://linux.die.net/man/2/remap_file_pages">remap_file_pages</a></li>

<li><a href="https://linux.die.net/man/2/mremap">mremap</a> (Linux manpage)</li>

<li><a href="https://linux.die.net/man/2/msync">msync</a></li>
</ul>


<p>
<b>References and further reading</b> 
</p>

<p>
General: 
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Mmap">mmap - Wikipedia</a></li>

<li><a href="https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/FileSystemAdvancedPT/MappingFilesIntoMemory/MappingFilesIntoMemory.html">Apple - Mapping Files Into Memory</a></li>

<li><a href="https://upsilon.cc/~zack/teaching/1415/progsyst/cours-05-mmap.pdf">Programmation SystèmeCours 5 — Memory Mapping</a> (<a href="http://web.archive.org/web/20200622232258/https://upsilon.cc/~zack/teaching/1415/progsyst/cours-05-mmap.pdf">Web Archive</a>)</li>

<li><a href="https://unix.stackexchange.com/questions/474926/how-does-memory-mapping-a-file-have-significant-performance-increases-over-the-s/475014">How does memory mapping a file have significant performance increases over the standard I/O system calls?</a></li>

<li><a href="https://courses.engr.illinois.edu/cs241/sp2014/lecture/27-IPC.pdf">Interprocess Communication: Memory mapped files and pipes</a></li>

<li><a href="http://web.cs.ucla.edu/honors/UPLOADS/kousha/thesis.pdf">Linux Memory Mapped System Call Performance</a></li>

<li><a href="https://w3.cs.jmu.edu/kirkpams/OpenCSF/Books/csf/html/MMap.html">Shared Memory with Memory-Mapped Files</a></li>

<li><a href="https://www.sublimetext.com/blog/articles/use-mmap-with-care">Use mmap With Care - Sublime HQ</a></li>

<li><a href="http://www.idryman.org/blog/2017/06/28/opic-a-memory-allocator-for-fast-serialization/">Writing a Memory Allocator for Fast Serialization</a></li>

<li><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2006/n2044.html">Paper: Memory Mapped Files And Shared Memory For C++</a></li>

<li><a href="https://indico.cern.ch/event/658060/contributions/2898569/attachments/1622526/2582399/pivarski-serialization.pdf">Overview of Serialization Technologies</a> - CERN</li>

<li><a href="https://www.usenix.org/sites/default/files/conference/protected-files/hotstorage17_slides_choi.pdf">Efficient Memory Mapped File I/O for In-Memory File Systems</a></li>

<li><a href="https://engineering.mongodb.com/post/getting-storage-engines-ready-for-fast-storage-devices">Getting storage engines ready for fast storage devices</a></li>

<li><a href="http://blogs.networkingfutures.co.uk/post/2015/12/28/Windows-Services-Implementing-Non-Persisted-Memory-Mapped-Files-Exposing-IPC-Style-Communications.aspx">Introduction to Memory Mapped Files</a> (.NET Specific)</li>
</ul>


<p>
MMAP - File Memory Mapping for other programming languages
</p>

<ul class="org-ul">
<li><a href="https://docs.rs/flatdata/0.5.0/flatdata/">https://docs.rs/flatdata/0.5.0/flatdata/</a> (Rust library for mmap)</li>

<li><a href="https://www.red-gate.com/simple-talk/dotnet/net-development/sharing-caring-using-memory-mapped-files-net/">Sharing is Caring: Using Memory Mapped Files in .NET</a></li>

<li><a href="https://coders-corner.net/2013/03/22/inter-process-communication-with-memory-mapped-files-part-01-transfer-a-data-structure-and-an-object/">Inter-Process Communication with Memory-Mapped Files, Part 01</a></li>

<li><a href="https://github.com/jampp/sharedbuffers/">Python SharedBuffer - library for mmap</a></li>

<li><a href="https://docs.julialang.org/en/v1/stdlib/Mmap/">https://docs.julialang.org/en/v1/stdlib/Mmap/</a> - Julia Language library for mmap (memory-mapped files)</li>

<li><a href="https://engineering.indeedblog.com/blog/2015/02/memory-mapping-with-util-mmap/">Memory Mapping with util-mmap</a> - mmap for Java.</li>
</ul>
</div>
</div>
<div id="outline-container-orgbf80345" class="outline-4">
<h4 id="orgbf80345"><span class="section-number-4">1.21.2</span> Example (C) - mmap for reading Windows PE32 files</h4>
<div class="outline-text-4" id="text-1-21-2">
<p>
This code uses mmap API (memory mapped files) for reading metadata
from PE (Portable Executable) - Windows native executable files or
windows object-code. 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78">https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78</a></li>
</ul>

<p>
File: unix-mmap.c 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdio.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdlib.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdint.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">assert.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">--- Unix/Posix headers ---------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">IMAGE_SIZEOF_SHORT_NAME</span>            8
<span class="org-preprocessor">#define</span> <span class="org-variable-name">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span>  16

<span class="org-keyword">typedef</span> <span class="org-type">int32_t</span>  <span class="org-type">LONG</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint16_t</span> <span class="org-type">WORD</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint32_t</span> <span class="org-type">DWORD</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint8_t</span>  <span class="org-type">BYTE</span>;
<span class="org-keyword">typedef</span> <span class="org-type">uint64_t</span> <span class="org-type">ULONGLONG</span>;;

<span class="org-comment-delimiter">// </span><span class="org-comment">Source: &lt;winttt.h&gt;  =&gt; Original: typedef struct _IMAGE_DOS_HEADER</span>
<span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-rainbow-delimiters-depth-1">{</span>            
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_magic</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cblp</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_crlc</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cparhdr</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_minalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_maxalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ss</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_sp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_csum</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ip</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cs</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_lfarlc</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ovno</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res</span><span class="org-rainbow-delimiters-depth-2">[</span>4<span class="org-rainbow-delimiters-depth-2">]</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oemid</span>;                  
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oeminfo</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res2</span><span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span>;               
    <span class="org-comment-delimiter">//  </span><span class="org-comment">Offset to the PE header from the beginning of the file. </span>
    <span class="org-type">LONG</span>   <span class="org-variable-name">e_lfanew</span>;                    
  <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">IMAGE_DOS_HEADER</span>;

 <span class="org-keyword">typedef</span> <span class="org-keyword">struct</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">Signature</span>; 
    <span class="org-type">WORD</span>  <span class="org-variable-name">Machine</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">NumberOfSections</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">TimeDateStamp</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">PointerToSymbolTable</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">NumberOfSymbols</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">SizeOfOptionalHeader</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">Characteristics</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">PE_HEADER</span>;


<span class="org-type">ssize_t</span> <span class="org-function-name">get_file_size</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">file_stat</span>; 
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> fstat<span class="org-rainbow-delimiters-depth-3">(</span>fd, &amp;file_stat<span class="org-rainbow-delimiters-depth-3">)</span> == -1 <span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">return</span> -1;
    <span class="org-keyword">return</span> file_stat.st_size;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Validate arguments ----------------------------//</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Usage: /unix-mmap &lt;FILE&gt; \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Get file descriptor ----------------------------//</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Get read-only file descriptor of file </span>
    <span class="org-type">int</span> <span class="org-variable-name">fd</span> = open<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, O_RDONLY<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>fd == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to open file. check ERRNO variable \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">ssize_t</span> <span class="org-variable-name">size</span> = get_file_size<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>size == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to get file size \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Map file in to process' virtual memory ---------------------------//</span>

    <span class="org-type">void</span>* <span class="org-variable-name">fmap</span> = mmap<span class="org-rainbow-delimiters-depth-2">(</span>    <span class="org-constant">NULL</span>        <span class="org-comment-delimiter">/* </span><span class="org-comment">Often set to zero, aka nullpointer</span><span class="org-comment-delimiter">           */</span>
                        , size        <span class="org-comment-delimiter">/* </span><span class="org-comment">Size of file mapping in bytes</span><span class="org-comment-delimiter">                */</span>
                        , PROT_READ   <span class="org-comment-delimiter">/* </span><span class="org-comment">Open in read-only mode</span><span class="org-comment-delimiter">                       */</span>
                        , MAP_PRIVATE <span class="org-comment-delimiter">/* </span><span class="org-comment">Only this process can access this memory-map</span><span class="org-comment-delimiter"> */</span>
                        , fd          <span class="org-comment-delimiter">/* </span><span class="org-comment">File descriptor of file to be memory mapped</span><span class="org-comment-delimiter">  */</span>
                        , 0x00        <span class="org-comment-delimiter">/* </span><span class="org-comment">Offset from the beggining of the file</span><span class="org-comment-delimiter">        */</span>
                     <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> fmap == MAP_FAILED<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: memory mapped failed. check ERRNO \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Process file -----------------------------------------// </span>

    <span class="org-type">unsigned</span> <span class="org-type">char</span>* <span class="org-variable-name">bmap</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">unsigned</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-2">)</span> fmap; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">char file_signature [2] = { bmap[0], bmap[1], bmap[2], bmap[3], 0x00 };</span>
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" File signature = %c %c 0x%X 0x%X \n"</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">IMAGE_DOS_HEADER</span>* <span class="org-variable-name">dos_header</span> = <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IMAGE_DOS_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">)</span> fmap;
    <span class="org-type">PE_HEADER</span>*        <span class="org-variable-name">pe_header</span>  = fmap + dos_header-&gt;e_lfanew;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> pe_header-&gt;Signature == 0x4550 <span class="org-rainbow-delimiters-depth-2">)</span>;

    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ========= [DOS HEADER] =================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = 0x%X (hex) \n"</span>, dos_header-&gt;e_magic<span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = %c %c  (str) \n"</span>, dos_header-&gt;e_magic &amp; 0xFF, <span class="org-rainbow-delimiters-depth-3">(</span>dos_header-&gt;e_magic &gt;&gt; 8<span class="org-rainbow-delimiters-depth-3">)</span> &amp; 0xFF<span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"       e_lfanew = 0x%X \n"</span>,      dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== [PE - Header] ================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"          Signature = 0x%X \n"</span>, pe_header-&gt;Signature<span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"            Machine = 0x%X \n"</span>, pe_header-&gt;Machine<span class="org-rainbow-delimiters-depth-2">)</span>;
    printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Number of sections = %d \n"</span>,   pe_header-&gt;NumberOfSections<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">---------- Release Resource ------------------------------------// </span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Unmap memory segment </span>
    munmap<span class="org-rainbow-delimiters-depth-2">(</span>fmap, size<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Release file-descriptor resource</span>
    close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of main() ----// </span>


</pre>
</div>

<p>
Build: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ gcc unix-mmap.c -o <span class="org-keyword">unix-mmap-c.bin</span> -Wall -Wextra -g
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./unix-mmap-c.bin notepad.exe 
 File signature = M Z 0x90 0x0 

 ========= [DOS HEADER] =================
   MAGIC NUMBER = 0x5A4D (hex) 
   MAGIC NUMBER = M Z  (str) 
       e_lfanew = 0xF8 

 ======== [PE - Header] ================
 Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 

          Signature = 0x4550 
            Machine = 0x8664 
 Number of sections = 7 

</pre>
</div>
</div>
</div>
<div id="outline-container-orge23abe8" class="outline-4">
<h4 id="orge23abe8"><span class="section-number-4">1.21.3</span> Example (C++) - mmap for reading Windows PE32 files</h4>
<div class="outline-text-4" id="text-1-21-3">
<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78">https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78</a></li>
</ul>

<p>
File: unix-mmap.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdint</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">--- Unix/Posix headers ---------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_SIZEOF_SHORT_NAME</span> = 8;
<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span> = 16;

<span class="org-comment-delimiter">// </span><span class="org-comment">using LONG      = long;</span>
<span class="org-keyword">using</span> <span class="org-type">LONG</span>      = <span class="org-constant">std</span>::int32_t;
<span class="org-keyword">using</span> <span class="org-type">WORD</span>      = <span class="org-constant">std</span>::uint16_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned short;</span>
<span class="org-keyword">using</span> <span class="org-type">DWORD</span>     = <span class="org-constant">std</span>::uint32_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long; </span>
<span class="org-keyword">using</span> <span class="org-type">BYTE</span>      = <span class="org-constant">std</span>::uint8_t;   <span class="org-comment-delimiter">//</span><span class="org-comment">unsigned char;</span>
<span class="org-keyword">using</span> <span class="org-type">ULONGLONG</span> = <span class="org-constant">std</span>::uint64_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long long </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Source: &lt;winttt.h&gt;  =&gt; Original: typedef struct _IMAGE_DOS_HEADER</span>
<span class="org-keyword">struct</span> <span class="org-type">IMAGE_DOS_HEADER</span> <span class="org-rainbow-delimiters-depth-1">{</span>            
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_magic</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cblp</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_crlc</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cparhdr</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_minalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_maxalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ss</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_sp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_csum</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ip</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cs</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_lfarlc</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ovno</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res</span><span class="org-rainbow-delimiters-depth-2">[</span>4<span class="org-rainbow-delimiters-depth-2">]</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oemid</span>;                  
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oeminfo</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res2</span><span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span>;               
    <span class="org-comment-delimiter">//  </span><span class="org-comment">Offset to the PE header from the beginning of the file. </span>
    <span class="org-type">LONG</span>   <span class="org-variable-name">e_lfanew</span>;                    
  <span class="org-rainbow-delimiters-depth-1">}</span>;

 <span class="org-keyword">struct</span> <span class="org-type">PE_HEADER</span>
 <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">Signature</span>; 
    <span class="org-type">WORD</span>  <span class="org-variable-name">Machine</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">NumberOfSections</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">TimeDateStamp</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">PointerToSymbolTable</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">NumberOfSymbols</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">SizeOfOptionalHeader</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">Characteristics</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span>;


<span class="org-type">ssize_t</span> <span class="org-function-name">get_file_size</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">file_stat</span>; 
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> fstat<span class="org-rainbow-delimiters-depth-3">(</span>fd, &amp;file_stat<span class="org-rainbow-delimiters-depth-3">)</span> == -1 <span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: unable to get file size"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> file_stat.st_size;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Validate arguments ----------------------------//</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Usage: /unix-mmap &lt;FILE&gt; \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Get file descriptor ----------------------------//</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Get read-only file descriptor of file </span>
    <span class="org-type">int</span> <span class="org-variable-name">fd</span> = open<span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, O_RDONLY<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>fd == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: unable to open file. check ERRNO variable \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">ssize_t</span> <span class="org-variable-name">size</span> = get_file_size<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Map file in to process' virtual memory ---------------------------//</span>

    <span class="org-type">void</span>* <span class="org-variable-name">fmap</span> = mmap<span class="org-rainbow-delimiters-depth-2">(</span>    <span class="org-constant">nullptr</span>     <span class="org-comment-delimiter">/* </span><span class="org-comment">Often set to zero, aka nullpointer</span><span class="org-comment-delimiter">           */</span>
                        , size        <span class="org-comment-delimiter">/* </span><span class="org-comment">Size of file mapping in bytes</span><span class="org-comment-delimiter">                */</span>
                        , PROT_READ   <span class="org-comment-delimiter">/* </span><span class="org-comment">Open in read-only mode</span><span class="org-comment-delimiter">                       */</span>
                        , MAP_PRIVATE <span class="org-comment-delimiter">/* </span><span class="org-comment">Only this process can access this memory-map</span><span class="org-comment-delimiter"> */</span>
                        , fd          <span class="org-comment-delimiter">/* </span><span class="org-comment">File descriptor of file to be memory mapped</span><span class="org-comment-delimiter">  */</span>
                        , 0x00        <span class="org-comment-delimiter">/* </span><span class="org-comment">Offset from the beggining of the file</span><span class="org-comment-delimiter">        */</span>
                     <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> fmap == MAP_FAILED<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: memory mapped failed. check ERRNO \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Process file -----------------------------------------// </span>

    <span class="org-keyword">const</span> <span class="org-keyword">auto</span> <span class="org-variable-name">bmap</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">unsigned</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>fmap<span class="org-rainbow-delimiters-depth-2">)</span>; 

    <span class="org-comment-delimiter">// </span><span class="org-comment">char file_signature [2] = { bmap[0], bmap[1], bmap[2], bmap[3], 0x00 };</span>
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" File signature = %c %c 0x%X 0x%X \n"</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">IMAGE_DOS_HEADER</span>* <span class="org-variable-name">dos_header</span> = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IMAGE_DOS_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>fmap<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">PE_HEADER</span>*        <span class="org-variable-name">pe_header</span>  = <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">PE_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">uintptr_t</span><span class="org-rainbow-delimiters-depth-3">)</span> fmap + dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> pe_header-&gt;Signature == 0x4550 <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ========= [DOS HEADER] =================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = 0x%X (hex) \n"</span>, dos_header-&gt;e_magic<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = %c %c  (str) \n"</span>, dos_header-&gt;e_magic &amp; 0xFF, <span class="org-rainbow-delimiters-depth-3">(</span>dos_header-&gt;e_magic &gt;&gt; 8<span class="org-rainbow-delimiters-depth-3">)</span> &amp; 0xFF<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"       e_lfanew = 0x%X \n"</span>,      dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== [PE - Header] ================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"          Signature = 0x%X \n"</span>, pe_header-&gt;Signature<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"            Machine = 0x%X \n"</span>, pe_header-&gt;Machine<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Number of sections = %d \n"</span>,   pe_header-&gt;NumberOfSections<span class="org-rainbow-delimiters-depth-2">)</span>;


    <span class="org-comment-delimiter">// </span><span class="org-comment">---------- Release Resource ------------------------------------// </span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Unmap memory segment </span>
    munmap<span class="org-rainbow-delimiters-depth-2">(</span>fmap, size<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Release file-descriptor resource</span>
    close<span class="org-rainbow-delimiters-depth-2">(</span>fd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of main() ----// </span>


</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ clang++ unix-mmap.cpp -o <span class="org-keyword">unix-mmap.bin</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./unix-mmap.bin ipconfig.exe 
 File signature = M Z 0x90 0x0 

 ========= [DOS HEADER] =================
   MAGIC NUMBER = 0x5A4D (hex) 
   MAGIC NUMBER = M Z  (str) 
       e_lfanew = 0xE8 

 ======== [PE - Header] ================
 Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 

          Signature = 0x4550 
            Machine = 0x8664 
 Number of sections = 6 


$ ./unix-mmap.bin notepad.exe 
 File signature = M Z 0x90 0x0 

 ========= [DOS HEADER] =================
   MAGIC NUMBER = 0x5A4D (hex) 
   MAGIC NUMBER = M Z  (str) 
       e_lfanew = 0xF8 

 ======== [PE - Header] ================
 Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 

          Signature = 0x4550 
            Machine = 0x8664 
 Number of sections = 7 
</pre>
</div>
</div>
</div>
<div id="outline-container-orgeb4eda4" class="outline-4">
<h4 id="orgeb4eda4"><span class="section-number-4">1.21.4</span> Example (C++) - mmap for reading Windows PE32 with class</h4>
<div class="outline-text-4" id="text-1-21-4">
<p>
This code uses a class FileMapping for encapsulating Unix
memory-mapped files which simplifies the usage of the mmap feature and
makes the code cleaner and safer. 
</p>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78">https://gist.github.com/166265f6dc85c8d9cc2dc00253caae78</a></li>
</ul>

<p>
File: unix-mmap-class.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fstream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdint</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">--- Unix/Posix headers ---------//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/mman.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/stat.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_SIZEOF_SHORT_NAME</span> = 8;
<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span> = 16;

<span class="org-comment-delimiter">// </span><span class="org-comment">using LONG      = long;</span>
<span class="org-keyword">using</span> <span class="org-type">LONG</span>      = <span class="org-constant">std</span>::int32_t;
<span class="org-keyword">using</span> <span class="org-type">WORD</span>      = <span class="org-constant">std</span>::uint16_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned short;</span>
<span class="org-keyword">using</span> <span class="org-type">DWORD</span>     = <span class="org-constant">std</span>::uint32_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long; </span>
<span class="org-keyword">using</span> <span class="org-type">BYTE</span>      = <span class="org-constant">std</span>::uint8_t;   <span class="org-comment-delimiter">//</span><span class="org-comment">unsigned char;</span>
<span class="org-keyword">using</span> <span class="org-type">ULONGLONG</span> = <span class="org-constant">std</span>::uint64_t;  <span class="org-comment-delimiter">// </span><span class="org-comment">unsigned long long </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Source: &lt;winttt.h&gt;  =&gt; Original: typedef struct _IMAGE_DOS_HEADER</span>
<span class="org-keyword">struct</span> <span class="org-type">IMAGE_DOS_HEADER</span> <span class="org-rainbow-delimiters-depth-1">{</span>            
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_magic</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cblp</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_crlc</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cparhdr</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_minalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_maxalloc</span>;               
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ss</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_sp</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_csum</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ip</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_cs</span>;                     
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_lfarlc</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_ovno</span>;                   
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res</span><span class="org-rainbow-delimiters-depth-2">[</span>4<span class="org-rainbow-delimiters-depth-2">]</span>;                 
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oemid</span>;                  
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_oeminfo</span>;                
    <span class="org-type">WORD</span>   <span class="org-variable-name">e_res2</span><span class="org-rainbow-delimiters-depth-2">[</span>10<span class="org-rainbow-delimiters-depth-2">]</span>;               
    <span class="org-comment-delimiter">//  </span><span class="org-comment">Offset to the PE header from the beginning of the file. </span>
    <span class="org-type">LONG</span>   <span class="org-variable-name">e_lfanew</span>;                    
  <span class="org-rainbow-delimiters-depth-1">}</span>;

 <span class="org-keyword">struct</span> <span class="org-type">PE_HEADER</span>
 <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">DWORD</span> <span class="org-variable-name">Signature</span>; 
    <span class="org-type">WORD</span>  <span class="org-variable-name">Machine</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">NumberOfSections</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">TimeDateStamp</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">PointerToSymbolTable</span>;
    <span class="org-type">DWORD</span> <span class="org-variable-name">NumberOfSymbols</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">SizeOfOptionalHeader</span>;
    <span class="org-type">WORD</span>  <span class="org-variable-name">Characteristics</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-doc">/** Class for encapsulating memory mapped files*/</span>
<span class="org-keyword">class</span> <span class="org-type">FileMapping</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span>   <span class="org-variable-name">m_fd</span>      = -1; 
    <span class="org-type">void</span>* <span class="org-variable-name">m_addr</span>    = <span class="org-constant">nullptr</span>; 
    <span class="org-type">ssize_t</span> <span class="org-variable-name">m_size</span>  = -1;

    <span class="org-type">ssize_t</span> <span class="org-function-name">get_file_size</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">file_stat</span>; 
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> fstat<span class="org-rainbow-delimiters-depth-4">(</span>fd, &amp;file_stat<span class="org-rainbow-delimiters-depth-4">)</span> == -1 <span class="org-rainbow-delimiters-depth-3">)</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: unable to get file size"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> file_stat.st_size;
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-function-name">public</span>: 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy constructor </span>
    <span class="org-function-name">FileMapping</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">FileMapping</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Disable copy assignment operator </span>
    <span class="org-type">FileMapping</span>&amp; <span class="org-keyword">operator</span><span class="org-function-name">=</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">FileMapping</span> <span class="org-keyword">const</span>&amp;<span class="org-rainbow-delimiters-depth-2">)</span> = <span class="org-keyword">delete</span>;    

    <span class="org-doc">/** </span>
<span class="org-doc">     * </span><span class="org-doc"><span class="org-constant">@param</span></span><span class="org-doc"> file_path - File to be memory-mapped to current process. </span>
<span class="org-doc">     */</span>
    <span class="org-function-name">FileMapping</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">file_path</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Get read-only file descriptor of file </span>
        m_fd = open<span class="org-rainbow-delimiters-depth-3">(</span>file_path.c_str<span class="org-rainbow-delimiters-depth-4">()</span>, O_RDONLY<span class="org-rainbow-delimiters-depth-3">)</span>;        
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_fd == -1<span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Unable to open file"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>      

        m_size = get_file_size<span class="org-rainbow-delimiters-depth-3">(</span>m_fd<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>m_size == -1<span class="org-rainbow-delimiters-depth-3">)</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Unable to get file size"</span><span class="org-rainbow-delimiters-depth-3">)</span>;


        m_addr = ::mmap<span class="org-rainbow-delimiters-depth-3">(</span> <span class="org-constant">nullptr</span>     
                        , m_size       
                        , PROT_READ   
                        , MAP_PRIVATE 
                        , m_fd        
                        , 0x00        
                    <span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span> m_addr == MAP_FAILED<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Error: failed to map file to memory"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

    <span class="org-rainbow-delimiters-depth-2">}</span>

    ~<span class="org-function-name">FileMapping</span><span class="org-rainbow-delimiters-depth-2">()</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Unmap memory segment </span>
        munmap<span class="org-rainbow-delimiters-depth-3">(</span>m_addr, m_size<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Release file-descriptor resource</span>
        close<span class="org-rainbow-delimiters-depth-3">(</span>m_fd<span class="org-rainbow-delimiters-depth-3">)</span>;

        m_fd = -1;
        m_addr = <span class="org-constant">nullptr</span>;
        m_size = -1;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-doc">/** </span><span class="org-doc"><span class="org-constant">@brief</span></span><span class="org-doc"> Returns pointer file mapping address. */</span>
    <span class="org-type">void</span>* <span class="org-function-name">addr</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> m_addr; <span class="org-rainbow-delimiters-depth-2">}</span>  

    <span class="org-doc">/** </span><span class="org-doc"><span class="org-constant">@brief</span></span><span class="org-doc">  Get casted pointer to an offset of the file mapping address. */</span>
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-type">T</span> <span class="org-function-name">addr_rel</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">ptrdiff_t</span> <span class="org-variable-name">offset</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> 
        <span class="org-keyword">return</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">T</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">uintptr_t</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>m_addr<span class="org-rainbow-delimiters-depth-4">)</span> + offset<span class="org-rainbow-delimiters-depth-3">)</span>;  
    <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of class FileMapping ---- //</span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>   
    <span class="org-comment-delimiter">// </span><span class="org-comment">----------- Validate arguments ----------------------------//</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>argc &lt; 2<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Usage: /unix-mmap &lt;FILE&gt; \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> EXIT_FAILURE;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-type">FileMapping</span> <span class="org-variable-name">fmap</span><span class="org-rainbow-delimiters-depth-2">(</span>argv<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">--------- Process file -----------------------------------------// </span>

    <span class="org-keyword">const</span> <span class="org-keyword">auto</span> <span class="org-variable-name">bmap</span> = fmap.addr_rel<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">unsigned</span> <span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>0x00<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">char file_signature [2] = { bmap[0], bmap[1], bmap[2], bmap[3], 0x00 };</span>
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" File signature = %c %c 0x%X 0x%X \n"</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>1<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>2<span class="org-rainbow-delimiters-depth-3">]</span>, bmap<span class="org-rainbow-delimiters-depth-3">[</span>3<span class="org-rainbow-delimiters-depth-3">]</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">IMAGE_DOS_HEADER</span>* <span class="org-variable-name">dos_header</span> = fmap.addr_rel<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">IMAGE_DOS_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span>0x00<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">PE_HEADER</span>*        <span class="org-variable-name">pe_header</span>  = fmap.addr_rel<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">PE_HEADER</span>*<span class="org-rainbow-delimiters-depth-2">&gt;(</span> dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    assert<span class="org-rainbow-delimiters-depth-2">(</span> pe_header-&gt;Signature == 0x4550 <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ========= [DOS HEADER] =================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = 0x%X (hex) \n"</span>, dos_header-&gt;e_magic<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"   MAGIC NUMBER = %c %c  (str) \n"</span>, dos_header-&gt;e_magic &amp; 0xFF, <span class="org-rainbow-delimiters-depth-3">(</span>dos_header-&gt;e_magic &gt;&gt; 8<span class="org-rainbow-delimiters-depth-3">)</span> &amp; 0xFF<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"       e_lfanew = 0x%X \n"</span>,      dos_header-&gt;e_lfanew<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n ======== [PE - Header] ================\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"          Signature = 0x%X \n"</span>, pe_header-&gt;Signature<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"            Machine = 0x%X \n"</span>, pe_header-&gt;Machine<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" Number of sections = %d \n"</span>,   pe_header-&gt;NumberOfSections<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of main() ----// </span>


</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-mmap-class.cpp -o <span class="org-keyword">unix-mmap-class.bin</span> -std=c++1z -g -Wall -Wextra
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./unix-mmap-class.bin notepad.exe 
 File signature = M Z 0x90 0x0 

 ========= [DOS HEADER] =================
   MAGIC NUMBER = 0x5A4D (hex) 
   MAGIC NUMBER = M Z  (str) 
       e_lfanew = 0xF8 

 ======== [PE - Header] ================
 Note: if machine is 0x8664 =&gt; the processor is AMD-Intel x86-64 

          Signature = 0x4550 
            Machine = 0x8664 
 Number of sections = 7 
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgfc480f9" class="outline-3">
<h3 id="orgfc480f9"><span class="section-number-3">1.22</span> Sockets - TCP/IP and Unix Domain Sockets</h3>
<div class="outline-text-3" id="text-1-22">
</div>
<div id="outline-container-orgb3ba086" class="outline-4">
<h4 id="orgb3ba086"><span class="section-number-4">1.22.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-22-1">
<p>
Sockets are inter process communication mechanism, intruduced by Unix
BSD 4.1 circa 1982, which allows multiple processes running at
different machines to communicate across TCP/IP network.
</p>

<p>
<b>Main Implementations</b>
</p>

<ul class="org-ul">
<li>BSD Sockets =&gt; Pervarsive on Unix-like operating systems: BSD, Linux, MacOSX, &#x2026;.,</li>
<li>Winsocks    =&gt; Microsft Windows only (Windows NT and Windows CE families)</li>
</ul>

<p>
<b>Domain and Connection Type</b>
</p>

<p>
A socket endpoint is defined by its <span class="underline">domain</span> and connection <span class="underline">type</span>. 
</p>

<p>
Most common socket domains:
</p>

<ul class="org-ul">
<li>AF_INET   =&gt; IPv4 - Internet Protocol [Most used]</li>
<li>AF_INET6  =&gt; IPv6 - Intenert Protocol (IPv6)</li>
<li>AF_UNIX   =&gt; Unix Domain socket on local machine [Most used]</li>
</ul>

<p>
Most common connection Types: 
</p>

<ul class="org-ul">
<li>SOCK_STREAM =&gt; <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">TCP</a> - Transmission Control Protocol</li>
<li>SOCK_DGRAM  =&gt; <a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol">UDP</a> - User Datagram Protocol</li>
<li>SOCK_RAW    =&gt; Raw network protocol (Requires root permission)</li>
</ul>

<p>
Socket server or socket client: 
</p>

<ul class="org-ul">
<li>socket client
<ul class="org-ul">
<li>=&gt; Connects to socket server and always starts the
connection. Example: curl; web browser (http client); netcat</li>
</ul></li>

<li>socket server
<ul class="org-ul">
<li>=&gt; Listen some port and waits client connection. It can handle
one or more clients. Example: Http server, nginx, ssh server.</li>
</ul></li>
</ul>

<p>
TCP/IP connection tuple: 
</p>

<ul class="org-ul">
<li>Hostname or IP address (IPv4 or IPv6)
<ul class="org-ul">
<li>0.0.0.0     / address used by a socket server for listening all hosts.</li>
<li>127.0.0.1   / Localhost</li>
<li>'localhost' / Local machine</li>
</ul></li>
<li>Port number: 16 bits number</li>
</ul>

<p>
Common TCP/IP Ports: 
</p>

<ul class="org-ul">
<li>20, 21 - FTP server</li>
<li>22 - SSH server</li>
<li>23 - Telnet (SSH predecessor)</li>
<li>80 - HTTP server</li>
<li>443 - HTTPS (HTTP + SSL/TSL) - Http with SSL encryption</li>
<li>143 - IMAP - Mail</li>
<li>25  - SMTP - Simple Mail Transfer Protocol</li>
<li>More at: <a href="https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers">List of TCP and UDP port numbers</a></li>
</ul>

<p>
<b>Further Reading</b> 
</p>

<ul class="org-ul">
<li><a href="https://pubs.opengroup.org/onlinepubs/009695399/functions/xsh_chap02_10.html">Sockets - Unix Open Group Specification</a></li>

<li><a href="https://en.wikipedia.org/wiki/Berkeley_sockets">Berkeley sockets (BSD Sockets)</a></li>

<li><a href="https://www.networkworld.com/article/3327557/using-the-linux-ss-command-to-examine-network-and-socket-connections.html">Using the Linux ss command to examine network and socket connections</a></li>

<li><a href="http://www.qnx.com/developers/docs/qnx_4.25_docs/tcpip50/prog_guide/sock_ipc_tut.html">QNX - A socket-based IPC tutorial</a></li>

<li><a href="https://devblogs.microsoft.com/commandline/af_unix-comes-to-windows/">AF_UNIX comes to Windows | Windows Command Line / windows socket network</a></li>

<li><a href="https://blog.myhro.info/2017/01/how-fast-are-unix-domain-sockets">How fast are Unix Domain Sockets?</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgf08383d" class="outline-4">
<h4 id="orgf08383d"><span class="section-number-4">1.22.2</span> BSD Socket APIs</h4>
<div class="outline-text-4" id="text-1-22-2">
<p>
Headers: 
</p>
<ul class="org-ul">
<li>#include &lt;sys/types.h&gt;</li>
<li>#include &lt;sys/socket.h&gt;</li>
<li>#include &lt;netdb.h&gt;</li>
</ul>

<p>
Functions for creating and disposing sockets:  
</p>

<ul class="org-ul">
<li><span class="underline">socket()</span>
<ul class="org-ul">
<li>Linux Manpage: "socket() creates an endpoint for communication
and returns a file descriptor that refers to that endpoint.  The
file descriptor returned by a successful call will be the
lowest-numbered file descriptor not currently open for the
process."</li>
<li>Note: returns -1 when an error happens and sets the <span class="underline">errno</span>
thread-local global variable.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">socket</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">domain</span>, <span class="org-type">int</span> <span class="org-variable-name">type</span>, <span class="org-type">int</span> <span class="org-variable-name">protocol</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Usage for TCP/IPv4 </span>
<span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_INET, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-1">)</span>; 
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>sockfd == -1<span class="org-rainbow-delimiters-depth-1">){</span> printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: failed to create a socket connect."</span><span class="org-rainbow-delimiters-depth-2">)</span>; abort<span class="org-rainbow-delimiters-depth-2">()</span>; <span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Usage for UDP/IPv4 </span>
<span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_INET, SOCK_DGRAM, 0<span class="org-rainbow-delimiters-depth-1">)</span>; 

<span class="org-comment-delimiter">// </span><span class="org-comment">Usage for Unix socket with TCP </span>
<span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_UNIX, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Usage for Unix socket with UDP </span>
<span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_UNIX, SOCK_DGRAM, 0<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">close()</span> =&gt; Close file descriptor or socket file descriptor.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">close</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Functions for setting a socket as client-socket: 
</p>

<ul class="org-ul">
<li><span class="underline">connect()</span> =&gt; Connect a client socket to a given address. On error,
(-1) is returned. On success, 0 is returned.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">connect</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">sockaddr</span> *<span class="org-variable-name">addr</span>, <span class="org-type">socklen_t</span> <span class="org-variable-name">addrlen</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Functions for setting a socket as a  server socket.
</p>

<ul class="org-ul">
<li><span class="underline">bind()</span> [SOCKET SERVER] =&gt; Bind a given port for listening income
connections. (used for socket servers)</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">bind</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">sockaddr</span>* <span class="org-variable-name">addr</span>, <span class="org-type">socklen_t</span> <span class="org-variable-name">addrlen</span><span class="org-rainbow-delimiters-depth-1">)</span>;

 <span class="org-keyword">struct</span> <span class="org-type">sockaddr</span> <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">sa_family_t</span> <span class="org-variable-name">sa_family</span>;
     <span class="org-type">char</span>        <span class="org-variable-name">sa_data</span><span class="org-rainbow-delimiters-depth-2">[</span>14<span class="org-rainbow-delimiters-depth-2">]</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<ul class="org-ul">
<li>listen() [SOCKET SERVER]

<ul class="org-ul">
<li>Linux Manpage: "listen() marks the socket referred to by sockfd
as a passive socket, that is, as a socket that will be used to
accept incoming connection requests using accept(2)."</li>

<li>Linux Manpage: "The backlog argument defines the maximum length
to which the queue of pending connections for sockfd may grow.
If a connection request arrives when the queue is full, the
client may receive an error with an indication of ECONNRE‐ FUSED
or, if the underlying protocol supports retransmission, the
request may be ignored so that a later reattempt at connection
succeeds."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">listen</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-type">int</span> <span class="org-variable-name">backlog</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>setsockopt() =&gt; Manipulate socket options.
<ul class="org-ul">
<li>Doc: $ man setsockopt</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">setsockopt</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-type">int</span> <span class="org-variable-name">level</span>, <span class="org-type">int</span> <span class="org-variable-name">optname</span>, <span class="org-keyword">const</span> <span class="org-type">void</span> *<span class="org-variable-name">optval</span>, <span class="org-type">socklen_t</span> <span class="org-variable-name">optlen</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>


<p>
Functions for sending and receiving messages: 
</p>

<ul class="org-ul">
<li>send() =&gt; Send a buffer to a socket.
<ul class="org-ul">
<li>Doc: $ man send</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">ssize_t</span> <span class="org-function-name">send</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-keyword">const</span> <span class="org-type">void</span> *<span class="org-variable-name">buf</span>, <span class="org-type">size_t</span> <span class="org-variable-name">len</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>recv() =&gt; Receive a message from a socket.
<ul class="org-ul">
<li>Doc: $ man recv</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">ssize_t</span> <span class="org-function-name">recv</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">sockfd</span>, <span class="org-type">void</span> *<span class="org-variable-name">buf</span>, <span class="org-type">size_t</span> <span class="org-variable-name">len</span>, <span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Functions for dealing with network address: 
</p>

<ul class="org-ul">
<li>gethostbyname()
<ul class="org-ul">
<li>Translate hostname or IPv4 into IPv4 address. This function
performs a DNS query.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">struct</span> <span class="org-type">hostent</span>*  <span class="org-function-name">gethostbyname</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">struct</span> <span class="org-type">hostent</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">char</span>  *<span class="org-variable-name">h_name</span>;            <span class="org-comment-delimiter">/* </span><span class="org-comment">official name of host</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">char</span> **<span class="org-variable-name">h_aliases</span>;         <span class="org-comment-delimiter">/* </span><span class="org-comment">alias list</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">int</span>    <span class="org-variable-name">h_addrtype</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">host address type</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">int</span>    <span class="org-variable-name">h_length</span>;          <span class="org-comment-delimiter">/* </span><span class="org-comment">length of address</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">char</span> **<span class="org-variable-name">h_addr_list</span>;       <span class="org-comment-delimiter">/* </span><span class="org-comment">list of addresses</span><span class="org-comment-delimiter"> */</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-preprocessor">#define</span> <span class="org-variable-name">h_addr</span> h_addr_list<span class="org-rainbow-delimiters-depth-1">[</span>0<span class="org-rainbow-delimiters-depth-1">]</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">for backward compatibility</span><span class="org-comment-delimiter"> */</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org5d950dc" class="outline-4">
<h4 id="org5d950dc"><span class="section-number-4">1.22.3</span> Simple TCP/IP socket echo server</h4>
<div class="outline-text-4" id="text-1-22-3">
<p>
Description: 
</p>

<ul class="org-ul">
<li>Sample code for a single-thread TCP/IP socket server listening at
port 8095.</li>
</ul>

<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/6337cd80b9eadad26f386320c1c67cc6">https://gist.github.com/6337cd80b9eadad26f386320c1c67cc6</a></li>
</ul>

<p>
File: socket-echo-server.cpp
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">File: socket-echo-server.cpp </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Desc: Simple socket server with a single thread. </span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">memcpy </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/socket.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">netdb.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">-------------  MAIN() ------------------------------//</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program started. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">The port should be a 16 bits number (Note: binding to some low port numbers </span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">requires administrative/root privilege.)</span>
     <span class="org-constant">std</span>::<span class="org-type">uint16_t</span> <span class="org-variable-name">port</span> = 8095;

     <span class="org-comment-delimiter">// </span><span class="org-comment">The address can be: </span>
     <span class="org-comment-delimiter">//   </span><span class="org-comment">'0.0.0.0'   for listening all hosts </span>
     <span class="org-comment-delimiter">//   </span><span class="org-comment">'127.0.0.1' for local host </span>
     <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span> = <span class="org-string">"0.0.0.0"</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">--- Create socket file descriptor -----------------------//</span>

     <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket <span class="org-rainbow-delimiters-depth-2">(</span>  AF_INET       <span class="org-comment-delimiter">// </span><span class="org-comment">domain:   IPv4</span>
                          , SOCK_STREAM   <span class="org-comment-delimiter">// </span><span class="org-comment">type:     TCP </span>
                          , 0             <span class="org-comment-delimiter">// </span><span class="org-comment">protocol: (value 0) </span>
                         <span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-comment-delimiter">// </span><span class="org-comment">Returns (-1) on failure </span>
     assert<span class="org-rainbow-delimiters-depth-2">(</span> sockfd != - 1<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">---------- query address ------------------------------//</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Note: the keyword 'struct' is not necessary here (redundant). </span>
     <span class="org-keyword">struct</span> <span class="org-type">hostent</span>* <span class="org-variable-name">h</span> = gethostbyname<span class="org-rainbow-delimiters-depth-2">(</span>hostname<span class="org-rainbow-delimiters-depth-2">)</span>;
     assert<span class="org-rainbow-delimiters-depth-2">(</span>h != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">sa</span>; 
     <span class="org-comment-delimiter">// </span><span class="org-comment">memset(&amp;sa, 0x00, sizeof(sa));</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">set address </span>
     memcpy<span class="org-rainbow-delimiters-depth-2">(</span>&amp;sa.sin_addr.s_addr, h-&gt;h_addr, h-&gt;h_length<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">//</span><span class="org-comment">bcopy( h-&gt;h_addr, &amp;sa.sin_addr.s_addr, h-&gt;h_length );</span>

     sa.sin_family = AF_INET;
     <span class="org-comment-delimiter">// </span><span class="org-comment">The function htons convert a number to big-endian format. </span>
     sa.sin_port   = htons<span class="org-rainbow-delimiters-depth-2">(</span>port<span class="org-rainbow-delimiters-depth-2">)</span>; 

     <span class="org-comment-delimiter">// </span><span class="org-comment">----- Bind to Port and wait for client connections ---------//</span>

     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> ::bind<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-4">)</span> &amp;sa, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>sa<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to bind socket \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Enables binding to the same address </span>
     <span class="org-type">int</span> <span class="org-variable-name">enable_reuseaddr</span> = 1;
     <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span> setsockopt<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;enable_reuseaddr, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> &lt; 0 <span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to set socket option. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Listening client connection \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-type">int</span> <span class="org-variable-name">backlog</span> = 5;
     assert<span class="org-rainbow-delimiters-depth-2">(</span> listen<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, backlog<span class="org-rainbow-delimiters-depth-3">)</span> != -1 <span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">--------------- Server Main Loop --------------------------//</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Infinite loop where client connections are handled</span>
     <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">true</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>  
         <span class="org-comment-delimiter">/* </span><span class="org-comment">[[ ============== BEGIN client loop =========== ]]</span><span class="org-comment-delimiter"> */</span>

         <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">client_sa</span>; 
         <span class="org-type">socklen_t</span> <span class="org-variable-name">addrlen</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>sockaddr_in<span class="org-rainbow-delimiters-depth-3">)</span>; 

         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [TRACE] Waiting for client connection. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-type">int</span> <span class="org-variable-name">sock_client</span> = accept<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-4">)</span> &amp;client_sa, &amp;addrlen <span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>sock_client == -1<span class="org-rainbow-delimiters-depth-3">)</span>
         <span class="org-rainbow-delimiters-depth-3">{</span>
              fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" Error: failure to handle client socket. Check errno \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
              close<span class="org-rainbow-delimiters-depth-4">(</span>sock_client<span class="org-rainbow-delimiters-depth-4">)</span>;
              <span class="org-keyword">continue</span>;
         <span class="org-rainbow-delimiters-depth-3">}</span>
         <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">welcome_msg</span> = <span class="org-string">"\n =&gt; [INFO] Hello world client side!! \n"</span>;     

         <span class="org-comment-delimiter">// </span><span class="org-comment">Send buffer content to client socket </span>
         send<span class="org-rainbow-delimiters-depth-3">(</span>sock_client, welcome_msg, strlen<span class="org-rainbow-delimiters-depth-4">(</span>welcome_msg<span class="org-rainbow-delimiters-depth-4">)</span>, 0<span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-3">[</span>300<span class="org-rainbow-delimiters-depth-3">]</span>;

         <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">true</span><span class="org-rainbow-delimiters-depth-3">){</span>
             <span class="org-comment-delimiter">// </span><span class="org-comment">Read message from client socket </span>
             <span class="org-type">ssize_t</span> <span class="org-variable-name">n</span> = recv<span class="org-rainbow-delimiters-depth-4">(</span>sock_client, &amp;buffer, 300, 0<span class="org-rainbow-delimiters-depth-4">)</span>;
             <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>n == 0<span class="org-rainbow-delimiters-depth-4">){</span> <span class="org-keyword">break</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

             <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stdout, <span class="org-string">" [INFO] Received: "</span><span class="org-rainbow-delimiters-depth-4">)</span>;            
             ::write<span class="org-rainbow-delimiters-depth-4">(</span>STDOUT_FILENO, buffer, n<span class="org-rainbow-delimiters-depth-4">)</span>;

             <span class="org-comment-delimiter">// </span><span class="org-comment">Send content back </span>
             send<span class="org-rainbow-delimiters-depth-4">(</span>sock_client, buffer, n, 0<span class="org-rainbow-delimiters-depth-4">)</span>;

             <span class="org-comment-delimiter">// </span><span class="org-comment">Compare 4 first bytes of buffer and 'quit' </span>
             <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> strncmp<span class="org-rainbow-delimiters-depth-5">(</span>buffer, <span class="org-string">"quit"</span>, 4<span class="org-rainbow-delimiters-depth-5">)</span> == 0<span class="org-rainbow-delimiters-depth-4">)</span>
             <span class="org-rainbow-delimiters-depth-4">{</span>
                 fprintf<span class="org-rainbow-delimiters-depth-5">(</span>stderr, <span class="org-string">" [TRACE] Shutdown connection. Ok. \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                 <span class="org-comment-delimiter">// </span><span class="org-comment">Close client connection </span>
                 shutdown<span class="org-rainbow-delimiters-depth-5">(</span>sock_client, SHUT_RDWR<span class="org-rainbow-delimiters-depth-5">)</span>;
                 close<span class="org-rainbow-delimiters-depth-5">(</span>sock_client<span class="org-rainbow-delimiters-depth-5">)</span>;
                 <span class="org-keyword">break</span>;
             <span class="org-rainbow-delimiters-depth-4">}</span>          
         <span class="org-rainbow-delimiters-depth-3">}</span>

     <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">[[ ============== END client loop =========== ]]</span><span class="org-comment-delimiter"> */</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Release resource =&gt; RAII (Resource-Acquisition-Is-Initialization) fits here. </span>
     close<span class="org-rainbow-delimiters-depth-2">(</span>sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ socket-echo-server.cpp -o <span class="org-keyword">socket-echo-server.elf</span> -std=c++1z -Wall -Wextra
</pre>
</div>

<p>
Running server: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./socket-echo-server.elf 
 [INFO] Program started. 
 [TRACE] Listening client connection 
 [TRACE] Waiting for client connection. 
c++1z ada spark high performance
c++2z c++20 C++17 c++14 C89 c90 ancient unix
quit
 [TRACE] Shutdown connection. Ok. 
 [TRACE] Waiting for client connection. 

</pre>
</div>

<p>
Running client: (netcat tool)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ nc localhost 8095

 =&gt; [INFO] Hello world client side!! 
c++1z ada spark high performance
c++1z ada spark high performance
c++2z c++20 C++17 c++14 C89 c90 ancient unix
c++2z c++20 C++17 c++14 C89 c90 ancient unix
quit
quit

^C
</pre>
</div>
</div>
</div>
<div id="outline-container-org3b4bf6e" class="outline-4">
<h4 id="org3b4bf6e"><span class="section-number-4">1.22.4</span> Simple Unix-domain socket echo server</h4>
<div class="outline-text-4" id="text-1-22-4">
<p>
GIST:  
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/ac308ab6a4cd8d92f02b4f9baeb910f3">https://gist.github.com/ac308ab6a4cd8d92f02b4f9baeb910f3</a></li>
</ul>

<p>
File: unix-domain-echo-server.cpp
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">File: socket-echo-server.cpp </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Desc: Simple socket server with a single thread. </span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>  <span class="org-comment-delimiter">// </span><span class="org-comment">memcpy </span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----// </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>    
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/socket.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/un.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">-------------  MAIN() ------------------------------//</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program started. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">unix_sock_file</span> = <span class="org-string">"/tmp/unix-socket-file"</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">--- Create socket file descriptor -----------------------//</span>

     <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket <span class="org-rainbow-delimiters-depth-2">(</span>  AF_UNIX, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
     assert<span class="org-rainbow-delimiters-depth-2">(</span> sockfd != - 1<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-keyword">struct</span> <span class="org-type">sockaddr_un</span> <span class="org-variable-name">sa</span>; 
     sa.sun_family = AF_UNIX; 
     strcpy<span class="org-rainbow-delimiters-depth-2">(</span> sa.sun_path, unix_sock_file<span class="org-rainbow-delimiters-depth-2">)</span>;  

     <span class="org-comment-delimiter">// </span><span class="org-comment">Remove file if it exists.   </span>
     unlink<span class="org-rainbow-delimiters-depth-2">(</span>unix_sock_file<span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">----- Bind to unix domain socket and wait for client connections ---------//</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span> ::bind<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-4">)</span> &amp;sa, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>sa<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-type">int</span> <span class="org-variable-name">err</span> = errno; 
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to bind socket \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [ERROR] =&gt; %s"</span>, strerror<span class="org-rainbow-delimiters-depth-4">(</span>err<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;
     <span class="org-rainbow-delimiters-depth-2">}</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Enables binding to the same address </span>
     <span class="org-type">int</span> <span class="org-variable-name">enable_reuseaddr</span> = 1;
     <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span> setsockopt<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;enable_reuseaddr, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> &lt; 0 <span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"Error: unable to set socket option. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> EXIT_FAILURE;
     <span class="org-rainbow-delimiters-depth-2">}</span>


     fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Listening client connection \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-type">int</span> <span class="org-variable-name">backlog</span> = 5;
     assert<span class="org-rainbow-delimiters-depth-2">(</span> listen<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, backlog<span class="org-rainbow-delimiters-depth-3">)</span> != -1 <span class="org-rainbow-delimiters-depth-2">)</span>;

     <span class="org-comment-delimiter">// </span><span class="org-comment">--------------- Server Main Loop --------------------------//</span>

     <span class="org-comment-delimiter">// </span><span class="org-comment">Infinite loop where client connections are handled</span>
     <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">true</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>  
           <span class="org-comment-delimiter">/* </span><span class="org-comment">[[ ============== BEGIN client loop =========== ]]</span><span class="org-comment-delimiter"> */</span>

           <span class="org-keyword">struct</span> <span class="org-type">sockaddr_un</span> <span class="org-variable-name">client_sa</span>; 
           <span class="org-type">socklen_t</span> <span class="org-variable-name">addrlen</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>sockaddr_un<span class="org-rainbow-delimiters-depth-3">)</span>; 

           fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" [TRACE] Waiting for client connection. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
           <span class="org-type">int</span> <span class="org-variable-name">sock_client</span> = accept<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-4">)</span> &amp;client_sa, &amp;addrlen <span class="org-rainbow-delimiters-depth-3">)</span>;

           <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>sock_client == -1<span class="org-rainbow-delimiters-depth-3">)</span>
           <span class="org-rainbow-delimiters-depth-3">{</span>
                   fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" Error: failure to handle client socket. Check errno \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                   close<span class="org-rainbow-delimiters-depth-4">(</span>sock_client<span class="org-rainbow-delimiters-depth-4">)</span>;
                   <span class="org-keyword">continue</span>;
           <span class="org-rainbow-delimiters-depth-3">}</span>
           <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">welcome_msg</span> = <span class="org-string">"\n =&gt; [INFO] Hello world client side!! \n"</span>;       

           <span class="org-comment-delimiter">// </span><span class="org-comment">Send buffer content to client socket </span>
           send<span class="org-rainbow-delimiters-depth-3">(</span>sock_client, welcome_msg, strlen<span class="org-rainbow-delimiters-depth-4">(</span>welcome_msg<span class="org-rainbow-delimiters-depth-4">)</span>, 0<span class="org-rainbow-delimiters-depth-3">)</span>;

           <span class="org-type">char</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-3">[</span>300<span class="org-rainbow-delimiters-depth-3">]</span>;

           <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">true</span><span class="org-rainbow-delimiters-depth-3">){</span>
                 <span class="org-comment-delimiter">// </span><span class="org-comment">Read message from client socket </span>
                 <span class="org-type">ssize_t</span> <span class="org-variable-name">n</span> = recv<span class="org-rainbow-delimiters-depth-4">(</span>sock_client, &amp;buffer, 300, 0<span class="org-rainbow-delimiters-depth-4">)</span>;
                 <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>n == 0<span class="org-rainbow-delimiters-depth-4">){</span> <span class="org-keyword">break</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

                 <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stdout, <span class="org-string">" [INFO] Received: "</span><span class="org-rainbow-delimiters-depth-4">)</span>;            
                 ::write<span class="org-rainbow-delimiters-depth-4">(</span>STDOUT_FILENO, buffer, n<span class="org-rainbow-delimiters-depth-4">)</span>;

                 <span class="org-comment-delimiter">// </span><span class="org-comment">Send content back </span>
                 send<span class="org-rainbow-delimiters-depth-4">(</span>sock_client, buffer, n, 0<span class="org-rainbow-delimiters-depth-4">)</span>;

                 <span class="org-comment-delimiter">// </span><span class="org-comment">Compare 4 first bytes of buffer and 'quit' </span>
                 <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> strncmp<span class="org-rainbow-delimiters-depth-5">(</span>buffer, <span class="org-string">"quit"</span>, 4<span class="org-rainbow-delimiters-depth-5">)</span> == 0<span class="org-rainbow-delimiters-depth-4">)</span>
                 <span class="org-rainbow-delimiters-depth-4">{</span>
                    fprintf<span class="org-rainbow-delimiters-depth-5">(</span>stderr, <span class="org-string">" [TRACE] Shutdown connection. Ok. \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                    <span class="org-comment-delimiter">// </span><span class="org-comment">Close client connection </span>
                    shutdown<span class="org-rainbow-delimiters-depth-5">(</span>sock_client, SHUT_RDWR<span class="org-rainbow-delimiters-depth-5">)</span>;
                    close<span class="org-rainbow-delimiters-depth-5">(</span>sock_client<span class="org-rainbow-delimiters-depth-5">)</span>;
                    <span class="org-keyword">break</span>;
                 <span class="org-rainbow-delimiters-depth-4">}</span>          
         <span class="org-rainbow-delimiters-depth-3">}</span>

   <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">[[ ============== END client loop =========== ]]</span><span class="org-comment-delimiter"> */</span>

   <span class="org-comment-delimiter">// </span><span class="org-comment">Release resource =&gt; RAII (Resource-Acquisition-Is-Initialization) fits here. </span>
   close<span class="org-rainbow-delimiters-depth-2">(</span>sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Build: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ unix-domain-echo-server.cpp -o <span class="org-keyword">unix-domain-echo-server.bin</span> -std=c++1z -Wall -Wextra -g
</pre>
</div>

<p>
Run server: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./unix-domain-echo-server.bin 
 [INFO] Program started. 
 [TRACE] Listening client connection 
 [TRACE] Waiting for client connection. 
unix irix posix linux macosx kernel
c++1z c++14 c++20 ADA spark ADA rust C++ Lisp

quit
 [TRACE] Shutdown connection. Ok. 
 [TRACE] Waiting for client connection. 
</pre>
</div>

<p>
Run client (netcat) : 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ nc -v -U /tmp/unix-socket-file 
<span class="org-function-name">Ncat</span>: Version 7.80 ( https://nmap.org/ncat )
<span class="org-function-name">Ncat</span>: Connected to /tmp/unix-socket-file.

 =&gt; [INFO] Hello world client side!! 
unix irix posix linux macosx kernel
unix irix posix linux macosx kernel
c++1z c++14 c++20 ADA spark ADA rust C++ Lisp
c++1z c++14 c++20 ADA spark ADA rust C++ Lisp


quit
quit
^C
</pre>
</div>

<p>
Check unix-socket file: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ file /tmp/unix-socket-file 
<span class="org-function-name">/tmp/unix-socket-file</span>: socket

$ ls -l /tmp/unix-socket-file 
srwxrwxr-x 1 mxpkf8 mxpkf8 0 Jul  2 01:22 /tmp/unix-socket-file=
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org94d7d42" class="outline-3">
<h3 id="org94d7d42"><span class="section-number-3">1.23</span> Sockets with IO Multiplexing [DRAFT]</h3>
<div class="outline-text-3" id="text-1-23">
</div>
<div id="outline-container-org43694b1" class="outline-4">
<h4 id="org43694b1"><span class="section-number-4">1.23.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-23-1">
<p>
A recurrent need in network socket programming is to handle multiple
incoming client socket connections that need to be managed
simultaneously. For instance, if a blocking read operation is
performed on a client socket from a http(web) server, the server will
not be able to serve the remaining client sockets while the read
operation is ongoing. Several solutions have adopted for solving this
issue, such as: 
</p>

<ul class="org-ul">
<li><span class="underline">Blocking IO (+) One process per connection</span>
<ul class="org-ul">
<li>Peform fork() system call, creating a child process wich is a
copy of current process and let it manage the socket file
descriptor.</li>
<li>Drawbacks: Complex, expensive and slow. A process has lots of operating
system resources associated with it, including virtual memory,
file descriptors and so on. Another issue is the complexity from
IPC - Inter-Process Communication.</li>
</ul></li>

<li><span class="underline">Blockign IO (+) One thread per connection</span>
<ul class="org-ul">
<li>Spawn/create a new thread for every connection.</li>
<li>Drawbacks: Although, this approach is less expensive than
open-process-per-connection method, it is still expensive and
non-scalable, specially for handling thousands of connections.</li>
</ul></li>

<li><span class="underline">Bloking IO (+) Thread Pool</span>
<ul class="org-ul">
<li>Reuse a set of pre-existing threads for managing each
connection and avoid the overhead of creating and destroying too
many threads.</li>
<li>Drawbacks: It only works for non-long running client socket
connections such as HTTP connections that are closed as soon as
possible. The drawback of this method is that it assumption that
any task submited to thread pool will finish as soon as possible
and not block the worker thread, otherwise, it will be
unusable. The asummption implies that the connection should be
closed as fast as possible, which means that the thread-pool
approach is only suitable for HTTP servers which usually close
the client socket connection after every request.</li>
</ul></li>

<li><span class="underline">Multiplexed IO</span> [BEST]
<ul class="org-ul">
<li>Many operating systems provide multiplexed IO facilities, such
as <span class="underline">select</span>, <span class="underline">poll</span> and <span class="underline">epoll</span> on Linux, <span class="underline">keque</span> on BSD-variants and
Mac-OSX and <span class="underline">IOCP</span> on Windows. Multiplexed IO allow managing
multiple file descriptors of any type in a single thread,
consequently this feature allows handling multiple client
socket connetions with far less overhead than using one thread
for every connection. This type IO API is that makes the
scalability of Nginx web server and NodeJS.</li>

<li>Multiplexed IO works in the following way: first the
application register the file descriptors it is interested in
monitoring; then the calling code calls a multiplexed IO
function that blocks the current thread during some amount of
time or indefinitely, the IO multiplexing function only
returns when any of the file descriptors are ready to be read
or written. The calling code handles each file descriptor by
iterating over the data structure returned by the IO
multiplexing function which contains the file descriptors
events.</li>

<li>Drawbacks:
<ul class="org-ul">
<li>Event-driven with possible callback hell which can be avoided
with <span class="underline">user-space threads</span> (aka: coroutines, goroutines, green
threads).</li>
<li>Any operation which takes a significant time needs to be run
in another thread, otherwise the threads handling the
connection will be blocked and unable to server any other
client request.</li>
</ul></li>

<li>Wrappers:
<ul class="org-ul">
<li>Multiplexed IO APIs are not standardized. As a result,
several high level wrappers have been created for providing
an uniform and cross-platform API for multiplexed IO. Some of
those wrapper libraries are:
<ul class="org-ul">
<li><i>Boost.ASIO</i> - C++ library for scalable and cross-platform network programming.</li>
<li><i>libUV</i>      - C library used by NodeJS; Julia language and so on.</li>
<li><i>libev</i></li>
<li><i>libEvent</i></li>
</ul></li>
</ul></li>

<li>Note: Many documents also calls multiplexed IO as <span class="underline">event-driven</span>
<span class="underline">IO</span>, <span class="underline">non-blocking IO</span> and so on.</li>

<li>Note: The EPool API cannot monitor file descriptors of regular
files. For this case, the Linux kernel provides the <span class="underline">iNotify</span> API.</li>
</ul></li>
</ul>

<p>
See: 
</p>

<ul class="org-ul">
<li><a href="https://eklitzke.org/blocking-io-nonblocking-io-and-epoll">Blocking I/O, Nonblocking I/O, And Epoll</a></li>

<li><a href="https://medium.com/@copyconstruct/the-method-to-epolls-madness-d9d2d6378642">The method to epoll’s madness. My previous post covered the… | by Cindy Sridharan | Medium</a></li>
</ul>
</div>
</div>

<div id="outline-container-org0f196f9" class="outline-4">
<h4 id="org0f196f9"><span class="section-number-4">1.23.2</span> Epoll() multiplexed IO API</h4>
<div class="outline-text-4" id="text-1-23-2">
<p>
Epoll is a highly scalable and efficient Linux-only multiplexed IO API
which allows monitoring an unlimted amount of file descriptors, and
consequentely file descriptors related to regular files, device files
and sockets. This API is that makes the scalability of NodeJS and
Nginx web server possible. 
</p>

<p>
Manpage: 
</p>
<ul class="org-ul">
<li><a href="https://man7.org/linux/man-pages/man2/epoll_create.2.html">epoll_create()</a></li>
<li><a href="https://man7.org/linux/man-pages/man2/epoll_ctl.2.html">epoll_ctl()</a></li>
</ul>

<p>
Header file: 
</p>
<ul class="org-ul">
<li>#include &lt;sys/epoll.h&gt;</li>
</ul>

<p>
Structs: 
</p>

<ul class="org-ul">
<li>The events is a Or bitmaks, some of the flags are:
<ul class="org-ul">
<li>EPOLLIN  =&gt; "The associated file is available for read(2) operations."</li>
<li>EPOLLOUT =&gt; "The associated file is available for write(2) operations."</li>
<li>EPOLLHUP =&gt; "Hang up happened on the associated file descriptor."</li>
<li>EPOLLET =&gt; "Requests edge-triggered notification for the
associated file descriptor.  The default behavior for epoll is
level-triggered.  See epoll(7) for more detailed information
about edge triggered and level-triggered notification."</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">typedef</span> <span class="org-keyword">union</span> <span class="org-type">epoll_data</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">void</span>        *<span class="org-variable-name">ptr</span>;
    <span class="org-type">int</span>          <span class="org-variable-name">fd</span>;
    <span class="org-type">uint32_t</span>     <span class="org-variable-name">u32</span>;
    <span class="org-type">uint64_t</span>     <span class="org-variable-name">u64</span>;
<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-type">epoll_data_t</span>;

<span class="org-keyword">struct</span> <span class="org-type">epoll_event</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">uint32_t</span>     <span class="org-variable-name">events</span>;      <span class="org-comment-delimiter">/* </span><span class="org-comment">Epoll events</span><span class="org-comment-delimiter"> */</span>
    <span class="org-type">epoll_data_t</span> <span class="org-variable-name">data</span>;        <span class="org-comment-delimiter">/* </span><span class="org-comment">User data variable</span><span class="org-comment-delimiter"> */</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Functions: 
</p>

<ul class="org-ul">
<li><span class="underline">epoll_create1(int)</span> =&gt; Creates epoll object, returns epoll file descriptor.
<ul class="org-ul">
<li>"If flags is 0, then, other than the fact that the obsolete size
argument is dropped, epoll_create1() is the same as
epoll_create().  The following value can be included in flags to
obtain different behavior:"</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"> <span class="org-type">int</span> <span class="org-function-name">epoll_create1</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">flags</span><span class="org-rainbow-delimiters-depth-1">)</span>;

 <span class="org-comment-delimiter">// </span><span class="org-comment">------ Usage ---------------------//</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">Epoll file descriptor </span>
 <span class="org-type">int</span> <span class="org-variable-name">epfd</span>; 
 <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> <span class="org-rainbow-delimiters-depth-2">(</span>epfd = epoll_create1<span class="org-rainbow-delimiters-depth-3">(</span>0<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span> == -1 <span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">{</span> 
    perror<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Unable to get epoll file descriptor. Check ERRNO variable."</span><span class="org-rainbow-delimiters-depth-2">)</span>; 
    exit<span class="org-rainbow-delimiters-depth-2">(</span>1<span class="org-rainbow-delimiters-depth-2">)</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">.... Use Epoll ....</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Close when no longer needed. </span>
close<span class="org-rainbow-delimiters-depth-1">(</span>epfd<span class="org-rainbow-delimiters-depth-1">)</span>; 
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">epoll_ctl()</span> =&gt; Modify, remove or add file descriptors to the
<i>interest list</i>, set of monitored file descriptors.
<ul class="org-ul">
<li>Doc: $ man epoll_ctl</li>
<li>Doc: <a href="https://man7.org/linux/man-pages/man2/epoll_ctl.2.html">Manpage</a></li>

<li>Some values of 'op':</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">epoll_ctl</span><span class="org-rainbow-delimiters-depth-1">(</span>  <span class="org-type">int</span> <span class="org-variable-name">epfd</span>                     <span class="org-comment-delimiter">// </span><span class="org-comment">Epoll file descriptor (Epoll object)</span>
              , <span class="org-type">int</span> <span class="org-variable-name">op</span>                       <span class="org-comment-delimiter">// </span><span class="org-comment">Operation to be performed </span>
              , <span class="org-type">int</span> <span class="org-variable-name">fd</span>                       <span class="org-comment-delimiter">// </span><span class="org-comment">File descritor </span>
              , <span class="org-keyword">struct</span> <span class="org-type">epoll_event</span> *<span class="org-variable-name">event</span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to epoll_event </span>
             <span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------//</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Usage example for registering file descriptor     //</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">add file descriptor to interest list.             // </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">--------------------------------------------------//</span>

<span class="org-type">int</span> <span class="org-variable-name">fd</span> = STDIN_FILENO; <span class="org-comment-delimiter">// </span><span class="org-comment">Stdin, console </span>
<span class="org-type">epoll_event</span> <span class="org-variable-name">ev</span>; 
<span class="org-comment-delimiter">// </span><span class="org-comment">Monitor when file descriptor is available for read operations.</span>
ev.events  = EPOLLIN;
<span class="org-comment-delimiter">// </span><span class="org-comment">Monitor when file descriptor is available for write operations.</span>
ev.events  = EPOLLIN | EPOLLOUT;
ev.data.fd = fd; 
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> epoll_ctrl<span class="org-rainbow-delimiters-depth-2">(</span>epfd, EPOLL_CTL_ADD, fd, &amp;ev <span class="org-rainbow-delimiters-depth-2">)</span> == -1 <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>  perror<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: failure. Check errno."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   exit<span class="org-rainbow-delimiters-depth-2">(</span>1<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">//</span><span class="org-comment">---------------------------------------------------//</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Usage example for removing file descriptor        //</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">--------------------------------------------------//</span>
<span class="org-type">epoll_event</span> <span class="org-variable-name">ev</span>; 
ev.events  = EPOLLIN;
ev.data.fd = fd; 
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span> epoll_ctrl<span class="org-rainbow-delimiters-depth-2">(</span>epfd, EPOLL_CTL_DEL, fd,  <span class="org-rainbow-delimiters-depth-2">)</span> == -1 <span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>  perror<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: failure. Check errno."</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   exit<span class="org-rainbow-delimiters-depth-2">(</span>1<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<ul class="org-ul">
<li><span class="underline">epoll_wait()</span> - IO multiplexing function - blocks the current
thread for some amount of time until an event related to a
monitored file descriptor has happened.
<ul class="org-ul">
<li>Manpage: "wait for an I/O event on an epoll file descriptor"</li>

<li><i>epfd</i> =&gt; Epoll file descriptor</li>

<li><i>events</i> =&gt; (Output) Pointer to array containing the events
related to the monitored file descriptors. This array is
allocated by the calling code.</li>

<li><i>maxevents</i> =&gt; Maximum number of monitored events (often the size
of events array).</li>

<li><i>timeout</i> =&gt; Number of milliseconds that epoll_wait() blocks the
current thread. If this value is (-1), the calling thread is
indefinitely until some IO event happens.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">int</span> <span class="org-function-name">epoll_wait</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">epfd</span>, <span class="org-keyword">struct</span> <span class="org-type">epoll_event</span> *<span class="org-variable-name">events</span>,
               <span class="org-type">int</span> <span class="org-variable-name">maxevents</span>, <span class="org-type">int</span> <span class="org-variable-name">timeout</span><span class="org-rainbow-delimiters-depth-1">)</span>; 
</pre>
</div>

<p>
Usage example of epoll_wait() with level triggered.
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">============ Usage for servers ===================// </span>
<span class="org-comment-delimiter">// </span>
<span class="org-type">void</span> <span class="org-function-name">Epoll_fd_option</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">epoll_fd</span>, <span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">int</span> <span class="org-variable-name">events</span><span class="org-rainbow-delimiters-depth-1">)</span>
 <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">epoll_event</span> <span class="org-variable-name">ev</span>; 
     ev.events  = events;
     ev.data.fd = fd; 
     <span class="org-type">int</span> <span class="org-variable-name">res</span> = epoll_ctl<span class="org-rainbow-delimiters-depth-2">(</span>epoll_fd, EPOLL_CTL_ADD, fd, &amp;ev<span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>res == -1<span class="org-rainbow-delimiters-depth-2">){</span>
         perror<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: EPoll / unable to register file descritor"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>    
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">MAX_EVENTS</span> = 10;     
<span class="org-type">int</span> <span class="org-variable-name">server</span> = socket<span class="org-rainbow-delimiters-depth-1">(</span>AF_INET, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-1">)</span>;
 .. .... ... ...

<span class="org-comment-delimiter">// </span><span class="org-comment">Create epoll object </span>
<span class="org-type">int</span> epfd = epoll_create1<span class="org-rainbow-delimiters-depth-1">(</span>0<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">epoll_event</span> <span class="org-variable-name">notifications</span><span class="org-rainbow-delimiters-depth-1">[</span>MAX_EVENTS<span class="org-rainbow-delimiters-depth-1">]</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Monitor incoming connections </span>
Epoll_fd_option<span class="org-rainbow-delimiters-depth-1">(</span>epfd, server, EPOLLIN<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Monitor stdin (console file descriptor)</span>
Epoll_fd_option<span class="org-rainbow-delimiters-depth-1">(</span>epfd, STDIN_FILENO, EPOLLIN<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">charr</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-1">[</span>300<span class="org-rainbow-delimiters-depth-1">]</span>;

<span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-1">(</span>;;<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Current thread blocked until any event happens.</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Returns number of evetns </span>
     <span class="org-type">int</span> <span class="org-variable-name">nfsd</span> = epoll_wait<span class="org-rainbow-delimiters-depth-2">(</span>epfd, notifications, MAX_EVENTS, -1<span class="org-rainbow-delimiters-depth-2">)</span>; 

     <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; nfsd; i++<span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-type">epoll_event</span> <span class="org-variable-name">ev</span> = notifications<span class="org-rainbow-delimiters-depth-3">[</span>i<span class="org-rainbow-delimiters-depth-3">]</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>ev.data.fd == server<span class="org-rainbow-delimiters-depth-3">)</span>
         <span class="org-rainbow-delimiters-depth-3">{</span>
              <span class="org-comment-delimiter">// </span><span class="org-comment">Accept connection return a client socket </span>
              <span class="org-type">int</span> <span class="org-variable-name">client_fd</span> = accept<span class="org-rainbow-delimiters-depth-4">(</span>server, <span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-5">)</span> &amp;client.sa, &amp;addrlen<span class="org-rainbow-delimiters-depth-4">)</span>;
              Epoll_fd_option<span class="org-rainbow-delimiters-depth-4">(</span>epfdm, client_fd, EPOLLIN<span class="org-rainbow-delimiters-depth-4">)</span>;
              <span class="org-keyword">continue</span>;
         <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Client socket ready for reading operations.</span>
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>ev.events &amp; EPOLLIN<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">Read 300 bytes from client socket file descriptor to buffer </span>
            <span class="org-type">int</span> <span class="org-variable-name">n</span> = read<span class="org-rainbow-delimiters-depth-4">(</span>ev.dada.fd, buffer, 300<span class="org-rainbow-delimiters-depth-4">)</span>;

            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>n == 0<span class="org-rainbow-delimiters-depth-4">){</span> close<span class="org-rainbow-delimiters-depth-5">(</span>ev.data.fd<span class="org-rainbow-delimiters-depth-5">)</span>; <span class="org-keyword">continue</span>; <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">Send back n bytes to client socket </span>
            write<span class="org-rainbow-delimiters-depth-4">(</span>ev.data.fd, buffer, n<span class="org-rainbow-delimiters-depth-4">)</span>;
            <span class="org-keyword">continue</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>

        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>ev.events &amp; EPOLLOUT<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span> 
           <span class="org-comment-delimiter">// </span><span class="org-comment">Perform write operations </span>
           ... ... .... ...                 
        <span class="org-rainbow-delimiters-depth-3">}</span>

     <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End for --- //</span>

<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End for --- //</span>

close<span class="org-rainbow-delimiters-depth-1">(</span>epfd<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-org78a897f" class="outline-4">
<h4 id="org78a897f"><span class="section-number-4">1.23.3</span> Epoll() example - sample code</h4>
<div class="outline-text-4" id="text-1-23-3">
<p>
GIST: 
</p>
<ul class="org-ul">
<li><a href="https://gist.github.com/f88892ac263b96ba9d989c582dc3ccf1">https://gist.github.com/f88892ac263b96ba9d989c582dc3ccf1</a></li>
</ul>

<p>
Description: 
</p>
<ul class="org-ul">
<li>Sample TCP/IPv4 network server using epoll() multiplexed IO API
for managing STDIN (console input) and multiple client sockets in
a single thread. The server also sends any message typed in server
console to all connected clients.</li>
<li>Note: It uses level triggered IO.</li>
</ul>

<p>
File: multiplex-epoll-server.cpp 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">File: socket-echo-server.cpp</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Desc: Simple socket server with a single thread.</span>

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">memcpy</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----- Unix/Linux headers -----//</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">unistd.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">fcntl.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/types.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/socket.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">netdb.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">signal.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Only available on Linux</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">sys/epoll.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-keyword">struct</span> <span class="org-type">Socket</span> 
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span>           <span class="org-variable-name">sockfd</span>; 
    <span class="org-type">sockaddr_in</span>   <span class="org-variable-name">sa</span>;     
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">struct</span> <span class="org-type">RecvMsg</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">ssize_t</span>     <span class="org-variable-name">size</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">msg</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">void</span> <span class="org-function-name">socket_close</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Socket</span>&amp; <span class="org-variable-name">sock</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">void</span>    <span class="org-function-name">fd_write</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">text</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">RecvMsg</span> <span class="org-function-name">fd_read</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">size_t</span> <span class="org-variable-name">buffer_max</span> = 500<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-doc">/** Make a server socket */</span>
<span class="org-type">Socket</span> <span class="org-function-name">socket_make_server</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">uint16_t</span> <span class="org-variable-name">port</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span> = <span class="org-string">"0.0.0.0"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-doc">/** Accept connetion from a server socket and returns a client socket */</span>
<span class="org-type">Socket</span> <span class="org-function-name">socket_accept</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Socket</span>&amp; <span class="org-variable-name">server</span><span class="org-rainbow-delimiters-depth-1">)</span>; 

<span class="org-doc">/** Register file descriptor to be monitored by Epoll */</span>
<span class="org-type">void</span> <span class="org-function-name">Epoll_register_fd</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">epoll_fd</span>, <span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">epoll_event</span> <span class="org-variable-name">ev</span>; 
    ev.events  = EPOLLIN;
    ev.data.fd = fd; 
    <span class="org-type">int</span> <span class="org-variable-name">res</span> = epoll_ctl<span class="org-rainbow-delimiters-depth-2">(</span>epoll_fd, EPOLL_CTL_ADD, fd, &amp;ev<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>res == -1<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: EPoll / unable to register file descritor"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>    
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-doc">/** Remove file descriptor from monitoring list. */</span>
<span class="org-type">void</span> <span class="org-function-name">Epoll_remove_fd</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">epoll_fd</span>, <span class="org-type">int</span> <span class="org-variable-name">fd</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">epoll_event</span> <span class="org-variable-name">ev</span>;
    <span class="org-type">int</span> <span class="org-variable-name">res</span> = epoll_ctl<span class="org-rainbow-delimiters-depth-2">(</span>epoll_fd, EPOLL_CTL_DEL, fd, &amp;ev<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/*  </span><span class="org-comment">Multiplex IO - Blocks current thread until any of monitored file descriptors </span>
<span class="org-comment"> *  has </span>
<span class="org-comment-delimiter"> */</span>
<span class="org-type">int</span> <span class="org-function-name">Epoll_wait</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">epoll_fd</span>, <span class="org-type">size_t</span> <span class="org-variable-name">max_events</span>, <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">epoll_event</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>&amp; <span class="org-variable-name">events</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns number of events received </span>
    <span class="org-type">int</span> <span class="org-variable-name">nfd</span> = epoll_wait<span class="org-rainbow-delimiters-depth-2">(</span> epoll_fd     <span class="org-comment-delimiter">// </span><span class="org-comment">Epoll file descripotr </span>
                        , &amp;events<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">[output] Array containing received events </span>
                        , max_events   <span class="org-comment-delimiter">// </span><span class="org-comment">Maximum number of events </span>
                        , -1           <span class="org-comment-delimiter">// </span><span class="org-comment">Timeout (-1) =&gt; Block indefinitely</span>
                        <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> nfd;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span> **<span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">" [INFO] Program started. "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">--- Create socket file descriptor -----------------------//</span>
    <span class="org-type">Socket</span> <span class="org-variable-name">server</span> = socket_make_server<span class="org-rainbow-delimiters-depth-2">(</span>9026, <span class="org-string">"0.0.0.0"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">constexpr</span> <span class="org-type">size_t</span> <span class="org-variable-name">MAX_EVENTS</span> = 10;     
    <span class="org-type">int</span> <span class="org-variable-name">epfd</span> = epoll_create1<span class="org-rainbow-delimiters-depth-2">(</span>0<span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span>epfd != - 1<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">events</span> = <span class="org-constant">std</span>::vector<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">epoll_event</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>MAX_EVENTS<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Register stdin </span>
    Epoll_register_fd<span class="org-rainbow-delimiters-depth-2">(</span>epfd, STDIN_FILENO<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Register socket server </span>
    Epoll_register_fd<span class="org-rainbow-delimiters-depth-2">(</span>epfd, server.sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Contains client sockets file descriptors </span>
    <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Socket</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">clients</span>; 


    <span class="org-comment-delimiter">// </span><span class="org-comment">Server-accept infinite loop </span>
    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [TRACE] Epoll waiting for events \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-type">int</span> <span class="org-variable-name">nfsd</span> = Epoll_wait<span class="org-rainbow-delimiters-depth-3">(</span>epfd, MAX_EVENTS, events<span class="org-rainbow-delimiters-depth-3">)</span>;            
        assert<span class="org-rainbow-delimiters-depth-3">(</span> nfsd != - 1<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">" [TRACE] Epoll events arrived =&gt; nfsd = %d \n"</span>, nfsd<span class="org-rainbow-delimiters-depth-3">)</span>;

        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = 0; i &lt; nfsd; i++<span class="org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-3">{</span>
            <span class="org-keyword">auto</span> <span class="org-variable-name">ev</span> = events<span class="org-rainbow-delimiters-depth-4">[</span>i<span class="org-rainbow-delimiters-depth-4">]</span>;

            <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">" ----------------------------------------------------\n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;

            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> <span class="org-rainbow-delimiters-depth-5">(</span>ev.events &amp; EPOLLERR<span class="org-rainbow-delimiters-depth-5">)</span> || <span class="org-rainbow-delimiters-depth-5">(</span>ev.events &amp; EPOLLHUP<span class="org-rainbow-delimiters-depth-5">)</span> <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">" [ERROR] Epoll error has happened. \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-keyword">continue</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">STDIN event =&gt; It happens after user types something and</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">hit RETURN on terminal.</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span> ev.data.fd == STDIN_FILENO <span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>
                <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">" [TRACE] Received STDIN event \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">line</span>;
                <span class="org-constant">std</span>::getline<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-constant">std</span>::cin, line<span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" \n STDIN = "</span> + line &lt;&lt; <span class="org-string">"\n"</span>;

                <span class="org-comment-delimiter">// </span><span class="org-comment">Send typed message to all client sockets</span>
                <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-5">(</span><span class="org-type">Socket</span>&amp; <span class="org-variable-name">cli</span>: clients<span class="org-rainbow-delimiters-depth-5">)</span>
                    fd_write<span class="org-rainbow-delimiters-depth-5">(</span>cli.sockfd, <span class="org-string">" STDIN = "</span> + line + <span class="org-string">"\n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;

                <span class="org-comment-delimiter">// </span><span class="org-comment">Quit server </span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span>line == <span class="org-string">"exit"</span><span class="org-rainbow-delimiters-depth-5">){</span> 
                    <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">" [INFO] Shutdown server OK."</span><span class="org-rainbow-delimiters-depth-6">)</span>;
                    <span class="org-keyword">return</span> EXIT_SUCCESS;
                <span class="org-rainbow-delimiters-depth-5">}</span>
                <span class="org-keyword">continue</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">Event that happens when there is a new connection.</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>ev.data.fd == server.sockfd<span class="org-rainbow-delimiters-depth-4">)</span>
            <span class="org-rainbow-delimiters-depth-4">{</span>                
                <span class="org-type">Socket</span> <span class="org-variable-name">client</span> = socket_accept<span class="org-rainbow-delimiters-depth-5">(</span>server<span class="org-rainbow-delimiters-depth-5">)</span>;        
                Epoll_register_fd<span class="org-rainbow-delimiters-depth-5">(</span>epfd, client.sockfd<span class="org-rainbow-delimiters-depth-5">)</span>;

                <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">" [TRACE] Accept client connection =&gt; ID = %d \n"</span>, client.sockfd<span class="org-rainbow-delimiters-depth-5">)</span>;                
                fd_write<span class="org-rainbow-delimiters-depth-5">(</span>client.sockfd,  <span class="org-string">"\n =&gt; [SERVER INFO] Hello world client side!! \n"</span><span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-comment-delimiter">// </span><span class="org-comment">socket_nonblock(client);</span>
                clients.push_back<span class="org-rainbow-delimiters-depth-5">(</span>client<span class="org-rainbow-delimiters-depth-5">)</span>;
                <span class="org-keyword">continue</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">Event that happens when some client socket sends data. </span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">EPOLIN event means that the file descriptor is ready for input. </span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-4">(</span>ev.events &amp; EPOLLIN<span class="org-rainbow-delimiters-depth-4">)</span>            
            <span class="org-rainbow-delimiters-depth-4">{</span>
               <span class="org-type">int</span> <span class="org-variable-name">fd</span> = ev.data.fd;
               <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"\n [TRACE] Receive client event =&gt; ID = %d \n"</span>, fd<span class="org-rainbow-delimiters-depth-5">)</span>;
               <span class="org-type">RecvMsg</span> <span class="org-variable-name">resp</span> = fd_read<span class="org-rainbow-delimiters-depth-5">(</span>fd, 500<span class="org-rainbow-delimiters-depth-5">)</span>;                                             
               <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-5">(</span>resp.size == 0<span class="org-rainbow-delimiters-depth-5">)</span>
               <span class="org-rainbow-delimiters-depth-5">{</span>
                   <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-6">(</span><span class="org-string">"\n [CLIENT ID = %d] =&gt;&gt; Disconnected from server. \n"</span>, fd<span class="org-rainbow-delimiters-depth-6">)</span>;
                   close<span class="org-rainbow-delimiters-depth-6">(</span>fd<span class="org-rainbow-delimiters-depth-6">)</span>;
                   <span class="org-keyword">continue</span>;
               <span class="org-rainbow-delimiters-depth-5">}</span>
               <span class="org-constant">std</span>::printf<span class="org-rainbow-delimiters-depth-5">(</span><span class="org-string">"\n [CLIENT ID = %d] =&gt;&gt; size = %d ; msg = %s \n"</span>, fd, resp.size, resp.msg.c_str<span class="org-rainbow-delimiters-depth-6">()</span><span class="org-rainbow-delimiters-depth-5">)</span>;
               fd_write<span class="org-rainbow-delimiters-depth-5">(</span>fd, <span class="org-string">" [SERVER ECHO] =&gt; ID = "</span> + <span class="org-constant">std</span>::to_string<span class="org-rainbow-delimiters-depth-6">(</span>fd<span class="org-rainbow-delimiters-depth-6">)</span> + <span class="org-string">" =&gt; "</span> + resp.msg<span class="org-rainbow-delimiters-depth-5">)</span>;
            <span class="org-rainbow-delimiters-depth-4">}</span>

        <span class="org-rainbow-delimiters-depth-3">}</span>


    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">[[ ============== END client loop =========== ]]</span><span class="org-comment-delimiter"> */</span>

    socket_close<span class="org-rainbow-delimiters-depth-2">(</span>server<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> 0;

<span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- End of main() -------------//</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">----------- Function Implementations ----------------------------------------//</span>

<span class="org-type">void</span> 
<span class="org-function-name">socket_close</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Socket</span>&amp; <span class="org-variable-name">sock</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    ::close<span class="org-rainbow-delimiters-depth-2">(</span>sock.sockfd<span class="org-rainbow-delimiters-depth-2">)</span>;
    sock.sockfd = -1;    
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">void</span> <span class="org-function-name">fd_write</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">const</span>&amp; <span class="org-variable-name">text</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    ::write<span class="org-rainbow-delimiters-depth-2">(</span>fd, text.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, text.size<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">RecvMsg</span> <span class="org-function-name">fd_read</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">fd</span>, <span class="org-type">size_t</span> <span class="org-variable-name">buffer_max</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">buffer</span><span class="org-rainbow-delimiters-depth-2">(</span>buffer_max, 0x00<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">ssize_t</span> <span class="org-variable-name">n</span> = read<span class="org-rainbow-delimiters-depth-2">(</span>fd, &amp;buffer<span class="org-rainbow-delimiters-depth-3">[</span>0<span class="org-rainbow-delimiters-depth-3">]</span>, buffer_max<span class="org-rainbow-delimiters-depth-2">)</span>;
    buffer.resize<span class="org-rainbow-delimiters-depth-2">(</span>n<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> RecvMsg<span class="org-rainbow-delimiters-depth-2">{</span>n, buffer<span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-type">Socket</span> 
<span class="org-function-name">socket_make_server</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">uint16_t</span> <span class="org-variable-name">port</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">hostname</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">int</span> <span class="org-variable-name">sockfd</span> = socket<span class="org-rainbow-delimiters-depth-2">(</span>AF_INET, SOCK_STREAM, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Returns (-1) on failure</span>
    assert<span class="org-rainbow-delimiters-depth-2">(</span>sockfd != -1<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">---------- query address ------------------------------//</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: the keyword 'struct' is not necessary here (redundant).</span>
    <span class="org-keyword">struct</span> <span class="org-type">hostent</span> *<span class="org-variable-name">h</span> = gethostbyname<span class="org-rainbow-delimiters-depth-2">(</span>hostname<span class="org-rainbow-delimiters-depth-2">)</span>;
    assert<span class="org-rainbow-delimiters-depth-2">(</span>h != <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">struct</span> <span class="org-type">sockaddr_in</span> <span class="org-variable-name">sa</span>;
    memcpy<span class="org-rainbow-delimiters-depth-2">(</span>&amp;sa.sin_addr.s_addr, h-&gt;h_addr, h-&gt;h_length<span class="org-rainbow-delimiters-depth-2">)</span>;
    sa.sin_family = AF_INET;
    <span class="org-comment-delimiter">// </span><span class="org-comment">The function htons convert a number to big-endian format.</span>
    sa.sin_port = htons<span class="org-rainbow-delimiters-depth-2">(</span>port<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">----- Bind to Port and wait for client connections ---------//</span>
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>::bind<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, <span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-4">)</span>&amp;sa, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span>sa<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> == -1<span class="org-rainbow-delimiters-depth-2">)</span>            
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: unable to bind socket \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;


    <span class="org-comment-delimiter">// </span><span class="org-comment">Enables binding to the same address</span>
    <span class="org-type">int</span> <span class="org-variable-name">enable_reuseaddr</span> = 1;
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>setsockopt<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;enable_reuseaddr, <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> &lt; 0<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Error: unable to set socket option. \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Ignore SIGPIPE signal which would cause abnormal termination of socket server</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Requires: #include &lt;signal.h&gt; header.</span>
    signal<span class="org-rainbow-delimiters-depth-2">(</span>SIGPIPE, SIG_IGN<span class="org-rainbow-delimiters-depth-2">)</span>;

    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] Listening client connection \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">int</span> <span class="org-variable-name">backlog</span> = 5;
    assert<span class="org-rainbow-delimiters-depth-2">(</span>listen<span class="org-rainbow-delimiters-depth-3">(</span>sockfd, backlog<span class="org-rainbow-delimiters-depth-3">)</span> != -1<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> Socket<span class="org-rainbow-delimiters-depth-2">{</span> sockfd, sa <span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">Socket</span> 
<span class="org-function-name">socket_accept</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Socket</span>&amp; <span class="org-variable-name">server</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">Socket</span> <span class="org-variable-name">client</span>;
    <span class="org-type">socklen_t</span> <span class="org-variable-name">addrlen</span> = <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-2">(</span>sockaddr_in<span class="org-rainbow-delimiters-depth-2">)</span>;
    client.sockfd = accept<span class="org-rainbow-delimiters-depth-2">(</span>server.sockfd, <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">sockaddr</span> *<span class="org-rainbow-delimiters-depth-3">)</span> &amp;client.sa, &amp;addrlen<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>client.sockfd == -1<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
        fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">" Error: failure to handle client socket. Check errno \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        close<span class="org-rainbow-delimiters-depth-3">(</span>client.sockfd<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">return</span> client;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">g++ multiplex-epoll-server.cpp -o <span class="org-keyword">out.bin</span> -std=c++1z -Wall -Wextra 
</pre>
</div>

<p>
Running: (Server - terminal 1)
</p>

<div class="org-src-container">
<pre class="src src-sh"> ./out.bin 

 [INFO] Program started. 
 [TRACE] Listening client connection 
 [TRACE] Epoll waiting for events 
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------
 [TRACE] Accept client connection =&gt; ID = 7 
 [TRACE] Epoll waiting for events 
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------

 [TRACE] Receive client event =&gt; ID = 7 

 [CLIENT ID = 7] =&gt;&gt; size = 19 ; msg = hello world server

 [TRACE] Epoll waiting for events 
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------
 [TRACE] Accept client connection =&gt; ID = 8 
 [TRACE] Epoll waiting for events 
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------

 [TRACE] Receive client event =&gt; ID = 8 

 [CLIENT ID = 8] =&gt;&gt; size = 30 ; msg = connect server from client 2 

 [TRACE] Epoll waiting for events 
message typed<span class="org-keyword"> in</span> stdin is sent to all client sockets.
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------
 [TRACE] Received STDIN event 

 STDIN = message typed<span class="org-keyword"> in</span> stdin is sent to all client sockets.
 [TRACE] Epoll waiting for events 
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------

 [TRACE] Receive client event =&gt; ID = 8 

 [CLIENT ID = 8] =&gt;&gt; size = 24 ; msg = from client 2 to server

 [TRACE] Epoll waiting for events 
 [TRACE] Epoll events arrived =&gt; nfsd = 1 
 ----------------------------------------------------
</pre>
</div>

<p>
Running: (Client 1 netcat from terminal 2)
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ &gt;&gt; nc -v localhost 9026
<span class="org-function-name">Ncat</span>: Version 7.80 ( https://nmap.org/ncat )
<span class="org-function-name">Ncat</span>: Connection to ::1 failed: Connection refused.
<span class="org-function-name">Ncat</span>: Trying next address...
<span class="org-function-name">Ncat</span>: Connected to 127.0.0.1:9026.

 =&gt; [SERVER INFO] Hello world client side!! 
hello world server
 [SERVER ECHO] =&gt; ID = 7 =&gt; hello world server
 STDIN = message typed<span class="org-keyword"> in</span> stdin is sent to all client sockets.
from client 1 to server
 [SERVER ECHO] =&gt; ID = 7 =&gt; from client 1 to server
^C&#9166;   
</pre>
</div>

<p>
Running: (Client 2 netcat from terminal 3)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ nc -v localhost  9026
<span class="org-function-name">Ncat</span>: Version 7.80 ( https://nmap.org/ncat )
<span class="org-function-name">Ncat</span>: Connection to ::1 failed: Connection refused.
<span class="org-function-name">Ncat</span>: Trying next address...
<span class="org-function-name">Ncat</span>: Connected to 127.0.0.1:9026.

 =&gt; [SERVER INFO] Hello world client side!! 
connect server from client 2 
 [SERVER ECHO] =&gt; ID = 8 =&gt; connect server from client 2 
 STDIN = message typed<span class="org-keyword"> in</span> stdin is sent to all client sockets.
from client 2 to server
 [SERVER ECHO] =&gt; ID = 8 =&gt; from client 2 to server
^C

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1372cc1" class="outline-3">
<h3 id="org1372cc1"><span class="section-number-3">1.24</span> X11 - X Windows System</h3>
<div class="outline-text-3" id="text-1-24">
</div>
<div id="outline-container-orgd087564" class="outline-4">
<h4 id="orgd087564"><span class="section-number-4">1.24.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-24-1">
<p>
Most Unix-like operating systems, including Linux and BSD variants,
except Apple's MacOSX, use X-Windows System, also called <b>X11</b>, which
is a <span class="underline">network-transparent</span> window system developed at project Athena
(MIT) in 1984 and nowadays it is led by the <a href="https://www.x.org/wiki/">X.Org</a> foundation. 
</p>

<p>
The <span class="underline">server</span> or <span class="underline">display server</span> (XServer) draws windows and widgets on
the human operator display and receives input events from mouse and
keyboard on behalf of one or more local or remote client applications
(XClients). This architechture enables network transparency, which is
the ability to operate either locally or over network. A client
appplication communicates with the XServer by using the X Windows
System (X11) network protocol via unix socket if the client
application is running on the user machine or via TCP/IP sockets if
the client application is running on a remote server.
</p>

<p>
<b>Main parts:</b>
</p>

<ul class="org-ul">
<li><span class="underline">X Server</span> (Server-side, User's Monitor/Screen)
<ul class="org-ul">
<li>=&gt; Runs on the user (human operator) machine, draws windows and
widgets for <span class="underline">x-clients</span>.</li>
</ul></li>

<li><span class="underline">X Client</span> =&gt; Application running on user machine or remote server.
<ul class="org-ul">
<li>=&gt; Initiates the connection and makes network requests to the
server, which draws the application's widgets.</li>
</ul></li>

<li><span class="underline">X11 - Network Protocol</span>
<ul class="org-ul">
<li>=&gt; Techinical specification or <span class="underline">technical</span> <span class="underline">standard</span> about how
x-server and x-clients should communicate.</li>
</ul></li>
</ul>

<p>
The X-Client (local or remote application) can communicate with the
X-Server by using:
</p>

<ul class="org-ul">
<li>Direct X11 protocol network requests via TCP/IP socket or Unix-sockets.</li>

<li><a href="https://www.x.org/releases/X11R7.7/doc/libX11/libX11/libX11.html">XLib</a> C Library =&gt; Encapsulates the X11 network protocol.</li>

<li><a href="https://xcb.freedesktop.org/">XCb</a> C Library =&gt; (Lower level than XLib) Similar to XLib, but has
a smaller footprint and lower latency, better suport for thread.</li>
</ul>

<p>
<b>Notes and considerations:</b>
</p>

<ul class="org-ul">
<li>Unlike on Windows and Mac-OSX, the graphics interface is not part
of neither Linux kernel nor BSD-variants' kernels. The ability to
run headless, without any graphics, makes Linux-based operating
systems suitable for network server and embedded systems where a
built-in GUI could cause higher overhead.</li>

<li>X11 protocol does not specify styling, widgets (menu, buttons and
so on). Those features are provided by <a href="https://en.wikipedia.org/wiki/Comparison_of_X_window_managers">window managers</a> and GUI
Graphical User Interface toolkits such as, <a href="https://en.wikipedia.org/wiki/GTK">GTK</a>,  <a href="https://en.wikipedia.org/wiki/Qt_(software)">Qt</a>, <a href="https://en.wikipedia.org/wiki/Motif_(software)">Motif</a>, <a href="https://en.wikipedia.org/wiki/FLTK">FLTK</a>, 
and <a href="https://en.wikipedia.org/wiki/Swing_(Java)">Java Swing</a> (Java Only).</li>

<li>X11 is not widely used on Embedded Linux systems as it is on Linux
desktop systems. Instead many embedded linux operate directly on
top of <a href="https://developer.toradex.com/knowledge-base/framebuffer-linux">Framebuffer</a>. The following approaches can be used for
creating graphical user interfaces on top of framebuffer: in-house
libraries, EGL (Embedded OpenGL), SDL or <a href="https://doc.qt.io/qt-5/embedded-linux.html">Qt toolkit</a> on top of
frambebuffer.</li>

<li>Although <span class="underline">Android</span> operating system is based on Linux kernel, unlike
the desktop GNU/Linux distribution counterparts, Android user
interface is built directly on top of framebuffer.</li>

<li>It is not worth developing any application on top of the X-Windows
System Protocol as it is low level, lacks widget abstractions and
may eventually be phased out by major Linux Desktop distribution
and replaced by <a href="https://en.wikipedia.org/wiki/Wayland_(display_server_protocol)">Wayland</a>. A better approach is to use higher level
libraries such as Qt Widgets, Qt QML, KDE Libraries (Qt variants),
Gtk or Java Swing as any application built on top of those
libraries will be able to work in any system using <span class="underline">Wayland</span>.</li>

<li>Despite being network transparent, X11 protocol is unsafe for
usage over the network dut to the protocol be unencrypted which
makes it vulnerable to MITM, snooping, spoofing and so on. A
workaround for safer usage over the network is to use X11 via SSH
forwarding.</li>
</ul>
</div>
</div>
<div id="outline-container-org05c07d7" class="outline-4">
<h4 id="org05c07d7"><span class="section-number-4">1.24.2</span> Further reading and references</h4>
<div class="outline-text-4" id="text-1-24-2">
</div>
<ol class="org-ol">
<li><a id="org2591ec8"></a>X-Windows System<br />
<div class="outline-text-5" id="text-1-24-2-1">
<ul class="org-ul">
<li><b>Documentation for the X Window System</b> - Version 11 Release 7.7
(X11R7.7) [MUST-READ]
<ul class="org-ul">
<li><a href="https://www.x.org/releases/X11R7.7/doc/">https://www.x.org/releases/X11R7.7/doc/</a></li>
</ul></li>

<li><b>X Window System Protocol</b> - X consortium Standard. [MUST-READ]
<ul class="org-ul">
<li><a href="https://www.x.org/releases/X11R7.7/doc/xproto/x11protocol.html">https://www.x.org/releases/X11R7.7/doc/xproto/x11protocol.html</a></li>
<li>Summary: Formal specification of X-Windows System Network Protocol.</li>
</ul></li>

<li><b>X WINDOW SYSTEM PROTOCOL, VERSION 11</b> - Alpha Update - April 1987
<ul class="org-ul">
<li><a href="https://tools.ietf.org/html/rfc1013">https://tools.ietf.org/html/rfc1013</a></li>
</ul></li>

<li><b>X Window System core protocol</b>
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/X_Window_System_core_protocol">https://en.wikipedia.org/wiki/X_Window_System_core_protocol</a></li>
<li>"The X Window System core protocol[1][2][3] is the base
protocol of the X Window System, which is a networked windowing
system for bitmap displays used to build graphical user
interfaces on Unix, Unix-like, and other operating systems. The
X Window System is based on a client–server model: a single
server controls the input/output hardware, such as the screen,
the keyboard, and the mouse; all application programs act as
clients, interacting with the user and with the other clients
via the server. .."</li>
</ul></li>

<li><b>Telnet Forwarding of X Window System Session Data</b>
<ul class="org-ul">
<li><a href="https://tools.ietf.org/html/draft-altman-telnet-fwdx-01">https://tools.ietf.org/html/draft-altman-telnet-fwdx-01</a></li>
</ul></li>

<li><b>Xming X Server for Windows</b>
<ul class="org-ul">
<li><a href="http://www.straightrunning.com/XmingNotes/">http://www.straightrunning.com/XmingNotes/</a></li>
<li>Summary: X Server implementation for Microsft Windows NT
operating system which allows using remote Linux or BSD
graphical applications via X11 X Windows System network
protocol.</li>
</ul></li>

<li><b>XWindows Utility Description</b>
<ul class="org-ul">
<li><a href="https://www.distributednetworks.com/redhat-linux-admin/module2/xwindows-utility-description.php">https://www.distributednetworks.com/redhat-linux-admin/module2/xwindows-utility-description.php</a></li>
</ul></li>

<li><b>X Server Source Code</b> / Gitlab
<ul class="org-ul">
<li><a href="https://gitlab.freedesktop.org/xorg/xserver">https://gitlab.freedesktop.org/xorg/xserver</a></li>
<li>"The X server accepts requests from client applications to
create windows, which are (normally rectangular) "virtual
screens" that the client program can draw into. Windows are
then composed on the actual screen by the X server (or by a
separate composite manager) as directed by the window manager,
which usually communicates with the user via graphical controls
such as buttons and draggable titlebars and borders."</li>
</ul></li>

<li><b>The XFree86 - Project Inc</b> - Major implementation of XServer for X11
<ul class="org-ul">
<li><a href="https://www.xfree86.org/">https://www.xfree86.org/</a></li>
<li>"The XFree86 Project, Inc is a global volunteer organization
which produces XFree86®, the freely redistributable open-source
implementation of the X Window System continuously
since 1992. XFree86 runs primarily on UNIX® and UNIX-like
operating systems like Linux, all of the BSD variants, Sun
Solaris both native 32 and 64 bit support, Solaris x86, Mac OS
X (via Darwin) as well as other platforms like OS/2 and
Cygwin. What XFree86 does, is provide a client/server interface
between the display hardware (those physical things like the
mouse, keyboard, and video displays) and the desktop
environment, (this is typically called a window manager as it
deals with how X is displayed i.e. the overall appearance). Yet
X it goes beyond that and also gives the infrastructure and a
standardized application interface (API). All of this which
makes XFree86 platform-independent, network-transparent and
fully extensible. In short, XFree86 is the premier open source
X11-based desktop infrastructure.</li>
</ul></li>

<li><b>Athena Widget Set - C Language Interface</b> (libXaw Version 1.0.13) - X Consortium Standard
<ul class="org-ul">
<li><a href="https://www.x.org/releases/current/doc/libXaw/libXaw.html">https://www.x.org/releases/current/doc/libXaw/libXaw.html</a></li>
<li>"The X Toolkit is made up of two distinct pieces, the Xt
Intrinsics and a widget set. The Athena widget set is a sample
implementation of a widget set built upon the Intrinsics. In
the X Toolkit, a widget is the combination of an X window or
subwindow and its associated input and output
semantics. Because the Intrinsics provide the same basic
functionality to all widget sets it may be possible to use
widgets from the Athena widget set with other widget sets based
upon the Intrinsics. Since widget sets may also implement
private protocols, all functionality may not be available when
mixing and matching widget sets. For information about the
Intrinsics, see the X Toolkit Intrinsics - C Language
Interface. The Athena widget set is a library package layered
on top of the Intrinsics and Xlib that provides a set of user
interface tools sufficient to build a wide variety of
applications. This layer extends the basic abstractions
provided by X and provides the next layer of functionality
primarily by supplying a cohesive set of sample
widgets. Although the Intrinsics are a Consortium standard,
there is no standard widget set."</li>
</ul></li>
</ul>
</div>
</li>
<li><a id="org73bfa45"></a>X Windows System Client Libraries<br />
<div class="outline-text-5" id="text-1-24-2-2">
<ul class="org-ul">
<li><b>Xlib - C Language X Interface</b> - X Consortium Standard
<ul class="org-ul">
<li><a href="https://www.x.org/releases/X11R7.7/doc/libX11/libX11/libX11.html">https://www.x.org/releases/X11R7.7/doc/libX11/libX11/libX11.html</a></li>
</ul></li>

<li><b>XCB X11 Client C Library</b> - Freedeskop foundation
<ul class="org-ul">
<li><a href="https://xcb.freedesktop.org/">https://xcb.freedesktop.org/</a></li>
</ul></li>
</ul>
</div>
</li>

<li><a id="org7c990dc"></a>X11 - X Windows System Concepts<br />
<div class="outline-text-5" id="text-1-24-2-3">
<ul class="org-ul">
<li><b>Window manager</b> - Arch Linux Wiki
<ul class="org-ul">
<li><a href="https://wiki.archlinux.org/index.php/window_manager">https://wiki.archlinux.org/index.php/window_manager</a></li>
<li>Summary: Outlines several possible window systems for X Windows
Systems, such as 2bwm, 9wm, compiz, blackbox, i3, awesome,
qtile, xmonad &#x2026;</li>
</ul></li>
</ul>
</div>
</li>

<li><a id="org901d3c7"></a>Wayland<br />
<div class="outline-text-5" id="text-1-24-2-4">
<p>
Note: Eventually may replace X Windows System. 
</p>

<ul class="org-ul">
<li><b>Wayland v/s Xorg : How Are They Similar &amp; How Are They Different</b>
<ul class="org-ul">
<li><a href="https://www.secjuice.com/wayland-vs-xorg/">https://www.secjuice.com/wayland-vs-xorg/</a></li>
</ul></li>

<li><b>Wayland (display server protocol)</b>
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Wayland_(display_server_protocol)">https://en.wikipedia.org/wiki/Wayland_(display_server_protocol)</a></li>
</ul></li>
</ul>
</div>
</li>

<li><a id="orgfaf8c19"></a>Low Level Graphics Stack - kernel and embedded Linux systems<br />
<div class="outline-text-5" id="text-1-24-2-5">
<ul class="org-ul">
<li><b>Linux Graphics Demystified</b> - Martin Fiedler - Dream Chip Techonologies GMHB
<ul class="org-ul">
<li><a href="https://keyj.emphy.de/files/linuxgraphics_en.pdf">https://keyj.emphy.de/files/linuxgraphics_en.pdf</a></li>
<li><a href="https://web.archive.org/web/20200426101542/https://keyj.emphy.de/files/linuxgraphics_en.pdf">https://web.archive.org/web/20200426101542/https://keyj.emphy.de/files/linuxgraphics_en.pdf</a></li>
<li>Summary: Explains about Linux low level graphics stack,
including framebuffer, X-Server.</li>
</ul></li>

<li><b>Linux Framebuffer</b> ( /dev/fb0 )
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Linux_framebuffer">https://en.wikipedia.org/wiki/Linux_framebuffer</a></li>
<li>"The Linux framebuffer (fbdev) is a graphic hardware-independent
abstraction layer to show graphics on a computer monitor,
typically on the system console.[1] It allows direct access to
the framebuffer (the part of a computer's video memory
containing a current video frame) using only the Linux kernel's
own basic facilities and its device file system interface."</li>
</ul></li>

<li><b>Linux Framebuffer</b> - Nicolas Caramelli
<ul class="org-ul">
<li><a href="https://github.com/caramelli/higfxback/wiki/Linux-Framebuffer">https://github.com/caramelli/higfxback/wiki/Linux-Framebuffer</a></li>
<li>Summary: Detailed explanation about Linux kernel framebuffer
infrastructure.</li>
</ul></li>

<li><b>Frmebuffer (Linux)</b> - Toradex Developer resources
<ul class="org-ul">
<li><a href="https://developer.toradex.com/knowledge-base/framebuffer-linux">https://developer.toradex.com/knowledge-base/framebuffer-linux</a></li>
<li>"The framebuffer (fbdev) is a character device providing access
to graphics hardware. Beside the framebuffer, other interfaces
exist to access graphics hardware such as the DRI (direct
rendering interface) or proprietary interfaces (NVIDIA
drivers). Typically, the framebuffer doesn't support any 2D/3D
hardware acceleration. &#x2026;"</li>
</ul></li>

<li><b>DRI - Direct Rendering Infrastructure</b>
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Direct_Rendering_Infrastructure">https://en.wikipedia.org/wiki/Direct_Rendering_Infrastructure</a></li>
<li>"The Direct Rendering Infrastructure (DRI) is a framework for
allowing direct access to graphics hardware under the X Window
System in a safe, efficient way.[6] The main use of DRI is to
provide hardware acceleration for the Mesa implementation of
OpenGL. DRI has also been adapted to provide OpenGL acceleration
on a framebuffer console without a display server running. &#x2026;"</li>
</ul></li>

<li><b>Mesa 3D and Direct Rendering Infrastructure wiki</b>
<ul class="org-ul">
<li><a href="https://dri.freedesktop.org/wiki/">https://dri.freedesktop.org/wiki/</a></li>
<li>"The Direct Rendering Infrastructure, also known as the DRI, is
a framework for allowing direct access to graphics hardware
under the X Window System in a safe and efficient manner. It
includes changes to the X server, to several client libraries,
and to the kernel (DRM, Direct Rendering Manager). The most
important use for the DRI is to create fast OpenGL
implementations providing hardware acceleration for
Mesa. Several 3D accelerated drivers have been written to the
DRI specification, including drivers for chipsets produced by
3DFX, AMD (formerly ATI), Intel and Matrox."</li>
</ul></li>

<li><b>Linux GPU Driver Developer's Guide</b>
<ul class="org-ul">
<li><a href="https://01.org/linuxgraphics/gfx-docs/drm/gpu/index.html">https://01.org/linuxgraphics/gfx-docs/drm/gpu/index.html</a></li>
<li>"The Linux DRM layer contains code intended to support the needs
of complex graphics devices, usually containing programmable
pipelines well suited to 3D graphics acceleration. Graphics
drivers in the kernel may make use of DRM functions to make
tasks like memory management, interrupt handling and DMA easier,
and provide a uniform interface to applications. A note on
versions: this guide covers features found in the DRM tree,
including the TTM memory manager, output configuration and mode
setting, and the new vblank internals, in addition to all the
regular features found in current kernels."</li>
</ul></li>

<li><b>Displaying and Rendering Graphics with Linux Training</b> - Bootlin
<ul class="org-ul">
<li><a href="https://bootlin.com/doc/training/graphics/graphics-slides.pdf">https://bootlin.com/doc/training/graphics/graphics-slides.pdf</a></li>
<li><a href="https://web.archive.org/web/20201018160609/https://bootlin.com/doc/training/graphics/graphics-slides.pdf">https://web.archive.org/web/20201018160609/https://bootlin.com/doc/training/graphics/graphics-slides.pdf</a></li>
</ul></li>

<li><b>Inside Linux - graphics Understanding the components, upgrading drivers, and advanced use cases</b> - Intel
<ul class="org-ul">
<li><a href="https://www.intel.com/content/dam/www/public/us/en/documents/white-papers/inside-linux-graphics-paper.pdf">https://www.intel.com/content/dam/www/public/us/en/documents/white-papers/inside-linux-graphics-paper.pdf</a></li>
</ul></li>

<li><b>EGL (API)</b> - Embedded OpenGL
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/EGL_(API)">https://en.wikipedia.org/wiki/EGL_(API)</a></li>
</ul></li>

<li><b>Qt for Embedded Linux</b> (Also covers Qt directly on top of Framebuffer device)
<ul class="org-ul">
<li><a href="https://doc.qt.io/qt-5/embedded-linux.html#linuxfb">https://doc.qt.io/qt-5/embedded-linux.html#linuxfb</a></li>
</ul></li>

<li><b>The Virtual Framebuffer</b> - Qt Company
<ul class="org-ul">
<li><a href="https://doc.qt.io/archives/qt-4.8//qvfb.html">https://doc.qt.io/archives/qt-4.8//qvfb.html</a></li>
<li>"Qt for Embedded Linux applications write directly to the
framebuffer, eliminating the need for the X Window System and
saving memory. For development and debugging purposes, a virtual
framebuffer can be used, allowing Qt for Embedded Linux programs
to be developed on a desktop machine, without switching between
consoles and X11."</li>
</ul></li>

<li><b>Writing to the Framebuffer</b> - Seena Burns
<ul class="org-ul">
<li><a href="http://seenaburns.com/2018/04/04/writing-to-the-framebuffer/">http://seenaburns.com/2018/04/04/writing-to-the-framebuffer/</a></li>
</ul></li>

<li><b>Writing to the Framebuffer</b> (Forum Discussion)
<ul class="org-ul">
<li><a href="https://news.ycombinator.com/item?id=16755552">https://news.ycombinator.com/item?id=16755552</a></li>
</ul></li>

<li><b>The DRM/KMS subsystem from a newbie’s point of view</b> - Boris Brezilion 
<ul class="org-ul">
<li><a href="https://events.static.linuxfound.org/sites/events/files/slides/brezillon-drm-kms.pdf">https://events.static.linuxfound.org/sites/events/files/slides/brezillon-drm-kms.pdf</a></li>
<li><a href="https://web.archive.org/web/20191031122549/https://events.static.linuxfound.org/sites/events/files/slides/brezillon-drm-kms.pdf">https://web.archive.org/web/20191031122549/https://events.static.linuxfound.org/sites/events/files/slides/brezillon-drm-kms.pdf</a></li>
</ul></li>

<li><b>DRM Driver Development For Embedded Systems</b> - Inki Dae, Software Platform Lab - Samsung
<ul class="org-ul">
<li><a href="https://elinux.org/images/7/71/Elce11_dae.pdf">https://elinux.org/images/7/71/Elce11_dae.pdf</a></li>
<li><a href="https://web.archive.org/web/20201018154836/https://elinux.org/images/7/71/Elce11_dae.pdf">https://web.archive.org/web/20201018154836/https://elinux.org/images/7/71/Elce11_dae.pdf</a></li>
</ul></li>

<li><b>drm - Direct Rendering Manager (DRI kernel support)</b> - Device Drivers Manual (NetBSD)
<ul class="org-ul">
<li><a href="https://www.daemon-systems.org/man/drm.4.html">https://www.daemon-systems.org/man/drm.4.html</a></li>
</ul></li>

<li><b>CS574 presentation: Linux OpenGL drivers: Direct Rendering  Infrastructure</b>
<ul class="org-ul">
<li><a href="https://www.cs.nmsu.edu/~joshagam/archive/cs574/3-dri.html">https://www.cs.nmsu.edu/~joshagam/archive/cs574/3-dri.html</a></li>
</ul></li>

<li><b>Platform specifics: Linux</b> - OpenGL - Kronos Group
<ul class="org-ul">
<li><a href="https://www.khronos.org/opengl/wiki/Platform_specifics:_Linux">https://www.khronos.org/opengl/wiki/Platform_specifics:_Linux</a></li>
<li>"This Section explains how to install Drivers to make OpenGL
Programs run under Linux and how to use different
Libraries/Toolkits to create Opengl Programs. Mesa is an
open-source OpenGL implementation, continually updated to
support the latest OpenGL specification. Direct Rendering
Infrastructure, also known as the DRI, is a framework for
allowing direct access to graphics hardware under the X Window
System in a safe and efficient manner."</li>
</ul></li>

<li><b>DRM(Direct Rendering Manager) of Tizen Kernel</b>
<ul class="org-ul">
<li><a href="https://download.tizen.org/misc/media/conference2012/wednesday/ballroom-c/2012-05-09-1330-1410-the_drm_%28direct_rendering_manager%29_of_tizen_kernel.pdf">https://download.tizen.org/misc/media/conference2012/wednesday/ballroom-c/2012-05-09-1330-1410-the_drm_%28direct_rendering_manager%29_of_tizen_kernel.pdf</a></li>
<li><a href="https://web.archive.org/web/20161109195212/http://download.tizen.org/misc/media/conference2012/wednesday/ballroom-c/2012-05-09-1330-1410-the_drm_(direct_rendering_manager)_of_tizen_kernel.pdf">https://web.archive.org/web/20161109195212/http://download.tizen.org/misc/media/conference2012/wednesday/ballroom-c/2012-05-09-1330-1410-the_drm_(direct_rendering_manager)_of_tizen_kernel.pdf</a></li>
</ul></li>

<li><b>Direct Rendering Infrastructure: Architecture</b> - José Manual Rios Fonseca
<ul class="org-ul">
<li><a href="https://paginas.fe.up.pt/~mei04010/dri-architecture.pdf">https://paginas.fe.up.pt/~mei04010/dri-architecture.pdf</a></li>
</ul></li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-org7f95cfe" class="outline-4">
<h4 id="org7f95cfe"><span class="section-number-4">1.24.3</span> X11 Uitilities</h4>
<div class="outline-text-4" id="text-1-24-3">
<p>
The following X11 utilities are widely used on many Linux
distributions: 
</p>


<p>
Authentication and authorization: 
</p>

<ul class="org-ul">
<li><a href="https://wiki.archlinux.org/index.php/Xinit">xinit</a> - Program that allows starting Xorg (X Server) manually from
command line.</li>

<li><a href="https://linux.die.net/man/1/xauth">xauth</a> - Display X server authorization information.</li>

<li><a href="https://wiki.archlinux.org/index.php/Xhost">xhost</a> - Arch wiki: "The xhost program is used to add and delete
host names or user names to the list allowed to make connections
to the X server. In the case of hosts, this provides a rudimentary
form of privacy control and security. It is only sufficient for a
workstation (single user) environment, although it does limit the
worst abuses. Environments which require more sophisticated
measures should implement the user-based mechanism or use the
hooks in the protocol for passing other authentication data to the
server."</li>
</ul>

<p>
Monitor Configuration: 
</p>

<ul class="org-ul">
<li><a href="https://wiki.archlinux.org/index.php/xrandr">xrandr</a> - utility for configuring screen/monitor orientation,
resolution, dual monitor and so on. By default, it shows the
current displays resoultions.</li>
</ul>

<p>
General Utilities: 
</p>

<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Xterm">xterm</a> - Reference implementation for X11 terminal emulators.</li>

<li><a href="https://en.wikipedia.org/wiki/Xkill">xkill</a> - command line application that allows forcefully
terminating any graphical program by calling $ xkill from command
line and clicking at the window whose process will be terminated.</li>

<li><a href="https://linux.die.net/man/1/cxdg-open">xdg-open</a> - Open file or directory from command line with default
system application. For instance, $ xdg-open file.xls, where
file.xls is a Excel spreadsheet, opens the file with Libreoffice,
if this application is available in the sytem.</li>

<li><a href="https://linux.die.net/man/1/xclip">xclip</a> - Allows copying stdin contents to clipboard and pasting
contents from clibpboard to stdout.</li>
</ul>

<p>
X11 Preference and configuration: 
</p>

<ul class="org-ul">
<li><a href="https://linux.die.net/man/1/xset">xet</a> - X-Server user preference.</li>

<li><a href="https://linux.die.net/man/1/xmodmap">xmodmap</a> - Modify keymaps and pointer buttons mapping in X Windows System X11.</li>

<li><a href="https://linux.die.net/man/1/setxkbmap">setxkbmap</a> - Modify Keyboard - allows changing the keyboard to
English, Portuguese, Greek, Cyrillic and so on.</li>

<li><a href="https://linux.die.net/man/1/xinput">xinput</a> - Configure and test X input devices such as keyboard,
mouse, touchpad and etc.</li>

<li><a href="https://www.x.org/releases/X11R7.7/doc/man/man1/xev.1.xhtml">xev</a> (X event monitor) "Xev creates a window and then asks the X server to send it
events whenever anything happens to the window (such as it being
moved, resized, typed in, clicked in, etc.). You can also attach
it to an existing window. It is useful for seeing what causes
events to occur and to display the information that they contain;
it is essentially a debugging and development tool, and should not
be needed in normal usage."
<ul class="org-ul">
<li>Source code: <a href="https://gitlab.freedesktop.org/xorg/app/xev">https://gitlab.freedesktop.org/xorg/app/xev</a></li>
<li>See also:
<ul class="org-ul">
<li><a href="http://www.rahul.net/kenton/events.html">X Application Software Engineering: Debugging X Input Events</a></li>
</ul></li>
</ul></li>

<li><a href="https://linux.die.net/man/1/xwininfo">xwinfo</a> - Utility for getting display information about windows. It
provides a cursor that shows information about any window that
user clicks at.</li>

<li><a href="https://linux.die.net/man/1/xsetroot">xsetroot</a> - Root window parametter settings.</li>

<li><a href="https://linux.die.net/man/1/xprop">xprop</a> - Similar to xwinfo, but displays font property.</li>

<li><a href="https://linux.die.net/man/1/xvinfo">xvinfo</a> - Display capabilities of video adapters.</li>

<li><a href="https://linux.die.net/man/1/xdriinfo">xdriinfo</a> - Get confituration of DRI (direct rendering interface)
device drivers.</li>
</ul>

<p>
X11 protocol message tracing/monitor tools (Note: most non-standard
tools, non commonly available in most distros.)
</p>

<ul class="org-ul">
<li><a href="https://gitlab.freedesktop.org/xorg/app/xscope">xscope</a> - "XSCOPE is a program to monitor the connections between
the X11 window server and a client program.  xscope runs as a
separate process.  By adjusting the host and/or display number
that a X11 client attaches to, the client is attached to xscope
instead of X11.  xscope attaches to X11 as if it were the client.
All bytes from the client are sent to xscope which passes them on
to X11; All bytes from X11 are sent to xscope which sends them on
to the client.  xscope is transparent to the client and X11.".</li>
</ul>


<ul class="org-ul">
<li><a href="https://x11vis.org/">x11vis</a> - "x11vis aims to be a useful tool for debugging X11
clients. Its main focus is on being as visual and interactive as
possible. Replacing X11 atom, window, font or pixmap IDs with
human readable names is the most basic functionality. Contrary to
other tools like xtrace, x11vis will display human readable IDs on
all requests, no matter at which point in time the information
gets available. To help you cope with lots of data, x11vis
displays only the most important information by default,
automatically folds sequences of boring requests, allows you to
filter by packet type or client and provides so-called markers
between you can navigate. Also, instead of just assigning a number
to each connection, x11vis displays the command line with which
that client was started. To learn more, please see the manual.".</li>

<li><a href="https://sourceforge.net/projects/xmon/">xmon</a> - "A monitor for the X Window System core protocol. Xmon
monitors the messages sent between an X11 server and a number of
X11 clients and displays the contents of the messages in an
interactively selectable level of detail."</li>

<li><a href="https://www.chiark.greenend.org.uk/~sgtatham/xtruss/">xtruss</a> - Tool for tracing/monitoring X11 network protocol.</li>

<li><a href="https://www.wireshark.org/">Wireshark</a> - Tool that allows debugging and tracing any network
protocol and also allows inspecting USB protocol. (Note:
scriptable in Lua programming language.)</li>
</ul>

<p>
Animation: 
</p>

<ul class="org-ul">
<li><a href="https://www.x.org/archive/X11R6.8.1/doc/xclock.1.html">xclock</a> - Clock animation.</li>

<li><a href="https://www.x.org/releases/X11R7.5/doc/man/man1/xeyes.1.html">xeyes</a> - Eye animation that follows the mouse pointer.</li>

<li><a href="https://linux.die.net/man/1/xlogo">xlogo</a> - X windows System "X" logo picture.</li>
</ul>
</div>
</div>

<div id="outline-container-org629d1a1" class="outline-4">
<h4 id="org629d1a1"><span class="section-number-4">1.24.4</span> X11 programming via Xlib</h4>
<div class="outline-text-4" id="text-1-24-4">
<p>
This sample Xlib applications draw a window with a rectangle and a
string. Note: Xlib lacks widgets. 
</p>

<p>
Code available at: 
</p>

<ul class="org-ul">
<li><a href="https://gist.github.com/f7f0b892011ad987bfed531336dbae89">https://gist.github.com/f7f0b892011ad987bfed531336dbae89</a></li>
</ul>

<p>
File: <span class="underline">CMakeLists.txt</span> 
</p>

<div class="org-src-container">
<pre class="src src-cmake"><span class="org-function-name">cmake_minimum_required</span>(VERSION 3.9)
<span class="org-function-name">project</span>(Simple_Cmake_Project)

<span class="org-comment">#========== Global Configurations =============#</span>
<span class="org-comment">#----------------------------------------------#</span>

<span class="org-function-name">set</span>(CMAKE_CXX_STANDARD 17)     
<span class="org-function-name">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

<span class="org-function-name">find_package</span>(X11 REQUIRED)

<span class="org-comment">#========== Targets Configurations ============#</span>

       <span class="org-function-name">add_executable</span>( xlib-demo xlib-demo.cpp )
<span class="org-function-name">target_link_libraries</span>( xlib-demo ${<span class="org-variable-name">X11_LIBRARIES</span>} )

<span class="org-comment"># add_executable(app2 application2.cpp)</span>
</pre>
</div>

<p>
File: <span class="underline">xlib-demo.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">X11/Xlib.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdlib</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span> <span class="org-function-name">abort_on_failure</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">bool</span> <span class="org-variable-name">predicate</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">message</span> = <span class="org-string">"Abort runtime."</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>predicate<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">return</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [ABORT] %s"</span>, message<span class="org-rainbow-delimiters-depth-2">)</span>;
    abort<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-doc">/** If the value passed to XOpenDisplay is null, the XClient (Xlib) attempts </span>
<span class="org-doc">     * to connect to the display server designated by the environment variable  </span>
<span class="org-doc">     * $DISPLAY, which is often set to the :1.0 or the local machine. </span>
<span class="org-doc">     *------------------------------------------------------------------------*/</span>
    <span class="org-type">Display</span>* <span class="org-variable-name">dpy</span> = XOpenDisplay<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    abort_on_failure<span class="org-rainbow-delimiters-depth-2">(</span>dpy != <span class="org-constant">nullptr</span>, <span class="org-string">"Cannot open display."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-doc">/** ----- Query Information about display server ------------------------*/</span>

    <span class="org-type">int</span> <span class="org-variable-name">version</span> = XProtocolVersion<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] X11 protocol version = "</span> &lt;&lt; version &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">vendor</span> = XServerVendor<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] X11 XServer vendor = "</span> &lt;&lt; vendor &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">disp_str</span> = XDisplayString<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] X11 Display string = "</span> &lt;&lt; disp_str &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-type">int</span> <span class="org-variable-name">n_screen</span> = XScreenCount<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Number of screens = "</span> &lt;&lt; n_screen &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-doc">/** ----- Draw Screen ------------------------------------------------*/</span>

    <span class="org-type">int</span> <span class="org-variable-name">screen</span> = DefaultScreen<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">Window</span> <span class="org-variable-name">wnd</span> = XCreateSimpleWindow<span class="org-rainbow-delimiters-depth-2">(</span>
                     dpy                         <span class="org-comment-delimiter">// </span><span class="org-comment">Display </span>
                   , RootWindow<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Parent Window </span>
                   , 10, 20                      <span class="org-comment-delimiter">// </span><span class="org-comment">Position (x - horizontal, y - vertical) from top-left corner </span>
                   , 400, 500                    <span class="org-comment-delimiter">// </span><span class="org-comment">Dimensions (width, height)</span>
                   , 1                           <span class="org-comment-delimiter">// </span><span class="org-comment">Border width </span>
                   , BlackPixel<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Border </span>
                   , WhitePixel<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Background color </span>
                   <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">/* </span><span class="org-comment">Casting void means that the return value (type int) is being ignored.</span><span class="org-comment-delimiter"> */</span>
    <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-2">)</span> XStoreName<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd, <span class="org-string">"X Windows-System X11"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Makes window visible </span>
    XMapWindow<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd<span class="org-rainbow-delimiters-depth-2">)</span>;
    XFlush<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">XEvent</span> <span class="org-variable-name">event</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Select events that the application is interested in. </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Only those events will notify the application. (XClient)</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">mask</span>  =   ExposureMask        
                | ButtonPressMask     <span class="org-comment-delimiter">// </span><span class="org-comment">Event: mouse button press</span>
                | KeyPressMask        <span class="org-comment-delimiter">// </span><span class="org-comment">Event: key press (keyboard)</span>
                | KeyReleaseMask      <span class="org-comment-delimiter">// </span><span class="org-comment">Event: key release (keyboard)</span>
                <span class="org-comment-delimiter">//</span><span class="org-comment">| PointerMotionMask   // Event: Mouse Move</span>
                ;
    XSelectInput<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd, mask<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Process window close event in X11 event loop for(;;)</span>
    <span class="org-type">Atom</span> <span class="org-variable-name">wnd_del</span> = XInternAtom<span class="org-rainbow-delimiters-depth-2">(</span>dpy, <span class="org-string">"WM_DELETE_WINDOW"</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    XSetWMProtocols<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd, &amp;wnd_del, 1<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">message</span> = <span class="org-string">"Draw some string on X11 - X windows system."</span>;

    <span class="org-comment-delimiter">/* </span><span class="org-comment">------- X11 (X Windows System) - Event loop ------------</span><span class="org-comment-delimiter"> */</span>

    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"\n [TRACE] Waiting event. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;;

         <span class="org-comment-delimiter">// </span><span class="org-comment">Get next X11 event      </span>
         XNextEvent<span class="org-rainbow-delimiters-depth-3">(</span>dpy, &amp;event<span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == ClientMessage<span class="org-rainbow-delimiters-depth-3">){</span>
                 fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [Event] User closed window. =&gt; Shutdown \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                 <span class="org-keyword">break</span>;
         <span class="org-rainbow-delimiters-depth-3">}</span>

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == Expose<span class="org-rainbow-delimiters-depth-3">)</span>    
                 fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr,  <span class="org-string">" [Event] Expose event. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == KeyPress<span class="org-rainbow-delimiters-depth-3">)</span>    
                 fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr,  <span class="org-string">" [Event] Key pressed. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == ButtonPress<span class="org-rainbow-delimiters-depth-3">)</span> 
                 fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr,  <span class="org-string">" [Event] Mouse button pressed. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == PointerMotionMask<span class="org-rainbow-delimiters-depth-3">)</span> 
                 fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr,  <span class="org-string">" [Event] Mouse button pressed. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;     

         <span class="org-comment-delimiter">// </span><span class="org-comment">X11 Graphics context, useful for drawing </span>
         <span class="org-type">GC</span> <span class="org-variable-name">gctx</span> = DefaultGC<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>;

         XFillRectangle<span class="org-rainbow-delimiters-depth-3">(</span> dpy, wnd, gctx
                        , 20, 50    <span class="org-comment-delimiter">// </span><span class="org-comment">(x, y) position from top-left corner origin </span>
                        , 100, 200  <span class="org-comment-delimiter">// </span><span class="org-comment">width and height </span>
                        <span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-type">GC</span> <span class="org-variable-name">gctx2</span> = DefaultGC<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>;                    

         XDrawString<span class="org-rainbow-delimiters-depth-3">(</span>  dpy     <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to display object </span>
                      , wnd     <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to window </span>
                      , gctx    <span class="org-comment-delimiter">// </span><span class="org-comment">Graphics context </span>
                      , 90, 300 <span class="org-comment-delimiter">// </span><span class="org-comment">(x, y) Position where string will be drawn (from top-left corner)</span>
                      , message
                      , strlen<span class="org-rainbow-delimiters-depth-4">(</span>message<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>; 

    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">----- End of event loop -------- // </span>

    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] User closed window. Shutdown application. Ok \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    XDestroyWindow<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Always close display </span>
    XCloseDisplay<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh">    $ &gt;&gt; git clone https://gist.github.com/f7f0b892011ad987bfed531336dbae89

<span class="org-function-name">File</span>: _CMakeLists.txt_ 

<span class="org-comment-delimiter">#</span><span class="org-comment">+BEGIN_SRC cmake </span>
   cmake_minimum_required(VERSION 3.9)
   project(Simple_Cmake_Project)

   <span class="org-comment-delimiter">#</span><span class="org-comment">========== Global Configurations =============#</span>
   <span class="org-comment-delimiter">#</span><span class="org-comment">----------------------------------------------#</span>

   <span class="org-builtin">set</span>(CMAKE_CXX_STANDARD 17)     
   <span class="org-builtin">set</span>(CMAKE_VERBOSE_MAKEFILE ON)

   find_package(X11 REQUIRED)

   <span class="org-comment-delimiter">#</span><span class="org-comment">========== Targets Configurations ============#</span>

          add_executable( xlib-demo xlib-demo.cpp )
   target_link_libraries( xlib-demo ${<span class="org-variable-name">X11_LIBRARIES</span>} )

   <span class="org-comment-delimiter"># </span><span class="org-comment">add_executable(app2 application2.cpp)</span>
</pre>
</div>

<p>
File: <span class="underline">xlib-demo.cpp</span> 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstring</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cassert</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> 

<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">X11/Xlib.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdlib</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-type">void</span> <span class="org-function-name">abort_on_failure</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">bool</span> <span class="org-variable-name">predicate</span>, <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">message</span> = <span class="org-string">"Abort runtime."</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>predicate<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">return</span>;
    <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [ABORT] %s"</span>, message<span class="org-rainbow-delimiters-depth-2">)</span>;
    abort<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span>** <span class="org-variable-name">argv</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-doc">/** If the value passed to XOpenDisplay is null, the XClient (Xlib) attempts </span>
<span class="org-doc">     * to connect to the display server designated by the environment variable  </span>
<span class="org-doc">     * $DISPLAY, which is often set to the :1.0 or the local machine. </span>
<span class="org-doc">     *------------------------------------------------------------------------*/</span>
    <span class="org-type">Display</span>* <span class="org-variable-name">dpy</span> = XOpenDisplay<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    abort_on_failure<span class="org-rainbow-delimiters-depth-2">(</span>dpy != <span class="org-constant">nullptr</span>, <span class="org-string">"Cannot open display."</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-doc">/** ----- Query Information about display server ------------------------*/</span>

    <span class="org-type">int</span> <span class="org-variable-name">version</span> = XProtocolVersion<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] X11 protocol version = "</span> &lt;&lt; version &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">vendor</span> = XServerVendor<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] X11 XServer vendor = "</span> &lt;&lt; vendor &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">disp_str</span> = XDisplayString<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] X11 Display string = "</span> &lt;&lt; disp_str &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-type">int</span> <span class="org-variable-name">n_screen</span> = XScreenCount<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [INFO] Number of screens = "</span> &lt;&lt; n_screen &lt;&lt; <span class="org-string">'\n'</span>;

    <span class="org-doc">/** ----- Draw Screen ------------------------------------------------*/</span>

    <span class="org-type">int</span> <span class="org-variable-name">screen</span> = DefaultScreen<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">Window</span> <span class="org-variable-name">wnd</span> = XCreateSimpleWindow<span class="org-rainbow-delimiters-depth-2">(</span>
                     dpy                         <span class="org-comment-delimiter">// </span><span class="org-comment">Display </span>
                   , RootWindow<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Parent Window </span>
                   , 10, 20                      <span class="org-comment-delimiter">// </span><span class="org-comment">Position (x - horizontal, y - vertical) from top-left corner </span>
                   , 400, 500                    <span class="org-comment-delimiter">// </span><span class="org-comment">Dimensions (width, height)</span>
                   , 1                           <span class="org-comment-delimiter">// </span><span class="org-comment">Border width </span>
                   , BlackPixel<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Border </span>
                   , WhitePixel<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>     <span class="org-comment-delimiter">// </span><span class="org-comment">Background color </span>
                   <span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">/* </span><span class="org-comment">Casting void means that the return value (type int) is being ignored.</span><span class="org-comment-delimiter"> */</span>
    <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">void</span><span class="org-rainbow-delimiters-depth-2">)</span> XStoreName<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd, <span class="org-string">"X Windows-System X11"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Makes window visible </span>
    XMapWindow<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd<span class="org-rainbow-delimiters-depth-2">)</span>;
    XFlush<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-type">XEvent</span> <span class="org-variable-name">event</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Select events that the application is interested in. </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Only those events will notify the application. (XClient)</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">mask</span>  =   ExposureMask        
                | ButtonPressMask     <span class="org-comment-delimiter">// </span><span class="org-comment">Event: mouse button press</span>
                | KeyPressMask        <span class="org-comment-delimiter">// </span><span class="org-comment">Event: key press (keyboard)</span>
                | KeyReleaseMask      <span class="org-comment-delimiter">// </span><span class="org-comment">Event: key release (keyboard)</span>
                <span class="org-comment-delimiter">//</span><span class="org-comment">| PointerMotionMask   // Event: Mouse Move</span>
                ;
    XSelectInput<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd, mask<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Process window close event in X11 event loop for(;;)</span>
    <span class="org-type">Atom</span> <span class="org-variable-name">wnd_del</span> = XInternAtom<span class="org-rainbow-delimiters-depth-2">(</span>dpy, <span class="org-string">"WM_DELETE_WINDOW"</span>, 0<span class="org-rainbow-delimiters-depth-2">)</span>;
    XSetWMProtocols<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd, &amp;wnd_del, 1<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-variable-name">message</span> = <span class="org-string">"Draw some string on X11 - X windows system."</span>;

    <span class="org-comment-delimiter">/* </span><span class="org-comment">------- X11 (X Windows System) - Event loop ------------</span><span class="org-comment-delimiter"> */</span>

    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span>;;<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr, <span class="org-string">"\n [TRACE] Waiting event. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;;

         <span class="org-comment-delimiter">// </span><span class="org-comment">Get next X11 event      </span>
         XNextEvent<span class="org-rainbow-delimiters-depth-3">(</span>dpy, &amp;event<span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == ClientMessage<span class="org-rainbow-delimiters-depth-3">){</span>
                 fprintf<span class="org-rainbow-delimiters-depth-4">(</span>stderr, <span class="org-string">" [Event] User closed window. =&gt; Shutdown \n"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
                 <span class="org-keyword">break</span>;
         <span class="org-rainbow-delimiters-depth-3">}</span>

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == Expose<span class="org-rainbow-delimiters-depth-3">)</span>    
                 fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr,  <span class="org-string">" [Event] Expose event. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == KeyPress<span class="org-rainbow-delimiters-depth-3">)</span>    
                 fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr,  <span class="org-string">" [Event] Key pressed. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == ButtonPress<span class="org-rainbow-delimiters-depth-3">)</span> 
                 fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr,  <span class="org-string">" [Event] Mouse button pressed. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>event.type == PointerMotionMask<span class="org-rainbow-delimiters-depth-3">)</span> 
                 fprintf<span class="org-rainbow-delimiters-depth-3">(</span>stderr,  <span class="org-string">" [Event] Mouse button pressed. \n"</span><span class="org-rainbow-delimiters-depth-3">)</span>;     

         <span class="org-comment-delimiter">// </span><span class="org-comment">X11 Graphics context, useful for drawing </span>
         <span class="org-type">GC</span> <span class="org-variable-name">gctx</span> = DefaultGC<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>;

         XFillRectangle<span class="org-rainbow-delimiters-depth-3">(</span> dpy, wnd, gctx
                        , 20, 50    <span class="org-comment-delimiter">// </span><span class="org-comment">(x, y) position from top-left corner origin </span>
                        , 100, 200  <span class="org-comment-delimiter">// </span><span class="org-comment">width and height </span>
                        <span class="org-rainbow-delimiters-depth-3">)</span>;

         <span class="org-type">GC</span> <span class="org-variable-name">gctx2</span> = DefaultGC<span class="org-rainbow-delimiters-depth-3">(</span>dpy, screen<span class="org-rainbow-delimiters-depth-3">)</span>;                    

         XDrawString<span class="org-rainbow-delimiters-depth-3">(</span>  dpy     <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to display object </span>
                      , wnd     <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to window </span>
                      , gctx    <span class="org-comment-delimiter">// </span><span class="org-comment">Graphics context </span>
                      , 90, 300 <span class="org-comment-delimiter">// </span><span class="org-comment">(x, y) Position where string will be drawn (from top-left corner)</span>
                      , message
                      , strlen<span class="org-rainbow-delimiters-depth-4">(</span>message<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-3">)</span>; 

    <span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-comment-delimiter">// </span><span class="org-comment">----- End of event loop -------- // </span>

    fprintf<span class="org-rainbow-delimiters-depth-2">(</span>stderr, <span class="org-string">" [TRACE] User closed window. Shutdown application. Ok \n"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    XDestroyWindow<span class="org-rainbow-delimiters-depth-2">(</span>dpy, wnd<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Always close display </span>
    XCloseDisplay<span class="org-rainbow-delimiters-depth-2">(</span>dpy<span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Building: 
</p>

<div class="org-src-container">
<pre class="src src-sh"> $ git clone https://gist.github.com/f7f0b892011ad987bfed531336dbae89 temp &amp;&amp; <span class="org-builtin">cd</span> temp 
 $ cmake -H. -B_build -DCMAKE_BUILD_TYPE=Debug -G Ninja
 $ cmake --build _build --target 
[2/2] Linking CXX executable xlib-demo
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ &gt;&gt; _build/xlib-demo 
[INFO] X11 protocol version = 11
[INFO] X11 XServer vendor = Fedora Project
[INFO] X11 Display string = :1.0
[INFO] Number of screens = 1

[TRACE] Waiting event. 
[Event] Expose event. 

[TRACE] Waiting event. 

[TRACE] Waiting event. 
[Event] Mouse button pressed. 
... ...     ... ...     ... ...     ... ...    
... ...     ... ...     ... ...    
</pre>
</div>

<p>
User Interface Screenshot: 
</p>


<div class="figure">
<p><a href="images/x11-gui-sample1.png"><img src="images/x11-gui-sample1.png" alt="x11-gui-sample1.png" /></a>
</p>
<p><span class="figure-number">Figure 1: </span>Xlib GUI User Interface.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2020-10-18 Sun 14:47</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
