<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-11-05 Mon 03:51 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CPP / C++ Notes - Design Patterns</title>
<meta name="generator" content="Org mode" />
<meta name="description" content="cpp/c++ c++ design patterns gneric programming object oriented metaprogramming"
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
<link href="theme/org-nav-theme.css" rel="stylesheet">
<script src="theme/org-nav-theme.js"></script>
<link rel="icon" href="favicon.ico" type="image/vnd.microsoft.icon" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">CPP / C++ Notes - Design Patterns</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgdbdf505">1. General Design Patterns</a>
<ul>
<li><a href="#org27483e2">1.1. General Techniques / Mechanism for Code Reuse</a></li>
<li><a href="#org69f5c4d">1.2. Singleton</a></li>
<li><a href="#org23794a6">1.3. Named constructor - static factory method</a></li>
<li><a href="#org69eec2a">1.4. Factory Method</a>
<ul>
<li><a href="#orgc717daa">1.4.1. Overview</a></li>
<li><a href="#orgbf5ec11">1.4.2. Factory Method Pattern Variations</a></li>
<li><a href="#orga1e0962">1.4.3. Sample Class Hierarchy</a></li>
<li><a href="#org028ae96">1.4.4. Simple factory - if-else statement</a></li>
<li><a href="#org88a8c90">1.4.5. Polymorphic Factory - registry based factory</a></li>
<li><a href="#orgbaf8f68">1.4.6. Universal Polymorphic Factory</a></li>
<li><a href="#org278594b">1.4.7. References</a></li>
</ul>
</li>
<li><a href="#org00d0337">1.5. Builder (Joshua Blosh)</a></li>
<li><a href="#org6fa277e">1.6. Strategy</a>
<ul>
<li><a href="#org065bce2">1.6.1. Overview</a></li>
<li><a href="#org330fb8d">1.6.2. Example</a></li>
</ul>
</li>
<li><a href="#org256e402">1.7. Method Chaining - Fluent API</a></li>
<li><a href="#orgb5b15dc">1.8. GOF - Template Pattern</a></li>
<li><a href="#orgd31d742">1.9. Null-Object Pattern</a></li>
<li><a href="#org56ff5bd">1.10. Composite</a></li>
<li><a href="#orgcd2b84b">1.11. Multiple booleans encoded as a single bitmask value</a></li>
</ul>
</li>
<li><a href="#orgca40a25">2. C++ Specific Design Pattern and Idioms</a>
<ul>
<li><a href="#orgd454c83">2.1. Interface Class</a>
<ul>
<li><a href="#orgfc42a4f">2.1.1. Overview</a></li>
<li><a href="#org4a9b221">2.1.2. Example</a></li>
</ul>
</li>
<li><a href="#org6ded86e">2.2. PIMPL - Pointer to Implementation</a></li>
<li><a href="#orgb0db59a">2.3. RAII - Resource Aquisition Is Initialization</a></li>
<li><a href="#orgac9738a">2.4. Type Erasure</a>
<ul>
<li><a href="#org58a8ded">2.4.1. Overview</a></li>
<li><a href="#orgaeb12c0">2.4.2. Example 1 - Simple type erasure.</a></li>
</ul>
</li>
<li><a href="#orgbd1dd0d">2.5. CRTP - Curious Recurring Template Pattern</a>
<ul>
<li><a href="#org6b5df90">2.5.1. Overview</a></li>
<li><a href="#orgec5029f">2.5.2. Example</a></li>
</ul>
</li>
<li><a href="#orgedf0b0d">2.6. Cross platform code with conditional compilation</a></li>
</ul>
</li>
</ul>
</div>
</div>
<ul class="org-ul">
<li><a href='index.html'>Index</a></li>
</ul>

<div id="outline-container-orgdbdf505" class="outline-2">
<h2 id="orgdbdf505"><span class="section-number-2">1</span> General Design Patterns</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org27483e2" class="outline-3">
<h3 id="org27483e2"><span class="section-number-3">1.1</span> General Techniques / Mechanism for Code Reuse</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li><b>Inheritance</b>
<ul class="org-ul">
<li>Dynamic / Runtime / Subtyping Polymorphism.</li>
<li>Benefits:
<ul class="org-ul">
<li>Allow switching implementation at runtime, store
different objects (pointers, smart pointers or references) at the
same container, defer method calls to specific implementation and
allow a client code work with multiple different implementations
at runtime. Inheritance alone is not evil, the problem is deep
inheritance hierarchies.</li>
</ul></li>
<li>Drawbacks:
<ul class="org-ul">
<li>Loss of value semantics and intrusive.</li>
<li>Classes must inherit from the same base class which requires
modification.</li>
<li>Objects can only be returned from factory functions as pointers
or pointers wrapped by smart pointers.</li>
<li>Slower speed than static polymorphism (templates and overloaded
functions or methods.)</li>
</ul></li>
</ul></li>

<li><b>Delegation</b> (a kind of OO composition)
<ul class="org-ul">
<li>Use another object for implementing some functionality and
forward a method call to it instead of inheriting the object
class. Examples: store items in a std::vector, instead of storing
them directly in the class with heap-allocated arrays; store an
heap-allocated object using smart pointers rather than storing it
using raw pointer and freeing it on the destructor.</li>
</ul></li>

<li><b>Static Polymorphism</b>
<ul class="org-ul">
<li>It is templates and overloaded functions or methods.</li>
<li>Templates can eliminate virtual method call overhead by resolving
methods at compile-time rather than at runtime.</li>
</ul></li>

<li><b>Type Erasure</b>
<ul class="org-ul">
<li>Combination of static and dynamic polymorphism which gets the
best of both sides with minimal overhead.</li>
</ul></li>

<li><b>Free Functions</b>
<ul class="org-ul">
<li>C++ is a multiparadigm language and not everything needs to to be
a class. So, functions can be used to extending classes without
modifying them by taking objects as arguments and applying
operations on them.</li>
</ul></li>

<li><b>Higher Order Functions / Higher Order Methods / Lambda Functions</b>
<ul class="org-ul">
<li>Lambda function can be used to add new behaviors to an object at
runtime, create generalized algorithms, functions, simplify event
handling, callbacks and design patterns.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org69f5c4d" class="outline-3">
<h3 id="org69f5c4d"><span class="section-number-3">1.2</span> Singleton</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Singleton is a creational design pattern where there is only a single
instance of a class and client code is forbidden from creating new
instances.
</p>

<p>
Note: Despite that there are lots of objections against this design
pattern, it is still worth knowing how it works.
</p>

<ul class="org-ul">
<li>File: <a href="src/design-patterns/singleton1.cpp">file:src/design-patterns/singleton1.cpp</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">FileRepository</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
    <span class="org-constant">std</span>::<span class="org-type">deque</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">_files</span>; 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Forbid client code instating a new instance. </span>
    <span class="org-function-name">FileRepository</span><span class="org-rainbow-delimiters-depth-2">(){}</span>  
    <span class="org-comment-delimiter">// </span><span class="org-comment">Forbid client code from creating a copy or using the</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">copy constructor.</span>
    <span class="org-function-name">FileRepository</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">FileRepository</span>&amp;<span class="org-rainbow-delimiters-depth-2">){}</span>
<span class="org-function-name">public</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">Return a reference to not allow client code </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">to delete object. </span>
    <span class="org-keyword">static</span> <span class="org-keyword">auto</span> <span class="org-function-name">getInstance</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">FileRepository</span>&amp; <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Initialized once - lazy initialization </span>
        <span class="org-keyword">static</span> <span class="org-keyword">auto</span> _instance = <span class="org-constant">std</span>::unique_ptr<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">FileRepository</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-keyword">new</span> <span class="org-type">FileRepository</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> *_instance.get<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">addFile</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">fname</span><span class="org-rainbow-delimiters-depth-2">){</span>
        _files.push_back<span class="org-rainbow-delimiters-depth-3">(</span>fname<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">clearFiles</span><span class="org-rainbow-delimiters-depth-2">(){</span>
            _files.clear<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">C++11 member function declaration looks better. </span>
    <span class="org-keyword">auto</span> <span class="org-function-name">showFiles</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">file</span>: _files<span class="org-rainbow-delimiters-depth-3">){</span>
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" File = "</span> &lt;&lt; file &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Test in CERN ROOT/Clign REPL:
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Load C++ code as it was a script.</span>
&gt;&gt; .L singleton1.cpp

<span class="org-comment-delimiter">// </span><span class="org-comment">Try to instantiate singleton object without reference. </span>
<span class="org-comment-delimiter">//</span><span class="org-comment">------------------------------------------------------</span>
&gt;&gt; FileRepository repo = <span class="org-constant">FileRepository</span>::getInstance<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-function-name">ROOT_prompt_2</span>:1:23: error: calling a <span class="org-keyword">private</span> constructor of <span class="org-keyword">class</span> <span class="org-warning">'</span>FileRepository<span class="org-warning">'</span>
FileRepository repo = <span class="org-constant">FileRepository</span>::getInstance<span class="org-rainbow-delimiters-depth-1">()</span>
                      ^
<span class="org-function-name">singleton1.cpp</span>:21:5: note: declared <span class="org-keyword">private</span> here
    FileRepository<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">FileRepository</span>&amp;<span class="org-rainbow-delimiters-depth-1">){}</span>
    ^
&gt;&gt; FileRepository&amp; repo = <span class="org-constant">FileRepository</span>::getInstance<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">FileRepository</span> &amp;<span class="org-rainbow-delimiters-depth-1">)</span> @0x2fc9640
&gt;&gt; 

&gt;&gt; FileRepository&amp; repo = <span class="org-constant">FileRepository</span>::getInstance<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">FileRepository</span> &amp;<span class="org-rainbow-delimiters-depth-1">)</span> @0x2fc9640
&gt;&gt; 

&gt;&gt; repo.showFiles<span class="org-rainbow-delimiters-depth-1">()</span>
&gt;&gt; 
&gt;&gt; repo.addFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"quarterly-sales-report.dat"</span><span class="org-rainbow-delimiters-depth-1">)</span>
&gt;&gt; repo.addFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"interest-payments.txt"</span><span class="org-rainbow-delimiters-depth-1">)</span>
&gt;&gt; repo.addFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"taxes-report.xls"</span><span class="org-rainbow-delimiters-depth-1">)</span>
&gt;&gt; repo.showFiles<span class="org-rainbow-delimiters-depth-1">()</span>
 File = quarterly-sales-report.dat
 File = interest-payments.txt
 File = taxes-report.xls
&gt;&gt; 
&gt;&gt; 

<span class="org-comment-delimiter">// </span><span class="org-comment">Try to copy object. </span>
&gt;&gt; FileRepository r = repo;
<span class="org-function-name">ROOT_prompt_9</span>:1:20: error: calling a <span class="org-keyword">private</span> constructor of <span class="org-keyword">class</span> <span class="org-warning">'</span>FileRepository<span class="org-warning">'</span>
FileRepository r = repo;
                   ^
<span class="org-function-name">singleton1.cpp</span>:21:5: note: declared <span class="org-keyword">private</span> here
    FileRepository<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">FileRepository</span>&amp;<span class="org-rainbow-delimiters-depth-1">){}</span>
    ^
&gt;&gt; 

<span class="org-comment-delimiter">// </span><span class="org-comment">Try to create a new object </span>
&gt;&gt; FileRepository&amp; repo2 = <span class="org-constant">FileRepository</span>::getInstance<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">FileRepository</span> &amp;<span class="org-rainbow-delimiters-depth-1">)</span> @0x2fc9640
&gt;&gt; repo2.showFiles<span class="org-rainbow-delimiters-depth-1">()</span>
 File = quarterly-sales-report.dat
 File = interest-payments.txt
 File = taxes-report.xls
&gt;&gt; 

<span class="org-comment-delimiter">// </span><span class="org-comment">Check whether repo and repo2 are the same object (reference equality)</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">-&gt; They are equal under reference equality criteria if they have the same address.</span>
&gt;&gt; &amp;repo == &amp;repo2
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-constant">true</span>
&gt;&gt; 
</pre>
</div>

<p>
Main function: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">FileRepository</span>&amp; <span class="org-variable-name">repo1</span> = <span class="org-constant">FileRepository</span>::getInstance<span class="org-rainbow-delimiters-depth-1">()</span>;
repo1.addFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"CashFlowStatement.txt"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
repo1.addFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Balance-Sheet.dat"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
repo1.addFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Sales-Report.csv"</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">FileRepository</span>&amp; <span class="org-variable-name">repo2</span> = <span class="org-constant">FileRepository</span>::getInstance<span class="org-rainbow-delimiters-depth-1">()</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha &lt;&lt; <span class="org-string">"Same object? (&amp;repo == &amp;repo1 ?) = "</span>
          &lt;&lt; <span class="org-rainbow-delimiters-depth-1">(</span>&amp;repo1 == &amp;repo2<span class="org-rainbow-delimiters-depth-1">)</span>
          &lt;&lt; <span class="org-string">"\n"</span>;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"Repository files"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
repo2.showFiles<span class="org-rainbow-delimiters-depth-1">()</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"Add more files"</span> &lt;&lt; <span class="org-constant">std</span>::endl;
repo2.addFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"fileX1.pdf"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
repo2.addFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"fileX2.pdf"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
repo2.addFile<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"fileX3.pdf"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
repo2.showFiles<span class="org-rainbow-delimiters-depth-1">()</span>;
</pre>
</div>

<p>
Compiling and running (<a href="src/design-patterns/singleton1.cpp">file:src/design-patterns/singleton1.cpp</a>): 
</p>

<div class="org-src-container">
<pre class="src src-txt">$ clang++ singleton1.cpp -o singleton1.bin -g -std=c++1z -Wall -Wextra 
$ ./singleton1.bin

Same object? (&amp;repo == &amp;repo1 ?) = true
Repository files
 File = CashFlowStatement.txt
 File = Balance-Sheet.dat
 File = Sales-Report.csv
Add more files
 File = CashFlowStatement.txt
 File = Balance-Sheet.dat
 File = Sales-Report.csv
 File = fileX1.pdf
 File = fileX2.pdf
 File = fileX3.pdf
</pre>
</div>
</div>
</div>
<div id="outline-container-org23794a6" class="outline-3">
<h3 id="org23794a6"><span class="section-number-3">1.3</span> Named constructor - static factory method</h3>
<div class="outline-text-3" id="text-1-3">
<p>
The named constructor or static factory design pattern uses static
methods instead of constructors for instantiating objects. This
approach has many advantages over constructor instantiation. Named
constructors are more readable than ordinary constructors and unlike
constructors, many named constructors static methods sharing the same
type signature can coexist. Another benefit is that this technique
allows objects to be instantiated in many different ways from several
different data representation.
</p>

<p>
Side note: It should not be confused with factory design pattern or
abstract factory design pattern.
</p>

<p>
Example:
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">ostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">cstdint</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">#include &lt;stdint&gt;   // WARNING - It may not be available</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Unsigned byte from 0 to 255 or 0x00 to 0xFF</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">---&gt; typedef uint8_t ubyte;</span>
<span class="org-keyword">using</span> <span class="org-type">ubyte</span> = uint8_t ; 

<span class="org-keyword">class</span> <span class="org-type">Color</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
    <span class="org-type">ubyte</span> <span class="org-variable-name">m_r</span>;
    <span class="org-type">ubyte</span> <span class="org-variable-name">m_g</span>;
    <span class="org-type">ubyte</span> <span class="org-variable-name">m_b</span>;
<span class="org-function-name">public</span>:
    <span class="org-function-name">Color</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ubyte</span> <span class="org-variable-name">red</span>, <span class="org-type">ubyte</span> <span class="org-variable-name">green</span>, <span class="org-type">ubyte</span> <span class="org-variable-name">blue</span><span class="org-rainbow-delimiters-depth-2">)</span>:
        m_r<span class="org-rainbow-delimiters-depth-2">(</span>red<span class="org-rainbow-delimiters-depth-2">)</span>, m_g<span class="org-rainbow-delimiters-depth-2">(</span>green<span class="org-rainbow-delimiters-depth-2">)</span>, m_b<span class="org-rainbow-delimiters-depth-2">(</span>blue<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{}</span>
    <span class="org-type">ubyte</span> <span class="org-function-name">red</span><span class="org-rainbow-delimiters-depth-2">(){</span>
        <span class="org-keyword">return</span> m_r;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">ubyte</span> <span class="org-function-name">blue</span><span class="org-rainbow-delimiters-depth-2">(){</span>
        <span class="org-keyword">return</span> m_b;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">ubyte</span> <span class="org-function-name">green</span><span class="org-rainbow-delimiters-depth-2">(){</span>
        <span class="org-keyword">return</span> m_g;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Named constructor or static factory method which builds the object</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">From the RGB tuple data representation </span>
    <span class="org-keyword">static</span> <span class="org-type">Color</span> <span class="org-function-name">fromRGB</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ubyte</span> <span class="org-variable-name">red</span>, <span class="org-type">ubyte</span> <span class="org-variable-name">green</span>, <span class="org-type">ubyte</span> <span class="org-variable-name">blue</span><span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-keyword">return</span> Color<span class="org-rainbow-delimiters-depth-3">(</span>red, green, blue<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Named constructor which builds Color object </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">from hexadecimal data representation </span>
    <span class="org-keyword">static</span> <span class="org-type">Color</span> <span class="org-function-name">fromHex</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">color</span><span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-type">int</span> <span class="org-variable-name">r</span> = color &amp; 0xFF;
        <span class="org-type">int</span> <span class="org-variable-name">g</span> = <span class="org-rainbow-delimiters-depth-3">(</span>color &gt;&gt; 8 <span class="org-rainbow-delimiters-depth-3">)</span> &amp; 0xFF;
        <span class="org-type">int</span> <span class="org-variable-name">b</span> = <span class="org-rainbow-delimiters-depth-3">(</span>color &gt;&gt; 16<span class="org-rainbow-delimiters-depth-3">)</span> &amp; 0xFF;
        <span class="org-keyword">return</span> Color<span class="org-rainbow-delimiters-depth-3">(</span>r, g, b<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Named constructor which builds a specific color.</span>
    <span class="org-keyword">static</span> <span class="org-type">Color</span> <span class="org-function-name">colorRED</span><span class="org-rainbow-delimiters-depth-2">(){</span>
        <span class="org-keyword">return</span> fromRGB<span class="org-rainbow-delimiters-depth-3">(</span>255, 0, 0<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">static</span> <span class="org-type">Color</span> <span class="org-function-name">colorBLUE</span><span class="org-rainbow-delimiters-depth-2">(){</span>
        <span class="org-keyword">return</span> fromRGB<span class="org-rainbow-delimiters-depth-3">(</span>0, 255, 0<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">static</span> <span class="org-type">Color</span> <span class="org-function-name">colorGREEN</span><span class="org-rainbow-delimiters-depth-2">(){</span>
        <span class="org-keyword">return</span> fromRGB<span class="org-rainbow-delimiters-depth-3">(</span>0, 0, 255<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">friend</span> <span class="org-constant">std</span>::<span class="org-type">ostream</span>&amp; <span class="org-keyword">operator</span> <span class="org-function-name">&lt;&lt;</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::<span class="org-type">ostream</span>&amp; <span class="org-variable-name">os</span>, <span class="org-keyword">const</span> <span class="org-type">Color</span>&amp; <span class="org-variable-name">c</span><span class="org-rainbow-delimiters-depth-2">){</span>
        os &lt;&lt; <span class="org-string">"Color(r = "</span>
           &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>c.m_r<span class="org-rainbow-delimiters-depth-3">)</span>
           &lt;&lt; <span class="org-string">", g = "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>c.m_g<span class="org-rainbow-delimiters-depth-3">)</span>
           &lt;&lt; <span class="org-string">", b = "</span> &lt;&lt; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">int</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>c.m_b<span class="org-rainbow-delimiters-depth-3">)</span> &lt;&lt; <span class="org-string">")"</span>;
        <span class="org-keyword">return</span> os;
    <span class="org-rainbow-delimiters-depth-2">}</span>      
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(){</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Red    = "</span> &lt;&lt; <span class="org-constant">Color</span>::colorRED<span class="org-rainbow-delimiters-depth-2">()</span>   &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Blue   = "</span> &lt;&lt; <span class="org-constant">Color</span>::colorBLUE<span class="org-rainbow-delimiters-depth-2">()</span>  &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Green  = "</span> &lt;&lt; <span class="org-constant">Color</span>::colorGREEN<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Color1 = "</span> &lt;&lt; <span class="org-constant">Color</span>::fromRGB<span class="org-rainbow-delimiters-depth-2">(</span>20, 90, 200<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Color2 = "</span> &lt;&lt; <span class="org-constant">Color</span>::fromHex<span class="org-rainbow-delimiters-depth-2">(</span>0xFF8AB5<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-constant">std</span>::cout.flush<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">return</span> 0;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<pre class="example">
Red    = Color(r = 255, g = 0, b = 0)
Blue   = Color(r = 0, g = 255, b = 0)
Green  = Color(r = 0, g = 0, b = 255)
Color1 = Color(r = 20, g = 90, b = 200)
Color2 = Color(r = 181, g = 138, b = 255)

</pre>

<p>
See: 
</p>
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/Factory_(object-oriented_programming)">Factory (object-oriented programming) - Wikipedia</a></li>
</ul>
</div>
</div>

<div id="outline-container-org69eec2a" class="outline-3">
<h3 id="org69eec2a"><span class="section-number-3">1.4</span> Factory Method</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-orgc717daa" class="outline-4">
<h4 id="orgc717daa"><span class="section-number-4">1.4.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
Factory method design pattern allows instatiating classes from a class
hierarchy without hardcoding the class name and kwnowing the class
implementation. There are many variations of this design pattern,
however the most common form is a class with method which returns an
instance of a derived class based on some input such as a number,
code, class name as string or number.
</p>

<p>
Definitions: 
</p>

<ul class="org-ul">
<li>Factory method or factory functions are any methods or functions
which returns an instance of a class or derived class.</li>
</ul>

<p>
Note: The factory design pattern in this document is the variation
which creates an instance of a set of derived classes based on some
input. 
</p>
</div>
</div>

<div id="outline-container-orgbf5ec11" class="outline-4">
<h4 id="orgbf5ec11"><span class="section-number-4">1.4.2</span> Factory Method Pattern Variations</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
Some variations: 
</p>

<ul class="org-ul">
<li><span class="underline">An ordinary function</span> whith if-else statements which returns an
instance of a set of derived  classes according to some
input.
<ul class="org-ul">
<li>Disadvantage: Adding new derived classes requires code
modification.</li>
</ul></li>

<li><span class="underline">A static method</span> with if-else statements. This is mostly used on
languages where there are not free functions or ordinary
functions.
<ul class="org-ul">
<li>Disadvantage: Requires modifying the code when new classes are
added to the hierarchy.</li>
</ul></li>

<li><span class="underline">Registry-based factory</span> (mostly known as Polymorphic Factory)- A
class contains a factory method for instantiating derived classes
based on some input and a hash table for registration of derived
classes.
<ul class="org-ul">
<li>Disadvantage: Possibly requires manual registration during the
program initialization.</li>

<li>Example:
<ul class="org-ul">
<li>Factory.register("sql",   SQLCreator)</li>
<li>Factory.register("mysql", MYSQLCreator)</li>
<li>DBDrivef driver = Factory.create("sqlite");</li>
</ul></li>
</ul></li>

<li><span class="underline">Reflection-base factory</span> - Some implementations uses reflection
registration of derived classes.
<ul class="org-ul">
<li>Disadvantage: May not be possible in languages without reflection
such as C++.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orga1e0962" class="outline-4">
<h4 id="orga1e0962"><span class="section-number-4">1.4.3</span> Sample Class Hierarchy</h4>
<div class="outline-text-4" id="text-1-4-3">
<p>
Consider the following class hierarchy: 
</p>

<ul class="org-ul">
<li>Base class</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">Base</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
   <span class="org-function-name">Base</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Destructor of base class must always be virtual </span>
    <span class="org-keyword">virtual</span> ~<span class="org-function-name">Base</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;   
    <span class="org-keyword">virtual</span> <span class="org-keyword">auto</span> <span class="org-function-name">getType</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-keyword">return</span> <span class="org-string">"Base"</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>    
   <span class="org-type">void</span> <span class="org-function-name">showType</span><span class="org-rainbow-delimiters-depth-2">(){</span>
      <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Class type = "</span> &lt;&lt; <span class="org-keyword">this</span>-&gt;getType<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-string">"\n"</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<ul class="org-ul">
<li>Derived class A</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">DerivedA</span>: <span class="org-keyword">public</span> <span class="org-type">Base</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
    <span class="org-function-name">DerivedA</span><span class="org-rainbow-delimiters-depth-2">(){}</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">getType</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>  -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">return</span> <span class="org-string">"DerivedA"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<ul class="org-ul">
<li>Derived class B</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">DerivedB</span>: <span class="org-keyword">public</span> <span class="org-type">Base</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
   <span class="org-function-name">DerivedB</span><span class="org-rainbow-delimiters-depth-2">(){}</span>
   <span class="org-keyword">auto</span> <span class="org-function-name">getType</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-keyword">return</span> <span class="org-string">"DerivedB"</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org028ae96" class="outline-4">
<h4 id="org028ae96"><span class="section-number-4">1.4.4</span> Simple factory - if-else statement</h4>
<div class="outline-text-4" id="text-1-4-4">
<p>
Note: This implementation uses a factory function instead of a factory
method. The function creates an instance of Base, DerivedA or DerivedB
based on the provided name. The problem of this implementation is that
it requires modification of the code when new derived classes are
added.
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">memory</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">smart pointers </span>

<span class="org-keyword">auto</span> <span class="org-function-name">simpleFactory</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">unique</span><span class="org-rainbow-delimiters-depth-1">&lt;</span>Base<span class="org-rainbow-delimiters-depth-1">&gt;</span> <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>name == <span class="org-string">"Base"</span><span class="org-rainbow-delimiters-depth-2">)</span>
         <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_unique<span class="org-rainbow-delimiters-depth-2">&lt;</span>Base<span class="org-rainbow-delimiters-depth-2">&gt;()</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>name == <span class="org-string">"DerivedA"</span><span class="org-rainbow-delimiters-depth-2">)</span>
         <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_unique<span class="org-rainbow-delimiters-depth-2">&lt;</span>DerivedA<span class="org-rainbow-delimiters-depth-2">&gt;()</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>name == <span class="org-string">"DerivedB"</span><span class="org-rainbow-delimiters-depth-2">)</span>
         <span class="org-keyword">return</span> <span class="org-constant">std</span>::make_unique<span class="org-rainbow-delimiters-depth-2">&lt;</span>DerivedB<span class="org-rainbow-delimiters-depth-2">&gt;()</span>;
     <span class="org-keyword">return</span> <span class="org-constant">nullptr</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

&gt;&gt; <span class="org-keyword">auto</span> base = simpleFactory<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Base"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
&gt;&gt; <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>base<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-constant">std</span>::puts<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Ok, then proceed."</span><span class="org-rainbow-delimiters-depth-2">)</span>; <span class="org-rainbow-delimiters-depth-1">}</span>
Ok, <span class="org-type">then</span> <span class="org-function-name">proceed</span>.

&gt;&gt; base-&gt;getType<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Base"</span>

&gt;&gt; <span class="org-keyword">auto</span> da = simpleFactory<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"DerivedA"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
&gt;&gt; da-&gt;getType<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"DerivedA"</span>
&gt;&gt; 
</pre>
</div>
</div>
</div>

<div id="outline-container-org88a8c90" class="outline-4">
<h4 id="org88a8c90"><span class="section-number-4">1.4.5</span> Polymorphic Factory - registry based factory</h4>
<div class="outline-text-4" id="text-1-4-5">
<p>
Despite this implementation be more complex than a factory-method
pattern implementation using if-else statement, this one doesn't
require source modification if new derived classes are added to the
hierarchy. 
</p>

<p>
The class Factory is used for instantiating derived classes of Base
class based on the class name provided as a string. The factory
methods in this class are makeUnique and makeRaw.
</p>

<ul class="org-ul">
<li>File:
<ul class="org-ul">
<li><a href="src/design-patterns/factory-pattern1.cpp">file:src/design-patterns/factory-pattern1.cpp</a></li>
</ul></li>
<li>Online Compiler:
<ul class="org-ul">
<li><a href="https://rextester.com/ILKI85678">https://rextester.com/ILKI85678</a></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">Factory</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
    <span class="org-keyword">using</span> <span class="org-type">FactoryMap</span> = <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::string, <span class="org-type">Factory</span>*<span class="org-rainbow-delimiters-depth-2">&gt;</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Force global variable to be initialized, thus it avoid</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">the inialization order fisaco. </span>
    <span class="org-keyword">static</span> <span class="org-keyword">auto</span> <span class="org-function-name">getRegister</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">FactoryMap</span>&amp; <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">static</span> FactoryMap classRegister<span class="org-rainbow-delimiters-depth-3">{}</span>;
       <span class="org-keyword">return</span> classRegister;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-function-name">public</span>: 
    <span class="org-comment-delimiter">/** </span><span class="org-comment">Register factory object of derived class */</span>
    <span class="org-keyword">static</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">registerFactory</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span>, <span class="org-type">Factory</span>* <span class="org-variable-name">factory</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">reg</span> = <span class="org-constant">Factory</span>::getRegister<span class="org-rainbow-delimiters-depth-3">()</span>;
         reg<span class="org-rainbow-delimiters-depth-3">[</span>name<span class="org-rainbow-delimiters-depth-3">]</span> = factory;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">/** </span><span class="org-comment">Show all registered classes */</span>
    <span class="org-keyword">static</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">showClasses</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Registered classes. "</span> &lt;&lt; <span class="org-string">"\n"</span>;
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =================== "</span> &lt;&lt; <span class="org-string">"\n"</span>;
         <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">pair</span>: <span class="org-constant">Factory</span>::getRegister<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>
                 <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" + "</span> &lt;&lt; pair.first &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>       
    <span class="org-comment-delimiter">/**  </span><span class="org-comment">Construct derived class returning a raw pointer */</span>
    <span class="org-keyword">static</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">makeRaw</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">Base</span>* <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-keyword">auto</span> <span class="org-variable-name">it</span> = <span class="org-constant">Factory</span>::getRegister<span class="org-rainbow-delimiters-depth-3">()</span>.find<span class="org-rainbow-delimiters-depth-3">(</span>name<span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>it != <span class="org-constant">Factory</span>::getRegister<span class="org-rainbow-delimiters-depth-4">()</span>.end<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>
                 <span class="org-keyword">return</span> it-&gt;second-&gt;construct<span class="org-rainbow-delimiters-depth-3">()</span>;
         <span class="org-keyword">return</span> <span class="org-constant">nullptr</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/** </span><span class="org-comment">Construct derived class returning an unique ptr  */</span>
    <span class="org-keyword">static</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">makeUnique</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Base</span><span class="org-rainbow-delimiters-depth-2">&gt;{</span>
        <span class="org-keyword">return</span> <span class="org-constant">std</span>::unique_ptr<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">Base</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-constant">Factory</span>::<span class="org-type">makeRaw</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Destructor </span>
    <span class="org-keyword">virtual</span>
    ~<span class="org-function-name">Factory</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;

    <span class="org-keyword">virtual</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">construct</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">Base</span>* = 0;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Concrete Factory: 
</p>

<ul class="org-ul">
<li>Template class used for creating static object which registers the
associated derived class during the program initialization before
the function main.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">DerivedClass</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">class</span> <span class="org-type">ConcreteFactory</span>: <span class="org-type">Factory</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
   <span class="org-comment-delimiter">// </span><span class="org-comment">Register this global object on the Factory register </span>
   <span class="org-function-name">ConcreteFactory</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">){</span>
      <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [TRACE] "</span> &lt;&lt; <span class="org-string">" Registered Class = "</span> &lt;&lt; name &lt;&lt; <span class="org-string">"\n"</span>;
      <span class="org-constant">Factory</span>::registerFactory<span class="org-rainbow-delimiters-depth-3">(</span>name, <span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>
   <span class="org-keyword">auto</span> <span class="org-function-name">construct</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">Base</span>* <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">DerivedClass</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>    
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Manual class registration: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Register Base class</span>
<span class="org-keyword">namespace</span> <span class="org-rainbow-delimiters-depth-1">{</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">Anonymous namespace is used to make the definitions here private to the current</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">compilation unit (current file). It is equivalent to the old C static keyword.</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">It could be placed at Base.cpp </span>
   <span class="org-type">ConcreteFactory</span><span class="org-rainbow-delimiters-depth-2">&lt;</span>Base<span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">factoryBase</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Base"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Class registration with macros:
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Macro for class registration </span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">REGISER_FACTORY</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">derivedClass</span><span class="org-rainbow-delimiters-depth-1">)</span> \
        <span class="org-keyword">namespace</span> <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-keyword">auto</span> <span class="org-variable-name">registry_</span> ## derivedClass = ConcreteFactory<span class="org-rainbow-delimiters-depth-2">&lt;</span>derivedClass<span class="org-rainbow-delimiters-depth-2">&gt;(</span>#derivedClass<span class="org-rainbow-delimiters-depth-2">)</span>;  <span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">//  </span><span class="org-comment">Registration with macro. </span>
REGISER_FACTORY<span class="org-rainbow-delimiters-depth-1">(</span>DerivedA<span class="org-rainbow-delimiters-depth-1">)</span>;
REGISER_FACTORY<span class="org-rainbow-delimiters-depth-1">(</span>DerivedB<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Main function: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-function-name">Factory</span>::showClasses<span class="org-rainbow-delimiters-depth-1">()</span>;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"\n"</span>;
<span class="org-function-name">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-1">&lt;</span>Base<span class="org-rainbow-delimiters-depth-1">&gt;</span> objBase = <span class="org-constant">Factory</span>::makeUnique<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Base"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">" type of objBase = "</span> &lt;&lt; objBase-&gt;getType<span class="org-rainbow-delimiters-depth-1">()</span> &lt;&lt; <span class="org-string">"\n"</span>;

<span class="org-function-name">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-1">&lt;</span>Base<span class="org-rainbow-delimiters-depth-1">&gt;</span> objDA = <span class="org-constant">Factory</span>::makeUnique<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"DerivedA"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">" type of derivedA = "</span> &lt;&lt; objDA-&gt;getType<span class="org-rainbow-delimiters-depth-1">()</span> &lt;&lt; <span class="org-string">"\n"</span>;

<span class="org-function-name">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-1">&lt;</span>Base<span class="org-rainbow-delimiters-depth-1">&gt;</span> objDB = <span class="org-constant">Factory</span>::makeUnique<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"DerivedB"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">" type of derivedA = "</span> &lt;&lt; objDB-&gt;getType<span class="org-rainbow-delimiters-depth-1">()</span> &lt;&lt; <span class="org-string">"\n"</span>;

<span class="org-function-name">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-1">&lt;</span>Base<span class="org-rainbow-delimiters-depth-1">&gt;</span> objDC = <span class="org-constant">Factory</span>::makeUnique<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Derived-error"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-negation-char">!</span>objDC<span class="org-rainbow-delimiters-depth-1">)</span>
   <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" ==&gt; Error: object not found in factory"</span> &lt;&lt; <span class="org-string">'\n'</span>;
</pre>
</div>

<p>
Output:
</p>

<div class="org-src-container">
<pre class="src src-txt">$ clang++ factory-pattern1.cpp -o factory-pattern1.bin -g -std=c++1z -Wall -Wextra $

$ ./factory-pattern1.bin
 [TRACE]  Registered Class = Base
 [TRACE]  Registered Class = DerivedA
 [TRACE]  Registered Class = DerivedB
 Registered classes. 
 =================== 
 + Base
 + DerivedA
 + DerivedB

 type of objBase = Base
 type of derivedA = DerivedA
 type of derivedA = DerivedB
 ==&gt; Error: object not found in factory
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbaf8f68" class="outline-4">
<h4 id="orgbaf8f68"><span class="section-number-4">1.4.6</span> Universal Polymorphic Factory</h4>
<div class="outline-text-4" id="text-1-4-6">
<p>
This customized implementation of the polymorphic factory can
instantiate objects of any type, even if they don't have the same base
class. Another feature is that the factory class doesn't need to have
any knowledge about any base class. The trick used were templates;
void* pointers for type erasure of heap-objects; static objects for
registering classes in the factory and RTTI - for generating better
error messages and making the conversion from void* to the particular
class being instantiated safer.
</p>

<ul class="org-ul">
<li>File: <a href="src/design-patterns/factory-universal1.cpp">file:src/design-patterns/factory-universal1.cpp</a></li>
<li>Online Compiler: <a href="https://rextester.com/GKEBF89553">https://rextester.com/GKEBF89553</a></li>
</ul>

<p>
The class <code>runtime_error_location</code> class is used for providing exception
with better context information with the line and the file the
exception was generated.
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#define</span> <span class="org-function-name">RUNTIME_ERROR_LOCATION</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">message</span><span class="org-rainbow-delimiters-depth-1">)</span>  \
        <span class="org-variable-name">runtime_error_location</span><span class="org-rainbow-delimiters-depth-1">(</span>__LINE__, __FILE__, message<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-keyword">struct</span> <span class="org-type">runtime_error_location</span>: <span class="org-keyword">public</span> <span class="org-constant">std</span>::<span class="org-type">exception</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-constant">std</span>::<span class="org-type">string</span>  <span class="org-variable-name">message</span>;
    <span class="org-function-name">runtime_error_location</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">text</span><span class="org-rainbow-delimiters-depth-2">)</span>
                : message<span class="org-rainbow-delimiters-depth-2">{</span>text<span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-function-name">runtime_error_location</span><span class="org-rainbow-delimiters-depth-2">(</span>
                <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">line</span>,
                <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">file</span>,
                <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">text</span>
                <span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-2">{</span>
          message = file + <span class="org-string">":"</span> + <span class="org-constant">std</span>::to_string<span class="org-rainbow-delimiters-depth-3">(</span>line<span class="org-rainbow-delimiters-depth-3">)</span> + <span class="org-string">": "</span> + <span class="org-string">"Error: "</span> + text;
        <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">what</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-keyword">noexcept</span> -&gt; <span class="org-keyword">const</span> <span class="org-type">char</span>* <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> message.c_str<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
The UniversalFactory contains the static factory methods make and makeSafe
which returns an unique_ptr to an object instantiated on the heap. If
the factory method make fails it returns a nullptr without throwing an
exception and makeSafe returns an <code>runtime_error_location</code> exception if
there is a failure to instantiate.
</p>

<p>
Once the classes are registered, objects can be instantiated with: 
</p>

<ul class="org-ul">
<li>std::unique_ptr&lt;BaseA&gt; objectD = UniversalFactory::make&lt;BaseClass&gt;("DerivedClassD");</li>
<li>std::unique_ptr&lt;BaseX&gt; object1 = UniversalFactory::make&lt;BaseClass&gt;("DerivedClassY");</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">UniversalFactory</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
      <span class="org-keyword">using</span> <span class="org-type">FactoryMap</span> = <span class="org-constant">std</span>::<span class="org-type">map</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-constant">std</span>::string, <span class="org-type">UniversalFactory</span>*<span class="org-rainbow-delimiters-depth-2">&gt;</span>;
      <span class="org-comment-delimiter">// </span><span class="org-comment">Force global variable to be initialized, thus it avoid the</span>
      <span class="org-comment-delimiter">// </span><span class="org-comment">inialization order fisaco.</span>
      <span class="org-keyword">static</span> <span class="org-keyword">auto</span> <span class="org-function-name">getRegister</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">FactoryMap</span>&amp; <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-keyword">static</span> FactoryMap classRegister<span class="org-rainbow-delimiters-depth-3">{}</span>;
         <span class="org-keyword">return</span> classRegister;
      <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-function-name">public</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">========== Instance Methods ========//</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Destructor</span>
    <span class="org-keyword">virtual</span>
    ~<span class="org-function-name">UniversalFactory</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Encapsulates class constructor.</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">The type void* performs pointer type erasure</span>
    <span class="org-keyword">virtual</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">create</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">void</span>* = 0;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Encapsulates destructor </span>
    <span class="org-keyword">virtual</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">destroy</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">void</span>* <span class="org-variable-name">object</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">void</span> = 0;

    <span class="org-keyword">virtual</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">size</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">size_t</span> = 0;

    <span class="org-keyword">virtual</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">typeinfo</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">type_info</span>&amp; = 0;

    <span class="org-comment-delimiter">// </span><span class="org-comment">========== Static Methods ========//</span>

    <span class="org-comment-delimiter">/** </span><span class="org-comment">Register factory object of derived class */</span>
    <span class="org-keyword">static</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">registerFactory</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span>, <span class="org-type">UniversalFactory</span>* <span class="org-variable-name">factory</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">reg</span> = <span class="org-constant">UniversalFactory</span>::getRegister<span class="org-rainbow-delimiters-depth-3">()</span>;
         reg<span class="org-rainbow-delimiters-depth-3">[</span>name<span class="org-rainbow-delimiters-depth-3">]</span> = factory;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">/** </span><span class="org-comment">Show all registered classes printing their name to stdout. */</span>
    <span class="org-keyword">static</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">showClasses</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" Registered classes. "</span> &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" =================== "</span> &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">pair</span>: <span class="org-constant">UniversalFactory</span>::getRegister<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>
             <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" + "</span> &lt;&lt; pair.first
                       &lt;&lt; <span class="org-string">" ; RTTI name = "</span>
                       &lt;&lt; pair.second-&gt;typeinfo<span class="org-rainbow-delimiters-depth-3">()</span>.name<span class="org-rainbow-delimiters-depth-3">()</span>
                       &lt;&lt; <span class="org-string">" ; size (bytes) = "</span>
                       &lt;&lt; pair.second-&gt;size<span class="org-rainbow-delimiters-depth-3">()</span>
                       &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/** </span><span class="org-comment">Attemp to instantiate a class, if it is not possible, returns nullptr */</span>
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">class</span> <span class="org-type">BaseClass</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-keyword">static</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">make</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">BaseClass</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
            <span class="org-type">FactoryMap</span>&amp; <span class="org-variable-name">reg</span> = <span class="org-constant">UniversalFactory</span>::getRegister<span class="org-rainbow-delimiters-depth-3">()</span>;
            <span class="org-keyword">auto</span> <span class="org-variable-name">it</span> = reg.find<span class="org-rainbow-delimiters-depth-3">(</span>name<span class="org-rainbow-delimiters-depth-3">)</span>;
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>it == reg.end<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>
                    <span class="org-keyword">return</span> <span class="org-constant">nullptr</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">Avoid core dump if the conversion is not possible.</span>
            <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>it-&gt;second-&gt;typeinfo<span class="org-rainbow-delimiters-depth-4">()</span> != <span class="org-keyword">typeid</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">BaseClass</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
                    <span class="org-keyword">return</span> <span class="org-constant">nullptr</span>;
            <span class="org-type">void</span>* <span class="org-variable-name">ptr</span> = it-&gt;second-&gt;create<span class="org-rainbow-delimiters-depth-3">()</span>;
            <span class="org-keyword">return</span> <span class="org-constant">std</span>::unique_ptr<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">BaseClass</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">BaseClass</span>*<span class="org-rainbow-delimiters-depth-4">&gt;(</span>ptr<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">/** </span><span class="org-comment">Attempt to instantiate class, if it is not possible throws an exception. */</span>
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">class</span> <span class="org-type">BaseClass</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-keyword">static</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">makeSafe</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">BaseClass</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-comment-delimiter">// </span><span class="org-comment">Throw exception for providing better context information and avoid</span>
       <span class="org-comment-delimiter">// </span><span class="org-comment">Core dump due to dangerous reinterpret_cast&lt;&gt;.</span>
       <span class="org-keyword">auto</span> <span class="org-variable-name">object</span> = <span class="org-constant">UniversalFactory</span>::make<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">BaseClass</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>name<span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>object == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">)</span>
          <span class="org-keyword">throw</span> RUNTIME_ERROR_LOCATION<span class="org-rainbow-delimiters-depth-3">(</span>
               <span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Cannot create type. Failed to cast void* to: "</span><span class="org-rainbow-delimiters-depth-4">)</span> + name<span class="org-rainbow-delimiters-depth-3">)</span>;
       <span class="org-keyword">return</span> object;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;  <span class="org-comment-delimiter">// </span><span class="org-comment">-------- End Of class UniversalFactory() ------//</span>

</pre>
</div>

<p>
The class FactoryImpl is used for creating static objects (global
objects) for registering classes in the factory during the program
initialization. This class also performs type erasure of the
constructor and destructor by using void* for allowing it to work with
any type. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">DerivedClass</span>, <span class="org-keyword">typename</span> <span class="org-type">BaseClass</span> = DerivedClass<span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">class</span> <span class="org-type">FactoryImpl</span>: <span class="org-type">UniversalFactory</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
     <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">type_info</span>&amp; <span class="org-variable-name">_tinfo</span>;
<span class="org-function-name">public</span>:
     <span class="org-comment-delimiter">// </span><span class="org-comment">Register this global object on the Factory register</span>
     <span class="org-function-name">FactoryImpl</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span>
             : _tinfo<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">typeid</span><span class="org-rainbow-delimiters-depth-3">(</span>BaseClass<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
     <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [TRACE] "</span> &lt;&lt; <span class="org-string">" Registered Class = "</span> &lt;&lt; name &lt;&lt; <span class="org-string">"\n"</span>;
         <span class="org-constant">UniversalFactory</span>::registerFactory<span class="org-rainbow-delimiters-depth-3">(</span>name, <span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Capture class default constructor =&gt; constructor type erasure </span>
     <span class="org-keyword">auto</span> <span class="org-function-name">create</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">void</span>* <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span>
             <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">DerivedClass</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-comment-delimiter">// </span><span class="org-comment">Capture destructor =&gt; Destructor type erasure </span>
     <span class="org-keyword">auto</span> <span class="org-function-name">destroy</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">void</span>* <span class="org-variable-name">object</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">void</span> <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span>
             <span class="org-keyword">delete</span> <span class="org-keyword">reinterpret_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">BaseClass</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>object<span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>  
     <span class="org-keyword">auto</span> <span class="org-function-name">typeinfo</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">type_info</span>&amp; <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span>
             <span class="org-keyword">return</span> _tinfo;
     <span class="org-rainbow-delimiters-depth-2">}</span>
     <span class="org-keyword">auto</span> <span class="org-function-name">size</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">size_t</span> <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span>
             <span class="org-keyword">return</span> <span class="org-keyword">sizeof</span><span class="org-rainbow-delimiters-depth-3">(</span>DerivedClass<span class="org-rainbow-delimiters-depth-3">)</span>;
     <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

</pre>
</div>

<p>
<b>Class Registration with static objects.</b>
</p>

<p>
Classes can be registered in the factory by creating an static
instance (static object) of the class FactoryImpl, which registers the
class or type passed as template parameter, during the object
initialization. 
</p>


<ul class="org-ul">
<li>The first template parameter is the class to be registered and the
second one is its base class. If the class to be registered, doesn't
have base class, it can omitted. The constructor argument is the name
of the class to be registered as string.</li>

<li>The anonymous namespace in this example is used for defining
internal linkage and making the static objects private or only
visible in the current compilation unit or file for avoiding name
clashes.</li>

<li>Note: The registered classes doesn't need to have a common base
class, thus it is possible to register any class as the class
NonDerived in the code below.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">namespace</span> <span class="org-rainbow-delimiters-depth-1">{</span>

   <span class="org-keyword">auto</span> <span class="org-variable-name">register_Base</span>       = FactoryImpl<span class="org-rainbow-delimiters-depth-2">&lt;</span>Base, Base<span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"Base"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-keyword">auto</span> <span class="org-variable-name">register_DerivedA</span>   = FactoryImpl<span class="org-rainbow-delimiters-depth-2">&lt;</span>DerivedA, Base<span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"DerivedA"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
   <span class="org-keyword">auto</span> <span class="org-variable-name">register_DerivedB</span>   = FactoryImpl<span class="org-rainbow-delimiters-depth-2">&lt;</span>DerivedB, Base<span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"DerivedB"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Classes without a base class doesn't need the second template paramter </span>
   <span class="org-keyword">auto</span> <span class="org-variable-name">register_NonDerived</span> = FactoryImpl<span class="org-rainbow-delimiters-depth-2">&lt;</span>NonDerived<span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-string">"NonDerived"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
The registration boilerplate can be eliminated by using macros:
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Register a non-polymorphic class -&gt; It means a class without base class </span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">REGISTER_CLASS_TO_FACTORY1</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">aclass</span><span class="org-rainbow-delimiters-depth-1">)</span> \
        <span class="org-keyword">namespace</span> <span class="org-rainbow-delimiters-depth-1">{</span>  <span class="org-keyword">auto</span> <span class="org-variable-name">register_</span> ## derived = FactoryImpl<span class="org-rainbow-delimiters-depth-2">&lt;</span>aclass, <span class="org-variable-name">aclass</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> #aclass <span class="org-rainbow-delimiters-depth-2">)</span>; <span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Register a polymorphic class to the factory.</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">REGISTER_CLASS_TO_FACTORY2</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-variable-name">derivedClass</span>, <span class="org-variable-name">baseClass</span><span class="org-rainbow-delimiters-depth-1">)</span> \
        <span class="org-keyword">namespace</span> <span class="org-rainbow-delimiters-depth-1">{</span>  <span class="org-keyword">auto</span> <span class="org-variable-name">register_</span> ## derivedClass = FactoryImpl<span class="org-rainbow-delimiters-depth-2">&lt;</span>derivedClass, <span class="org-variable-name">baseClass</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span> #derivedClass <span class="org-rainbow-delimiters-depth-2">)</span>; <span class="org-rainbow-delimiters-depth-1">}</span>

REGISTER_CLASS_TO_FACTORY2<span class="org-rainbow-delimiters-depth-1">(</span>Base, Base<span class="org-rainbow-delimiters-depth-1">)</span>;
REGISTER_CLASS_TO_FACTORY2<span class="org-rainbow-delimiters-depth-1">(</span>DerivedA, Base<span class="org-rainbow-delimiters-depth-1">)</span>;
REGISTER_CLASS_TO_FACTORY2<span class="org-rainbow-delimiters-depth-1">(</span>DerivedB, Base<span class="org-rainbow-delimiters-depth-1">)</span>;
REGISTER_CLASS_TO_FACTORY1<span class="org-rainbow-delimiters-depth-1">(</span>NonDerived<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
<b>Usage example in CERN's ROOT/Cling REPL:</b>
</p>

<p>
Load the proof-of-concept file
</p>

<div class="org-src-container">
<pre class="src src-cpp">&gt;&gt; .L factory-universal1.cpp 
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span>  Registered Class = Base
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span>  Registered Class = DerivedA
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span>  Registered Class = DerivedB
 <span class="org-rainbow-delimiters-depth-1">[</span>TRACE<span class="org-rainbow-delimiters-depth-1">]</span>  Registered Class = NonDerived
&gt;&gt; 
&gt;&gt; 
</pre>
</div>

<p>
Instantiate some classes: 
</p>

<div class="org-src-container">
<pre class="src src-cpp">&gt;&gt; <span class="org-keyword">auto</span> base = <span class="org-constant">UniversalFactory</span>::make<span class="org-rainbow-delimiters-depth-1">&lt;</span>Base<span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"Base"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span>Base, <span class="org-constant">std</span>::<span class="org-type">default_delete</span><span class="org-rainbow-delimiters-depth-3">&lt;</span>Base<span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-rainbow-delimiters-depth-2">&gt;</span> &amp;<span class="org-rainbow-delimiters-depth-1">)</span> @0x7f768c558088
&gt;&gt; 

&gt;&gt; base-&gt;getType<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"Base"</span>
&gt;&gt; 

&gt;&gt; <span class="org-keyword">auto</span> derivA = <span class="org-constant">UniversalFactory</span>::make<span class="org-rainbow-delimiters-depth-1">&lt;</span>Base<span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"DerivedA"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span>Base, <span class="org-constant">std</span>::<span class="org-type">default_delete</span><span class="org-rainbow-delimiters-depth-3">&lt;</span>Base<span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-rainbow-delimiters-depth-2">&gt;</span> &amp;<span class="org-rainbow-delimiters-depth-1">)</span> @0x7f768c5581f8

&gt;&gt; derivA-&gt;showType<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-type">Class</span> <span class="org-variable-name">type</span> = DerivedA

&gt;&gt; <span class="org-keyword">auto</span> derivB = <span class="org-constant">UniversalFactory</span>::make<span class="org-rainbow-delimiters-depth-1">&lt;</span>Base<span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"DerivedB"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span>Base, <span class="org-constant">std</span>::<span class="org-type">default_delete</span><span class="org-rainbow-delimiters-depth-3">&lt;</span>Base<span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-rainbow-delimiters-depth-2">&gt;</span> &amp;<span class="org-rainbow-delimiters-depth-1">)</span> @0x7f768c558238

&gt;&gt; derivB-&gt;showType<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-type">Class</span> <span class="org-variable-name">type</span> = DerivedB
&gt;&gt; 

<span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">cls</span> : <span class="org-rainbow-delimiters-depth-2">{</span><span class="org-string">"Base"</span>, <span class="org-string">"DerivedA"</span>, <span class="org-string">"DerivedB"</span><span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-keyword">auto</span> obj = <span class="org-constant">UniversalFactory</span>::makeSafe<span class="org-rainbow-delimiters-depth-2">&lt;</span>Base<span class="org-rainbow-delimiters-depth-2">&gt;(</span>cls<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Class ["</span> &lt;&lt; cls &lt;&lt; <span class="org-string">" ] = "</span> &lt;&lt; obj-&gt;getType<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">" \n"</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Output: </span>
Class <span class="org-rainbow-delimiters-depth-1">[</span>Base <span class="org-rainbow-delimiters-depth-1">]</span> = Base 
Class <span class="org-rainbow-delimiters-depth-1">[</span>DerivedA <span class="org-rainbow-delimiters-depth-1">]</span> = DerivedA 
Class <span class="org-rainbow-delimiters-depth-1">[</span>DerivedB <span class="org-rainbow-delimiters-depth-1">]</span> = DerivedB 
&gt;&gt; 

</pre>
</div>

<p>
Show all registered classes 
</p>

<div class="org-src-container">
<pre class="src src-cpp">&gt;&gt; <span class="org-constant">UniversalFactory</span>::showClasses<span class="org-rainbow-delimiters-depth-1">()</span>
 <span class="org-type">Registered</span> <span class="org-variable-name">classes</span>. 
 =================== 
 + Base ; <span class="org-type">RTTI</span> <span class="org-variable-name">name</span> = 4Base ; size <span class="org-rainbow-delimiters-depth-1">(</span>bytes<span class="org-rainbow-delimiters-depth-1">)</span> = 8
 + DerivedA ; <span class="org-type">RTTI</span> <span class="org-variable-name">name</span> = 4Base ; size <span class="org-rainbow-delimiters-depth-1">(</span>bytes<span class="org-rainbow-delimiters-depth-1">)</span> = 8
 + DerivedB ; <span class="org-type">RTTI</span> <span class="org-variable-name">name</span> = 4Base ; size <span class="org-rainbow-delimiters-depth-1">(</span>bytes<span class="org-rainbow-delimiters-depth-1">)</span> = 8
 + NonDerived ; <span class="org-type">RTTI</span> <span class="org-variable-name">name</span> = 10NonDerived ; size <span class="org-rainbow-delimiters-depth-1">(</span>bytes<span class="org-rainbow-delimiters-depth-1">)</span> = 1
&gt;&gt; 
</pre>
</div>

<p>
Instantiate a non-derived class: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Instantiate a non derived class of Base </span>
&gt;&gt; <span class="org-keyword">auto</span> ndc = <span class="org-constant">UniversalFactory</span>::make<span class="org-rainbow-delimiters-depth-1">&lt;</span>NonDerived<span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"NonDerived"</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span>NonDerived, <span class="org-constant">std</span>::<span class="org-type">default_delete</span><span class="org-rainbow-delimiters-depth-3">&lt;</span>NonDerived<span class="org-rainbow-delimiters-depth-3">&gt;</span> <span class="org-rainbow-delimiters-depth-2">&gt;</span> &amp;<span class="org-rainbow-delimiters-depth-1">)</span> @0x7f768c558138
&gt;&gt; 

&gt;&gt; ndc-&gt;printMessage<span class="org-rainbow-delimiters-depth-1">()</span>;
 ==&gt; I am a non derived <span class="org-keyword">class</span>
&gt;&gt; 
</pre>
</div>

<p>
Try creating a class which is not registered
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Returns a null pointer if there is a failure. </span>
&gt;&gt; <span class="org-constant">UniversalFactory</span>::make<span class="org-rainbow-delimiters-depth-1">&lt;</span>Base<span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"Error"</span><span class="org-rainbow-delimiters-depth-1">)</span> == <span class="org-constant">nullptr</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-constant">true</span>

&gt;&gt; <span class="org-constant">UniversalFactory</span>::make<span class="org-rainbow-delimiters-depth-1">&lt;</span>DerivedA<span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"Error"</span><span class="org-rainbow-delimiters-depth-1">)</span> == <span class="org-constant">nullptr</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-constant">true</span>
&gt;&gt; 

<span class="org-comment-delimiter">// </span><span class="org-comment">makeSafe throws an exception </span>
&gt;&gt; <span class="org-keyword">auto</span> dummy = <span class="org-constant">UniversalFactory</span>::makeSafe<span class="org-rainbow-delimiters-depth-1">&lt;</span>Base<span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"NonDerived"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">Error</span> <span class="org-type">in</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-constant">TRint</span>::HandleTermInput<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>: runtime_error_location caught: 
<span class="org-function-name">factory-universal1.cpp</span>:123: Error: Cannot create type. Failed to cast <span class="org-type">void</span>* to: NonDerived
&gt;&gt; 
</pre>
</div>
</div>
</div>
<div id="outline-container-org278594b" class="outline-4">
<h4 id="org278594b"><span class="section-number-4">1.4.7</span> References</h4>
<div class="outline-text-4" id="text-1-4-7">
<p>
<b>References</b>
</p>

<ul class="org-ul">
<li>Bruce Eckel - <b>Thinking in Patterns with Java</b> - Page: 53
<ul class="org-ul">
<li><a href="http://www.cs.huji.ac.il/~noam/intro2cs2001/www/TIPatterns.pdf">http://www.cs.huji.ac.il/~noam/intro2cs2001/www/TIPatterns.pdf</a></li>
</ul></li>

<li>Bruce Eckel - <b>Thinking in C++, 2nd edition, Volume 2</b>
<ul class="org-ul">
<li><a href="http://www.cs.cmu.edu/~gregjor/project/eckelbook/volume2/Chap11.htm">http://www.cs.cmu.edu/~gregjor/project/eckelbook/volume2/Chap11.htm</a></li>
</ul></li>

<li><a href="http://www.lsi.us.es/~jtorres/LibroJava/TIJ2R3-17_.html">http://www.lsi.us.es/~jtorres/LibroJava/TIJ2R3-17_.html</a></li>

<li><a href="http://www.andypatterns.com/index.php/blog/from_strategy_to_bridge/">AndyPatterns - From Strategy to Bridge</a></li>

<li><a href="http://www.thedevpiece.com/cdi-polymorphism-and-the-factory-pattern/">CDI, Polymorphism and The Factory Pattern</a></li>

<li>Design patterns - OOD Lecture 6 -
<a href="https://www.it.uu.se/edu/course/homepage/ood/ht12/overview/patterns/Lecture6.pdf">https://www.it.uu.se/edu/course/homepage/ood/ht12/overview/patterns/Lecture6.pdf</a></li>

<li>Creational Patterns for Variability
<ul class="org-ul">
<li><a href="http://www-st.inf.tu-dresden.de/Lehre/WS04-05/dpf/slides/2b-creational-variability-2p.pdf">http://www-st.inf.tu-dresden.de/Lehre/WS04-05/dpf/slides/2b-creational-variability-2p.pdf</a></li>
</ul></li>

<li>the Factory Design Pattern -
<a href="https://cs.anu.edu.au/courses/comp2500/notes/15factory.slides.pdf">https://cs.anu.edu.au/courses/comp2500/notes/15factory.slides.pdf</a></li>

<li>Design Patterns as Quality Influencing Factor in Object Oriented
Design Approach - <a href="https://arxiv.org/pdf/1402.2372.pdf">https://arxiv.org/pdf/1402.2372.pdf</a></li>

<li><a href="https://www.journaldev.com/1392/factory-design-pattern-in-java">Factory Design Pattern in Java - JournalDev</a></li>

<li><a href="https://industriallogic.com/xp/refactoring/polymorphicCreationFactory.html">Introduce Polymorphic Creation with Factory Method</a></li>

<li>Factory Method -
<a href="https://www.dofactory.com/net/factory-method-design-pattern">https://www.dofactory.com/net/factory-method-design-pattern</a></li>
</ul>

<p>
<b>Further Reading</b> 
</p>

<ul class="org-ul">
<li><b>Doing something on shared library initialization</b>
<ul class="org-ul">
<li><a href="http://zerohour.net/~reed/dylib_init.html">http://zerohour.net/~reed/dylib_init.html</a></li>
</ul></li>

<li><b>Factory Design Pattern in C++</b>
<ul class="org-ul">
<li><a href="http://blog.fourthwoods.com/2011/06/04/factory-design-pattern-in-c/">http://blog.fourthwoods.com/2011/06/04/factory-design-pattern-in-c/</a></li>
</ul></li>

<li><b>Abstract Factory Step-by-Step Implementation in C++</b>
<ul class="org-ul">
<li><a href="http://www.dorodnic.com/blog/2014/03/29/abstract-factory/">http://www.dorodnic.com/blog/2014/03/29/abstract-factory/</a></li>
</ul></li>

<li><b>Sutter's Mill - GotW #90 Solution: Factories</b>
<ul class="org-ul">
<li><a href="https://herbsutter.com/2013/05/30/gotw-90-solution-factories/">https://herbsutter.com/2013/05/30/gotw-90-solution-factories/</a></li>
</ul></li>

<li><b>Unforgettable Factory Registration</b>
<ul class="org-ul">
<li><a href="http://www.nirfriedman.com/2018/04/29/unforgettable-factory/">http://www.nirfriedman.com/2018/04/29/unforgettable-factory/</a></li>
</ul></li>

<li><b>C++: Factory With Self-Registering Types</b>
<ul class="org-ul">
<li><a href="https://dzone.com/articles/factory-with-self-registering-types">https://dzone.com/articles/factory-with-self-registering-types</a></li>
</ul></li>

<li><b>Object Factories in a Static Library</b>
<ul class="org-ul">
<li><a href="http://www.sourcexr.com/articles/2014/06/21/object-factory-in-a-static-library">http://www.sourcexr.com/articles/2014/06/21/object-factory-in-a-static-library</a></li>
</ul></li>

<li><b>Automatic object factory in C++</b>
<ul class="org-ul">
<li><a href="https://blog.noctua-software.com/object-factory-c++.html">https://blog.noctua-software.com/object-factory-c++.html</a></li>
</ul></li>

<li><b>Self Registering Classes - Taking polymorphism to the limit</b>
<ul class="org-ul">
<li><a href="https://accu.org/index.php/journals/597">https://accu.org/index.php/journals/597</a></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org00d0337" class="outline-3">
<h3 id="org00d0337"><span class="section-number-3">1.5</span> Builder (Joshua Blosh)</h3>
<div class="outline-text-3" id="text-1-5">
<p>
The purpose of the builder design pattern proposed by Joshua Bloch is
to simplify the instantiation of objects with many constructor
parameters or many optional parameters. Note: it should not be
confused with the GOF (Gang of Four) builder pattern.
</p>

<p>
Example: 
</p>

<ul class="org-ul">
<li>File: builder.cpp</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Joshua Bloch's Builder Pattern for simplifying the instantiation</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">of objects with many constructor parameters. It is not the</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">GOF (Gang of Four) builder pattern. </span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Function meta object </span>
<span class="org-keyword">class</span> <span class="org-type">UserData</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
        <span class="org-keyword">using</span> <span class="org-type">ulong</span> = <span class="org-type">unsigned</span> <span class="org-type">long</span>;
<span class="org-function-name">private</span>:
        <span class="org-type">ulong</span>          <span class="org-variable-name">_userID</span> = 0;
        <span class="org-constant">std</span>::<span class="org-type">string</span>    <span class="org-variable-name">_name</span>;
        <span class="org-constant">std</span>::<span class="org-type">string</span>    <span class="org-variable-name">_lastName</span>;
        <span class="org-constant">std</span>::<span class="org-type">string</span>    <span class="org-variable-name">_email</span>;
        <span class="org-function-name">UserData</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
<span class="org-function-name">public</span>:
        <span class="org-comment-delimiter">// </span><span class="org-comment">Explicit is better than implicit </span>
        ~<span class="org-function-name">UserData</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;

        <span class="org-keyword">auto</span> <span class="org-function-name">show</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">void</span>
        <span class="org-rainbow-delimiters-depth-2">{</span>
            <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\nUser{"</span>
                      &lt;&lt; <span class="org-string">"\n"</span> &lt;&lt; <span class="org-string">"  id        = "</span> &lt;&lt; _userID
                      &lt;&lt; <span class="org-string">"\n"</span> &lt;&lt; <span class="org-string">"  name      = "</span> &lt;&lt; _name
                      &lt;&lt; <span class="org-string">"\n"</span> &lt;&lt; <span class="org-string">"  last name = "</span> &lt;&lt; _lastName
                      &lt;&lt; <span class="org-string">"\n"</span> &lt;&lt; <span class="org-string">"  email     = "</span> &lt;&lt; _email
                      &lt;&lt; <span class="org-string">"\n"</span> &lt;&lt; <span class="org-string">"}"</span>
                      &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>

        <span class="org-comment-delimiter">// </span><span class="org-comment">Allow builder class access UserData's private data</span>
        <span class="org-keyword">friend</span> <span class="org-keyword">class</span> <span class="org-type">UserBuilder</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>; <span class="org-comment-delimiter">//</span><span class="org-comment">--- EoF class UserData --- //</span>

<span class="org-keyword">class</span> <span class="org-type">UserBuilder</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
        <span class="org-comment-delimiter">//</span><span class="org-comment">class UserData;</span>
        <span class="org-type">UserData</span> <span class="org-variable-name">_data</span><span class="org-rainbow-delimiters-depth-2">{}</span>;
<span class="org-function-name">public</span>:
        <span class="org-function-name">UserBuilder</span><span class="org-rainbow-delimiters-depth-2">(){</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">_data = UserData();</span>
        <span class="org-rainbow-delimiters-depth-2">}</span>       
        <span class="org-keyword">auto</span> <span class="org-function-name">setID</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">ulong</span> <span class="org-variable-name">userID</span> <span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">UserBuilder</span>&amp; <span class="org-rainbow-delimiters-depth-2">{</span>
           _data._userID = userID;
           <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-keyword">auto</span> <span class="org-function-name">setName</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">UserBuilder</span>&amp; <span class="org-rainbow-delimiters-depth-2">{</span>
            _data._name = name;
            <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-keyword">auto</span> <span class="org-function-name">setLastName</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">UserBuilder</span>&amp; <span class="org-rainbow-delimiters-depth-2">{</span>
            _data._lastName = name;
            <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-keyword">auto</span> <span class="org-function-name">setEmail</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">email</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">UserBuilder</span>&amp; <span class="org-rainbow-delimiters-depth-2">{</span>
           _data._email = email;
           <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-keyword">auto</span> <span class="org-function-name">build</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">UserData</span> <span class="org-rainbow-delimiters-depth-2">{</span>
           <span class="org-keyword">return</span> <span class="org-keyword">this</span>-&gt;_data;
        <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>; <span class="org-comment-delimiter">//</span><span class="org-comment">--- EoF class UserData::builder --- //</span>

<span class="org-type">int</span> <span class="org-function-name">main</span><span class="org-rainbow-delimiters-depth-1">(){</span>
    <span class="org-keyword">auto</span> <span class="org-variable-name">user0</span> =
            UserBuilder<span class="org-rainbow-delimiters-depth-2">()</span>
            .setID<span class="org-rainbow-delimiters-depth-2">(</span>2065<span class="org-rainbow-delimiters-depth-2">)</span>
            .setName<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"John"</span><span class="org-rainbow-delimiters-depth-2">)</span>
            .setLastName<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Von Neumman"</span><span class="org-rainbow-delimiters-depth-2">)</span>
            .setEmail<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"nx098774a@sknmap.co"</span><span class="org-rainbow-delimiters-depth-2">)</span>
            .build<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">user1</span> =
            UserBuilder<span class="org-rainbow-delimiters-depth-2">()</span>
            .setID<span class="org-rainbow-delimiters-depth-2">(</span>1065<span class="org-rainbow-delimiters-depth-2">)</span>
            .setName<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Enrico"</span><span class="org-rainbow-delimiters-depth-2">)</span>
            .setLastName<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Fermi"</span><span class="org-rainbow-delimiters-depth-2">)</span>
            .setEmail<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"dummyEmail@service1.co.uk"</span><span class="org-rainbow-delimiters-depth-2">)</span>
            .build<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">auto</span> <span class="org-variable-name">user2</span> =
            UserBuilder<span class="org-rainbow-delimiters-depth-2">()</span>
            .setID<span class="org-rainbow-delimiters-depth-2">(</span>2001<span class="org-rainbow-delimiters-depth-2">)</span>
            .setName<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Stanislaw"</span><span class="org-rainbow-delimiters-depth-2">)</span>
            .setLastName<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Ulam"</span><span class="org-rainbow-delimiters-depth-2">)</span>
            .setEmail<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"wsx752@couk.com.sk"</span><span class="org-rainbow-delimiters-depth-2">)</span>
            .build<span class="org-rainbow-delimiters-depth-2">()</span>;
    user0.show<span class="org-rainbow-delimiters-depth-2">()</span>;
    user1.show<span class="org-rainbow-delimiters-depth-2">()</span>;       
    user2.show<span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-keyword">return</span> EXIT_SUCCESS;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ builder.cpp -o <span class="org-keyword">builder.bin</span> -g -std=c++1z -Wall -Wextra &amp;&amp; ./builder.bin
User{
  id        = 2065
  name      = John
  last name = Von Neumman
  email     = nx098774a@sknmap.co
}

User{
  id        = 1065
  name      = Enrico
  last name = Fermi
  email     = dummyEmail@service1.co.uk
}

User{
  id        = 2001
  name      = Stanislaw
  last name = Ulam
  email     = wsx752@couk.com.sk
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org6fa277e" class="outline-3">
<h3 id="org6fa277e"><span class="section-number-3">1.6</span> Strategy</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-org065bce2" class="outline-4">
<h4 id="org065bce2"><span class="section-number-4">1.6.1</span> Overview</h4>
<div class="outline-text-4" id="text-1-6-1">
<p>
Intent: A behavioral design pattern from GOF which allows the client
code to select and change an algorithm encapsulated as an object at
runtime.
</p>

<p>
Note: this design pattern is similar to a callback and can be
simplified with functional programming. 
</p>

<p>
<b>Parts:</b>
</p>

<ul class="org-ul">
<li><span class="underline">Context</span>:
<ul class="org-ul">
<li>Object that has a reference to an strategy objects and sets the
strategy at runtime.</li>
<li>Resposibilities:
<ul class="org-ul">
<li>Set strategy</li>
<li>Change strategy</li>
<li>Invoke strategy</li>
</ul></li>
</ul></li>

<li><span class="underline">IStrategy</span>: (Algorithm interface)
<ul class="org-ul">
<li>Strategt interface define the algorithm operations.</li>
</ul></li>

<li><span class="underline">Concrete strategy</span>.
<ul class="org-ul">
<li>Strategies objects or implementation of IStrategy class.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org330fb8d" class="outline-4">
<h4 id="org330fb8d"><span class="section-number-4">1.6.2</span> Example</h4>
<div class="outline-text-4" id="text-1-6-2">
<p>
Code: 
</p>
<ul class="org-ul">
<li>File: <a href="src/design-patterns/strategy-pattern1.cpp">file:src/design-patterns/strategy-pattern1.cpp</a></li>
<li>Online Compiler: <a href="https://rextester.com/WQO93455">https://rextester.com/WQO93455</a></li>
</ul>

<p>
Strategy interface: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Strategy interface </span>
<span class="org-keyword">struct</span> <span class="org-type">IStrategy</span><span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">virtual</span> ~<span class="org-function-name">IStrategy</span><span class="org-rainbow-delimiters-depth-2">(){}</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">Essential: Algorithm encapsulated by strategy object </span>
  <span class="org-keyword">virtual</span> <span class="org-keyword">auto</span> <span class="org-function-name">compute</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span>, <span class="org-type">double</span> <span class="org-variable-name">y</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">double</span> = 0;  
  <span class="org-comment-delimiter">// </span><span class="org-comment">Optional: Provides strategy metadata </span>
  <span class="org-keyword">virtual</span> <span class="org-keyword">auto</span> <span class="org-function-name">name</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span> = 0;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Clone this object (Note: This is a virtual constructor)</span>
  <span class="org-keyword">virtual</span> <span class="org-keyword">auto</span> <span class="org-function-name">clone</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">IStrategy</span>* = 0;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Context Class: 
</p>
<ul class="org-ul">
<li>Selects and switch the strategy (aka algorithm).</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">Context</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>: 
  <span class="org-constant">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span>IStrategy<span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">_strategy</span>;
<span class="org-function-name">public</span>:
  <span class="org-function-name">Context</span><span class="org-rainbow-delimiters-depth-2">()</span>
    : _strategy<span class="org-rainbow-delimiters-depth-2">{</span><span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-function-name">Context</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IStrategy</span>* <span class="org-variable-name">s</span><span class="org-rainbow-delimiters-depth-2">)</span>
    : _strategy<span class="org-rainbow-delimiters-depth-2">{</span>s<span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-function-name">Context</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">IStrategy</span>&amp; <span class="org-variable-name">s</span><span class="org-rainbow-delimiters-depth-2">)</span>
    : _strategy<span class="org-rainbow-delimiters-depth-2">{</span>s.clone<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">auto</span> <span class="org-function-name">setStrategy</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IStrategy</span>* <span class="org-variable-name">s</span><span class="org-rainbow-delimiters-depth-2">){</span>
    _strategy.reset<span class="org-rainbow-delimiters-depth-3">(</span>s<span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">auto</span> <span class="org-function-name">setStrategy</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">IStrategy</span>&amp; <span class="org-variable-name">s</span><span class="org-rainbow-delimiters-depth-2">){</span>
    _strategy.reset<span class="org-rainbow-delimiters-depth-3">(</span>s.clone<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>  
  <span class="org-keyword">auto</span> <span class="org-function-name">compute</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span>, <span class="org-type">double</span> <span class="org-variable-name">y</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>_strategy == <span class="org-constant">nullptr</span><span class="org-rainbow-delimiters-depth-3">)</span>
      <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: strategy not set"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-type">double</span> <span class="org-variable-name">result</span> = _strategy-&gt;compute<span class="org-rainbow-delimiters-depth-3">(</span>x, y<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" strategy = "</span> &lt;&lt; _strategy-&gt;name<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-string">" "</span>
              &lt;&lt; <span class="org-string">"( x = "</span> &lt;&lt; x &lt;&lt; <span class="org-string">" ; "</span>
              &lt;&lt; <span class="org-string">"y = "</span> &lt;&lt; y &lt;&lt; <span class="org-string">" )"</span>
              &lt;&lt; <span class="org-string">"\n"</span> ;
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Result = "</span> &lt;&lt; result &lt;&lt; <span class="org-string">"\n"</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Concrete strategies: 
</p>

<ul class="org-ul">
<li>add =&gt; algorithm which adds two numbers.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">AddStrategy</span>: <span class="org-keyword">public</span> <span class="org-type">IStrategy</span> <span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
  <span class="org-keyword">auto</span> <span class="org-function-name">name</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-string">"add"</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">auto</span> <span class="org-function-name">compute</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span>, <span class="org-type">double</span> <span class="org-variable-name">y</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">double</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> x + y;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">auto</span> <span class="org-function-name">clone</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">IStrategy</span>* <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [TRACE] AddStrategy =&gt; I was cloned"</span> &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">AddStrategy</span><span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<ul class="org-ul">
<li>Multiplication</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">struct</span> <span class="org-type">MulStrategy</span>: <span class="org-keyword">public</span> <span class="org-type">IStrategy</span> <span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
  <span class="org-keyword">auto</span> <span class="org-function-name">name</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-string">"mul"</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>  
  <span class="org-type">double</span> <span class="org-function-name">compute</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span>, <span class="org-type">double</span> <span class="org-variable-name">y</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> x + y;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">auto</span> <span class="org-function-name">clone</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">IStrategy</span>* <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [TRACE] MulStrategy =&gt; I was cloned"</span> &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">MulStrategy</span><span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>  
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<ul class="org-ul">
<li>Linear Combination:</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">struct</span> <span class="org-type">LinearCombStrategy</span>: <span class="org-keyword">public</span> <span class="org-type">IStrategy</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-type">double</span> <span class="org-variable-name">a</span>, <span class="org-variable-name">b</span>, <span class="org-variable-name">c</span>;
  <span class="org-function-name">LinearCombStrategy</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">a</span>, <span class="org-type">double</span> <span class="org-variable-name">b</span>, <span class="org-type">double</span> <span class="org-variable-name">c</span><span class="org-rainbow-delimiters-depth-2">)</span>
    : a<span class="org-rainbow-delimiters-depth-2">(</span>a<span class="org-rainbow-delimiters-depth-2">)</span>, b<span class="org-rainbow-delimiters-depth-2">(</span>b<span class="org-rainbow-delimiters-depth-2">)</span>, c<span class="org-rainbow-delimiters-depth-2">(</span>c<span class="org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-2">{</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">auto</span> <span class="org-function-name">name</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span><span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class="org-string">"Linear combination a * x + b * y + c"</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>    
  <span class="org-keyword">auto</span> <span class="org-function-name">compute</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span>, <span class="org-type">double</span> <span class="org-variable-name">y</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> a * x + b * y + c;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">auto</span> <span class="org-function-name">clone</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-type">IStrategy</span>* <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" [TRACE] LinearCombStrategy =&gt; I was cloned"</span> &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">LinearCombStrategy</span><span class="org-rainbow-delimiters-depth-3">(</span>*<span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>  
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Main function: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">Context</span> <span class="org-variable-name">ctx</span>;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"==== Strategy = add ===="</span> &lt;&lt; <span class="org-string">"\n"</span>;
ctx.setStrategy<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">new</span> <span class="org-type">AddStrategy</span><span class="org-rainbow-delimiters-depth-1">)</span>;
ctx.compute<span class="org-rainbow-delimiters-depth-1">(</span>3.0, 4.0<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"==== Strategy = mul ===="</span> &lt;&lt; <span class="org-string">"\n"</span>;
ctx.setStrategy<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">new</span> <span class="org-type">MulStrategy</span><span class="org-rainbow-delimiters-depth-1">)</span>;
ctx.compute<span class="org-rainbow-delimiters-depth-1">(</span>3.0, 4.0<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"==== Strategy = Linear combination ===="</span> &lt;&lt; <span class="org-string">"\n"</span>;
ctx.setStrategy<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">new</span> <span class="org-type">LinearCombStrategy</span><span class="org-rainbow-delimiters-depth-2">(</span>5, 3, 4<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>;
ctx.compute<span class="org-rainbow-delimiters-depth-1">(</span>3.0, 4.0<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"==== Strategy = Linear combination [2] ===="</span> &lt;&lt; <span class="org-string">"\n"</span>;
<span class="org-keyword">auto</span> <span class="org-variable-name">comb1</span> = LinearCombStrategy<span class="org-rainbow-delimiters-depth-1">(</span>6.0, 5.0, 10.0<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Copy stack-allocated object comb1 using the virtual constructor</span>
ctx.setStrategy<span class="org-rainbow-delimiters-depth-1">(</span>comb1<span class="org-rainbow-delimiters-depth-1">)</span>;
ctx.compute<span class="org-rainbow-delimiters-depth-1">(</span>5.0, 3.0<span class="org-rainbow-delimiters-depth-1">)</span>;  

<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"==== Strategy = Linear combination [2] ===="</span> &lt;&lt; <span class="org-string">"\n"</span>;  
<span class="org-comment-delimiter">// </span><span class="org-comment">Copy stack-allocated temporary object comb1 using the virtual constructor</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">clone</span>
ctx.setStrategy<span class="org-rainbow-delimiters-depth-1">(</span>LinearCombStrategy<span class="org-rainbow-delimiters-depth-2">{</span>6.0, 5.0, 10.0<span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>;
ctx.compute<span class="org-rainbow-delimiters-depth-1">(</span>2.0, 6.0<span class="org-rainbow-delimiters-depth-1">)</span>;  
</pre>
</div>

<p>
Output: 
</p>

<div class="org-src-container">
<pre class="src src-txt">$ clang++ strategy-pattern1.cpp -o strategy-pattern1.bin -g -std=c++1z -Wall -Wextra 
$ ./strategy-pattern1.bin
==== Strategy = add ====
 strategy = add ( x = 3 ; y = 4 )
Result = 7
==== Strategy = mul ====
 strategy = mul ( x = 3 ; y = 4 )
Result = 7
==== Strategy = Linear combination ====
 strategy = Linear combination a * x + b * y + c ( x = 3 ; y = 4 )
Result = 31
==== Strategy = Linear combination [2] ====
 [TRACE] LinearCombStrategy =&gt; I was cloned
 strategy = Linear combination a * x + b * y + c ( x = 5 ; y = 3 )
Result = 55
==== Strategy = Linear combination [2] ====
 [TRACE] LinearCombStrategy =&gt; I was cloned
 strategy = Linear combination a * x + b * y + c ( x = 2 ; y = 6 )
Result = 52

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org256e402" class="outline-3">
<h3 id="org256e402"><span class="section-number-3">1.7</span> Method Chaining - Fluent API</h3>
<div class="outline-text-3" id="text-1-7">
<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">CharacterSuperMutant</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
    <span class="org-type">double</span> <span class="org-variable-name">m_x</span>;
    <span class="org-type">double</span> <span class="org-variable-name">m_y</span>;
    <span class="org-type">double</span> <span class="org-variable-name">m_z</span>;
<span class="org-function-name">public</span>:
    <span class="org-type">CharacterSuperMutant</span>&amp; <span class="org-function-name">setX</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">){</span>
        m_x = x;
        <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">CharacterSuperMutant</span>&amp; <span class="org-function-name">setPosition</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span>, <span class="org-type">double</span> <span class="org-variable-name">y</span>, <span class="org-type">double</span> <span class="org-variable-name">z</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">auto</span> <span class="org-function-name">setColor</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">COLOR</span> <span class="org-variable-name">color</span><span class="org-rainbow-delimiters-depth-2">){</span>
        ... ....
        <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">C++ 11 </span>
    <span class="org-keyword">auto</span> <span class="org-function-name">setForce</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">force</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">CharacterSuperMutant</span>&amp; <span class="org-rainbow-delimiters-depth-2">{</span>
        ... ... 
        <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>   

    <span class="org-comment-delimiter">// </span><span class="org-comment">Method / member function declaration, the implemention is in a different file.</span>
    <span class="org-type">CharacterSuperMutant</span>&amp; <span class="org-constant">CharacterSuperMutant</span>::<span class="org-function-name">setPosition</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span>, <span class="org-type">double</span> <span class="org-variable-name">y</span>, <span class="org-type">double</span> <span class="org-variable-name">z</span><span class="org-rainbow-delimiters-depth-2">)</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">C++11 </span>
    <span class="org-keyword">auto</span> <span class="org-constant">CharacterSuperMutant</span>::<span class="org-function-name">setStamina</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span>, <span class="org-type">double</span> <span class="org-variable-name">y</span>, <span class="org-type">double</span> <span class="org-variable-name">z</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">CharacterSuperMutant</span>&amp;;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Example: Method implemented separated from class declaration in .cpp file.</span>
<span class="org-type">CharacterSuperMutant</span>&amp; <span class="org-constant">CharacterSuperMutant</span>::<span class="org-function-name">setPosition</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span>, <span class="org-type">double</span> <span class="org-variable-name">y</span>, <span class="org-type">double</span> <span class="org-variable-name">z</span><span class="org-rainbow-delimiters-depth-1">){</span>
    m_x = x; m_y = y; m_z  = z;
    <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">C++11 auto syntax </span>
<span class="org-keyword">auto</span> <span class="org-constant">CharacterSuperMutant</span>::<span class="org-function-name">setStamina</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span>, <span class="org-type">double</span> <span class="org-variable-name">y</span>, <span class="org-type">double</span> <span class="org-variable-name">z</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">CharacterSuperMutant</span>&amp; <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">... ... ... </span>
    <span class="org-keyword">return</span> *<span class="org-keyword">this</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
Usage: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">CharacterSuperMutant</span> <span class="org-variable-name">mutant1</span>;
mutant1.setForce<span class="org-rainbow-delimiters-depth-1">(</span>1000<span class="org-rainbow-delimiters-depth-1">)</span>.setColor<span class="org-rainbow-delimiters-depth-1">(</span>BLUE<span class="org-rainbow-delimiters-depth-1">)</span>.setPosition<span class="org-rainbow-delimiters-depth-1">(</span>x<span class="org-rainbow-delimiters-depth-1">)</span>.show<span class="org-rainbow-delimiters-depth-1">()</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Instead of:</span>
mutant1.setForce<span class="org-rainbow-delimiters-depth-1">(</span>1000<span class="org-rainbow-delimiters-depth-1">)</span>
mutant1.setColor<span class="org-rainbow-delimiters-depth-1">(</span>BLUE<span class="org-rainbow-delimiters-depth-1">)</span>
mutant1.setPosition<span class="org-rainbow-delimiters-depth-1">(</span>x<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb5b15dc" class="outline-3">
<h3 id="orgb5b15dc"><span class="section-number-3">1.8</span> GOF - Template Pattern</h3>
<div class="outline-text-3" id="text-1-8">
<p>
It is stated by GOF as: "Defines the skeleton of an algorithm in a
method, deferring some steps to subclasses. Template Method lets
subclasses redefine certain steps of an algorithm without changing the
algorithms structure."
</p>

<ul class="org-ul">
<li>Intent: Create an algorithm template that allows redefine some
steps without changing its structure.</li>
</ul>

<p>
The parent abstract class has four different types of methods:
</p>
<ul class="org-ul">
<li><span class="underline">Concrete methods</span>: Methods implemented in the abstract class.</li>

<li><span class="underline">Abstract methods</span>: Methods without implementation that must be
implemented by subclasses.</li>

<li><span class="underline">Hook methods</span>: Methods with default implementation that can be
overriden by subclasses.</li>

<li><span class="underline">Template methods</span>: Method that calls concrete methods, abstract
methods or hook methods.</li>
</ul>

<p>
Participants: 
</p>
<ul class="org-ul">
<li><span class="underline">Base Class</span>: Defines an algorithm which calls primitive methods (aka
hook methods) that will be defined by the derived classes.</li>
<li><span class="underline">Derived Class</span>: Implements primitive methods (virtual methods or
methods that can be overriden) defined in the <span class="underline">base class</span>.</li>
</ul>

<p>
Features: 
</p>
<ul class="org-ul">
<li>The base class defines an algorithm stub, however some steps are
required to be implemented by the derived class.</li>
<li>This pattern provides an <span class="underline">inverse control structure</span>, the algorithm
defined in the base class which calls the primitive methods which
are algorithm steps declared in the base class.</li>
<li>This pattern can be the base of an framework.</li>
</ul>

<p>
Example: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">IntervalSummation</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">Algorithm or entry point which calls the derived class method.</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">This is the template method </span>
 <span class="org-type">double</span> <span class="org-function-name">summation</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">lower</span>, <span class="org-type">int</span> <span class="org-variable-name">upper</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span><span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-type">double</span> <span class="org-variable-name">sum</span> = 0;
         <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = lower; i &lt;= upper; i++<span class="org-rainbow-delimiters-depth-3">)</span>
                 sum += <span class="org-keyword">this</span>-&gt;stepFn<span class="org-rainbow-delimiters-depth-3">(</span>i<span class="org-rainbow-delimiters-depth-3">)</span>;
         <span class="org-keyword">return</span> sum; 
 <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-function-name">protected</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">Hook method or to be defined by the derived class</span>
    <span class="org-keyword">virtual</span> <span class="org-type">double</span> <span class="org-function-name">stepFn</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> = 0 ;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">class</span> <span class="org-type">SumOfSquares</span>: <span class="org-keyword">public</span> <span class="org-type">IntervalSummation</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
    <span class="org-type">double</span> <span class="org-function-name">stepFn</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> x * x; <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">class</span> <span class="org-type">SumOfCubes</span>: <span class="org-keyword">public</span> <span class="org-type">IntervalSummation</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
    <span class="org-type">double</span> <span class="org-function-name">stepFn</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> x * x * x; <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">void</span> <span class="org-function-name">clientCode</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">IntervalSummation</span>&amp; <span class="org-variable-name">obj</span><span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Summation at [0, 15] = "</span> &lt;&lt; obj.summation<span class="org-rainbow-delimiters-depth-2">(</span>0, 15<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
Running in CERN's ROOT REPL:
</p>

<div class="org-src-container">
<pre class="src src-sh">&gt;&gt; sq.summation(0, 10)
(double) 385.00000

&gt;&gt; sc.summation(0, 10)
(double) 3025.0000

&gt;&gt; clientCode(sq)
Summation at [0, 15] = 1240

&gt;&gt; clientCode(sc)
Summation at [0, 15] = 14400
&gt;&gt; 
</pre>
</div>

<p>
References: 
</p>

<ul class="org-ul">
<li>Template Method, Factory Method, and Composite. -
<a href="http://condor.depaul.edu/cjones1/depaul/se455/notes/lecture07.pdf">http://condor.depaul.edu/cjones1/depaul/se455/notes/lecture07.pdf</a></li>
<li>Template Method - <a href="http://cs.unb.ca/~wdu/cs4015/ch5k.pdf">http://cs.unb.ca/~wdu/cs4015/ch5k.pdf</a></li>
<li>Encapsulating Algorithms with the Template Method Design Pattern -
<a href="https://redlich.net/pdf/publications/jupitermedia/template.pdf">https://redlich.net/pdf/publications/jupitermedia/template.pdf</a></li>
<li>Template Method Design Pattern in Java -
<a href="https://www.journaldev.com/1763/template-method-design-pattern-in-java">https://www.journaldev.com/1763/template-method-design-pattern-in-java</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgd31d742" class="outline-3">
<h3 id="orgd31d742"><span class="section-number-3">1.9</span> Null-Object Pattern</h3>
<div class="outline-text-3" id="text-1-9">
<p>
An object, called nulll object, which doesn't do anything and has
empty methods implementing a required interface by the client code is
used to convey the absense of an ordinary object instead of null or
null pointer.
</p>

<p>
Example: in a database system, instead of returning null, null
reference or null pointer for an not found employee object, an empty
object, called null object, with an empty mehtods is returned. It has
the advantage of avoiding null exception that can crash unexpectdely a
program. Another problem of null or null pointers is that null bugs
cannot be caught at compile-time and are also known to be hard to
debug and trace.
</p>

<p>
Alternatives: 
</p>
<ul class="org-ul">
<li>Throw an exception when there is the absense of an object. For
instance, std::runtime_error("Error: record not found.").</li>
<li>Use optional type (Haskell's maybe) or C++17 Optional.</li>
<li>Return a pointer that is set to null for denoting the absence of an
object. This pattern is widely used by many C and C++
codes. However it is prone for the infamous null pointer exception
problems.</li>
</ul>

<blockquote>
<p>
A Null Object provides a surrogate for another object that shares
the same interface but does nothing. Thus, the Null Object
encapsulates the implementation decisions of how to do nothing and
hides those details from its collaborators.
  &#x2013; Bobby Woolf in [PLoP3]
</p>
</blockquote>

<p>
Code Example:
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Interface </span>
<span class="org-keyword">class</span> <span class="org-type">ICompany</span><span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-keyword">virtual</span> <span class="org-type">unsigned</span>    <span class="org-function-name">getID</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>       = 0;    
        <span class="org-keyword">virtual</span> <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>     = 0;
        <span class="org-keyword">virtual</span> <span class="org-type">void</span>        <span class="org-function-name">showCompany</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> = 0;
        <span class="org-keyword">virtual</span> ~<span class="org-function-name">ICompany</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">class</span> <span class="org-type">Company</span>: <span class="org-keyword">public</span> <span class="org-type">ICompany</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
        <span class="org-function-name">Company</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">unsigned</span> <span class="org-variable-name">id</span>, <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">name</span><span class="org-rainbow-delimiters-depth-2">)</span>:
                _name<span class="org-rainbow-delimiters-depth-2">(</span>name<span class="org-rainbow-delimiters-depth-2">)</span>,
                _id<span class="org-rainbow-delimiters-depth-2">(</span>id<span class="org-rainbow-delimiters-depth-2">){</span>
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-type">unsigned</span> <span class="org-function-name">getID</span><span class="org-rainbow-delimiters-depth-2">()</span>      <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> _id; <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> _name; <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-type">void</span> <span class="org-function-name">showCompany</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Company is = "</span> &lt;&lt; _name &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>   
        ~<span class="org-function-name">Company</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
<span class="org-function-name">private</span>:
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">_name</span>;
        <span class="org-type">unsigned</span>    <span class="org-variable-name">_id</span>;    
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Null object </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Returns this null object instead of returning a null pointer</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">when a givne company is not found in the database system.</span>
<span class="org-keyword">class</span> <span class="org-type">NullCompany</span>: <span class="org-keyword">public</span> <span class="org-type">ICompany</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
        <span class="org-type">unsigned</span> <span class="org-function-name">getID</span><span class="org-rainbow-delimiters-depth-2">()</span>      <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> 0; <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> <span class="org-string">""</span>; <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-type">void</span> <span class="org-function-name">showCompany</span><span class="org-rainbow-delimiters-depth-2">()</span>    <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{}</span>      
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org56ff5bd" class="outline-3">
<h3 id="org56ff5bd"><span class="section-number-3">1.10</span> Composite</h3>
<div class="outline-text-3" id="text-1-10">
<p>
The composite pattern is a structural design pattern intruduced by GOF
which allows clients to deal with tree collection of objects in the
same way as a primitive objects. 
</p>

<p>
Features and applications: 
</p>

<ul class="org-ul">
<li>Allow client code to ignore differences between individual objects
and collection (composite objects) and treat them uniformly.</li>

<li>Known cases:
<ul class="org-ul">
<li>GUI Widgets - Java Swing GUI library allows to build a complex
GUI out of individual UI elements such as buttons, menu, text box
and panels which can have many UI child objects and other panels.</li>
<li>AST - Abstract Syntax Trees</li>
<li>XML - Nodes</li>
</ul></li>

<li>Participants of Composite
<ul class="org-ul">
<li><span class="underline">Component</span>:
<ul class="org-ul">
<li>Overview: Interface or abstract class which defines common
operations shared by the primitive objects and composite objects.</li>
</ul></li>

<li><span class="underline">Leaf</span>
<ul class="org-ul">
<li>Overview:
<ul class="org-ul">
<li>Represents a primitive object which doesn't contain any child
object.</li>
</ul></li>
</ul></li>

<li><span class="underline">Composite</span>
<ul class="org-ul">
<li>Overview 
<ul class="org-ul">
<li>As the name implies, the composite object contains leaf
children objects.</li>
<li>Implements child operations in the component interface.</li>
<li>Can add or remove leaf objects or composite object as
children.</li>
<li>The composite object forwards the messages related to child
operations to the children elements.</li>
</ul></li>
<li>Methods:
<ul class="org-ul">
<li>.Add(Component)</li>
<li>.Remove(Component)</li>
<li>.Clear()</li>
</ul></li>
</ul></li>
</ul></li>
</ul>

<p>
<b>Example:</b>
</p>

<p>
File: 
</p>
<ul class="org-ul">
<li><a href="src/design-patterns/composite1.cpp">file:src/design-patterns/composite1.cpp</a></li>
</ul>

<p>
Online Compiler: 
</p>
<ul class="org-ul">
<li><a href="https://rextester.com/DYIE1548">https://rextester.com/DYIE1548</a></li>
</ul>


<p>
Component interface: 
</p>
<ul class="org-ul">
<li>Defines primitive elements operations.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">IGraphic</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
     <span class="org-keyword">virtual</span> <span class="org-keyword">auto</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>  = 0;
     <span class="org-keyword">virtual</span> <span class="org-keyword">auto</span> <span class="org-function-name">draw</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">void</span> = 0;
     <span class="org-keyword">virtual</span> <span class="org-keyword">auto</span> <span class="org-function-name">rotate</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> = 0;
     <span class="org-keyword">virtual</span> ~<span class="org-function-name">IGraphic</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Convenient type aliases: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">using</span> <span class="org-type">cstring</span> = <span class="org-keyword">const</span> <span class="org-type">char</span>*;
<span class="org-keyword">using</span> <span class="org-type">GNode</span> = <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-1">&lt;</span>IGraphic<span class="org-rainbow-delimiters-depth-1">&gt;</span>;
</pre>
</div>

<p>
Leaf, group aka composite object: 
</p>
<ul class="org-ul">
<li>Allows to performing an operation, which would be performed on a
single primitive element, on all elements stored in the composite
object.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">Group</span>: <span class="org-keyword">public</span> <span class="org-type">IGraphic</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
    <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span>GNode<span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">_nodes</span>;
    <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">_id</span>;
    <span class="org-keyword">static</span> <span class="org-keyword">constexpr</span> <span class="org-type">cstring</span> <span class="org-variable-name">_type</span> = <span class="org-string">"Group"</span>;
<span class="org-function-name">public</span>:
    <span class="org-function-name">Group</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">id</span><span class="org-rainbow-delimiters-depth-2">)</span>: <span class="org-function-name">_id</span><span class="org-rainbow-delimiters-depth-2">(</span>id<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Create group = "</span> &lt;&lt; id &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    ~<span class="org-function-name">Group</span><span class="org-rainbow-delimiters-depth-2">(){</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Destroy group - id = &lt;&lt; "</span> &lt;&lt; _id &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">auto</span> <span class="org-function-name">begin</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-keyword">decltype</span><span class="org-rainbow-delimiters-depth-2">(</span>_nodes.begin<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> _nodes.begin<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">end</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-keyword">decltype</span><span class="org-rainbow-delimiters-depth-2">(</span>_nodes.end<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> _nodes.end<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">auto</span> <span class="org-function-name">clear</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        _nodes.clear<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">size</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">size_t</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> _nodes.size<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">add</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">GNode</span> <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] id = "</span> &lt;&lt; _id
                  &lt;&lt; <span class="org-string">"; Add object = "</span> &lt;&lt; n-&gt;type<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-string">"\n"</span>;
       _nodes.push_back<span class="org-rainbow-delimiters-depth-3">(</span>n<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">add</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IGraphic</span>* <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] id = "</span> &lt;&lt; _id
                  &lt;&lt; <span class="org-string">" ; Add object = "</span> &lt;&lt; n-&gt;type<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-string">"\n"</span>;
        _nodes.push_back<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">std</span>::shared_ptr<span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">IGraphic</span><span class="org-rainbow-delimiters-depth-4">&gt;(</span>n<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Add stack-allocated object </span>
    <span class="org-keyword">auto</span> <span class="org-function-name">addFromStack</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">IGraphic</span>* <span class="org-variable-name">n</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] id = "</span> &lt;&lt; _id
                  &lt;&lt; <span class="org-string">" ; Add object = "</span> &lt;&lt; n-&gt;type<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Dummy deleter to avoid core dump by avoiding deleting</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">stack-allocated object or non-owned pointer.</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">s</span> = <span class="org-constant">std</span>::shared_ptr<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">IGraphic</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>n, <span class="org-rainbow-delimiters-depth-4">[](</span><span class="org-type">IGraphic</span>*<span class="org-rainbow-delimiters-depth-4">){</span> <span class="org-keyword">return</span> ; <span class="org-rainbow-delimiters-depth-4">}</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        _nodes.push_back<span class="org-rainbow-delimiters-depth-3">(</span>s<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>   

    <span class="org-comment-delimiter">// </span><span class="org-comment">Note: Template methods should always be in the header files</span>
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">class</span> <span class="org-type">Node</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">addNew</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">id</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">auto</span> <span class="org-variable-name">n</span> = <span class="org-constant">std</span>::make_unique<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">Node</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>id<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] id = "</span> &lt;&lt; _id
                          &lt;&lt; <span class="org-string">" ; Add object = "</span> &lt;&lt; n-&gt;type<span class="org-rainbow-delimiters-depth-3">()</span> &lt;&lt; <span class="org-string">"\n"</span>;    
        _nodes.push_back<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">std</span>::move<span class="org-rainbow-delimiters-depth-4">(</span>n<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">======&gt; Interface IGraphic &lt;&lt;=========//</span>

    <span class="org-keyword">auto</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> _type;
    <span class="org-rainbow-delimiters-depth-2">}</span>    
    <span class="org-keyword">auto</span> <span class="org-function-name">draw</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">void</span> <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Draw group - id =  "</span> &lt;&lt; _id &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">obj</span>: _nodes<span class="org-rainbow-delimiters-depth-3">)</span>
            obj-&gt;draw<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">rotate</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">angle</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Rotate group - id = "</span> &lt;&lt; _id &lt;&lt; <span class="org-string">"\n"</span>;
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">obj</span>: _nodes<span class="org-rainbow-delimiters-depth-3">)</span>
            obj-&gt;rotate<span class="org-rainbow-delimiters-depth-3">(</span>angle<span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>    
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Primitive element or node: Line  
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">Line</span>: <span class="org-keyword">public</span> <span class="org-type">IGraphic</span> <span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
    <span class="org-keyword">static</span> <span class="org-keyword">constexpr</span> <span class="org-type">cstring</span> <span class="org-variable-name">_type</span> = <span class="org-string">"Line"</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">_id</span>;
<span class="org-function-name">public</span>:
    <span class="org-function-name">Line</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">id</span><span class="org-rainbow-delimiters-depth-2">)</span>: _id<span class="org-rainbow-delimiters-depth-2">{</span>id<span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-keyword">return</span> _type;
    <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-keyword">auto</span> <span class="org-function-name">draw</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">void</span> <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Draw line - id = "</span> &lt;&lt; _id &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-keyword">auto</span> <span class="org-function-name">rotate</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">angle</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Rotate line ; id = "</span> &lt;&lt; _id 
                   &lt;&lt; <span class="org-string">"; angle = "</span> &lt;&lt; angle &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>  
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>


<p>
Primitive element or node: Triangle 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">Triangle</span>: <span class="org-keyword">public</span> <span class="org-type">IGraphic</span> <span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
    <span class="org-keyword">static</span> <span class="org-keyword">constexpr</span> <span class="org-type">cstring</span> <span class="org-variable-name">_type</span> = <span class="org-string">"Triangle"</span>;
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">_id</span>;
<span class="org-function-name">public</span>:
    <span class="org-function-name">Triangle</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span>&amp; <span class="org-variable-name">id</span><span class="org-rainbow-delimiters-depth-2">)</span>: _id<span class="org-rainbow-delimiters-depth-2">{</span>id<span class="org-rainbow-delimiters-depth-2">}</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">type</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span>
       <span class="org-keyword">return</span> _type;
    <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-keyword">auto</span> <span class="org-function-name">draw</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">void</span> <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Draw triangle - id = "</span> &lt;&lt; _id &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span> 
    <span class="org-keyword">auto</span> <span class="org-function-name">rotate</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">angle</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span> <span class="org-keyword">override</span> <span class="org-rainbow-delimiters-depth-2">{</span>
         <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [TRACE] Rotate triangle"</span>
                   &lt;&lt; <span class="org-string">" id = "</span> &lt;&lt; _id
                   &lt;&lt; <span class="org-string">" angle = "</span> &lt;&lt; angle &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>  
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Sample client code: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Count total number of elements </span>
<span class="org-keyword">auto</span> <span class="org-function-name">countElements</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">Group</span>&amp; <span class="org-variable-name">group</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">size_t</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">size_t</span> <span class="org-variable-name">n</span> = 0;
    <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">g</span>: group<span class="org-rainbow-delimiters-depth-2">){</span>
       <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span>g-&gt;type<span class="org-rainbow-delimiters-depth-4">()</span> == <span class="org-string">"Group"</span><span class="org-rainbow-delimiters-depth-3">){</span>
               <span class="org-keyword">auto</span> <span class="org-variable-name">p</span> = <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">Group</span>*<span class="org-rainbow-delimiters-depth-4">&gt;(</span>g.get<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;
               n += countElements<span class="org-rainbow-delimiters-depth-4">(</span>*p<span class="org-rainbow-delimiters-depth-4">)</span>;          
       <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-keyword">else</span><span class="org-rainbow-delimiters-depth-3">{</span> ++n; <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-keyword">return</span> n;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
Main function: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">const</span> <span class="org-type">char</span> <span class="org-variable-name">nl</span> = <span class="org-string">'\n'</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"=== Objects construction === "</span> &lt;&lt; nl;

<span class="org-keyword">auto</span> <span class="org-variable-name">groupA</span> = Group<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"groupA"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
groupA.add<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">new</span> <span class="org-type">Triangle</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"triangleA1"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>;
groupA.add<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">new</span> <span class="org-type">Line</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"lineA1"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>;
groupA.addNew<span class="org-rainbow-delimiters-depth-1">&lt;</span>Line<span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"LineA2"</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-keyword">auto</span> <span class="org-variable-name">groupB</span> = <span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-1">&lt;</span>Group<span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"GroupB"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
groupB-&gt;add<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">new</span> <span class="org-type">Triangle</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"triangleB1"</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>;
groupB-&gt;addNew<span class="org-rainbow-delimiters-depth-1">&lt;</span>Triangle<span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"triangleB2"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
groupB-&gt;addNew<span class="org-rainbow-delimiters-depth-1">&lt;</span>Line<span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"LineB1"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
groupB-&gt;addNew<span class="org-rainbow-delimiters-depth-1">&lt;</span>Line<span class="org-rainbow-delimiters-depth-1">&gt;(</span><span class="org-string">"LineB2"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-keyword">auto</span> <span class="org-variable-name">triangleB3</span> = Triangle<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"triangleB3"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
groupB-&gt;addFromStack<span class="org-rainbow-delimiters-depth-1">(</span>&amp;triangleB3<span class="org-rainbow-delimiters-depth-1">)</span>;
groupA.add<span class="org-rainbow-delimiters-depth-1">(</span>groupB<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; nl &lt;&lt; <span class="org-string">"=== End of object construction === "</span> &lt;&lt; nl;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"Total of elements of groupA = "</span> &lt;&lt; countElements<span class="org-rainbow-delimiters-depth-1">(</span>groupA<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-string">"\n"</span>;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"Total of elements of groupB = "</span> &lt;&lt; countElements<span class="org-rainbow-delimiters-depth-1">(</span>*groupB<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-string">"\n"</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; nl &lt;&lt; <span class="org-string">" [*] ==&gt; Draw group B"</span> &lt;&lt; <span class="org-string">"\n"</span>;
groupB-&gt;draw<span class="org-rainbow-delimiters-depth-1">()</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; nl &lt;&lt; <span class="org-string">" [*] ==&gt; Rotate group B"</span> &lt;&lt; <span class="org-string">"\n"</span>;
groupB-&gt;rotate<span class="org-rainbow-delimiters-depth-1">(</span>90<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; nl &lt;&lt; <span class="org-string">" [*] ==&gt; Draw group A"</span> &lt;&lt; <span class="org-string">"\n"</span>;
groupA.draw<span class="org-rainbow-delimiters-depth-1">()</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; nl &lt;&lt; <span class="org-string">" [*] ==&gt; Rotate group A"</span> &lt;&lt; <span class="org-string">"\n"</span>;
groupA.rotate<span class="org-rainbow-delimiters-depth-1">(</span>15<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; nl &lt;&lt; <span class="org-string">" [*] ==&gt; Remove objects from group B"</span> &lt;&lt; <span class="org-string">"\n"</span>;
groupB-&gt;clear<span class="org-rainbow-delimiters-depth-1">()</span>;
groupA.draw<span class="org-rainbow-delimiters-depth-1">()</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"=== End of Program ===="</span> &lt;&lt; <span class="org-string">"\n"</span>;

</pre>
</div>

<p>
Running:  (<a href="src/design-patterns/composite1.cpp">file:src/design-patterns/composite1.cpp</a>)
</p>

<div class="org-src-container">
<pre class="src src-sh">$ g++ composite1.cpp -o <span class="org-keyword">composite1.bin</span> -g -std=c++1z -Wall -Wextra 
$ ./composite1.bin

=== Objects construction === 
 [TRACE] Create group = groupA
 [TRACE] id = groupA ; Add object = Triangle
 [TRACE] id = groupA ; Add object = Line
 [TRACE] id = groupA ; Add object = Line
 [TRACE] Create group = GroupB
 [TRACE] id = GroupB ; Add object = Triangle
 [TRACE] id = GroupB ; Add object = Triangle
 [TRACE] id = GroupB ; Add object = Line
 [TRACE] id = GroupB ; Add object = Line
 [TRACE] id = GroupB ; Add object = Triangle
 [TRACE] id = groupA; Add object = Group

=== End of object construction === 
Total of elements of groupA = 8
Total of elements of groupB = 5

 [*] ==&gt; Draw group B
 [TRACE] Draw group - id =  GroupB
 [TRACE] Draw triangle - id = triangleB1
 [TRACE] Draw triangle - id = triangleB2
 [TRACE] Draw line - id = LineB1
 [TRACE] Draw line - id = LineB2
 [TRACE] Draw triangle - id = triangleB3

 [*] ==&gt; Rotate group B
 [TRACE] Rotate group - id = GroupB
 [TRACE] Rotate triangle id = triangleB1 angle = 90
 [TRACE] Rotate triangle id = triangleB2 angle = 90
 [TRACE] Rotate line ; id = LineB1; angle = 90
 [TRACE] Rotate line ; id = LineB2; angle = 90
 [TRACE] Rotate triangle id = triangleB3 angle = 90

 [*] ==&gt; Draw group A
 [TRACE] Draw group - id =  groupA
 [TRACE] Draw triangle - id = triangleA1
 [TRACE] Draw line - id = lineA1
 [TRACE] Draw line - id = LineA2
 [TRACE] Draw group - id =  GroupB
 [TRACE] Draw triangle - id = triangleB1
 [TRACE] Draw triangle - id = triangleB2
 [TRACE] Draw line - id = LineB1
 [TRACE] Draw line - id = LineB2
 [TRACE] Draw triangle - id = triangleB3

 [*] ==&gt; Rotate group A
 [TRACE] Rotate group - id = groupA
 [TRACE] Rotate triangle id = triangleA1 angle = 15
 [TRACE] Rotate line ; id = lineA1; angle = 15
 [TRACE] Rotate line ; id = LineA2; angle = 15
 [TRACE] Rotate group - id = GroupB
 [TRACE] Rotate triangle id = triangleB1 angle = 15
 [TRACE] Rotate triangle id = triangleB2 angle = 15
 [TRACE] Rotate line ; id = LineB1; angle = 15
 [TRACE] Rotate line ; id = LineB2; angle = 15
 [TRACE] Rotate triangle id = triangleB3 angle = 15

 [*] ==&gt; Remove objects from group B
 [TRACE] Draw group - id =  groupA
 [TRACE] Draw triangle - id = triangleA1
 [TRACE] Draw line - id = lineA1
 [TRACE] Draw line - id = LineA2
 [TRACE] Draw group - id =  GroupB
=== End of Program ====
 [TRACE] Destroy group - id = &lt;&lt; groupA
<span class="org-sh-heredoc"> [TRACE] Destroy group - id = &lt;&lt; GroupB</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgcd2b84b" class="outline-3">
<h3 id="orgcd2b84b"><span class="section-number-3">1.11</span> Multiple booleans encoded as a single bitmask value</h3>
<div class="outline-text-3" id="text-1-11">
<p>
Note: It is not a design pattern, but a technique for encoding
multiple booleans or flags inside a single value, passing multiple
booleans as function parameters or returning multiple booleans as a
single value.
</p>

<p>
Example: 
</p>

<ul class="org-ul">
<li>File:  <a href="src/design-patterns/boolean-bitmask.C">file:src/design-patterns/boolean-bitmask.C</a>  (CLING script)</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">iostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">vector</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">ostream</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span> <span class="org-comment-delimiter">// </span><span class="org-comment">Operator: (&lt;&lt;)</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">string</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">Permissions</span>: <span class="org-type">unsigned</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-variable-name">executable</span> = 0x01,  <span class="org-comment-delimiter">// </span><span class="org-comment">decimal = 1 or (1 &lt;&lt; 0)</span>
    <span class="org-variable-name">writeable</span>  = 0x02,  <span class="org-comment-delimiter">// </span><span class="org-comment">decimal = 2 or (1 &lt;&lt; 1)</span>
    <span class="org-variable-name">readable</span>   = 0x04   <span class="org-comment-delimiter">// </span><span class="org-comment">decimal = 4 or (1 &lt;&lt; 2)</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">Permissions</span> <span class="org-keyword">operator</span> <span class="org-function-name">|</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Permissions</span> <span class="org-variable-name">lhs</span>, <span class="org-type">Permissions</span> <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-keyword">return</span> <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Permissions</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span><span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">unsigned</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>lhs<span class="org-rainbow-delimiters-depth-3">)</span> | <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">unsigned</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>rhs<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-type">bool</span> <span class="org-keyword">operator</span> <span class="org-function-name">&amp;</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Permissions</span> <span class="org-variable-name">lhs</span>, <span class="org-type">Permissions</span> <span class="org-variable-name">rhs</span><span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-keyword">return</span> <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">unsigned</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>lhs<span class="org-rainbow-delimiters-depth-2">)</span> &amp; <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">unsigned</span><span class="org-rainbow-delimiters-depth-2">&gt;(</span>rhs<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Make permissions enum printable. </span>
<span class="org-function-name">std</span>::ostream&amp; <span class="org-keyword">operator</span>&lt;&lt;<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">ostream</span>&amp; <span class="org-variable-name">os</span>, <span class="org-keyword">const</span> <span class="org-type">Permissions</span>&amp; <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-1">){</span>
    os &lt;&lt; <span class="org-constant">std</span>::boolalpha; <span class="org-comment-delimiter">// </span><span class="org-comment">Make bool printable as 'true' or 'false' instead of 0 or 1</span>
    os &lt;&lt; <span class="org-string">"readable = "</span>   &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>p &amp; <span class="org-constant">Permissions</span>::readable<span class="org-rainbow-delimiters-depth-2">)</span>   &lt;&lt; <span class="org-string">"; "</span>
       &lt;&lt; <span class="org-string">"writeable = "</span>  &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>p &amp; <span class="org-constant">Permissions</span>::writeable<span class="org-rainbow-delimiters-depth-2">)</span>  &lt;&lt; <span class="org-string">"; "</span>
       &lt;&lt; <span class="org-string">"executable = "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>p &amp; <span class="org-constant">Permissions</span>::executable<span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-keyword">return</span> os;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Load script </span>
&gt;&gt; .L boolean-bitmask.C 

&gt;&gt; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">Permissions</span>::readable &lt;&lt; <span class="org-constant">std</span>::endl;
readable = <span class="org-constant">true</span>; writeable = <span class="org-constant">false</span>; executable = <span class="org-constant">false</span>

&gt;&gt; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">Permissions</span>::readable &lt;&lt; <span class="org-string">"\n"</span>;
readable = <span class="org-constant">true</span>; writeable = <span class="org-constant">false</span>; executable = <span class="org-constant">false</span>

&gt;&gt; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">Permissions</span>::writeable &lt;&lt; <span class="org-string">"\n"</span>;
readable = <span class="org-constant">false</span>; writeable = <span class="org-constant">true</span>; executable = <span class="org-constant">false</span>

&gt;&gt; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">Permissions</span>::executable &lt;&lt; <span class="org-string">"\n"</span>;
readable = <span class="org-constant">false</span>; writeable = <span class="org-constant">false</span>; executable = <span class="org-constant">true</span>

&gt;&gt; <span class="org-keyword">auto</span> p1 = <span class="org-constant">Permissions</span>::executable | <span class="org-constant">Permissions</span>::readable ;
&gt;&gt; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"p1 =&gt; "</span> &lt;&lt; p1 &lt;&lt; <span class="org-string">"\n"</span>;
p1 =&gt; readable = <span class="org-constant">true</span>; writeable = <span class="org-constant">false</span>; executable = <span class="org-constant">true</span>
&gt;&gt; 

&gt;&gt; <span class="org-keyword">auto</span> p2 = <span class="org-constant">Permissions</span>::executable | <span class="org-constant">Permissions</span>::readable | <span class="org-constant">Permissions</span>::writeable ;
&gt;&gt; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"p2 =&gt; "</span> &lt;&lt; p2 &lt;&lt; <span class="org-string">"\n"</span>;
p2 =&gt; readable = <span class="org-constant">true</span>; writeable = <span class="org-constant">true</span>; executable = <span class="org-constant">true</span>
&gt;&gt; 

&gt;&gt; <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-1">(</span>p1 &amp; <span class="org-constant">Permissions</span>::readable<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"File is readable"</span> &lt;&lt; <span class="org-string">"\n"</span>; <span class="org-rainbow-delimiters-depth-1">}</span>
File <span class="org-type">is</span> <span class="org-variable-name">readable</span>
&gt;&gt; 

</pre>
</div>

<p>
Shows all flags or all bits that are set: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span> <span class="org-function-name">showPermissions</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">Permissions</span> <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-1">){</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Is readable?     : "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>p &amp; <span class="org-constant">Permissions</span>::readable<span class="org-rainbow-delimiters-depth-2">)</span>   &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Is writeable?    : "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>p &amp; <span class="org-constant">Permissions</span>::writeable<span class="org-rainbow-delimiters-depth-2">)</span>  &lt;&lt; <span class="org-string">'\n'</span>;
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Is executable?   : "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>p &amp; <span class="org-constant">Permissions</span>::executable<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">'\n'</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

&gt;&gt; showPermissions<span class="org-rainbow-delimiters-depth-1">(</span>p1<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-type">Is</span> <span class="org-function-name">readable</span>?     : <span class="org-constant">true</span>
Is writeable?    : <span class="org-constant">false</span>
Is executable?   : <span class="org-constant">true</span>
&gt;&gt; 
&gt;&gt; showPermissions<span class="org-rainbow-delimiters-depth-1">(</span>p2<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-type">Is</span> <span class="org-variable-name">readable</span>?     : <span class="org-constant">true</span>
Is writeable?    : <span class="org-constant">true</span>
Is executable?   : <span class="org-constant">true</span>
&gt;&gt; 
</pre>
</div>

<p>
Design 1: Function uses multiple bools creating a file with some
permissions. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">using</span> <span class="org-type">FilePerms</span> = <span class="org-constant">std</span>::<span class="org-type">tuple</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">bool</span>, <span class="org-type">bool</span>, <span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Design 1:</span>
<span class="org-type">FilePerms</span> <span class="org-function-name">createFileDD1</span><span class="org-rainbow-delimiters-depth-1">(</span>
     <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span>,
     <span class="org-type">bool</span> <span class="org-variable-name">readable</span>,
     <span class="org-type">bool</span> <span class="org-variable-name">writeable</span>,
     <span class="org-type">bool</span> <span class="org-variable-name">executable</span> <span class="org-rainbow-delimiters-depth-1">){</span>
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha
               &lt;&lt; <span class="org-string">"Create file = "</span> &lt;&lt; name &lt;&lt; <span class="org-string">"\n"</span>
               &lt;&lt; <span class="org-string">" with the following permissions"</span> &lt;&lt; <span class="org-string">"\n"</span>
               &lt;&lt; <span class="org-string">"  + readable   = "</span> &lt;&lt; readable   &lt;&lt; <span class="org-string">"\n"</span>
               &lt;&lt; <span class="org-string">"  + writeable  = "</span> &lt;&lt; writeable  &lt;&lt; <span class="org-string">"\n"</span>
               &lt;&lt; <span class="org-string">"  + executable = "</span> &lt;&lt; executable &lt;&lt; <span class="org-string">"\n"</span>
               &lt;&lt; <span class="org-string">"\n"</span>;
     <span class="org-keyword">return</span> FilePerms <span class="org-rainbow-delimiters-depth-2">{</span>readable, writeable, executable<span class="org-rainbow-delimiters-depth-2">}</span>;    
<span class="org-rainbow-delimiters-depth-1">}</span>

&gt;&gt; <span class="org-keyword">auto</span> pd1 = createFileDD1<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"dataset.txt"</span>, <span class="org-constant">true</span>, <span class="org-constant">false</span>, <span class="org-constant">false</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-type">Create</span> <span class="org-variable-name">file</span> = dataset.txt
 with the following permissions
  + readable   = <span class="org-constant">true</span>
  + writeable  = <span class="org-constant">false</span>
  + executable = <span class="org-constant">false</span>

&gt;&gt; pd1
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">tuple</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">bool</span>, <span class="org-type">bool</span>, <span class="org-type">bool</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> &amp;<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-constant">true</span>, <span class="org-constant">false</span>, <span class="org-constant">false</span> <span class="org-rainbow-delimiters-depth-1">}</span>
&gt;&gt; 

&gt;&gt; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"R = "</span> &lt;&lt; <span class="org-constant">std</span>::get<span class="org-rainbow-delimiters-depth-1">&lt;</span>0<span class="org-rainbow-delimiters-depth-1">&gt;(</span>pd1<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-string">"\n"</span>;
R = <span class="org-constant">true</span>
&gt;&gt; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"W = "</span> &lt;&lt; <span class="org-constant">std</span>::get<span class="org-rainbow-delimiters-depth-1">&lt;</span>1<span class="org-rainbow-delimiters-depth-1">&gt;(</span>pd1<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-string">"\n"</span>;
W = <span class="org-constant">false</span>
&gt;&gt; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"X = "</span> &lt;&lt; <span class="org-constant">std</span>::get<span class="org-rainbow-delimiters-depth-1">&lt;</span>2<span class="org-rainbow-delimiters-depth-1">&gt;(</span>pd1<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-string">"\n"</span>;
X = <span class="org-constant">false</span>
&gt;&gt; 
</pre>
</div>

<p>
Design 2: Use bitmask flags instead of bools. The advantage is more
readability and less functions parameters. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Design 1:</span>
<span class="org-type">Permissions</span> <span class="org-function-name">createFileDD2</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">name</span>, <span class="org-type">Permissions</span> <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-1">){</span>
     <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-constant">std</span>::boolalpha
               &lt;&lt; <span class="org-string">"Create file = "</span> &lt;&lt; name &lt;&lt; <span class="org-string">"\n"</span>
               &lt;&lt; <span class="org-string">" with the following permissions"</span> &lt;&lt; <span class="org-string">"\n"</span>
               &lt;&lt; <span class="org-string">"  + readable   = "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>p &amp; <span class="org-constant">Permissions</span>::readable<span class="org-rainbow-delimiters-depth-2">)</span>   &lt;&lt; <span class="org-string">"\n"</span>
               &lt;&lt; <span class="org-string">"  + writeable  = "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>p &amp; <span class="org-constant">Permissions</span>::writeable<span class="org-rainbow-delimiters-depth-2">)</span>  &lt;&lt; <span class="org-string">"\n"</span>
               &lt;&lt; <span class="org-string">"  + executable = "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>p &amp; <span class="org-constant">Permissions</span>::executable<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">"\n"</span>
               &lt;&lt; <span class="org-string">"\n"</span>;
     <span class="org-keyword">return</span> p;
<span class="org-rainbow-delimiters-depth-1">}</span>

&gt;&gt; <span class="org-keyword">auto</span> pd2 = createFileDD2<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"Sales-report.xls"</span>, <span class="org-constant">Permissions</span>::readable | <span class="org-constant">Permissions</span>::writeable<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-type">Create</span> <span class="org-variable-name">file</span> = Sales-report.xls
 with the following permissions
  + readable   = <span class="org-constant">true</span>
  + writeable  = <span class="org-constant">true</span>
  + executable = <span class="org-constant">false</span>

<span class="org-rainbow-delimiters-depth-1">(</span>Permissions<span class="org-rainbow-delimiters-depth-1">)</span>  : <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">unsigned</span> <span class="org-type">int</span><span class="org-rainbow-delimiters-depth-1">)</span> 6
&gt;&gt; 

&gt;&gt; createFileDD2<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"parser.exe"</span>, <span class="org-constant">Permissions</span>::readable | <span class="org-constant">Permissions</span>::writeable | Create file = parser.exe
 with the following permissions
  + readable   = <span class="org-constant">true</span>
  + writeable  = <span class="org-constant">true</span>
  + executable = <span class="org-constant">true</span>

<span class="org-rainbow-delimiters-depth-2">(</span>Permissions<span class="org-rainbow-delimiters-depth-2">)</span>  : <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">unsigned</span> <span class="org-type">int</span><span class="org-rainbow-delimiters-depth-2">)</span> 7
&gt;&gt; 

&gt;&gt; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"R = "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>pd2 &amp; <span class="org-constant">Permissions</span>::readable<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">"\n"</span>;
R = <span class="org-constant">true</span>
&gt;&gt; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"W = "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>pd2 &amp; <span class="org-constant">Permissions</span>::writeable<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">"\n"</span>;
W = <span class="org-constant">true</span>
&gt;&gt; <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"X = "</span> &lt;&lt; <span class="org-rainbow-delimiters-depth-2">(</span>pd2 &amp; <span class="org-constant">Permissions</span>::executable<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-string">"\n"</span>;
X = <span class="org-constant">false</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgca40a25" class="outline-2">
<h2 id="orgca40a25"><span class="section-number-2">2</span> C++ Specific Design Pattern and Idioms</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgd454c83" class="outline-3">
<h3 id="orgd454c83"><span class="section-number-3">2.1</span> Interface Class</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-orgfc42a4f" class="outline-4">
<h4 id="orgfc42a4f"><span class="section-number-4">2.1.1</span> Overview</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
Unlike C# and Java, C++ doesn't have any keyword for implementing
interface, however it can be implemented by creating a class with only
pure virtual functions, in other words, only abstract methods or
methods without implementation. 
</p>

<p>
The interface class has a runtime overhead due to the virtual methods
that are resolved at runtime. An alternative solution when the virtual
methods calls performance overhead is not acceptable, is to use
generic programming or templates which doesn't have runtime cost since
the methods to be called are resolved at compile-time.
</p>

<p>
Note: 
</p>
<ul class="org-ul">
<li>The annotation <b>virtual</b> - means that the method (member function)
can be overriden by the derived class. Methods in the base class
not annotated as virtual cannot be overriden in the derived
classes. Unlike Java, C++ methods are not virtual by default.</li>

<li>The annotation (=0) - means a pure virtual member function, aka
pure virtual function which is an <span class="underline">abstract method</span>, method without
implementation.</li>
</ul>

<p>
<b>Example</b>: Interface Class Declaration: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">IStack</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
    <span class="org-keyword">virtual</span> ~<span class="org-function-name">IStack</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
    <span class="org-keyword">virtual</span> <span class="org-type">int</span>    <span class="org-function-name">size</span><span class="org-rainbow-delimiters-depth-2">()</span>         <span class="org-keyword">const</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">void</span>   <span class="org-function-name">push</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span>       = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">double</span> <span class="org-function-name">pop</span><span class="org-rainbow-delimiters-depth-2">()</span>                = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">double</span> <span class="org-function-name">peek</span><span class="org-rainbow-delimiters-depth-2">()</span>         <span class="org-keyword">const</span> = 0;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Or: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">struct</span> <span class="org-type">IStack</span><span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">virtual</span> ~<span class="org-function-name">IStack</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
    <span class="org-keyword">virtual</span> <span class="org-type">int</span>    <span class="org-function-name">size</span><span class="org-rainbow-delimiters-depth-2">()</span>         <span class="org-keyword">const</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">void</span>   <span class="org-function-name">push</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span>       = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">double</span> <span class="org-function-name">pop</span><span class="org-rainbow-delimiters-depth-2">()</span>                = 0;
    <span class="org-keyword">virtual</span> <span class="org-type">double</span> <span class="org-function-name">peek</span><span class="org-rainbow-delimiters-depth-2">()</span>         <span class="org-keyword">const</span> = 0;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Or using C++ auto keyword for functions: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">struct</span> <span class="org-type">IStack</span><span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">virtual</span> ~<span class="org-function-name">IStack</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
    <span class="org-keyword">virtual</span> <span class="org-keyword">auto</span> <span class="org-function-name">size</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>   -&gt; <span class="org-type">int</span>    = 0;
    <span class="org-keyword">virtual</span> <span class="org-keyword">auto</span> <span class="org-function-name">push</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span> -&gt; <span class="org-type">void</span>   = 0;
    <span class="org-keyword">virtual</span> <span class="org-keyword">auto</span> <span class="org-function-name">pop</span><span class="org-rainbow-delimiters-depth-2">()</span>          -&gt; <span class="org-type">double</span> = 0;
    <span class="org-keyword">virtual</span> <span class="org-keyword">auto</span> <span class="org-function-name">peek</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>   -&gt; <span class="org-type">double</span> = 0;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-org4a9b221" class="outline-4">
<h4 id="org4a9b221"><span class="section-number-4">2.1.2</span> Example</h4>
<div class="outline-text-4" id="text-2-1-2">
<p>
<b>Complete Code Example</b>
</p>
<ul class="org-ul">
<li>File:  <a href="src/design-patterns/interface-class.cpp">file:src/design-patterns/interface-class.cpp</a></li>
</ul>

<p>
Interface class declaration:
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Interface Stack. (Should be placed in the header file.) </span>
<span class="org-keyword">class</span> <span class="org-type">IStack</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
        <span class="org-keyword">virtual</span> ~<span class="org-function-name">IStack</span><span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;
        <span class="org-keyword">virtual</span> <span class="org-type">int</span>    <span class="org-function-name">size</span><span class="org-rainbow-delimiters-depth-2">()</span>         <span class="org-keyword">const</span> = 0;
        <span class="org-keyword">virtual</span> <span class="org-type">void</span>   <span class="org-function-name">push</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span>       = 0;
        <span class="org-keyword">virtual</span> <span class="org-type">double</span> <span class="org-function-name">pop</span><span class="org-rainbow-delimiters-depth-2">()</span>                = 0;
        <span class="org-keyword">virtual</span> <span class="org-type">double</span> <span class="org-function-name">peek</span><span class="org-rainbow-delimiters-depth-2">()</span>         <span class="org-keyword">const</span> = 0;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Example: Interface implementations. 
</p>

<ul class="org-ul">
<li>Implementation of interface IStack using vector as internal
representation.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">StackVector</span>: <span class="org-keyword">public</span> <span class="org-type">IStack</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
        <span class="org-function-name">StackVector</span><span class="org-rainbow-delimiters-depth-2">(){}</span>
        <span class="org-function-name">StackVector</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">initializer_list</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">xs</span><span class="org-rainbow-delimiters-depth-2">){</span>
                _stack.insert<span class="org-rainbow-delimiters-depth-3">(</span>_stack.begin<span class="org-rainbow-delimiters-depth-4">()</span>, xs.begin<span class="org-rainbow-delimiters-depth-4">()</span>, xs.end<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-type">int</span> <span class="org-function-name">size</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-keyword">return</span> _stack.size<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>   
        <span class="org-type">void</span> <span class="org-function-name">push</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">){</span>
                _stack.push_back<span class="org-rainbow-delimiters-depth-3">(</span>x<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>   
        <span class="org-type">double</span> <span class="org-function-name">pop</span><span class="org-rainbow-delimiters-depth-2">(){</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">this</span>-&gt;size<span class="org-rainbow-delimiters-depth-4">()</span> == 0<span class="org-rainbow-delimiters-depth-3">)</span>
                        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: stack is empty"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
                <span class="org-type">double</span> <span class="org-variable-name">top</span> = _stack.back<span class="org-rainbow-delimiters-depth-3">()</span>;
                _stack.pop_back<span class="org-rainbow-delimiters-depth-3">()</span>;
                <span class="org-keyword">return</span> top;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-type">double</span> <span class="org-function-name">peek</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">this</span>-&gt;size<span class="org-rainbow-delimiters-depth-4">()</span> == 0<span class="org-rainbow-delimiters-depth-3">)</span>
                        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: stack is empty"</span><span class="org-rainbow-delimiters-depth-3">)</span>;      
                <span class="org-keyword">return</span> _stack.back<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-function-name">private</span>:
        <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">_stack</span><span class="org-rainbow-delimiters-depth-2">{}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<ul class="org-ul">
<li>Implementation using deque as internal representation:</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">StackDeque</span>: <span class="org-keyword">public</span> <span class="org-type">IStack</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
        <span class="org-function-name">StackDeque</span><span class="org-rainbow-delimiters-depth-2">(){}</span>
        <span class="org-function-name">StackDeque</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">initializer_list</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-3">&gt;</span>&amp; <span class="org-variable-name">xs</span><span class="org-rainbow-delimiters-depth-2">){</span>
                _stack.insert<span class="org-rainbow-delimiters-depth-3">(</span>_stack.begin<span class="org-rainbow-delimiters-depth-4">()</span>, xs.begin<span class="org-rainbow-delimiters-depth-4">()</span>, xs.end<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>   
        <span class="org-type">int</span> <span class="org-function-name">size</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-keyword">return</span> _stack.size<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>   
        <span class="org-type">void</span> <span class="org-function-name">push</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">){</span>
                _stack.push_back<span class="org-rainbow-delimiters-depth-3">(</span>x<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>   
        <span class="org-type">double</span> <span class="org-function-name">pop</span><span class="org-rainbow-delimiters-depth-2">(){</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">this</span>-&gt;size<span class="org-rainbow-delimiters-depth-4">()</span> == 0<span class="org-rainbow-delimiters-depth-3">)</span>
                        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: stack is empty"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
                <span class="org-type">double</span> <span class="org-variable-name">top</span> = _stack.back<span class="org-rainbow-delimiters-depth-3">()</span>;
                _stack.pop_back<span class="org-rainbow-delimiters-depth-3">()</span>;
                <span class="org-keyword">return</span> top;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-type">double</span> <span class="org-function-name">peek</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">this</span>-&gt;size<span class="org-rainbow-delimiters-depth-4">()</span> == 0<span class="org-rainbow-delimiters-depth-3">)</span>
                        <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: stack is empty"</span><span class="org-rainbow-delimiters-depth-3">)</span>;      
                <span class="org-keyword">return</span> _stack.back<span class="org-rainbow-delimiters-depth-3">()</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-function-name">private</span>:
        <span class="org-constant">std</span>::<span class="org-type">deque</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">_stack</span><span class="org-rainbow-delimiters-depth-2">{}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<ul class="org-ul">
<li>Sample client code:</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp">
<span class="org-keyword">auto</span> <span class="org-function-name">stack_sum</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">IStack</span>&amp; <span class="org-variable-name">s</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">double</span><span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">std::cerr &lt;&lt; " ==&gt; stack_sum for references" &lt;&lt; std::endl;</span>
        <span class="org-type">double</span> <span class="org-variable-name">sum</span> = 0.0;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>s.size<span class="org-rainbow-delimiters-depth-3">()</span> == 0<span class="org-rainbow-delimiters-depth-2">)</span>
                <span class="org-keyword">return</span> sum;
        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>s.size<span class="org-rainbow-delimiters-depth-3">()</span> != 0<span class="org-rainbow-delimiters-depth-2">)</span>
                sum += s.pop<span class="org-rainbow-delimiters-depth-2">()</span>;
        <span class="org-keyword">return</span> sum;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-function-name">stack_sum</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">IStack</span>* <span class="org-variable-name">s</span><span class="org-rainbow-delimiters-depth-1">)</span> -&gt; <span class="org-type">double</span><span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">std::cerr &lt;&lt; " ==&gt; stack_sum for pointers" &lt;&lt; std::endl;</span>
        <span class="org-type">double</span> <span class="org-variable-name">sum</span> = 0.0;
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>s-&gt;size<span class="org-rainbow-delimiters-depth-3">()</span> == 0<span class="org-rainbow-delimiters-depth-2">)</span>
                <span class="org-keyword">return</span> sum;
        <span class="org-keyword">while</span><span class="org-rainbow-delimiters-depth-2">(</span>s-&gt;size<span class="org-rainbow-delimiters-depth-3">()</span> != 0<span class="org-rainbow-delimiters-depth-2">)</span>
                sum += s-&gt;pop<span class="org-rainbow-delimiters-depth-2">()</span>;
        <span class="org-keyword">return</span> sum;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
Function main: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">StackVector</span> <span class="org-variable-name">sv</span> = <span class="org-rainbow-delimiters-depth-1">{</span>1.0, 2.0, 3.0, 5.0, 6.0<span class="org-rainbow-delimiters-depth-1">}</span>;
<span class="org-type">StackDeque</span>  <span class="org-variable-name">sd</span> = <span class="org-rainbow-delimiters-depth-1">{</span>1.0, 2.0, 3.0, 5.0, 6.0<span class="org-rainbow-delimiters-depth-1">}</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">The same client code works with any implementation of the interface. </span>
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"stack_sum(sv) = "</span> &lt;&lt; stack_sum<span class="org-rainbow-delimiters-depth-1">(</span>sv<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"stack_sum(sd) = "</span> &lt;&lt; stack_sum<span class="org-rainbow-delimiters-depth-1">(</span>sd<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;

<span class="org-type">IStack</span>* <span class="org-variable-name">spointer</span> = <span class="org-constant">nullptr</span>;
<span class="org-type">StackVector</span> <span class="org-variable-name">sv2</span> = <span class="org-rainbow-delimiters-depth-1">{</span>1.0, 2.0, 3.0, 5.0, 6.0<span class="org-rainbow-delimiters-depth-1">}</span>;
<span class="org-type">StackDeque</span>  <span class="org-variable-name">sd2</span> = <span class="org-rainbow-delimiters-depth-1">{</span>1.0, 2.0, 3.0, 5.0, 6.0<span class="org-rainbow-delimiters-depth-1">}</span>;
spointer = &amp;sv2;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"stack_sum(spointer) = "</span> &lt;&lt; stack_sum<span class="org-rainbow-delimiters-depth-1">(</span>spointer<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;
spointer = &amp;sd2;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"stack_sum(spointer) = "</span> &lt;&lt; stack_sum<span class="org-rainbow-delimiters-depth-1">(</span>spointer<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;

<span class="org-keyword">auto</span> <span class="org-variable-name">sptr</span> = <span class="org-constant">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">IStack</span>, <span class="org-constant">std</span>::<span class="org-type">function</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">void</span> <span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">IStack</span>*<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">&gt;</span><span class="org-rainbow-delimiters-depth-1">&gt;{</span>
        <span class="org-constant">nullptr</span>,
        <span class="org-comment-delimiter">// </span><span class="org-comment">Custom deleter </span>
        <span class="org-rainbow-delimiters-depth-2">[](</span><span class="org-type">IStack</span>* <span class="org-variable-name">p</span><span class="org-rainbow-delimiters-depth-2">){</span>
                <span class="org-constant">std</span>::cerr &lt;&lt; <span class="org-string">" ==== Stack deleted OK"</span> &lt;&lt; <span class="org-constant">std</span>::endl ;
                <span class="org-keyword">delete</span> p;
        <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
sptr.reset<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">new</span> <span class="org-type">StackVector</span><span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>;
sptr-&gt;push<span class="org-rainbow-delimiters-depth-1">(</span>10<span class="org-rainbow-delimiters-depth-1">)</span>;
sptr-&gt;push<span class="org-rainbow-delimiters-depth-1">(</span>25.0<span class="org-rainbow-delimiters-depth-1">)</span>;
sptr-&gt;push<span class="org-rainbow-delimiters-depth-1">(</span>20.0<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"stack_sum(sptr) = "</span> &lt;&lt; stack_sum<span class="org-rainbow-delimiters-depth-1">(</span>*sptr<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;
sptr.reset<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">new</span> <span class="org-type">StackDeque</span><span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>;
sptr-&gt;push<span class="org-rainbow-delimiters-depth-1">(</span>10<span class="org-rainbow-delimiters-depth-1">)</span>;
sptr-&gt;push<span class="org-rainbow-delimiters-depth-1">(</span>25.0<span class="org-rainbow-delimiters-depth-1">)</span>;
sptr-&gt;push<span class="org-rainbow-delimiters-depth-1">(</span>20.0<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"stack_sum(sptr) = "</span> &lt;&lt; stack_sum<span class="org-rainbow-delimiters-depth-1">(</span>*sptr<span class="org-rainbow-delimiters-depth-1">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;
</pre>
</div>

<p>
Compiling Running: 
</p>

<div class="org-src-container">
<pre class="src src-txt">$ clang++ interface-class.cpp -o interface-class.bin -g -std=c++1z -Wall -Wextra 
$ ./interface-class.bin
stack_sum(sv) = 17
stack_sum(sd) = 17
stack_sum(spointer) = 17
stack_sum(spointer) = 17
stack_sum(sptr) = 55
 ==== Stack deleted OK
stack_sum(sptr) = 55
 ==== Stack deleted OK
</pre>
</div>

<p>
References and further reading: 
</p>
<ul class="org-ul">
<li><a href="https://en.wikibooks.org/wiki/More_C++_Idioms/Interface_Class">More C++ Idioms/Interface Class - Wikibooks, open books for an open world</a></li>
<li><a href="https://accu.org/index.php/journals/269">ACCU - Separating Interface and Implementation in C++</a></li>
<li><a href="https://www.boost.org/doc/libs/1_63_0/libs/smart_ptr/sp_techniques.html">Smart Pointer Programming Techniques - 1.63.0</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org6ded86e" class="outline-3">
<h3 id="org6ded86e"><span class="section-number-3">2.2</span> PIMPL - Pointer to Implementation</h3>
<div class="outline-text-3" id="text-2-2">
<p>
The PIMPL - Pointer to Implementation idiom, also known as compiler
firewall, is a widely used technique  in C++ for completly hiding class
private members in the public header file. This technique uses an
opaque pointer to an internal non declared class in the current header
file encapsulating all fields of the outer class.
</p>

<p>
Also known as: 
</p>
<ul class="org-ul">
<li>PIMPL - Pointer to Implementation</li>
<li>Compiler firewall idiom</li>
<li>Cheshire Cat</li>
</ul>

<p>
Motivation and Benefits: 
</p>

<ul class="org-ul">
<li>Reduce compilation time as the number of #include headers in the
class header is not changed.</li>

<li>Makes the class data member in the public header really private.</li>

<li>Changing of private members of the class which are encapsulated in
the opaque pointer class does not require recompilation of client
code. This feature is very important for library development as it
avoid client code recompilation as the public headers are not
changed.</li>

<li>Less likely to breaking binary compatibility - ABI Application
Binary Interface.</li>

<li>Note: Changing class member variables or member functions (methods)
breaks the ABI and requires the recompilation of client code. The
pimpl maintains the binary compatibility by not changing class'
private members.</li>

<li>TL;DR
<ul class="org-ul">
<li>PIMPL: Allow changes to implementation without the
need to recompile client code.</li>
</ul></li>
</ul>

<p>
Drawbacks: 
</p>

<ul class="org-ul">
<li>More complexity and work for API implementators.</li>
<li>Not convenient when there are protected members which needs to be
accessed by subclasses.</li>
<li>Runtime performance overhead due to the pointer indirection.</li>
</ul>

<p>
Example: All private members of class CashFlow are conained in the
opaque type Impl which is not defined in the header file.
</p>

<ul class="org-ul">
<li>file: <span class="underline">CashFlow.h</span>  -&gt; Class public interface.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#if</span><span class="org-negation-char"><span class="org-preprocessor">n</span></span><span class="org-preprocessor">def</span> _CashFlow_H_
<span class="org-preprocessor">#define</span> <span class="org-variable-name">_CashFlow_H_</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">C++ 11's smart pointers</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">memory</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-keyword">class</span> <span class="org-type">CashFlow</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">Forward declaration of incomplete type.</span>
    <span class="org-keyword">struct</span> <span class="org-type">Impl</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">This opaque type encapsulate the outer class' private member </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Pointer to implementation (PIMPL)</span>
    <span class="org-constant">std</span>::<span class="org-type">unique_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Impl</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">m_pimpl</span>;
<span class="org-function-name">public</span>:
    <span class="org-comment-delimiter">// </span><span class="org-comment">Default ctor </span>
    <span class="org-function-name">CashFlow</span><span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-type">void</span> <span class="org-function-name">show</span><span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-type">void</span> <span class="org-function-name">add</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span>;
    <span class="org-type">int</span>  <span class="org-function-name">size</span><span class="org-rainbow-delimiters-depth-2">()</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Net Present Value - NPV of cash flow for a given rate of return </span>
    <span class="org-type">double</span> <span class="org-function-name">npv</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">rate</span><span class="org-rainbow-delimiters-depth-2">)</span>; 
    <span class="org-comment-delimiter">// </span><span class="org-comment">Compute IRR - Internal rate of return </span>
    <span class="org-type">double</span> <span class="org-function-name">irr</span><span class="org-rainbow-delimiters-depth-2">()</span>; 
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-preprocessor">#endif</span> <span class="org-comment-delimiter">// </span><span class="org-comment">--- EOF ---- // </span>
</pre>
</div>

<ul class="org-ul">
<li>file: <span class="underline">CashFlow.cpp</span>  -&gt; Class implementation.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">C++ 11's smart pointers</span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">memory</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string">"CashFlow.h"</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Struct is just class with all members</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">public by default </span>
<span class="org-keyword">struct</span> <span class="org-constant">CashFlow</span>::<span class="org-type">Impl</span><span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">cash flow vector </span>
    <span class="org-constant">std</span>::<span class="org-type">vector</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">double</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">m_clf</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Default ctor </span>
    <span class="org-function-name">Impl</span><span class="org-rainbow-delimiters-depth-2">(){}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Default dtor </span>
    ~Impl<span class="org-rainbow-delimiters-depth-2">()</span> = <span class="org-keyword">default</span>;  
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Default ctor </span>
<span class="org-function-name">CashFlow</span>::~CashFlow = <span class="org-keyword">default</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Ctor </span>
<span class="org-function-name">CashFlow</span>::CashFlow<span class="org-rainbow-delimiters-depth-1">()</span>: m_pimpl<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">new</span> <span class="org-type">Impl</span><span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{}</span>

<span class="org-type">void</span> <span class="org-constant">CashFlow</span>::<span class="org-function-name">add</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-1">){</span>
    m_pimpl-&gt;m_clf.push_back<span class="org-rainbow-delimiters-depth-2">(</span>x<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">double</span> <span class="org-constant">CashFlow</span>::<span class="org-function-name">get</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span><span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-keyword">return</span> m_pimpl-&gt;m_clf<span class="org-rainbow-delimiters-depth-2">[</span>i<span class="org-rainbow-delimiters-depth-2">]</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
   ... ... ... .... 
</pre>
</div>

<p>
References and further: 
</p>

<ul class="org-ul">
<li><b>Pimpl Idiom</b> - &lt;&gt;</li>

<li><b>Best Friends: C++11 Move Semantics and Pimpl</b> -
<a href="https://www.embeddeduse.com/2016/05/30/best-friends-cpp11-move-semantics-and-pimpl/">https://www.embeddeduse.com/2016/05/30/best-friends-cpp11-move-semantics-and-pimpl/</a></li>

<li><b>Improving C++ Encapsulation with the Pimpl Idiom</b> -
<a href="https://visualstudiomagazine.com/articles/2012/11/29/the-pimpl-idiom-in-c-plus-plus.aspx">https://visualstudiomagazine.com/articles/2012/11/29/the-pimpl-idiom-in-c-plus-plus.aspx</a></li>

<li><b>Why every C++ developer should know about the pimpl idiom pattern</b> -
<a href="https://tonka2013.wordpress.com/2013/08/31/why-every-c-developer-should-know-about-the-pimpl-idiom-pattern/">https://tonka2013.wordpress.com/2013/08/31/why-every-c-developer-should-know-about-the-pimpl-idiom-pattern/</a></li>

<li><b>Passing Containing Parent to pimpl idiom implementation class</b> -
<a href="http://www.sharprobotica.com/2010/04/passing-containing-parent-to-pimpl-idiom-implementation-class/">http://www.sharprobotica.com/2010/04/passing-containing-parent-to-pimpl-idiom-implementation-class/</a></li>

<li><b>Dive in to C++ and survive</b> -
<a href="https://www.embedded.com/print/4008235">https://www.embedded.com/print/4008235</a></li>

<li><b>Modern and Lucid C++ Advanced for Professional Programmers</b> -
<a href="https://wiki.ifs.hsr.ch/CppAdvanced/files/lecture_12_advanced_library_design.pdf">https://wiki.ifs.hsr.ch/CppAdvanced/files/lecture_12_advanced_library_design.pdf</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgb0db59a" class="outline-3">
<h3 id="orgb0db59a"><span class="section-number-3">2.3</span> RAII - Resource Aquisition Is Initialization</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Comes from book: <span class="underline">C++ Programming with Design Patterns Revealed</span> 
</p>

<p>
RAII is a design pattern which takes advantage of C++'s deterministic
destructor feature for deallocating resources such as pointers to
objects allocated on the heap memory, database handlers, socket
handlers and etc. The RAAI technique uses an object allocated on the
stack which acquires the resource as a constructor argument and
performs the resource cleanup in the destructor method which is called
when when the wrapper object goes out scope or an exception happens.
</p>

<ul class="org-ul">
<li>Note: This pattern is specific for C++, for Java and Scala use <span class="underline">try</span>
<span class="underline">finally</span> statements. Python has the <span class="underline">with</span> statement and C# has the
<span class="underline">using</span> statement. In addition, this pattern needs the
<b>deterministic destructor</b> feature which is unique to C++.</li>
</ul>

<p>
Note: It is no longer necessary to design any class for RAII since
C++11 has smart pointers which already implements this
pattern. However, it is important to understand how this idiom works
and the problem that it solves.
</p>
<ul class="org-ul">
<li>In C++ &gt;= C++ 11, it is better to use <code>unique_ptr</code> for handling
resources as shown at <a href="https://msdn.microsoft.com/en-us/library/hh438480.aspx">Objects Own Resources (RAII)</a></li>
</ul>

<p>
RAII is described as the process of: 
</p>
<ul class="org-ul">
<li>Acquiring a resouce and wrapping it as an object's state.</li>
<li>Using the resource</li>
<li>Releasing the resource in the object's destructor member function
which is executed when the object goes out of escope.</li>
</ul>

<p>
Problems solved by the pattern.
</p>
<ul class="org-ul">
<li>Avoid <a href="https://en.wikipedia.org/wiki/Memory_leak">memory leak</a></li>
<li>Avoid <a href="https://en.wikipedia.org/wiki/Resource_leak">resource leak</a></li>
<li>Save and restore context. =&gt; An object allocated on the stack could
be used to set the current directory and restore saved directory
when the destructor is invoked when the object goes out scope. The
same technique could be used to save and restore std::cout or
std::cerr flags.</li>
</ul>

<p>
Known uses: 
</p>
<ul class="org-ul">
<li>C++11 <span class="underline">shared_ptr</span> (Smart pointer)</li>
<li>C++11 <span class="underline">unique_ptr</span> (Smart pointer)</li>
</ul>

<p>
 <b>Example 1:</b> Naive code - If an exception happens, the resource will not
be released and the code will be vulnerable against memory leak or
resource leak.  
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">Handler</span>* <span class="org-variable-name">handle</span>  = getDatabaseHandler<span class="org-rainbow-delimiters-depth-1">()</span>; 
<span class="org-comment-delimiter">// </span><span class="org-comment">Throw exception =&gt; Resource leak </span>
performInvalidOperation<span class="org-rainbow-delimiters-depth-1">(</span>handle<span class="org-rainbow-delimiters-depth-1">)</span>;  
...
<span class="org-comment-delimiter">// </span><span class="org-comment">Forget to release resource!</span>
deleteResource<span class="org-rainbow-delimiters-depth-1">(</span>handle<span class="org-rainbow-delimiters-depth-1">)</span>; 
</pre>
</div>

<p>
Or: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">Object</span>* <span class="org-variable-name">heapObject</span> = <span class="org-keyword">new</span> <span class="org-type">Object</span><span class="org-rainbow-delimiters-depth-1">(</span>param0, param1, ....<span class="org-rainbow-delimiters-depth-1">)</span>;
peformOperation<span class="org-rainbow-delimiters-depth-1">(</span>heapObject<span class="org-rainbow-delimiters-depth-1">)</span>; 
heapObject-&gt;method1; 

<span class="org-comment-delimiter">// </span><span class="org-comment">Throw exception!! ==&gt; Memory Leak!</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">If the user forget this statement, </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">a memory leak will happen. </span>
<span class="org-keyword">delete</span> heapObject; 
</pre>
</div>

<p>
<b>Solution - RAAI Pattern</b>
</p>

<ul class="org-ul">
<li>An object is used to control the lifetime of a resource ensuring
that is released when the object goes out of scope or an exception
happens. The resource is aquired by the constructor and realeased
by the destructor.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">Resource</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">class</span> <span class="org-type">RaaiHandler</span> <span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:  
   <span class="org-comment-delimiter">// </span><span class="org-comment">Consructor: Acquire resource on the constructor </span>
   <span class="org-function-name">RaaiHandler</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">Resource</span>* <span class="org-variable-name">rawHandle_</span><span class="org-rainbow-delimiters-depth-2">)</span> : <span class="org-rainbow-delimiters-depth-2">(</span>rawHandle_<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{}</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Destructor: Releases resource </span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">The destructor is always called when the object goes out of scope </span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">or an exception happens.</span>
   ~<span class="org-function-name">RaiiHandler</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-keyword">delete</span> _handler; 
    <span class="org-rainbow-delimiters-depth-2">}</span>      
<span class="org-function-name">private</span>:
   <span class="org-type">RaiiHandler</span>* <span class="org-variable-name">_handler</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Object created without new keyword is allocated in the stack, not in the heap.</span>
<span class="org-type">RaiiHandler</span> <span class="org-function-name">hnd</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">createNewResource</span><span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">.. . Peform operation </span>
Operation<span class="org-rainbow-delimiters-depth-1">(</span>hnd<span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-comment-delimiter">// </span><span class="org-comment">Once the escope is gone, the resource is released.</span>
</pre>
</div>

<p>
<b>References</b>
</p>

<ul class="org-ul">
<li><a href="https://www.codeproject.com/Articles/580077/ResourceplusAcquisitionplusisplusInitializationplu">Resource Acquisition is Initialization (RAII) - CodeProject</a></li>
<li><a href="https://stackoverflow.com/questions/2321511/what-is-meant-by-resource-acquisition-is-initialization-raii">c++ - What is meant by Resource Acquisition is Initialization (RAII)? - Stack Overflow</a></li>
<li><a href="https://www.codeproject.com/Articles/122129/RAII-Resource-Acquisition-Is-Initialization-C-Help">RAII (Resource Acquisition Is Initialization) C# Helper Classes - CodeProject</a></li>
<li><a href="http://jrdodds.blogs.com/blog/2004/08/raii_in_c.html/">RAII in C++ (constructive nonconformist)</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgac9738a" class="outline-3">
<h3 id="orgac9738a"><span class="section-number-3">2.4</span> Type Erasure</h3>
<div class="outline-text-3" id="text-2-4">
</div>
<div id="outline-container-org58a8ded" class="outline-4">
<h4 id="org58a8ded"><span class="section-number-4">2.4.1</span> Overview</h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
Type erasure is a set of techniques for providing an uniform interface
for many different types by hiding the type information from the
client code. In C++ type erasure can be implemented with a combination
of object oriented programming and generic programming, in other
words, inheritance and templates. The fundamental building blocks of
this pattern are a base class, called <span class="underline">concept</span>, which provides the
uniform interface to the wrapped types and a derived templatized
class, called <span class="underline">model</span>, inherting the concept class which adapts the
wrapped type to the concept class. The inheritance allows any template
instantation of the model to be treated as it was the base class, thus
this approach hides the type information which can be later recovered
by downcasting the base class to the derived class.
</p>

<ul class="org-ul">
<li>Definition by Dave Abrahams and Aleksey Curtovoy in, <b>C++ Template</b>
<b>Metaprogramming.</b></li>
</ul>

<blockquote>
<p>
In its fullest expression, type erasure is the process of turning a
wide variety of types with a common interface into one type with that
same interface
</p>
</blockquote>

<p>
Parts: 
</p>

<ul class="org-ul">
<li><b>Concept class</b>
<ul class="org-ul">
<li>base class - definines the interface being enforced.</li>
</ul></li>
<li><b>Model class</b>
<ul class="org-ul">
<li>templatized class inherting the concept class adpating the
wrapped type to the concept class and holding an instance of the
wrapped type.</li>
</ul></li>
<li><b>Type Erasure class</b> (outter class)
<ul class="org-ul">
<li>Both the concept and model classes are private inner classes of
the type erasure class.</li>
<li>The type erasure class takes an instance of the model class in the
constructor.</li>
<li>This class stores a pointer variable to the concept class, but
storing a pointer to the model class (dynamic polymorphism).</li>
</ul></li>
<li><b>Wrapped Type</b> or Objects 
<ul class="org-ul">
<li>Types wrapped by the model class wich will be erased.</li>
</ul></li>
</ul>

<p>
Use-cases: 
</p>

<ul class="org-ul">
<li>Create a common interface for many different types.</li>
<li>Store wrapped types without a common base class in STL containers.</li>
<li>Store templatized classes in STL containers.</li>
<li>Implement dynamic or runtime polymorphism with value semantics.</li>
<li>Take advantage of the commonality of many unrelated classes without
a common base class without modifying their source code.</li>
</ul>

<p>
Known uses in C++ standard library: 
</p>

<ul class="org-ul">
<li>std::function (C++11, formber Boost.Function)</li>

<li>std::any (C++17, former Boost.Any)
<ul class="org-ul">
<li>A container which can store anything and the type of the stored
object is not known at runtime.</li>
</ul></li>

<li>std::variant (C++17, former Boost.Variant)
<ul class="org-ul">
<li>Provides an interface for sum types or disjoint union or <span class="underline">visitor</span> OO
design pattern which is useful for manipulating abstract syntax
tree, creating interpreters, tree data structures and fixed class
hierarchies.</li>
</ul></li>

<li>void* - Void pointer in many C-APIs.</li>
</ul>


<p>
References and further reading:
</p>
<ul class="org-ul">
<li>Nevin Liber, <b>Type Erasure</b>  <a href="http://files.meetup.com/1455470/Type%20Erasure.pdf">http://files.meetup.com/1455470/Type Erasure.pdf</a></li>
<li><a href="https://stackoverflow.com/questions/46041683/type-erasure-retrieving-value-type-check-at-compile-time">c++ - Type erasure: Retrieving value - type check at compile time - Stack Overflow</a></li>
<li><a href="http://talesofcpp.fusionfenix.com/post-16/episode-nine-erasing-the-concrete">Episode Nine: Erasing the Concrete</a></li>
<li><a href="https://codereview.stackexchange.com/questions/41879/concept-based-polymorphism">c++ - Concept based polymorphism - Code Review Stack Exchange</a></li>
<li><a href="https://github.com/andyprowl/virtual-concepts/blob/master/draft/Dynamic%20Generic%20Programming%20with%20Virtual%20Concepts.pdf">Dynamic Programming with Virtual Concepts</a></li>
<li><a href="https://www.reddit.com/r/cpp/comments/5epngi/type_erased_concepts/">Type erased concepts : cpp</a></li>
<li><a href="http://www.cplusplus.com/articles/oz18T05o/">C++ type erasure - C++ Articles</a></li>
<li><a href="https://blog.tartanllama.xyz/type-erasure-unified-call/">Type erasure with unified call syntax</a></li>
<li><a href="http://www.sgh1.net/posts/cpp-type-erasure.md">My Internet Weblog - Type Erasure in C++</a></li>
<li><a href="https://accu.org/index.php/journals/2424">ACCU - Polymorphism in C++ – A Type Compatibility View</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgaeb12c0" class="outline-4">
<h4 id="orgaeb12c0"><span class="section-number-4">2.4.2</span> Example 1 - Simple type erasure.</h4>
<div class="outline-text-4" id="text-2-4-2">
<p>
<span class="underline">Problem:</span> Handle the classes A, B and C which don't have a common base
class using dynamic (aka runtime) polymorphism taking advantage of
their commonality, the method .getName(). Note: the source code of A,
B and C aren't allowed to be modified
</p>

<ul class="org-ul">
<li>Complete source code:
<ul class="org-ul">
<li>File: <a href="src/design-patterns/type-erasure1.cpp">file:src/design-patterns/type-erasure1.cpp</a></li>
<li>Online Compiler: <a href="https://rextester.com/XFH16030">https://rextester.com/XFH16030</a></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">A</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> <span class="org-string">"class A"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">sayA</span><span class="org-rainbow-delimiters-depth-2">(){</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"I am the class A"</span> &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">class</span> <span class="org-type">B</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>  <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> <span class="org-string">"class B"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">sayB</span><span class="org-rainbow-delimiters-depth-2">(){</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"I am the class B"</span> &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>   
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">class</span> <span class="org-type">C</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
    <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span>  <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">return</span> <span class="org-string">"class C"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-type">void</span> <span class="org-function-name">sayC</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"I am the class C"</span> &lt;&lt; <span class="org-string">"\n"</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;
</pre>
</div>

<p>
Solution: Type erasure design pattern. 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">TypeErasure</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
    <span class="org-comment-delimiter">//  </span><span class="org-comment">--- Forward declarations ----</span>
    <span class="org-keyword">class</span> <span class="org-type">Concept</span>;
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">class</span> <span class="org-type">T</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-keyword">class</span> <span class="org-type">Model</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">--- Member Variables ----- // </span>
    <span class="org-constant">std</span>::<span class="org-type">shared_ptr</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Concept</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">_concept_ptr</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Optional: </span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">RTTI (runtime type information) for recovering wrapped type</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">by downcasting </span>
    <span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">type_info</span>&amp; <span class="org-variable-name">_tinfo</span>;
<span class="org-function-name">public</span>:
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> 
    <span class="org-function-name">TypeErasure</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">const</span> <span class="org-type">T</span>&amp; <span class="org-variable-name">obj</span><span class="org-rainbow-delimiters-depth-2">)</span>
    : _concept_ptr<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">std</span>::make_shared<span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">Model</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">T</span><span class="org-rainbow-delimiters-depth-4">&gt;</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span>obj<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
    ,_tinfo<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-keyword">typeid</span><span class="org-rainbow-delimiters-depth-3">(</span>T<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-rainbow-delimiters-depth-2">{</span>       
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">auto</span> <span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-2">{</span>
            <span class="org-keyword">return</span> _concept_ptr-&gt;getName<span class="org-rainbow-delimiters-depth-3">()</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-comment-delimiter">// </span><span class="org-comment">Recover reference to wrapped type </span>
    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">recover</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">T</span> <span class="org-rainbow-delimiters-depth-2">{</span>       
        <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">typeid</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-type">T</span><span class="org-rainbow-delimiters-depth-4">)</span> != _tinfo<span class="org-rainbow-delimiters-depth-3">)</span>
                <span class="org-keyword">throw</span> <span class="org-constant">std</span>::runtime_error<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Error: cannot cast to this type"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">Note: static_cast downcasting to wrong type has undefined behavior,</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">use with care!</span>
        <span class="org-keyword">return</span> <span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">Model</span><span class="org-rainbow-delimiters-depth-4">&lt;</span><span class="org-type">T</span><span class="org-rainbow-delimiters-depth-4">&gt;</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span>_concept_ptr.get<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>-&gt;_obj;
    <span class="org-rainbow-delimiters-depth-2">}</span>

    <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
    <span class="org-keyword">auto</span> <span class="org-function-name">hasType</span><span class="org-rainbow-delimiters-depth-2">()</span> -&gt; <span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-2">{</span>
            <span class="org-keyword">return</span> _tinfo == <span class="org-keyword">typeid</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">T</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-function-name">private</span>:
   <span class="org-comment-delimiter">// </span><span class="org-comment">Concept class defines the interface to be enforced</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">In general, it is an interface class, a class with only pure virtual</span>
   <span class="org-comment-delimiter">// </span><span class="org-comment">methods (abstract methods), in other words methods without implementation.</span>
   <span class="org-keyword">class</span> <span class="org-type">Concept</span><span class="org-rainbow-delimiters-depth-2">{</span>
   <span class="org-keyword">public</span>:
           <span class="org-keyword">virtual</span> <span class="org-keyword">auto</span> <span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> = 0;
           <span class="org-keyword">virtual</span> ~<span class="org-function-name">Concept</span><span class="org-rainbow-delimiters-depth-3">()</span> = <span class="org-keyword">default</span>;
   <span class="org-rainbow-delimiters-depth-2">}</span>;

   <span class="org-comment-delimiter">// </span><span class="org-comment">Adapt the wrapped type (T) to the concept</span>
   <span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-keyword">typename</span> <span class="org-type">T</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>
   <span class="org-keyword">class</span> <span class="org-type">Model</span>: <span class="org-keyword">public</span> <span class="org-type">Concept</span> <span class="org-rainbow-delimiters-depth-2">{</span>
   <span class="org-keyword">public</span>:
           <span class="org-comment-delimiter">// </span><span class="org-comment">Instance of the wrapped type </span>
           <span class="org-type">T</span> <span class="org-variable-name">_obj</span>;
           <span class="org-comment-delimiter">// </span><span class="org-comment">Initialize _opj by copying the parameter </span>
           <span class="org-function-name">Model</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-keyword">const</span> <span class="org-type">T</span>&amp; <span class="org-variable-name">obj</span><span class="org-rainbow-delimiters-depth-3">)</span>: <span class="org-function-name">_obj</span><span class="org-rainbow-delimiters-depth-3">(</span>obj<span class="org-rainbow-delimiters-depth-3">){}</span>
           <span class="org-keyword">auto</span> <span class="org-function-name">getName</span><span class="org-rainbow-delimiters-depth-3">()</span> <span class="org-keyword">const</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-3">{</span>
                   <span class="org-keyword">return</span> _obj.getName<span class="org-rainbow-delimiters-depth-4">()</span>;
           <span class="org-rainbow-delimiters-depth-3">}</span>
   <span class="org-rainbow-delimiters-depth-2">}</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>;

</pre>
</div>

<p>
Testing in Cling REPL: 
</p>

<div class="org-src-container">
<pre class="src src-cpp">&gt;&gt; .L type-erasure1.cpp 
&gt;&gt; 
&gt;&gt; A<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">(</span>A<span class="org-rainbow-delimiters-depth-1">)</span> @0x1fc2970
&gt;&gt; A<span class="org-rainbow-delimiters-depth-1">()</span>.getName<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"class A"</span>
&gt;&gt; B<span class="org-rainbow-delimiters-depth-1">()</span>.getName<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"class B"</span>
&gt;&gt; 
&gt;&gt; B<span class="org-rainbow-delimiters-depth-1">()</span>.sayB<span class="org-rainbow-delimiters-depth-1">()</span>
I am the <span class="org-keyword">class</span> <span class="org-type">B</span>
&gt;&gt; 

<span class="org-keyword">auto</span> tlist = <span class="org-constant">std</span>::deque<span class="org-rainbow-delimiters-depth-1">&lt;</span>TypeErasure<span class="org-rainbow-delimiters-depth-1">&gt;()</span>;
tlist.emplace_back<span class="org-rainbow-delimiters-depth-1">(</span>A<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
tlist.emplace_back<span class="org-rainbow-delimiters-depth-1">(</span>B<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>
tlist.emplace_back<span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>

&gt;&gt; <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">t</span>: tlist<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Class type = "</span> &lt;&lt; t.getName<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">"\n"</span>; <span class="org-rainbow-delimiters-depth-1">}</span>
<span class="org-type">Class</span> <span class="org-variable-name">type</span> = <span class="org-keyword">class</span> A
Class type = <span class="org-keyword">class</span> B
Class type = <span class="org-keyword">class</span> C
&gt;&gt; 

&gt;&gt; tlist.at<span class="org-rainbow-delimiters-depth-1">(</span>0<span class="org-rainbow-delimiters-depth-1">)</span>.recover<span class="org-rainbow-delimiters-depth-1">&lt;</span>A<span class="org-rainbow-delimiters-depth-1">&gt;()</span>
<span class="org-rainbow-delimiters-depth-1">(</span>A<span class="org-rainbow-delimiters-depth-1">)</span> @0x20cc590
&gt;&gt; tlist.at<span class="org-rainbow-delimiters-depth-1">(</span>0<span class="org-rainbow-delimiters-depth-1">)</span>.recover<span class="org-rainbow-delimiters-depth-1">&lt;</span>A<span class="org-rainbow-delimiters-depth-1">&gt;()</span>.sayA<span class="org-rainbow-delimiters-depth-1">()</span>
I am the <span class="org-keyword">class</span> <span class="org-type">A</span>
&gt;&gt; tlist.at<span class="org-rainbow-delimiters-depth-1">(</span>0<span class="org-rainbow-delimiters-depth-1">)</span>.recover<span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">A</span><span class="org-rainbow-delimiters-depth-1">&gt;()</span>.getName<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"class A"</span>
&gt;&gt; 

&gt;&gt; tlist.at<span class="org-rainbow-delimiters-depth-1">(</span>1<span class="org-rainbow-delimiters-depth-1">)</span>.recover<span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">B</span><span class="org-rainbow-delimiters-depth-1">&gt;()</span>.getName<span class="org-rainbow-delimiters-depth-1">()</span>
<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::string<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-string">"class B"</span>
&gt;&gt; 

&gt;&gt; tlist.at<span class="org-rainbow-delimiters-depth-1">(</span>1<span class="org-rainbow-delimiters-depth-1">)</span>.recover<span class="org-rainbow-delimiters-depth-1">&lt;</span>C<span class="org-rainbow-delimiters-depth-1">&gt;()</span>
<span class="org-type">Error</span> <span class="org-type">in</span> <span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-constant">TRint</span>::HandleTermInput<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>: <span class="org-constant">std</span>::runtime_error caught: Error: cannot cast to <span class="org-keyword">this</span> type
&gt;&gt; 
</pre>
</div>

<p>
Main function: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">auto</span> <span class="org-variable-name">tlist</span> = <span class="org-constant">std</span>::deque<span class="org-rainbow-delimiters-depth-1">&lt;</span>TypeErasure<span class="org-rainbow-delimiters-depth-1">&gt;()</span>;
tlist.emplace_back<span class="org-rainbow-delimiters-depth-1">(</span>A<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>;
tlist.emplace_back<span class="org-rainbow-delimiters-depth-1">(</span>B<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>;
tlist.emplace_back<span class="org-rainbow-delimiters-depth-1">(</span>C<span class="org-rainbow-delimiters-depth-2">()</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-function-name">std</span>::cout &lt;&lt; <span class="org-string">"\n"</span> &lt;&lt; <span class="org-string">"EXPERIMENT 1 ============"</span> &lt;&lt; <span class="org-string">"\n"</span>;   
<span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-keyword">auto</span>&amp; <span class="org-variable-name">t</span>: tlist<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Class type = "</span> &lt;&lt; t.getName<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">"\n"</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">Note: It is a copy!</span>
 <span class="org-type">A</span> <span class="org-variable-name">objA</span> = tlist.at<span class="org-rainbow-delimiters-depth-1">(</span>0<span class="org-rainbow-delimiters-depth-1">)</span>.recover<span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">A</span><span class="org-rainbow-delimiters-depth-1">&gt;()</span>;
 objA.sayA<span class="org-rainbow-delimiters-depth-1">()</span>;

 <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"\n"</span> &lt;&lt; <span class="org-string">"EXPERIMENT 2 ============"</span> &lt;&lt; <span class="org-string">"\n"</span>;

 <span class="org-comment-delimiter">// </span><span class="org-comment">Simulate downcasting failure </span>
 <span class="org-keyword">try</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-type">B</span> <span class="org-variable-name">objB</span> = tlist.at<span class="org-rainbow-delimiters-depth-2">(</span>0<span class="org-rainbow-delimiters-depth-2">)</span>.recover<span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">B</span><span class="org-rainbow-delimiters-depth-2">&gt;()</span>;
    objB.sayB<span class="org-rainbow-delimiters-depth-2">()</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-keyword">catch</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-constant">std</span>::<span class="org-type">runtime_error</span>&amp; <span class="org-variable-name">ex</span><span class="org-rainbow-delimiters-depth-1">){</span>
    <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">" [FAILURE]"</span> &lt;&lt; ex.what<span class="org-rainbow-delimiters-depth-2">()</span> &lt;&lt; <span class="org-string">"\n"</span>;
 <span class="org-rainbow-delimiters-depth-1">}</span>

 <span class="org-type">B</span> <span class="org-variable-name">objB</span> = tlist.at<span class="org-rainbow-delimiters-depth-1">(</span>1<span class="org-rainbow-delimiters-depth-1">)</span>.recover<span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">B</span><span class="org-rainbow-delimiters-depth-1">&gt;()</span>;
 objB.sayB<span class="org-rainbow-delimiters-depth-1">()</span>;

 <span class="org-keyword">auto</span> <span class="org-variable-name">objC</span> = tlist.at<span class="org-rainbow-delimiters-depth-1">(</span>2<span class="org-rainbow-delimiters-depth-1">)</span>.recover<span class="org-rainbow-delimiters-depth-1">&lt;</span>C<span class="org-rainbow-delimiters-depth-1">&gt;()</span>;
 objC.sayC<span class="org-rainbow-delimiters-depth-1">()</span>;
</pre>
</div>

<p>
Compiling and running: (File: <a href="src/design-patterns/type-erasure1.cpp">file:src/design-patterns/type-erasure1.cpp</a>)
</p>

<div class="org-src-container">
<pre class="src src-cpp">$ clang++ type-erasure1.cpp -o <span class="org-keyword">type-erasure1.bin</span> -g -std=c++1z -Wall -Wextra 
$ ./type-erasure1.bin

EXPERIMENT 1 ============
Class type = <span class="org-keyword">class</span> A
Class type = <span class="org-keyword">class</span> B
Class type = <span class="org-keyword">class</span> C
I am the <span class="org-keyword">class</span> A

EXPERIMENT 2 ============
 <span class="org-rainbow-delimiters-depth-1">[</span><span class="org-constant">FAILURE</span><span class="org-rainbow-delimiters-depth-1">]</span>Error: cannot cast to <span class="org-keyword">this</span> type
I am the <span class="org-keyword">class</span> B
I am the <span class="org-keyword">class</span> C
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgbd1dd0d" class="outline-3">
<h3 id="orgbd1dd0d"><span class="section-number-3">2.5</span> CRTP - Curious Recurring Template Pattern</h3>
<div class="outline-text-3" id="text-2-5">
</div>
<div id="outline-container-org6b5df90" class="outline-4">
<h4 id="org6b5df90"><span class="section-number-4">2.5.1</span> Overview</h4>
<div class="outline-text-4" id="text-2-5-1">
<p>
It is a variation of GOF template design pattern where an algorithm
defined by the base class is customized or specified by the derived 
class. However, unlike the GOF one, this version uses C++ template
metaprogramming for emulating dynamic polymorphism or inheritance
at compile time. So it makes the code faster by eliminating virtual
function-calls.
</p>

<p>
Features: 
</p>
<ul class="org-ul">
<li>Coined by James Coplien - 1995</li>
<li>Static polymorphism technique based on template metaprogramming for
speeding up the code eliminating virtual functions.</li>
</ul>

<p>
Use cases:
</p>
<ul class="org-ul">
<li>Reduce virtual function call overhead - by simulating dynamic
polymorphism through static polymorphism.</li>
<li>Implement state machines.</li>
<li>Implement high performance numerical libraries.</li>
<li>Code injection.</li>
</ul>

<p>
Libraries using this pattern:
</p>
<ul class="org-ul">
<li>Boost.Iterator</li>
<li>Boost.Python</li>
<li>Boost.Serialization</li>
</ul>

<p>
Also known as: 
</p>
<ul class="org-ul">
<li>Code injection</li>
<li>Barton‐Nackman Trick</li>
<li>Mixin - Name used outside C++ community</li>
</ul>
</div>
</div>

<div id="outline-container-orgec5029f" class="outline-4">
<h4 id="orgec5029f"><span class="section-number-4">2.5.2</span> Example</h4>
<div class="outline-text-4" id="text-2-5-2">
<p>
<b>Approach 1 - GOF - OOP template pattern</b> 
</p>

<ul class="org-ul">
<li>Code 1: GOF Template method design pattern using virtual functions.</li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">class</span> <span class="org-type">IntervalSummation</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
        <span class="org-comment-delimiter">// </span><span class="org-comment">Algorithm or entry point which calls the derived class method.</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">This is the template method </span>
        <span class="org-type">double</span> <span class="org-function-name">summation</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">lower</span>, <span class="org-type">int</span> <span class="org-variable-name">upper</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span><span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-type">double</span> <span class="org-variable-name">sum</span> = 0;
                <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = lower; i &lt;= upper; i++<span class="org-rainbow-delimiters-depth-3">)</span>
                        sum += <span class="org-keyword">this</span>-&gt;stepFn<span class="org-rainbow-delimiters-depth-3">(</span>i<span class="org-rainbow-delimiters-depth-3">)</span>;
                <span class="org-keyword">return</span> sum; 
        <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-function-name">protected</span>:
        <span class="org-comment-delimiter">// </span><span class="org-comment">Hook method or to be defined by the derived class</span>
        <span class="org-keyword">virtual</span> <span class="org-type">double</span> <span class="org-function-name">stepFn</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> = 0 ;
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">class</span> <span class="org-type">SumOfSquares</span>: <span class="org-keyword">public</span> <span class="org-type">IntervalSummation</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
        <span class="org-type">double</span> <span class="org-function-name">stepFn</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> x * x; <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">class</span> <span class="org-type">SumOfCubes</span>: <span class="org-keyword">public</span> <span class="org-type">IntervalSummation</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">private</span>:
        <span class="org-type">double</span> <span class="org-function-name">stepFn</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> x * x * x; <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-type">void</span> <span class="org-function-name">clientCode</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">IntervalSummation</span>&amp; <span class="org-variable-name">obj</span><span class="org-rainbow-delimiters-depth-1">){</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Summation at [0, 15] = "</span> &lt;&lt; obj.summation<span class="org-rainbow-delimiters-depth-2">(</span>0, 15<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>Approach 2 - CRTP generic programming pattern</b> 
</p>

<ul class="org-ul">
<li>Code 2: Code rewritten using CRTP for eliminating virtual function
calls. The advantage is that this code can run faster than the
previous one, however the cost is the higher complexity, loss of
readability and runtime polymorphism. For instance, now is not
possible to store multiple implementations of IntervalSummation in
a data structure or refer to them with the same pointer.</li>

<li>File: <a href="src/design-patterns/crtp1.cpp">file:src/design-patterns/crtp1.cpp</a></li>
<li>Online Compiler: <a href="https://rextester.com/ZLZH2040">https://rextester.com/ZLZH2040</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">Implementation</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-keyword">class</span> <span class="org-type">IntervalSummation</span><span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-function-name">public</span>:
        <span class="org-comment-delimiter">// </span><span class="org-comment">Get reference to implementation </span>
        <span class="org-type">Implementation</span>&amp; <span class="org-function-name">self</span><span class="org-rainbow-delimiters-depth-2">(){</span>
                <span class="org-keyword">return</span> *<span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">Implementation</span>*<span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Overload method </span>
        <span class="org-keyword">const</span> <span class="org-type">Implementation</span>&amp; <span class="org-function-name">self</span><span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span>
                <span class="org-keyword">return</span> *<span class="org-keyword">static_cast</span><span class="org-rainbow-delimiters-depth-3">&lt;</span><span class="org-type">Implementation</span> <span class="org-keyword">const</span> * <span class="org-keyword">const</span><span class="org-rainbow-delimiters-depth-3">&gt;(</span><span class="org-keyword">this</span><span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-rainbow-delimiters-depth-2">}</span>   
        <span class="org-type">double</span> <span class="org-function-name">summation</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">int</span> <span class="org-variable-name">lower</span>, <span class="org-type">int</span> <span class="org-variable-name">upper</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-type">double</span> <span class="org-variable-name">sum</span> = 0;
        <span class="org-keyword">for</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">int</span> <span class="org-variable-name">i</span> = lower; i &lt;= upper; i++<span class="org-rainbow-delimiters-depth-3">)</span>
              sum += self<span class="org-rainbow-delimiters-depth-3">()</span>.stepFn<span class="org-rainbow-delimiters-depth-3">(</span>i<span class="org-rainbow-delimiters-depth-3">)</span>;
        <span class="org-keyword">return</span> sum; 
        <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">class</span> <span class="org-type">SumOfSquares</span>: <span class="org-keyword">public</span> <span class="org-type">IntervalSummation</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">SumOfSquares</span><span class="org-rainbow-delimiters-depth-1">&gt;{</span>
<span class="org-function-name">public</span>:
        <span class="org-type">double</span> <span class="org-function-name">stepFn</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> x * x; <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">class</span> <span class="org-type">SumOfCubes</span>: <span class="org-keyword">public</span> <span class="org-type">IntervalSummation</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-type">SumOfCubes</span><span class="org-rainbow-delimiters-depth-1">&gt;{</span>
<span class="org-function-name">public</span>:
        <span class="org-type">double</span> <span class="org-function-name">stepFn</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-type">double</span> <span class="org-variable-name">x</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">const</span> <span class="org-rainbow-delimiters-depth-2">{</span> <span class="org-keyword">return</span> x * x * x; <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-keyword">template</span><span class="org-rainbow-delimiters-depth-1">&lt;</span><span class="org-keyword">class</span> <span class="org-type">T</span><span class="org-rainbow-delimiters-depth-1">&gt;</span>
<span class="org-type">void</span> <span class="org-function-name">clientCode</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">const</span> <span class="org-type">IntervalSummation</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">T</span><span class="org-rainbow-delimiters-depth-2">&gt;</span>&amp; <span class="org-variable-name">obj</span><span class="org-rainbow-delimiters-depth-1">){</span>
        <span class="org-constant">std</span>::cout &lt;&lt; <span class="org-string">"Summation at [0, 15] = "</span> &lt;&lt; obj.summation<span class="org-rainbow-delimiters-depth-2">(</span>0, 15<span class="org-rainbow-delimiters-depth-2">)</span> &lt;&lt; <span class="org-constant">std</span>::endl;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
Running: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ clang++ crtp.cpp -o <span class="org-keyword">crtp.bin</span> -std=c++1z -Wall -Wextra  &amp;&amp; ./crtp.bin
Sum of squares<span class="org-keyword"> in</span> [0, 10] = 385
Sum of cubes  <span class="org-keyword"> in</span> [0, 10] = 3025
Summation at [0, 15] = 1240
Summation at [0, 15] = 14400
</pre>
</div>

<p>
References: 
</p>

<ul class="org-ul">
<li><a href="https://www.codeproject.com/Tips/537606/Cplusplus-Prefer-Curiously-Recurring-Template-Patt">C++: Prefer Curiously Recurring Template Pattern (CRTP) to Template Pattern - CodeProject</a></li>
<li><a href="https://mklimenko.github.io/english/2018/07/02/platform-dependent-crtp/">CRTP-based platform-dependent optimizations | GNSS C++ solutions</a></li>
<li><a href="http://stevedewhurst.com/once_weakly/once-weakly20170328/once-weakly20170328.pdf">http://stevedewhurst.com/once_weakly/once-weakly20170328/once-weakly20170328.pdf</a></li>
<li id="[[<a href="http://enki-tech.blogspot.com/2012/08/c11-generic-singleton.html">http://enki-tech.blogspot.com/2012/08/c11-generic-singleton.html</a>][Enki">Technical Blog: C++11: A generic Singleton]]</li>
<li>IDENTIFYING PROGRAMMING IDIOMS IN C++ GENERIC LIBRARIES -
<a href="https://etd.ohiolink.edu/rws_etd/document/get/kent1259116053/inline">https://etd.ohiolink.edu/rws_etd/document/get/kent1259116053/inline</a></li>
<li><a href="http://www.masaers.com/2014/01/22/CRTP-operator-hijacking.html">Using CRTP to easily hijack operators in c++11 | masaers’ blog</a></li>
<li><a href="https://github.com/nojhan/crtp_functor_ttp">https://github.com/nojhan/crtp_functor_ttp</a></li>
<li><a href="https://web.archive.org/web/20060211034709/http://devnet.developerpipeline.com/documents/s=9843/cuj0601diggins/">Developer::Pipelines | Building More Flexible Types with Mixins</a></li>
<li id="[[<a href="https://accu.org/index.php/journals/296">https://accu.org/index.php/journals/296</a>][ACCU">Better Encapsulation for the Curiously Recurring Template Pattern]]</li>
<li><a href="http://www.di.unipi.it/~nids/docs/templates_vs_inheritance.html">Replacing Virtual Methods with Templates</a></li>
<li><a href="http://gsd.web.elte.hu/lectures/bolyai/2018/mixin_crtp/mixin_crtp.pdf">http://gsd.web.elte.hu/lectures/bolyai/2018/mixin_crtp/mixin_crtp.pdf</a></li>
<li><a href="https://faithandbrave.hateblo.jp/entry/20071206/1196934096">https://faithandbrave.hateblo.jp/entry/20071206/1196934096</a></li>
<li><a href="https://nativecoding.wordpress.com/2015/06/05/virtual-methods-vs-crtp-benchmark-2/">Virtual Methods vs CRTP Benchmark – Native Coding</a></li>
<li><a href="https://nativecoding.wordpress.com/2015/01/11/important-c-idioms/">https://nativecoding.wordpress.com/2015/01/11/important-c-idioms/</a></li>
<li><a href="http://barngoggles.com/visitor-with-crtp/">http://barngoggles.com/visitor-with-crtp/</a></li>
</ul>

<p>
Best Links: 
</p>

<ul class="org-ul">
<li><a href="https://nativecoding.wordpress.com/2015/01/11/important-c-idioms/">https://nativecoding.wordpress.com/2015/01/11/important-c-idioms/</a></li>
<li><a href="https://marcoarena.wordpress.com/2012/04/29/use-crtp-for-polymorphic-chaining/">https://marcoarena.wordpress.com/2012/04/29/use-crtp-for-polymorphic-chaining/</a></li>
<li><a href="http://thothonegan.tumblr.com/post/157363120503/crtp-curiously-recurring-template-pattern">http://thothonegan.tumblr.com/post/157363120503/crtp-curiously-recurring-template-pattern</a></li>
</ul>

<p>
Videos: 
</p>

<ul class="org-ul">
<li>Curiously Recurring Template Pattern (CRTP) -
<a href="https://www.youtube.com/watch?v=C3Pi5GlIfjs">https://www.youtube.com/watch?v=C3Pi5GlIfjs</a></li>

<li></li>


<li></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgedf0b0d" class="outline-3">
<h3 id="orgedf0b0d"><span class="section-number-3">2.6</span> Cross platform code with conditional compilation</h3>
<div class="outline-text-3" id="text-2-6">
<p>
Note: It is not a design pattern, but a useful for techinque for
designing cross platform code in C++.
</p>

<p>
Macros are useful for writing cross-platform code by hiding and
isolating platform-specific details, such as specific hardware
registers address, compiler extensions, APIs and system calls. This
example shows how to use conditional compilation to write code which
can be compiled on an Unix-like operating system, such as Linux or OSX
and Windows.
</p>

<p>
Example: 
</p>

<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">Scoped enum is used to identify the operating system the code </span>
<span class="org-comment-delimiter">// </span><span class="org-comment">was copiled against.</span>
<span class="org-keyword">enum</span> <span class="org-keyword">class</span> <span class="org-type">SystemType</span><span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-variable-name">WindowsNT</span>,
    <span class="org-variable-name">Linux</span>,
    <span class="org-variable-name">MacOSX</span>,
    <span class="org-variable-name">FreeBSD</span>,
    <span class="org-variable-name">Unknown</span>
<span class="org-rainbow-delimiters-depth-1">}</span>;

<span class="org-comment-delimiter">/**  </span><span class="org-comment">Returns operating system that the </span>
<span class="org-comment"> *   library was compiled against.</span>
<span class="org-comment">*/</span>
<span class="org-keyword">auto</span> <span class="org-function-name">getSystemType</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-type">SystemType</span> <span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-preprocessor">     #ifdef</span> __apple__
        <span class="org-keyword">return</span> <span class="org-constant">SystemType</span>::MacOSX;
<span class="org-preprocessor">     #elif</span> <span class="org-preprocessor">defined</span> __linux__
        <span class="org-keyword">return</span> <span class="org-constant">SystemType</span>::Linux;
<span class="org-preprocessor">     #elif</span> <span class="org-preprocessor">defined</span> _WIN32 || <span class="org-preprocessor">defined</span> _WIN64
       <span class="org-keyword">return</span> <span class="org-constant">SystemType</span>::WindowsNT;
<span class="org-preprocessor">     #else</span>
       <span class="org-keyword">return</span> <span class="org-constant">SystemType</span>::Unknown;
<span class="org-preprocessor">     #endif</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-function-name">getOperatingSystem</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-type">SystemType</span> <span class="org-variable-name">type</span> = getSystemType<span class="org-rainbow-delimiters-depth-2">()</span>;
     <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>type == <span class="org-constant">SystemType</span>::Linux<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">return</span> <span class="org-string">"Linux"</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>type == <span class="org-constant">SystemType</span>::MacOSX<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">return</span> <span class="org-string">"MacOSX"</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>type == <span class="org-constant">SystemType</span>::WindowsNT<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">return</span> <span class="org-string">"Windows NT"</span>;
     <span class="org-keyword">if</span><span class="org-rainbow-delimiters-depth-2">(</span>type == <span class="org-constant">SystemType</span>::FreeBSD<span class="org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">return</span> <span class="org-string">"FreeBSD"</span>;       
     <span class="org-keyword">return</span> <span class="org-string">"Unknown operating system"</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">auto</span> <span class="org-function-name">isWindows</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">return</span> getSystemType<span class="org-rainbow-delimiters-depth-2">()</span> == <span class="org-constant">SystemType</span>::WindowsNT;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">Check whether is U-N-I-X like </span>
<span class="org-keyword">auto</span> <span class="org-function-name">isNixLike</span><span class="org-rainbow-delimiters-depth-1">()</span> -&gt; <span class="org-type">bool</span> <span class="org-rainbow-delimiters-depth-1">{</span>
     <span class="org-keyword">auto</span> <span class="org-variable-name">t</span> = getSystemType<span class="org-rainbow-delimiters-depth-2">()</span>;
     <span class="org-keyword">return</span> t == <span class="org-constant">SystemType</span>::Linux
             || t == <span class="org-constant">SystemType</span>::FreeBSD
             || t == <span class="org-constant">SystemType</span>::MacOSX;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Cross platform code for creating directory */</span>
<span class="org-type">void</span> <span class="org-function-name">makeDirectory</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-constant">std</span>::<span class="org-type">string</span> <span class="org-variable-name">path</span><span class="org-rainbow-delimiters-depth-1">){</span>
<span class="org-preprocessor">     #if</span> <span class="org-preprocessor">defined</span> __linux__ || <span class="org-preprocessor">defined</span> __apple__
    <span class="org-comment-delimiter">/** </span><span class="org-comment">==== U-NIX Specific code ==== */</span>
        mkdir<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, 0777<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-preprocessor">     #elif</span> _WIN32
    <span class="org-comment-delimiter">/** </span><span class="org-comment">==== Windows Specific Code ==== */</span>
        CreateDirectoryA<span class="org-rainbow-delimiters-depth-2">(</span>path.c_str<span class="org-rainbow-delimiters-depth-3">()</span>, <span class="org-constant">NULL</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-preprocessor">     #endif</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">/** </span><span class="org-comment">Get home directory, ~/ or $HOME on Unix or %USERPROFILE% </span>
<span class="org-comment"> * environment variable on Windows </span>
<span class="org-comment"> */</span>
<span class="org-function-name">std</span>::string getHomeDir<span class="org-rainbow-delimiters-depth-1">(){</span>
    <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>getSystemType<span class="org-rainbow-delimiters-depth-3">()</span> == <span class="org-constant">SystemType</span>::WindowsNT<span class="org-rainbow-delimiters-depth-2">)</span>
       <span class="org-keyword">return</span> getEnv<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"USERPROFILE"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
     <span class="org-keyword">else</span>
      <span class="org-keyword">return</span> getEnv<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"HOME"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2018-11-05 Mon 03:51</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
